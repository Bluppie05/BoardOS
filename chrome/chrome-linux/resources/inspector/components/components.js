import{ResourceType as e,ParsedURL as t,Revealer as n,UIString as o,Settings as i,EventTarget as a}from"../common/common.js";import{StringUtilities as r}from"../platform/platform.js";import{ResourceTreeModel as s,SDKModel as c,DebuggerModel as l,NetworkRequest as d}from"../sdk/sdk.js";import{Utils as u,UIUtils as m,ARIAUtils as h,SettingsUI as p,ContextMenu as g,DockController as b,RemoteDebuggingTerminatedScreen as L,Dialog as k,GlassPane as f,TargetCrashedScreen as v}from"../ui/ui.js";import{LiveLocation as _,DebuggerWorkspaceBinding as C,CSSWorkspaceBinding as S,ResourceUtils as x,BlackboxManager as y}from"../bindings/bindings.js";import{InspectorFrontendHost as T}from"../host/host.js";import{TextUtils as I}from"../text_utils/text_utils.js";import{Workspace as N}from"../workspace/workspace.js";var w=Object.freeze({__proto__:null,PrecomputedFeatures:void 0,ImagePreview:class{static build(t,n,o,i={precomputedFeatures:void 0,imageAltText:void 0}){const{precomputedFeatures:a,imageAltText:c}=i,l=t.model(s.ResourceTreeModel);if(!l)return Promise.resolve(null);let d,m=l.resourceForURL(n),h=n;if(!b(m)&&a&&a.currentSrc&&(h=a.currentSrc,m=l.resourceForURL(h)),!m||!b(m))return Promise.resolve(null);const p=new Promise(e=>{d=e}),g=document.createElement("img");return g.addEventListener("load",(function(){const e=document.createElement("table");u.appendStyle(e,"components/imagePreview.css",{enableLegacyPatching:!0}),e.className="image-preview-container";const t=g.naturalWidth,i=g.naturalHeight,s=a?a.renderedWidth:t,c=a?a.renderedHeight:i;let l;o&&(l=c!==i||s!==t?ls`${s} × ${c} pixels (intrinsic: ${t} × ${i} pixels)`:ls`${s} × ${c} pixels`);e.createChild("tr").createChild("td","image-container").appendChild(g),l&&(e.createChild("tr").createChild("td").createChild("span","description").textContent=l);h!==n&&(e.createChild("tr").createChild("td").createChild("span","description").textContent=r.sprintf("currentSrc: %s",h.trimMiddle(100)));d(e)}),!1),g.addEventListener("error",()=>d(null),!1),c&&(g.alt=c),m.populateImageSource(g),p;function b(t){return!!t&&t.resourceType()===e.resourceTypes.Image}}static async loadDimensionsForNode(e){if(!e.nodeName()||"img"!==e.nodeName().toLowerCase())return;const t=await e.resolveToObject("");if(!t)return;const n=t.callFunctionJSON((function(){return{renderedWidth:this.width,renderedHeight:this.height,currentSrc:this.currentSrc}}),void 0);return t.release(),n}static defaultAltTextForImageURL(e){const n=new t.ParsedURL(e),o=n.isValid?n.displayName:ls`unknown source`;return ls`Image from ${o}`}}});const U=new Set;let D=null;const R=new WeakMap,B=new WeakMap,F=new WeakMap,M=new Map;let A,E;class H{constructor(e,t,n=(()=>{})){this._maxLength=e||m.MaxLengthForDisplayedURLs,this._anchorsByTarget=new Map,this._locationPoolByTarget=new Map,this._onLiveLocationUpdate=n,this._useLinkDecorator=!!t,U.add(this),c.TargetManager.instance().observeTargets(this)}static setLinkDecorator(e){console.assert(!D,"Cannot re-register link decorator."),D=e,e.addEventListener(P.Events.LinkIconChanged,(function(e){const t=e.data,n=R.get(t)||[];for(const e of n)H._updateLinkDecorations(e)}));for(const e of U)e._updateAllAnchorDecorations()}_updateAllAnchorDecorations(){for(const e of this._anchorsByTarget.values())for(const t of e)H._updateLinkDecorations(t)}static _bindUILocation(e,t){const n=H._linkInfo(e);if(!n)return;if(n.uiLocation=t,!t)return;const o=t.uiSourceCode;let i=R.get(o);i||(i=new Set,R.set(o,i)),i.add(e)}static _unbindUILocation(e){const t=H._linkInfo(e);if(!t||!t.uiLocation)return;const n=t.uiLocation.uiSourceCode;t.uiLocation=null;const o=R.get(n);o&&o.delete(e)}targetAdded(e){this._anchorsByTarget.set(e,[]),this._locationPoolByTarget.set(e,new _.LiveLocationPool)}targetRemoved(e){const t=this._locationPoolByTarget.get(e);if(this._locationPoolByTarget.delete(e),!t)return;t.disposeAll();const n=this._anchorsByTarget.get(e);if(n){this._anchorsByTarget.delete(e);for(const e of n){const t=H._linkInfo(e);if(!t)continue;t.liveLocation=null,H._unbindUILocation(e);const n=t.fallback;if(n){e.href=n.href,e.title=n.title,e.className=n.className,e.textContent=n.textContent;const t=B.get(n);t&&B.set(e,t)}}}}maybeLinkifyScriptLocation(e,t,n,o,i){let a=null;const r={lineNumber:o,maxLength:this._maxLength,columnNumber:i?i.columnNumber:void 0,className:i?i.className:void 0,tabStop:i?i.tabStop:void 0,text:void 0,preventClick:void 0,bypassURLTrimming:void 0},{columnNumber:s=0,className:c=""}=r;if(n&&(a=H.linkifyURL(n,r)),!e||e.isDisposed())return a;const d=e.model(l.DebuggerModel);if(!d)return a;let u;if(t&&(u=d.createRawLocationByScriptId(t,o||0,s)),u||(u=d.createRawLocationByURL(n,o||0,s)),!u)return a;const m={maxLength:void 0,title:void 0,href:void 0,preventClick:void 0,bypassURLTrimming:void 0,tabStop:i?i.tabStop:void 0},h=H._createLink("​",c,m),p=H._linkInfo(h);if(!p)return null;p.enableDecorator=this._useLinkDecorator,p.fallback=a;const g=this._locationPoolByTarget.get(u.debuggerModel.target());if(!g)return null;C.DebuggerWorkspaceBinding.instance().createLiveLocation(u,this._updateAnchor.bind(this,h),g).then(e=>{e&&(p.liveLocation=e,this._onLiveLocationUpdate())});return this._anchorsByTarget.get(u.debuggerModel.target()).push(h),h}linkifyScriptLocation(e,t,n,o,i){const a=this.maybeLinkifyScriptLocation(e,t,n,o,i),r={lineNumber:o,maxLength:this._maxLength,className:i?i.className:void 0,columnNumber:i?i.columnNumber:void 0,tabStop:i?i.tabStop:void 0,text:void 0,preventClick:void 0,bypassURLTrimming:void 0};return a||H.linkifyURL(n,r)}linkifyRawLocation(e,t,n){return this.linkifyScriptLocation(e.debuggerModel.target(),e.scriptId,t,e.lineNumber,{columnNumber:e.columnNumber,className:n,tabStop:void 0})}maybeLinkifyConsoleCallFrame(e,t,n){const o={columnNumber:t.columnNumber,tabStop:n?n.tabStop:void 0,className:n?n.className:void 0};return this.maybeLinkifyScriptLocation(e,t.scriptId,t.url,t.lineNumber,o)}linkifyStackTraceTopFrame(e,t,n){console.assert(!!t.callFrames&&!!t.callFrames.length);const o=t.callFrames[0],i=H.linkifyURL(o.url,{className:n,lineNumber:o.lineNumber,columnNumber:o.columnNumber,maxLength:this._maxLength,text:void 0,preventClick:void 0,tabStop:void 0,bypassURLTrimming:void 0});if(e.isDisposed())return i;const a=e.model(l.DebuggerModel);if(!a)return i;const r=a.createRawLocationsByStackTrace(t);if(0===r.length)return i;const s=H._createLink("​",n||""),c=H._linkInfo(s);if(!c)return i;c.enableDecorator=this._useLinkDecorator,c.fallback=i;const d=this._locationPoolByTarget.get(e);if(!d)return i;C.DebuggerWorkspaceBinding.instance().createStackTraceTopFrameLiveLocation(r,this._updateAnchor.bind(this,s),d).then(e=>{c.liveLocation=e,this._onLiveLocationUpdate()});return this._anchorsByTarget.get(e).push(s),s}linkifyCSSLocation(e,t){const n=H._createLink("​",t||""),o=H._linkInfo(n);if(!o)return n;o.enableDecorator=this._useLinkDecorator;const i=this._locationPoolByTarget.get(e.cssModel().target());if(!i)return n;S.CSSWorkspaceBinding.instance().createLiveLocation(e,this._updateAnchor.bind(this,n),i).then(e=>{o.liveLocation=e,this._onLiveLocationUpdate()});return this._anchorsByTarget.get(e.cssModel().target()).push(n),n}reset(){for(const e of[...this._anchorsByTarget.keys()])this.targetRemoved(e),this.targetAdded(e)}dispose(){for(const e of[...this._anchorsByTarget.keys()])this.targetRemoved(e);c.TargetManager.instance().unobserveTargets(this),U.delete(this)}async _updateAnchor(e,t){H._unbindUILocation(e);const o=await t.uiLocation();if(!o){if(t instanceof S.LiveLocation){const o=t.header();o&&o.ownerNode&&(e.addEventListener("click",e=>{e.consume(!0),n.reveal(o.ownerNode||null)},!1),H._setTrimmedText(e,"<style>"))}return}H._bindUILocation(e,o);const i=o.linkText(!0);H._setTrimmedText(e,i,this._maxLength);let a=o.uiSourceCode.url();"application/wasm"===o.uiSourceCode.mimeType()?a+=":0x"+o.columnNumber.toString(16):"number"==typeof o.lineNumber&&(a+=":"+(o.lineNumber+1)),e.title=a,e.classList.toggle("webkit-html-blackbox-link",await t.isBlackboxed()),H._updateLinkDecorations(e)}setLiveLocationUpdateCallback(e){this._onLiveLocationUpdate=e}static _updateLinkDecorations(e){const t=H._linkInfo(e);if(!t||!t.enableDecorator)return;if(!D||!t.uiLocation)return;t.icon&&t.icon.parentElement&&e.removeChild(t.icon);const n=D.linkIcon(t.uiLocation.uiSourceCode);n&&(n.style.setProperty("margin-right","2px"),e.insertBefore(n,e.firstChild)),t.icon=n}static linkifyURL(e,t){const n=(t=t||{text:void 0,className:void 0,lineNumber:void 0,columnNumber:void 0,preventClick:void 0,maxLength:void 0,tabStop:void 0,bypassURLTrimming:void 0}).text,i=t.className||"",a=t.lineNumber,r=t.columnNumber,s=t.preventClick,c=t.maxLength||m.MaxLengthForDisplayedURLs,l=t.bypassURLTrimming;if(!e||e.trim().toLowerCase().startsWith("javascript:")){const t=document.createElement("span");return i&&(t.className=i),t.textContent=n||e||o.UIString("(unknown)"),t}let d=n||x.displayNameForURL(e);"number"!=typeof a||n||(d+=":"+(a+1));const u={maxLength:c,title:d!==e?e:"",href:e,preventClick:s,tabStop:t.tabStop,bypassURLTrimming:l},h=H._createLink(d,i,u),p=H._linkInfo(h);return p?(a&&(p.lineNumber=a),r&&(p.columnNumber=r),h):h}static linkifyRevealable(e,t,n){const o={maxLength:m.MaxLengthForDisplayedURLs,href:n,title:void 0,preventClick:void 0,tabStop:void 0,bypassURLTrimming:void 0},i=H._createLink(t,"",o),a=H._linkInfo(i);return a?(a.revealable=e,i):i}static _createLink(e,t,n){n=n||{maxLength:void 0,title:void 0,href:void 0,preventClick:void 0,tabStop:void 0,bypassURLTrimming:void 0};const{maxLength:o,title:i,href:a,preventClick:r,tabStop:s,bypassURLTrimming:c}=n,l=document.createElement("span");t&&(l.className=t),l.classList.add("devtools-link"),i&&(l.title=i),a&&(l.href=a),c?(l.classList.add("devtools-link-styled-trim"),H._appendTextWithoutHashes(l,e)):H._setTrimmedText(l,e,o);const d={icon:null,enableDecorator:!1,uiLocation:null,liveLocation:null,url:a||null,lineNumber:null,columnNumber:null,revealable:null,fallback:null};return B.set(l,d),r?l.classList.add("devtools-link-prevent-click"):(l.addEventListener("click",e=>{H._handleClick(e)&&e.consume(!0)},!1),l.addEventListener("keydown",e=>{isEnterKey(e)&&H._handleClick(e)&&e.consume(!0)},!1)),h.markAsLink(l),l.tabIndex=s?0:-1,l}static _setTrimmedText(e,t,n){if(e.removeChildren(),n&&t.length>n){const o=function(e,t){let n=Math.floor(t/2),o=e.length-Math.ceil(t/2)+1;const i=e.codePointAt(o-1);void 0!==i&&i>=65536&&(o++,n++);const a=e.codePointAt(n-1);void 0!==a&&n>0&&a>=65536&&n--;return[e.substring(0,n),e.substring(n,o),e.substring(o)]}(t,n);H._appendTextWithoutHashes(e,o[0]),H._appendHiddenText(e,o[1]),H._appendTextWithoutHashes(e,o[2])}else H._appendTextWithoutHashes(e,t)}static _appendTextWithoutHashes(e,t){const n=I.Utils.splitStringByRegexes(t,[/[a-f0-9]{20,}/g]);for(const t of n)-1===t.regexIndex?m.createTextChild(e,t.value):(m.createTextChild(e,t.value.substring(0,7)),H._appendHiddenText(e,t.value.substring(7)))}static _appendHiddenText(e,t){const n=m.createTextChild(e.createChild("span","devtools-link-ellipsis"),"…");F.set(n,t)}static untruncatedNodeText(e){return F.get(e)||e.textContent||""}static _linkInfo(e){return e&&B.get(e)||null}static _handleClick(e){const t=e.currentTarget;return!m.isBeingEdited(e.target)&&!t.hasSelection()&&H.invokeFirstAction(t)}static invokeFirstAction(e){const t=H._linkActions(e);return!!t.length&&(t[0].handler.call(null),!0)}static _linkHandlerSetting(){return A||(A=i.Settings.instance().createSetting("openLinkHandler",ls`auto`)),A}static registerLinkHandler(e,t){M.set(e,t),W.instance()._update()}static unregisterLinkHandler(e){M.delete(e),W.instance()._update()}static uiLocation(e){const t=H._linkInfo(e);return t?t.uiLocation:null}static _linkActions(e){const i=H._linkInfo(e),a=[];if(!i)return a;let r="",s=null;if(i.uiLocation)s=i.uiLocation,r=s.uiSourceCode.contentURL();else if(i.url){r=i.url;const e=N.WorkspaceImpl.instance().uiSourceCodeForURL(r)||N.WorkspaceImpl.instance().uiSourceCodeForURL(t.ParsedURL.urlWithoutHash(r));s=e?e.uiLocation(i.lineNumber||0,i.columnNumber||0):null}const c=r?x.resourceForURL(r):null,l=s?s.uiSourceCode:c,d=i.revealable||s||c;if(d){const e=n.revealDestination(d);a.push({section:"reveal",title:e?ls`Reveal in ${e}`:ls`Reveal`,handler:()=>n.reveal(d)})}if(l){const e=s?s.lineNumber:i.lineNumber||0;for(const t of M.keys()){const n=M.get(t);if(!n)continue;const i={section:"reveal",title:o.UIString("Open using %s",t),handler:n.bind(null,l,e)};t===H._linkHandlerSetting().get()?a.unshift(i):a.push(i)}}return(c||i.url)&&(a.push({section:"reveal",title:m.openLinkExternallyLabel(),handler:()=>T.InspectorFrontendHostInstance.openInNewTab(r)}),a.push({section:"clipboard",title:m.copyLinkAddressLabel(),handler:()=>T.InspectorFrontendHostInstance.copyText(r)})),a}}class P extends a.EventTarget{linkIcon(e){throw new Error("Not implemented yet")}}P.Events={LinkIconChanged:Symbol("LinkIconChanged")};class W{constructor(){this._element=document.createElement("select"),this._element.classList.add("chrome-select"),this._element.addEventListener("change",this._onChange.bind(this),!1),this._update()}static instance(e={forceNew:null}){const{forceNew:t}=e;return E&&!t||(E=new W),E}_update(){this._element.removeChildren();const e=[...M.keys()];e.unshift(o.UIString("auto"));for(const t of e){const e=document.createElement("option");e.textContent=t,e.selected=t===H._linkHandlerSetting().get(),this._element.appendChild(e)}this._element.disabled=e.length<=1}_onChange(e){if(!e.target)return;const t=e.target.value;H._linkHandlerSetting().set(t)}settingElement(){return p.createCustomSetting(o.UIString("Link handling:"),this._element)}}var j=Object.freeze({__proto__:null,Linkifier:H,LinkDecorator:P,LinkContextMenuProvider:class{appendApplicableItems(e,t,n){let o=n;for(;o&&!B.get(o);)o=o.parentNodeOrShadowHost();const i=o,a=H._linkActions(i);for(const e of a)t.section(e.section).appendItem(e.title,e.handler)}},LinkHandlerSettingUI:W,ContentProviderContextMenuProvider:class{appendApplicableItems(e,t,n){const i=n;if(i.contentURL()){t.revealSection().appendItem(m.openLinkExternallyLabel(),()=>T.InspectorFrontendHostInstance.openInNewTab(i.contentURL()));for(const e of M.keys()){const n=M.get(e);n&&t.revealSection().appendItem(o.UIString("Open using %s",e),n.bind(null,i,0))}i instanceof d.NetworkRequest||t.clipboardSection().appendItem(m.copyLinkAddressLabel(),()=>T.InspectorFrontendHostInstance.copyText(i.contentURL()))}}},_LinkInfo:void 0,LinkifyURLOptions:void 0,LinkifyOptions:void 0,_CreateLinkOptions:void 0,LinkHandler:void 0});var O=Object.freeze({__proto__:null,buildStackTracePreviewContents:function(e,t,n={stackTrace:void 0,contentUpdated:void 0,tabStops:void 0}){const{stackTrace:o,contentUpdated:i,tabStops:a}=n,r=document.createElement("span");r.classList.add("monospace"),r.style.display="inline-block";const s=u.createShadowRootWithCoreStyles(r,{cssFile:"components/jsUtils.css",enableLegacyPatching:!0,delegatesFocus:void 0}).createChild("table","stack-preview-container");let c=0,l=0;const d=[];function h(n){let o=0;for(const i of n.callFrames){l++;let r=l>30&&n.callFrames.length>31;const c=document.createElement("tr");c.createChild("td").textContent="\n",c.createChild("td","function-name").textContent=m.beautifyFunctionName(i.functionName);const u=t.maybeLinkifyConsoleCallFrame(e,i,{tabStop:!!a,className:void 0,columnNumber:void 0});if(u){u.addEventListener("contextmenu",p.bind(null,u));const e=H.uiLocation(u);e&&y.BlackboxManager.instance().isBlackboxedUISourceCode(e.uiSourceCode)&&(r=!0),c.createChild("td").textContent=" @ ",c.createChild("td").appendChild(u),d.push(u)}r&&(c.classList.add("blackboxed"),++o),s.appendChild(c)}return c+=o,n.callFrames.length===o}function p(e,t){const n=new g.ContextMenu(t);t.consume(!0);const o=H.uiLocation(e);o&&y.BlackboxManager.instance().canBlackboxUISourceCode(o.uiSourceCode)&&(y.BlackboxManager.instance().isBlackboxedUISourceCode(o.uiSourceCode)?n.debugSection().appendItem(ls`Stop blackboxing`,()=>y.BlackboxManager.instance().unblackboxUISourceCode(o.uiSourceCode)):n.debugSection().appendItem(ls`Blackbox script`,()=>y.BlackboxManager.instance().blackboxUISourceCode(o.uiSourceCode))),n.appendApplicableItems(t),n.show()}if(!o)return{element:r,links:d};h(o);let b=o.parent;for(;b;){if(!b.callFrames.length){b=b.parent;continue}const e=s.createChild("tr");e.createChild("td").textContent="\n",e.createChild("td","stack-preview-async-description").textContent=m.asyncStackTraceLabel(b.description),e.createChild("td"),e.createChild("td"),h(b)&&e.classList.add("blackboxed"),b=b.parent}if(c){const e=s.createChild("tr","show-blackboxed-link");e.createChild("td").textContent="\n";const t=e.createChild("td");t.colSpan=4;const n=t.createChild("span","link");n.textContent=1===c?ls`Show 1 more frame`:ls`Show ${c} more frames`,n.addEventListener("click",()=>{s.classList.add("show-blackboxed"),i&&i()},!1)}return{element:r,links:d}},Options:void 0});var $=Object.freeze({__proto__:null,reload:function(){b.DockController.instance().canDock()&&b.DockController.instance().dockSide()===b.State.Undocked&&T.InspectorFrontendHostInstance.setIsDocked(!0,(function(){})),T.InspectorFrontendHostInstance.reattach(()=>window.location.reload())}});class z extends c.SDKModel{constructor(e){super(e),e.registerInspectorDispatcher(this),e.inspectorAgent().invoke_enable(),this._hideCrashedDialog=null}detached({reason:e}){L.RemoteDebuggingTerminatedScreen.show(e)}static webSocketConnectionLost(){L.RemoteDebuggingTerminatedScreen.show(ls`WebSocket disconnected`)}targetCrashed(){if(this.target().parentTarget())return;const e=new k.Dialog;e.setSizeBehavior(f.SizeBehavior.MeasureContent),e.addCloseButton(),e.setDimmed(!0),this._hideCrashedDialog=e.hide.bind(e),new v.TargetCrashedScreen(()=>{this._hideCrashedDialog=null}).show(e.contentElement),e.show()}targetReloadedAfterCrash(){this.target().runtimeAgent().invoke_runIfWaitingForDebugger(),this._hideCrashedDialog&&(this._hideCrashedDialog.call(null),this._hideCrashedDialog=null)}}c.SDKModel.register(z,c.Capability.Inspector,!0);var K=Object.freeze({__proto__:null,TargetDetachedDialog:z});export{w as ImagePreview,O as JSPresentationUtils,j as Linkifier,$ as Reload,K as TargetDetachedDialog};
