import{DOMDebuggerModel as e,RemoteObject as t}from"../sdk/sdk.js";import{Console as n,UIString as r,Revealer as i}from"../common/common.js";import{Linkifier as s}from"../components/components.js";import{ObjectPropertiesSection as o}from"../object_ui/object_ui.js";import{Widget as l,TreeOutline as a,ARIAUtils as c,ContextMenu as u}from"../ui/ui.js";function h(r){const i=r.runtimeModel().target().model(e.DOMDebuggerModel);if(!i)return Promise.resolve({eventListeners:[],internalHandlers:null});const s={eventListeners:[]};return r.callFunction((function(){const e=[];let t=[],n=[],r=[function(e){if(!(e&&e instanceof Node))return{eventListeners:[]};const t=window.jQuery;if(!t||!t.fn)return{eventListeners:[]};const n=t,r=t._data||t.data,i=[],s=[];if("function"==typeof r){const t=r(e,"events");for(const n in t)for(const r in t[n]){const s=t[n][r];if("object"==typeof s||"function"==typeof s){const t={handler:s.handler||s,useCapture:!0,passive:!1,once:!1,type:n};t.remove=u.bind(e,s.selector),i.push(t)}}const n=r(e);n&&"function"==typeof n.handle&&s.push(n.handle)}const o=n(e)[0];if(o){const e=o.$events;for(const t in e){const n=e[t];for(const e in n)if("function"==typeof n[e]){const r={handler:n[e],useCapture:!0,passive:!1,once:!1,type:t};i.push(r)}}o&&o.$handle&&s.push(o.$handle)}return{eventListeners:i,internalHandlers:s}}];try{self.devtoolsFrameworkEventListeners&&s(self.devtoolsFrameworkEventListeners)&&(r=r.concat(self.devtoolsFrameworkEventListeners))}catch(t){e.push("devtoolsFrameworkEventListeners call produced error: "+a(t))}for(let i=0;i<r.length;++i)try{const e=r[i](this);e.eventListeners&&s(e.eventListeners)&&(t=t.concat(e.eventListeners.map(o).filter(c))),e.internalHandlers&&s(e.internalHandlers)&&(n=n.concat(e.internalHandlers.map(l).filter(c)))}catch(t){e.push("fetcher call produced error: "+a(t))}const i={eventListeners:t};n.length&&(i.internalHandlers=n);if(e.length){let t="Framework Event Listeners API Errors:\n\t"+e.join("\n\t");t=t.substr(0,t.length-1),i.errorString=t}return i;function s(e){if(!e||"object"!=typeof e)return!1;try{if("function"==typeof e.splice){const t=e.length;return"number"==typeof t&&t>>>0===t&&(t>0||1/t>0)}}catch(e){}return!1}function o(t){try{let n="";t||(n+="empty event listener, ");const r=t.type;r&&"string"==typeof r||(n+="event listener's type isn't string or empty, ");const i=t.useCapture;"boolean"!=typeof i&&(n+="event listener's useCapture isn't boolean or undefined, ");const s=t.passive;"boolean"!=typeof s&&(n+="event listener's passive isn't boolean or undefined, ");const o=t.once;"boolean"!=typeof o&&(n+="event listener's once isn't boolean or undefined, ");const l=t.handler;l&&"function"==typeof l||(n+="event listener's handler isn't a function or empty, ");const a=t.remove;return a&&"function"!=typeof a&&(n+="event listener's remove isn't a function, "),n?(e.push(n.substr(0,n.length-2)),null):{type:r,useCapture:i,passive:s,once:o,handler:l,remove:a}}catch(t){return e.push(a(t)),null}}function l(t){return t&&"function"==typeof t?t:(e.push("internal handler isn't a function or empty"),null)}function a(e){try{return""+e}catch(e){return"<error>"}}function c(e){return!!e}function u(e,t,n){if(!(this&&this instanceof Node))return;const r=window.jQuery;if(!r||!r.fn)return;r(this).off(t,e,n)}}),void 0).then(u).then((function(e){return e.getOwnProperties(!1)})).then((function(e){if(!e.properties)throw new Error("Object properties is empty");const r=[];for(const u of e.properties)"eventListeners"===u.name&&u.value&&r.push(o(u.value).then(a)),"internalHandlers"===u.name&&u.value&&r.push((s=u.value,t.RemoteArray.objectAsArray(s).map(l).then(t.RemoteArray.createFromRemoteObjects.bind(null))).then(c)),"errorString"===u.name&&u.value&&(i=u.value,n.Console.instance().error(String(i.value)));var i;var s;return Promise.all(r)})).then((function(){return s})).catch(e=>(console.error(e),s));function o(n){return t.RemoteArray.objectAsArray(n).map((function(t){let n,s,o,a,c=null,h=null,d=null,p=null;const v=[];function f(e){d=e?e.location:null}return v.push(t.callFunctionJSON((function(){return{type:this.type,useCapture:this.useCapture,passive:this.passive,once:this.once}}),void 0).then((function(e){n=e.type,s=e.useCapture,o=e.passive,a=e.once}))),v.push(t.callFunction((function(){return this.handler})).then(u).then((function(e){return h=e,h})).then(l).then((function(e){return c=e,e.debuggerModel().functionDetailsPromise(e).then(f)}))),v.push(t.callFunction((function(){return this.remove})).then(u).then((function(e){if("function"!==e.type)return;p=e}))),Promise.all(v).then((function(){if(!d)throw new Error("Empty event listener's location");return new e.EventListener(i,r,n,s,o,a,c,h,d,p,e.EventListener.Origin.FrameworkUser)})).catch(e=>(console.error(e),null))})).then(h)}function l(e){return t.RemoteFunction.objectAsFunction(e).targetFunction()}function a(e){s.eventListeners=e}function c(e){s.internalHandlers=e}function u(e){if(e.wasThrown||!e.object)throw new Error("Exception in callFunction or empty result");return e.object}function h(e){return e.filter((function(e){return!!e}))}}var d=Object.freeze({__proto__:null,frameworkEventListeners:h,FrameworkEventListenersObject:void 0,EventListenerObjectInInspectedPage:void 0});class p extends l.VBox{constructor(e,t=!1){super(),this._changeCallback=e,this._enableDefaultTreeFocus=t,this._treeOutline=new a.TreeOutlineInShadow,this._treeOutline.hideOverflow(),this._treeOutline.registerRequiredCSS("object_ui/objectValue.css",{enableLegacyPatching:!0}),this._treeOutline.registerRequiredCSS("event_listeners/eventListenersView.css",{enableLegacyPatching:!0}),this._treeOutline.setComparator(v.comparator),this._treeOutline.element.classList.add("monospace"),this._treeOutline.setShowSelectionOnKeyboardFocus(!0),this._treeOutline.setFocusable(!0),this.element.appendChild(this._treeOutline.element),this._emptyHolder=document.createElement("div"),this._emptyHolder.classList.add("gray-info-message"),this._emptyHolder.textContent=r.UIString("No event listeners"),this._emptyHolder.tabIndex=-1,this._linkifier=new s.Linkifier,this._treeItemMap=new Map}focus(){this._enableDefaultTreeFocus&&(this._emptyHolder.parentNode?this._emptyHolder.focus():this._treeOutline.forceSelect())}async addObjects(e){this.reset(),await Promise.all(e.map(e=>e?this._addObject(e):Promise.resolve())),this.addEmptyHolderIfNeeded(),this._eventListenersArrivedForTest()}_addObject(n){let r,i=null;const s=[],o=n.runtimeModel().target().model(e.DOMDebuggerModel);return o&&s.push(o.eventListeners(n).then((function(e){r=e}))),s.push(h(n).then((function(e){i=e}))),Promise.all(s).then((function(){if(!i)return Promise.resolve();if(!i.internalHandlers)return Promise.resolve();return i.internalHandlers.object().callFunctionJSON((function(){const e=[],t=new Set(this);for(const n of arguments)e.push(t.has(n));return e}),r.map((function(e){return t.RemoteObject.toCallArgument(e.handler())}))).then((function(e){for(let t=0;t<r.length;++t)e[t]&&r[t].markAsFramework()}))})).then(function(){this._addObjectEventListeners(n,r),i&&this._addObjectEventListeners(n,i.eventListeners)}.bind(this))}_addObjectEventListeners(e,t){if(t)for(const n of t){this._getOrCreateTreeElementForType(n.type()).addObjectEventListener(n,e)}}showFrameworkListeners(t,n,r){const i=this._treeOutline.rootElement().children();for(const s of i){let i=!0;for(const o of s.children()){const s=o,l=s.eventListener().origin();let a=!1;l!==e.EventListener.Origin.FrameworkUser||t||(a=!0),l===e.EventListener.Origin.Framework&&t&&(a=!0),!n&&s.eventListener().passive()&&(a=!0),r||s.eventListener().passive()||(a=!0),s.hidden=a,i=i&&a}s.hidden=i}}_getOrCreateTreeElementForType(e){let t=this._treeItemMap.get(e);return t||(t=new v(e,this._linkifier,this._changeCallback),this._treeItemMap.set(e,t),t.hidden=!0,this._treeOutline.appendChild(t)),this._emptyHolder.remove(),t}addEmptyHolderIfNeeded(){let e=!0,t=null;for(const n of this._treeOutline.rootElement().children())n.hidden=!n.firstChild(),e=e&&n.hidden,t||n.hidden||(t=n);e&&!this._emptyHolder.parentNode&&this.element.appendChild(this._emptyHolder),t&&t.select(!0)}reset(){const e=this._treeOutline.rootElement().children();for(const t of e)t.removeChildren();this._linkifier.reset()}_eventListenersArrivedForTest(){}}class v extends a.TreeElement{constructor(e,t,n){super(e),this.toggleOnClick=!0,this._linkifier=t,this._changeCallback=n,c.setAccessibleName(this.listItemElement,e+", event listener")}static comparator(e,t){return e.title===t.title?0:e.title>t.title?1:-1}addObjectEventListener(e,t){const n=new f(e,t,this._linkifier,this._changeCallback);this.appendChild(n)}}class f extends a.TreeElement{constructor(e,t,n,r){super("",!0),this._eventListener=e,this.editable=!1,this._setTitle(t,n),this._changeCallback=r}async onpopulate(){const e=[],n=this._eventListener,r=n.domDebuggerModel().runtimeModel();e.push(r.createRemotePropertyFromPrimitiveValue("useCapture",n.useCapture())),e.push(r.createRemotePropertyFromPrimitiveValue("passive",n.passive())),e.push(r.createRemotePropertyFromPrimitiveValue("once",n.once())),void 0!==n.handler()&&e.push(new t.RemoteObjectProperty("handler",n.handler())),o.ObjectPropertyTreeElement.populateWithProperties(this,e,[],!0,null)}_setTitle(e,t){const n=this.listItemElement.createChild("span","event-listener-details"),s=this.listItemElement.createChild("span","event-listener-tree-subtitle"),l=t.linkifyRawLocation(this._eventListener.location(),this._eventListener.sourceURL());s.appendChild(l);const a=o.ObjectPropertiesSection.createPropertyValue(e,!1,!1);if(this._valueTitle=a.element,n.appendChild(this._valueTitle),this._eventListener.canRemove()){const e=n.createChild("span","event-listener-button");e.textContent=r.UIString("Remove"),e.title=r.UIString("Delete event listener"),e.addEventListener("click",e=>{this._removeListener(),e.consume()},!1),n.appendChild(e)}if(this._eventListener.isScrollBlockingType()&&this._eventListener.canTogglePassive()){const e=n.createChild("span","event-listener-button");e.textContent=r.UIString("Toggle Passive"),e.title=r.UIString("Toggle whether event listener is passive or blocking"),e.addEventListener("click",e=>{this._togglePassiveListener(),e.consume()},!1),n.appendChild(e)}this.listItemElement.addEventListener("contextmenu",t=>{const n=new u.ContextMenu(t);t.target!==l&&n.appendApplicableItems(l),"node"===e.subtype&&n.defaultSection().appendItem(ls`Reveal in Elements panel`,()=>i.reveal(e)),n.defaultSection().appendItem(ls`Delete event listener`,this._removeListener.bind(this),!this._eventListener.canRemove()),n.defaultSection().appendCheckboxItem(ls`Passive`,this._togglePassiveListener.bind(this),this._eventListener.passive(),!this._eventListener.canTogglePassive()),n.show()})}_removeListener(){this._removeListenerBar(),this._eventListener.remove()}_togglePassiveListener(){this._eventListener.togglePassive().then(()=>this._changeCallback())}_removeListenerBar(){const e=this.parent;e.removeChild(this),e.childCount()||e.collapse();let t=!0;for(let n=0;n<e.childCount();++n)e.childAt(n).hidden||(t=!1);e.hidden=t}eventListener(){return this._eventListener}onenter(){return!!this._valueTitle&&(this._valueTitle.click(),!0)}}var m=Object.freeze({__proto__:null,EventListenersView:p,EventListenersTreeElement:v,ObjectEventListenerBar:f});export{d as EventListenersUtils,m as EventListenersView};
