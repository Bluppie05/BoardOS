import{Settings as t}from"../common/common.js";import{DataGrid as e}from"../data_grid/data_grid.js";import{userMetrics as i,UserMetrics as a}from"../host/host.js";import{SDKModel as o,WebAuthnModel as n}from"../sdk/sdk.js";import{UIUtils as r,Widget as s,Toolbar as c,ARIAUtils as l}from"../ui/ui.js";const h={ExportCredential:Symbol("ExportCredential"),RemoveCredential:Symbol("RemoveCredential")};class d extends e.DataGridNode{constructor(t){super(t)}nodeSelfHeight(){return 24}createCell(t){const e=super.createCell(t);if(e.title=e.textContent||"","actions"!==t)return e;const i=r.createTextButton(ls`Export`,()=>{this.dataGrid&&this.dataGrid.dispatchEventToListeners(h.ExportCredential,this.data)});e.appendChild(i);const a=r.createTextButton(ls`Remove`,()=>{this.dataGrid&&this.dataGrid.dispatchEventToListeners(h.RemoveCredential,this.data)});return e.appendChild(a),e}}class u extends e.DataGridNode{createCells(t){t.removeChildren();const i=this.createTDWithClass(e.Align.Center);this.dataGrid&&(i.colSpan=this.dataGrid.visibleColumnsArray.length);const a=document.createElement("span",{is:"source-code"});a.textContent="navigator.credentials.create()",a.classList.add("code");const o=r.formatLocalized("No credentials. Try calling %s from your website.",[a]);i.appendChild(o),t.appendChild(i)}}class p extends s.VBox{constructor(){super(!0),this.registerRequiredCSS("webauthn/webauthnPane.css",{enableLegacyPatching:!0}),this.contentElement.classList.add("webauthn-pane"),this._enabled=!1,this._activeAuthId=null,this._hasBeenEnabled=!1,this._dataGrids=new Map,this._availableAuthenticatorSetting=t.Settings.instance().createSetting("webauthnAuthenticators",[]);const e=o.TargetManager.instance().mainTarget();e&&(this._model=e.model(n.WebAuthnModel)),this._createToolbar(),this._authenticatorsView=this.contentElement.createChild("div","authenticators-view"),this._createNewAuthenticatorSection(),this._updateVisibility(!1)}async _loadInitialAuthenticators(){let t=null;const e=this._availableAuthenticatorSetting.get();for(const i of e){if(!this._model)continue;const e=await this._model.addAuthenticator(i);this._addAuthenticatorSection(e,i),i.authenticatorId=e,i.active&&(t=e)}this._availableAuthenticatorSetting.set(e),t&&this._setActiveAuthenticator(t)}ownerViewDisposed(){this._enableCheckbox&&this._enableCheckbox.setChecked(!1),this._setVirtualAuthEnvEnabled(!1)}_createToolbar(){this._topToolbarContainer=this.contentElement.createChild("div","webauthn-toolbar-container"),this._topToolbar=new c.Toolbar("webauthn-toolbar",this._topToolbarContainer);const t=ls`Enable virtual authenticator environment`;this._enableCheckbox=new c.ToolbarCheckbox(t,t,this._handleCheckboxToggle.bind(this)),this._topToolbar.appendToolbarItem(this._enableCheckbox)}_createCredentialsDataGrid(t){const i=[{id:"credentialId",title:ls`ID`,longText:!0,weight:24},{id:"isResidentCredential",title:ls`Is Resident`,dataType:e.DataType.Boolean,weight:10},{id:"rpId",title:ls`RP ID`},{id:"userHandle",title:ls`User Handle`},{id:"signCount",title:ls`Sign Count`},{id:"actions",title:ls`Actions`}],a={displayName:ls`Credentials`,columns:i,editCallback:void 0,deleteCallback:void 0,refreshCallback:void 0},o=new e.DataGridImpl(a);return o.renderInline(),o.setStriped(!0),o.addEventListener(h.ExportCredential,this._handleExportCredential,this),o.addEventListener(h.RemoveCredential,this._handleRemoveCredential.bind(this,t)),this._dataGrids.set(t,o),o}_handleExportCredential(t){this._exportCredential(t.data)}_handleRemoveCredential(t,e){this._removeCredential(t,e.data.credentialId)}async _updateCredentials(t){const e=this._dataGrids.get(t);if(e){if(this._model){const i=await this._model.getCredentials(t);e.rootNode().removeChildren();for(const t of i){const i=new d(t);e.rootNode().appendChild(i)}this._maybeAddEmptyNode(e)}setTimeout(this._updateCredentials.bind(this,t),1e3)}}_maybeAddEmptyNode(t){if(t.rootNode().children.length)return;const e=new u;t.rootNode().appendChild(e)}_setVirtualAuthEnvEnabled(t){t&&!this._hasBeenEnabled&&(i.actionTaken(a.Action.VirtualAuthenticatorEnvironmentEnabled),this._hasBeenEnabled=!0),this._enabled=t,this._model&&this._model.setVirtualAuthEnvEnabled(t),this._updateVisibility(t),t?this._loadInitialAuthenticators():this._removeAuthenticatorSections()}_updateVisibility(t){t?this._newAuthenticatorSection&&(this._newAuthenticatorSection.style.visibility="visible"):this._newAuthenticatorSection&&(this._newAuthenticatorSection.style.visibility="hidden")}_removeAuthenticatorSections(){this._authenticatorsView.innerHTML="",this._dataGrids.clear()}_handleCheckboxToggle(){this._setVirtualAuthEnvEnabled(!this._enabled)}_updateEnabledTransportOptions(t){if(!this._transportSelect)return;const e=this._transportSelect.value;this._transportSelect.removeChildren();for(const e of t)this._transportSelect.appendChild(new Option(e,e));this._transportSelect.value=e,this._transportSelect.value||(this._transportSelect.selectedIndex=0)}_updateNewAuthenticatorSectionOptions(){this._protocolSelect&&this._residentKeyCheckbox&&this._userVerificationCheckbox&&(this._protocolSelect.value===Protocol.WebAuthn.AuthenticatorProtocol.Ctap2?(this._residentKeyCheckbox.disabled=!1,this._userVerificationCheckbox.disabled=!1,this._updateEnabledTransportOptions([Protocol.WebAuthn.AuthenticatorTransport.Usb,Protocol.WebAuthn.AuthenticatorTransport.Ble,Protocol.WebAuthn.AuthenticatorTransport.Nfc,Protocol.WebAuthn.AuthenticatorTransport.Internal])):(this._residentKeyCheckbox.checked=!1,this._residentKeyCheckbox.disabled=!0,this._userVerificationCheckbox.checked=!1,this._userVerificationCheckbox.disabled=!0,this._updateEnabledTransportOptions([Protocol.WebAuthn.AuthenticatorTransport.Usb,Protocol.WebAuthn.AuthenticatorTransport.Ble,Protocol.WebAuthn.AuthenticatorTransport.Nfc])))}_createNewAuthenticatorSection(){this._newAuthenticatorSection=this.contentElement.createChild("div","new-authenticator-container");const t=r.createLabel(ls`New authenticator`,"new-authenticator-title");this._newAuthenticatorSection.appendChild(t),this._newAuthenticatorForm=this._newAuthenticatorSection.createChild("div","new-authenticator-form");const e=this._newAuthenticatorForm.createChild("div","authenticator-option"),i=this._newAuthenticatorForm.createChild("div","authenticator-option"),a=this._newAuthenticatorForm.createChild("div","authenticator-option"),o=this._newAuthenticatorForm.createChild("div","authenticator-option"),n=this._newAuthenticatorForm.createChild("div","authenticator-option"),s=r.createLabel(ls`Protocol`,"authenticator-option-label");e.appendChild(s),this._protocolSelect=e.createChild("select","chrome-select"),l.bindLabelToControl(s,this._protocolSelect),Object.values(Protocol.WebAuthn.AuthenticatorProtocol).sort().forEach(t=>{this._protocolSelect&&this._protocolSelect.appendChild(new Option(t,t))}),this._protocolSelect&&(this._protocolSelect.value=Protocol.WebAuthn.AuthenticatorProtocol.Ctap2);const c=r.createLabel(ls`Transport`,"authenticator-option-label");i.appendChild(c),this._transportSelect=i.createChild("select","chrome-select"),l.bindLabelToControl(c,this._transportSelect),this._residentKeyCheckboxLabel=r.CheckboxLabel.create(ls`Supports resident keys`,!1),this._residentKeyCheckboxLabel.textElement.classList.add("authenticator-option-label"),a.appendChild(this._residentKeyCheckboxLabel.textElement),this._residentKeyCheckbox=this._residentKeyCheckboxLabel.checkboxElement,this._residentKeyCheckbox.checked=!1,this._residentKeyCheckbox.classList.add("authenticator-option-checkbox"),a.appendChild(this._residentKeyCheckboxLabel),this._userVerificationCheckboxLabel=r.CheckboxLabel.create("Supports user verification",!1),this._userVerificationCheckboxLabel.textElement.classList.add("authenticator-option-label"),o.appendChild(this._userVerificationCheckboxLabel.textElement),this._userVerificationCheckbox=this._userVerificationCheckboxLabel.checkboxElement,this._userVerificationCheckbox.checked=!1,this._userVerificationCheckbox.classList.add("authenticator-option-checkbox"),o.appendChild(this._userVerificationCheckboxLabel),this._addAuthenticatorButton=r.createTextButton(ls`Add`,this._handleAddAuthenticatorButton.bind(this),""),n.createChild("div","authenticator-option-label"),n.appendChild(this._addAuthenticatorButton);const h=r.createLabel(ls`Add authenticator`,"");l.bindLabelToControl(h,this._addAuthenticatorButton),this._updateNewAuthenticatorSectionOptions(),this._protocolSelect&&this._protocolSelect.addEventListener("change",this._updateNewAuthenticatorSectionOptions.bind(this))}async _handleAddAuthenticatorButton(){const t=this._createOptionsFromCurrentInputs();if(this._model){const e=await this._model.addAuthenticator(t),i=this._availableAuthenticatorSetting.get();i.push({authenticatorId:e,...t}),this._availableAuthenticatorSetting.set(i.map(t=>({...t,active:t.authenticatorId===e}))),this._addAuthenticatorSection(e,t)}}async _addAuthenticatorSection(t,e){const i=document.createElement("div");i.classList.add("authenticator-section"),i.setAttribute("data-authenticator-id",t),this._authenticatorsView.insertAdjacentElement("afterbegin",i);const a=i.createChild("div","authenticator-section-header"),o=a.createChild("div","authenticator-section-title");l.markAsHeading(o,2),await this._clearActiveAuthenticator();const n=a.createChild("div","active-button-container"),s=r.createRadioLabel("active-authenticator-"+t,ls`Active`);s.radioElement.addEventListener("click",this._setActiveAuthenticator.bind(this,t)),n.appendChild(s),s.radioElement.checked=!0,this._activeAuthId=t;const h=a.createChild("button","text-button");h.textContent=ls`Remove`,h.addEventListener("click",this._removeAuthenticator.bind(this,t));const d=new c.Toolbar("edit-name-toolbar",o),u=new c.ToolbarButton(ls`Edit name`,"largeicon-edit"),p=new c.ToolbarButton(ls`Save name`,"largeicon-checkmark");p.setVisible(!1);const _=o.createChild("input","authenticator-name-field");_.setAttribute("readOnly","true");const b=t.slice(-5);_.value=ls`Authenticator ${b}`,this._updateActiveLabelTitle(s,_.value),u.addEventListener(c.ToolbarButton.Events.Click,()=>this._handleEditNameButton(o,_,u,p)),p.addEventListener(c.ToolbarButton.Events.Click,()=>this._handleSaveNameButton(o,_,u,p,s)),_.addEventListener("focusout",()=>this._handleSaveNameButton(o,_,u,p,s)),_.addEventListener("keydown",t=>{"Enter"===t.key&&this._handleSaveNameButton(o,_,u,p,s)}),d.appendToolbarItem(u),d.appendToolbarItem(p),this._createAuthenticatorFields(i,t,e);const C=document.createElementWithClass("div","credentials-title");C.textContent=ls`Credentials`,i.appendChild(C);this._createCredentialsDataGrid(t).asWidget().show(i),this._updateCredentials(t)}_exportCredential(t){let e="-----BEGIN PRIVATE KEY-----\n";for(let i=0;i<t.privateKey.length;i+=64)e+=t.privateKey.substring(i,i+64)+"\n";e+="-----END PRIVATE KEY-----";const i=document.createElement("a");i.download=ls`Private key.pem`,i.href="data:application/x-pem-file,"+encodeURIComponent(e),i.click()}async _removeCredential(t,e){const i=this._dataGrids.get(t);i&&(i.rootNode().children.find(t=>t.data.credentialId===e).remove(),this._maybeAddEmptyNode(i),this._model&&await this._model.removeCredential(t,e))}_createAuthenticatorFields(t,e,i){const a=t.createChild("div","authenticator-fields"),o=a.createChild("div","authenticator-field"),n=a.createChild("div","authenticator-field"),s=a.createChild("div","authenticator-field"),c=a.createChild("div","authenticator-field"),l=a.createChild("div","authenticator-field");o.appendChild(r.createLabel(ls`UUID`,"authenticator-option-label")),n.appendChild(r.createLabel(ls`Protocol`,"authenticator-option-label")),s.appendChild(r.createLabel(ls`Transport`,"authenticator-option-label")),c.appendChild(r.createLabel(ls`Supports resident keys`,"authenticator-option-label")),l.appendChild(r.createLabel(ls`Supports user verification`,"authenticator-option-label")),o.createChild("div","authenticator-field-value").textContent=e,n.createChild("div","authenticator-field-value").textContent=i.protocol,s.createChild("div","authenticator-field-value").textContent=i.transport,c.createChild("div","authenticator-field-value").textContent=i.hasResidentKey?ls`Yes`:ls`No`,l.createChild("div","authenticator-field-value").textContent=i.hasUserVerification?ls`Yes`:ls`No`}_handleEditNameButton(t,e,i,a){e.removeAttribute("readonly"),t.classList.add("editing-name"),e.focus(),a.setVisible(!0),i.setVisible(!1)}_handleSaveNameButton(t,e,i,a,o){e.setAttribute("readonly",""),t.classList.remove("editing-name"),i.setVisible(!0),a.setVisible(!1),this._updateActiveLabelTitle(o,e.value)}_updateActiveLabelTitle(t,e){t.radioElement.title=ls`Set ${e} as the active authenticator`}_removeAuthenticator(t){if(this._authenticatorsView){const e=this._authenticatorsView.querySelector(`[data-authenticator-id=${CSS.escape(t)}]`);e&&e.remove()}this._dataGrids.delete(t),this._model&&this._model.removeAuthenticator(t);const e=this._availableAuthenticatorSetting.get().filter(e=>e.authenticatorId!==t);if(this._availableAuthenticatorSetting.set(e),this._activeAuthId===t){const t=Array.from(this._dataGrids.keys());t.length?this._setActiveAuthenticator(t[0]):this._activeAuthId=null}}_createOptionsFromCurrentInputs(){if(!(this._protocolSelect&&this._transportSelect&&this._residentKeyCheckbox&&this._userVerificationCheckbox))throw new Error("Unable to create options from current inputs");return{protocol:this._protocolSelect.options[this._protocolSelect.selectedIndex].value,transport:this._transportSelect.options[this._transportSelect.selectedIndex].value,hasResidentKey:this._residentKeyCheckbox.checked,hasUserVerification:this._userVerificationCheckbox.checked,automaticPresenceSimulation:!0,isUserVerified:!0}}async _setActiveAuthenticator(t){await this._clearActiveAuthenticator(),this._model&&await this._model.setAutomaticPresenceSimulation(t,!0),this._activeAuthId=t;const e=this._availableAuthenticatorSetting.get().map(e=>({...e,active:e.authenticatorId===t}));this._availableAuthenticatorSetting.set(e),this._updateActiveButtons()}_updateActiveButtons(){const t=this._authenticatorsView.getElementsByClassName("authenticator-section");Array.from(t).forEach(t=>{const e=t.querySelector("input.dt-radio-button");e&&(e.checked=t.dataset.authenticatorId===this._activeAuthId)})}async _clearActiveAuthenticator(){this._activeAuthId&&this._model&&await this._model.setAutomaticPresenceSimulation(this._activeAuthId,!1),this._activeAuthId=null,this._updateActiveButtons()}}var _=Object.freeze({__proto__:null,WebauthnPaneImpl:p});export{_ as WebauthnPane};
