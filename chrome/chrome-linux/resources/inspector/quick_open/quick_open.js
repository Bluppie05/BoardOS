import{UIString as e,Settings as t}from"../common/common.js";import{Diff as i}from"../diff/diff.js";import{userMetrics as s,UserMetrics as r,InspectorFrontendHost as o}from"../host/host.js";import{Runtime as n}from"../root/root.js";import{Widget as a,ARIAUtils as l,TextPrompt as h,ListModel as c,ListControl as d,UIUtils as m,Dialog as _,Geometry as p,GlassPane as u,InspectorView as g,ShortcutRegistry as f,ViewManager as v,View as C,ActionRegistry as w}from"../ui/ui.js";import{StringUtilities as y,NumberUtilities as x}from"../platform/platform.js";import{TextRange as E}from"../text_utils/text_utils.js";class b extends a.VBox{constructor(e,t,i){super(!0),this._promptHistory=t||[],this._scoringTimer=0,this._filterTimer=0,this._loadTimeout=0,this._refreshListWithCurrentResult,this._dialog,this._query,this.contentElement.classList.add("filtered-list-widget");const s=this._onKeyDown.bind(this);this.contentElement.addEventListener("keydown",s,!0),l.markAsCombobox(this.contentElement),this.registerRequiredCSS("quick_open/filteredListWidget.css",{enableLegacyPatching:!0}),this._promptElement=this.contentElement.createChild("div","filtered-list-widget-input"),l.setAccessibleName(this._promptElement,ls`Quick open prompt`),this._promptElement.setAttribute("spellcheck","false"),this._promptElement.setAttribute("contenteditable","plaintext-only"),this._prompt=new h.TextPrompt,this._prompt.initialize(()=>Promise.resolve([]));const r=this._prompt.attach(this._promptElement);r.addEventListener("input",this._onInput.bind(this),!1),r.classList.add("filtered-list-widget-prompt-element"),this._bottomElementsContainer=this.contentElement.createChild("div","vbox"),this._progressElement=this._bottomElementsContainer.createChild("div","filtered-list-widget-progress"),this._progressBarElement=this._progressElement.createChild("div","filtered-list-widget-progress-bar"),this._items=new c.ListModel,this._list=new d.ListControl(this._items,this,d.ListMode.EqualHeightItems),this._itemElementsContainer=this._list.element,this._itemElementsContainer.classList.add("container"),this._bottomElementsContainer.appendChild(this._itemElementsContainer),this._itemElementsContainer.addEventListener("click",this._onClick.bind(this),!1),l.markAsListBox(this._itemElementsContainer),l.setControls(this._promptElement,this._itemElementsContainer),l.setAutocomplete(this._promptElement,l.AutocompleteInteractionModel.list),this._notFoundElement=this._bottomElementsContainer.createChild("div","not-found-text"),this._notFoundElement.classList.add("hidden"),this.setDefaultFocusedElement(this._promptElement),this._prefix="",this._provider=e,this._queryChangedCallback=i}static highlightRanges(e,t,s){if(!t)return!1;function r(e,t){const s=i.DiffWrapper.charDiff(t,e);let r=0;const o=[];for(let e=0;e<s.length;++e){const t=s[e];if(t[0]===i.Operation.Equal)o.push(new E.SourceRange(r,t[1].length));else if(t[0]!==i.Operation.Insert)return null;r+=t[1].length}return o}if(null===e.textContent)return!1;const o=e.textContent;let n=r(o,t);return n&&!s||(n=r(o.toUpperCase(),t.toUpperCase())),!!n&&(m.highlightRangesWithStyleClass(e,n,"highlight"),!0)}setPlaceholder(e,t){this._prompt.setPlaceholder(e,t)}setPromptTitle(e){l.setAccessibleName(this._promptElement,e)}showAsDialog(e=ls`Quick open`){this._dialog=new _.Dialog,l.setAccessibleName(this._dialog.contentElement,e),this._dialog.setMaxContentSize(new p.Size(504,340)),this._dialog.setSizeBehavior(u.SizeBehavior.SetExactWidthMaxHeight),this._dialog.setContentPosition(null,22),this.show(this._dialog.contentElement),l.setExpanded(this.contentElement,!0),this._dialog.once("hidden").then(()=>{this.dispatchEventToListeners("hidden")}),this._dialog.show()}setPrefix(e){this._prefix=e}setProvider(e){e!==this._provider&&(this._provider&&this._provider.detach(),this._clearTimers(),this._provider=e,this.isShowing()&&this._attachProvider())}setQuerySelectedRange(e,t){this._prompt.setSelectedRange(e,t)}_attachProvider(){this._items.replaceAll([]),this._list.invalidateItemHeight(),this._provider&&(this._provider.setRefreshCallback(this._itemsLoaded.bind(this,this._provider)),this._provider.attach()),this._itemsLoaded(this._provider)}_value(){return this._prompt.text().trim()}_cleanValue(){return this._value().substring(this._prefix.length)}wasShown(){this._attachProvider()}willHide(){this._provider&&this._provider.detach(),this._clearTimers(),l.setExpanded(this.contentElement,!1)}_clearTimers(){clearTimeout(this._filterTimer),clearTimeout(this._scoringTimer),clearTimeout(this._loadTimeout),this._filterTimer=0,this._scoringTimer=0,this._loadTimeout=0,this._refreshListWithCurrentResult=void 0}_onEnter(e){if(!this._provider)return;const t=this._provider.itemCount()?this._list.selectedItem():null;this._selectItem(t),this._dialog&&this._dialog.hide()}_itemsLoaded(e){this._loadTimeout||e!==this._provider||(this._loadTimeout=setTimeout(this._updateAfterItemsLoaded.bind(this),0))}_updateAfterItemsLoaded(){this._loadTimeout=0,this._filterItems()}createElementForItem(e){const t=document.createElement("div"),i=this._provider&&this._provider.renderAsTwoRows();t.className="filtered-list-widget-item "+(i?"two-rows":"one-row");const s=t.createChild("div","filtered-list-widget-title"),r=t.createChild("div","filtered-list-widget-subtitle");return r.textContent="​",this._provider&&this._provider.renderItem(e,this._cleanValue(),s,r),l.markAsOption(t),t}heightForItem(e){return 0}isItemSelectable(e){return!0}selectedItemChanged(e,t,i,s){i&&i.classList.remove("selected"),s&&s.classList.add("selected"),l.setActiveDescendant(this._promptElement,s)}_onClick(e){const t=this._list.itemForNode(e.target);null!==t&&(e.consume(!0),this._selectItem(t),this._dialog&&this._dialog.hide())}setQuery(e){this._prompt.focus(),this._prompt.setText(e),this._queryChanged(),this._prompt.autoCompleteSoon(!0),this._scheduleFilter()}_tabKeyPressed(){const e=this._prompt.text();let t;for(let i=this._promptHistory.length-1;i>=0;i--)if(this._promptHistory[i]!==e&&this._promptHistory[i].startsWith(e)){t=this._promptHistory[i];break}return!!t&&(this._prompt.focus(),this._prompt.setText(t),this._prompt.setDOMSelection(e.length,t.length),this._scheduleFilter(),!0)}_itemsFilteredForTest(){}_filterItems(){if(this._filterTimer=0,this._scoringTimer&&(clearTimeout(this._scoringTimer),this._scoringTimer=0,this._refreshListWithCurrentResult&&this._refreshListWithCurrentResult()),!this._provider)return this._bottomElementsContainer.classList.toggle("hidden",!0),void this._itemsFilteredForTest();this._bottomElementsContainer.classList.toggle("hidden",!1),this._progressBarElement.style.transform="scaleX(0)",this._progressBarElement.classList.remove("filtered-widget-progress-fade","hidden");const e=this._provider.rewriteQuery(this._cleanValue());this._query=e;const t=e?y.filterRegex(e):null,i=[],s=[],r=[];let o=0;const n=[],a=window.performance.now(),l=x.clamp(10,500,this._provider.itemCount()/10|0);function h(e,t){return t-e}(function c(d){if(!this._provider)return;this._scoringTimer=0;let m,_=0;for(m=d;m<this._provider.itemCount()&&_<l;++m){if(t&&!t.test(this._provider.itemKeyAt(m)))continue;const a=this._provider.itemScoreAt(m,e);if(e&&_++,a>o||s.length<100){const e=s.upperBound(a,h);if(s.splice(e,0,a),r.splice(e,0,m),s.length>100){const e=r.peekLast();e&&n.push(e),s.length=100,r.length=100}const t=s.peekLast();t&&(o=t)}else i.push(m)}if(this._refreshListWithCurrentResult=this._refreshList.bind(this,r,n,i),m<this._provider.itemCount())return this._scoringTimer=setTimeout(c.bind(this,m),0),void(window.performance.now()-a>50&&(this._progressBarElement.style.transform="scaleX("+m/this._provider.itemCount()+")"));window.performance.now()-a>100?(this._progressBarElement.style.transform="scaleX(1)",this._progressBarElement.classList.add("filtered-widget-progress-fade")):this._progressBarElement.classList.add("hidden");this._refreshListWithCurrentResult()}).call(this,0)}_refreshList(e,t,i){this._refreshListWithCurrentResult=void 0,i=[...e,...t,...i],this._updateNotFoundMessage(!!i.length);const s=this._list.element.offsetHeight;this._items.replaceAll(i),i.length&&this._list.selectItem(i[0]),this._list.element.offsetHeight!==s&&this._list.viewportResized(),this._itemsFilteredForTest()}_updateNotFoundMessage(e){this._list.element.classList.toggle("hidden",!e),this._notFoundElement.classList.toggle("hidden",e),!e&&this._provider&&(this._notFoundElement.textContent=this._provider.notFoundText(this._cleanValue()),l.alert(this._notFoundElement.textContent,this._notFoundElement))}_onInput(){this._queryChanged(),this._scheduleFilter()}_queryChanged(){this._queryChangedCallback&&this._queryChangedCallback(this._value()),this._provider&&this._provider.queryChanged(this._cleanValue())}updateSelectedItemARIA(e,t){return!1}_onKeyDown(e){let t=!1;switch(e.key){case"Enter":return void this._onEnter(e);case"Tab":t=this._tabKeyPressed();break;case"ArrowUp":t=this._list.selectPreviousItem(!0,!1);break;case"ArrowDown":t=this._list.selectNextItem(!0,!1);break;case"PageUp":t=this._list.selectItemPreviousPage(!1);break;case"PageDown":t=this._list.selectItemNextPage(!1)}t&&e.consume(!0)}_scheduleFilter(){this._filterTimer||(this._filterTimer=setTimeout(this._filterItems.bind(this),0))}_selectItem(e){this._promptHistory.push(this._value()),this._promptHistory.length>100&&this._promptHistory.shift(),this._provider&&this._provider.selectItem(e,this._cleanValue())}}class T{constructor(){this._refreshCallback}setRefreshCallback(e){this._refreshCallback=e}attach(){}itemCount(){return 0}itemKeyAt(e){return""}itemScoreAt(e,t){return 1}renderItem(e,t,i,s){}renderAsTwoRows(){return!1}selectItem(e,t){}refresh(){this._refreshCallback&&this._refreshCallback()}rewriteQuery(e){return e}queryChanged(e){}notFoundText(t){return e.UIString("No results found")}detach(){}}var A=Object.freeze({__proto__:null,FilteredListWidget:b,Provider:T});const k=[];class L{constructor(){this._prefix=null,this._query="",this._providers=new Map,this._prefixes=[],this._filteredListWidget=null,n.Runtime.instance().extensions(T).forEach(this._addProvider.bind(this)),this._prefixes.sort((e,t)=>t.length-e.length)}static show(e){const t=new this,i=new b(null,k,t._queryChanged.bind(t));t._filteredListWidget=i,i.setPlaceholder(ls`Type '?' to see available commands`,ls`Type question mark to see available commands`),i.showAsDialog(),i.setQuery(e)}_addProvider(e){const t=e.descriptor().prefix;null!==t&&(this._prefixes.push(t),this._providers.set(t,e.instance.bind(e)))}_queryChanged(e){const t=this._prefixes.find(t=>e.startsWith(t));if("string"!=typeof t||this._prefix===t)return;if(this._prefix=t,!this._filteredListWidget)return;this._filteredListWidget.setPrefix(t),this._filteredListWidget.setProvider(null);const i=this._providers.get(t);i&&i().then(e=>{this._prefix===t&&this._filteredListWidget&&(this._filteredListWidget.setProvider(e),this._providerLoadedForTest(e))})}_providerLoadedForTest(e){}}var I=Object.freeze({__proto__:null,history:k,QuickOpenImpl:L,ShowActionDelegate:class{handleAction(e,t){switch(t){case"quickOpen.show":return L.show(""),!0}return!1}}});let P;class R{constructor(){this._commands=[],this._loadCommands()}static instance(){return P||(P=new R),P}static createCommand(e){const{category:t,keys:i,title:r,shortcut:o,executeHandler:n,availableHandler:a,userActionCode:l}=e,h=i.split(",");let c="";h.forEach(e=>{c+=ls(e.trim())+"\0"});let d=n;if(l){const e=l;d=()=>{s.actionTaken(e),n()}}return new S(t,r,c,o,d,a)}static createSettingCommand(e,i,s){const r=e.descriptor().category||"",o=e.descriptor().tags||"",n=!!e.descriptor().reloadRequired,a=t.Settings.instance().moduleSetting(e.descriptor().settingName);return R.createCommand({category:ls(r),keys:o,title:i,shortcut:"",executeHandler:()=>{a.set(s),n&&g.InspectorView.instance().displayReloadRequiredWarning(ls`One or more settings have changed which requires a reload to take effect.`)},availableHandler:function(){return a.get()!==s},userActionCode:void 0})}static createActionCommand(e){const{action:t,userActionCode:i}=e,s=f.ShortcutRegistry.instance().shortcutTitleForAction(t.id())||"";return R.createCommand({category:t.category(),keys:t.tags(),title:t.title(),shortcut:s,executeHandler:t.execute.bind(t),userActionCode:i,availableHandler:void 0})}static createRevealViewCommand(t){const{title:i,tags:s,category:r,userActionCode:o,id:n}=t;return R.createCommand({category:r,keys:s||"",title:e.UIString("Show %s",i),shortcut:"",executeHandler:v.ViewManager.instance().showView.bind(v.ViewManager.instance(),n,!0),userActionCode:o,availableHandler:void 0})}_loadCommands(){const e=new Map;n.Runtime.instance().extensions(C.ViewLocationResolver).forEach(t=>{const i=t.descriptor().category,s=t.descriptor().name;i&&s&&e.set(s,i)});const t=n.Runtime.instance().extensions("view");for(const i of t){const t=e.get(i.descriptor().location);if(!t)continue;const s=i.descriptor(),r={id:s.id,title:s.title,tags:s.tags,category:ls(t),userActionCode:void 0};this._commands.push(R.createRevealViewCommand(r))}const i=n.Runtime.instance().extensions("setting");for(const e of i){const t=e.descriptor().options;if(t&&e.descriptor().category)for(const i of t)this._commands.push(R.createSettingCommand(e,ls(i.title),i.value))}this._loadCommandsFromPreRegisteredExtensions(e)}_loadCommandsFromPreRegisteredExtensions(e){const t=v.getRegisteredViewExtensions();for(const i of t){const t=e.get(i.location());if(!t)continue;const s={title:i.title(),tags:i.tags(),category:ls(t),userActionCode:void 0,id:i.viewId()};this._commands.push(R.createRevealViewCommand(s))}}commands(){return this._commands}}const F=["#F44336","#E91E63","#9C27B0","#673AB7","#3F51B5","#03A9F4","#00BCD4","#009688","#4CAF50","#8BC34A","#CDDC39","#FFC107","#FF9800","#FF5722","#795548","#9E9E9E","#607D8B"];class S{constructor(e,t,i,s,r,o){this._category=e,this._title=t,this._key=e+"\0"+t+"\0"+i,this._shortcut=s,this._executeHandler=r,this._availableHandler=o}category(){return this._category}title(){return this._title}key(){return this._key}shortcut(){return this._shortcut}available(){return!this._availableHandler||this._availableHandler()}execute(){this._executeHandler()}}var D=Object.freeze({__proto__:null,CommandMenu:R,ActionCommandOptions:void 0,RevealViewCommandOptions:void 0,CreateCommandOptions:void 0,CommandMenuProvider:class extends T{constructor(){super(),this._commands=[]}attach(){const e=R.instance().commands(),t=w.ActionRegistry.instance().availableActions();for(const e of t){if(!e.category())continue;const t={action:e,userActionCode:void 0};this._commands.push(R.createActionCommand(t))}for(const t of e)t.available()&&this._commands.push(t);this._commands=this._commands.sort((function(e,t){const i=e.category().compareTo(t.category());return i||e.title().compareTo(t.title())}))}detach(){this._commands=[]}itemCount(){return this._commands.length}itemKeyAt(e){return this._commands[e].key()}itemScoreAt(e,t){const s=this._commands[e];let r=i.DiffWrapper.characterScore(t.toLowerCase(),s.title().toLowerCase());return s.category().startsWith("Panel")?r+=2:s.category().startsWith("Drawer")&&(r+=1),r}renderItem(e,t,i,s){const r=this._commands[e];i.removeChildren();const o=i.createChild("span","tag"),n=String.hashCode(r.category())%F.length;o.style.backgroundColor=F[n],o.textContent=r.category(),m.createTextChild(i,r.title()),b.highlightRanges(i,t,!0),s.textContent=r.shortcut()}selectItem(e,t){null!==e&&(this._commands[e].execute(),s.actionTaken(r.Action.SelectCommandFromCommandMenu))}notFoundText(){return ls`No commands found`}},MaterialPaletteColors:F,Command:S,ShowActionDelegate:class{handleAction(e,t){return o.InspectorFrontendHostInstance.bringToFront(),L.show(">"),!0}}});var H=Object.freeze({__proto__:null,HelpQuickOpen:class extends T{constructor(){super(),this._providers=[],n.Runtime.instance().extensions(T).forEach(this._addProvider.bind(this))}_addProvider(e){e.title()&&this._providers.push({prefix:e.descriptor().prefix||"",title:e.title()})}itemCount(){return this._providers.length}itemKeyAt(e){return this._providers[e].prefix}itemScoreAt(e,t){return-this._providers[e].prefix.length}renderItem(e,t,i,s){const r=this._providers[e];i.createChild("span","monospace").textContent=(r.prefix||"…")+" ",m.createTextChild(i,r.title)}selectItem(e,t){null!==e&&L.show(this._providers[e].prefix)}renderAsTwoRows(){return!1}}});class O extends T{constructor(e,t){super(),this._options=e,this._resolve=t}notFoundText(){return ls`${this._options.prompt} (Press 'Enter' to confirm or 'Escape' to cancel.)`}selectItem(e,t){this._resolve(t)}}var W=Object.freeze({__proto__:null,QuickInputOptions:void 0,QuickInput:class{constructor(){throw new ReferenceError("Instance type not implemented.")}static show(e){let t=new Promise(e=>{});const i=new Promise(i=>{const s=new O(e,i),r=new b(s);e.placeHolder&&r.setPlaceholder(e.placeHolder),r.setPromptTitle(e.placeHolder||e.prompt),r.showAsDialog(e.prompt),t=r.once("hidden"),r.setQuery(e.value||""),e.valueSelection&&r.setQuerySelectedRange(e.valueSelection[0],e.valueSelection[1])});return Promise.race([i,t]).then(e=>e)}}});class q extends T{constructor(e,t,i=.5,s=.25){super(),this._resolve=t,this._items=e,this._matchOnDescription=i,this._matchOnDetail=s}itemCount(){return this._items.length}itemKeyAt(e){const t=this._items[e];let i=t.label;return this._matchOnDescription&&(i+=" "+t.description),this._matchOnDetail&&(i+=" "+t.detail),i}itemScoreAt(e,t){const s=this._items[e],r=t.toLowerCase();let o=i.DiffWrapper.characterScore(r,s.label.toLowerCase());if(this._matchOnDescription&&s.description){o+=i.DiffWrapper.characterScore(r,s.description.toLowerCase())*this._matchOnDescription}if(this._matchOnDetail&&s.detail){o+=i.DiffWrapper.characterScore(r,s.detail.toLowerCase())*this._matchOnDetail}return o}renderItem(e,t,i,s){const r=this._items[e];i.removeChildren();const o=i.createChild("span");if(m.createTextChild(o,r.label),b.highlightRanges(i,t,!0),r.description){const e=i.createChild("span","quickpick-description");m.createTextChild(e,r.description),this._matchOnDescription&&b.highlightRanges(e,t,!0)}r.detail&&(m.createTextChild(s,r.detail),this._matchOnDetail&&b.highlightRanges(s,t,!0))}renderAsTwoRows(){return this._items.some(e=>!!e.detail)}selectItem(e,t){"number"!=typeof e?this._resolve(void 0):this._resolve(this._items[e])}}var Q=Object.freeze({__proto__:null,QuickPickItem:void 0,QuickPickOptions:void 0,QuickPick:class{constructor(){throw new ReferenceError("Instance type not implemented.")}static show(e,t){let i=new Promise(e=>{});const s=new Promise(s=>{const r=new q(e,s,t.matchOnDescription?.5:0,t.matchOnDetail?.25:0),o=new b(r);o.setPlaceholder(t.placeHolder),o.setPromptTitle(t.placeHolder),o.showAsDialog(t.placeHolder),i=o.once("hidden"),o.setQuery("")});return Promise.race([s,i]).then(e=>e)}}});export{D as CommandMenu,A as FilteredListWidget,H as HelpQuickOpen,W as QuickInput,I as QuickOpen,Q as QuickPick};
