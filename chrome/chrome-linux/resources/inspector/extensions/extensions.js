import{RemoteObject as e,SDKModel as t,NetworkManager as n,NetworkLog as s,ResourceTreeModel as i,HARLog as o,DOMModel as r,RuntimeModel as a}from"../sdk/sdk.js";import{Widget as c,Panel as d,Toolbar as u,SearchableView as l,View as h,UIUtils as p,InspectorView as _,Context as g,ShortcutRegistry as m}from"../ui/ui.js";import{ResourceUtils as b}from"../bindings/bindings.js";import{ObjectWrapper as f,Revealer as R}from"../common/common.js";import{Linkifier as w}from"../components/components.js";import{InspectorFrontendHost as S,InspectorFrontendHostAPI as y}from"../host/host.js";import{StringUtilities as E}from"../platform/platform.js";import{Runtime as x}from"../root/root.js";import{ThemeSupport as I}from"../theme_support/theme_support.js";import{Workspace as v}from"../workspace/workspace.js";function P(e){e.panels||(e.panels={}),e.panels.SearchAction={CancelSearch:"cancelSearch",PerformSearch:"performSearch",NextSearchResult:"nextSearchResult",PreviousSearchResult:"previousSearchResult"},e.Events={ButtonClicked:"button-clicked-",PanelObjectSelected:"panel-objectSelected-",NetworkRequestFinished:"network-request-finished",OpenResource:"open-resource",PanelSearch:"panel-search-",RecordingStarted:"trace-recording-started-",RecordingStopped:"trace-recording-stopped-",ResourceAdded:"resource-added",ResourceContentCommitted:"resource-content-committed",ViewShown:"view-shown-",ViewHidden:"view-hidden-"},e.Commands={AddRequestHeaders:"addRequestHeaders",AddTraceProvider:"addTraceProvider",ApplyStyleSheet:"applyStyleSheet",CompleteTraceSession:"completeTraceSession",CreatePanel:"createPanel",CreateSidebarPane:"createSidebarPane",CreateToolbarButton:"createToolbarButton",EvaluateOnInspectedPage:"evaluateOnInspectedPage",ForwardKeyboardEvent:"_forwardKeyboardEvent",GetHAR:"getHAR",GetPageResources:"getPageResources",GetRequestContent:"getRequestContent",GetResourceContent:"getResourceContent",InspectedURLChanged:"inspectedURLChanged",OpenResource:"openResource",Reload:"Reload",Subscribe:"subscribe",SetOpenResourceHandler:"setOpenResourceHandler",SetResourceContent:"setResourceContent",SetSidebarContent:"setSidebarContent",SetSidebarHeight:"setSidebarHeight",SetSidebarPage:"setSidebarPage",ShowPanel:"showPanel",Unsubscribe:"unsubscribe",UpdateButton:"updateButton",RegisterLanguageExtensionPlugin:"registerLanguageExtensionPlugin"},e.LanguageExtensionPluginCommands={AddRawModule:"addRawModule",RemoveRawModule:"removeRawModule",SourceLocationToRawLocation:"sourceLocationToRawLocation",RawLocationToSourceLocation:"rawLocationToSourceLocation",GetScopeInfo:"getScopeInfo",ListVariablesInScope:"listVariablesInScope",EvaluateVariable:"evaluateVariable",GetTypeInfo:"getTypeInfo",GetFormatter:"getFormatter",GetFunctionInfo:"getFunctionInfo",GetInlinedFunctionRanges:"getInlinedFunctionRanges",GetInlinedCalleesRanges:"getInlinedCalleesRanges"}}self.injectedExtensionAPI=function(e,t,n,s,i,o){const r=new Set(s),a=window.chrome||{};if(Object.getOwnPropertyDescriptor(a,"devtools"))return;const c={};P(c);const d=c.Commands,u=c.LanguageExtensionPluginCommands,l=c.Events;let h=!1;function p(e,t){this._type=e,this._listeners=[],this._customDispatch=t}function _(){this.onRequestFinished=new I(l.NetworkRequestFinished,(function(e){const t=e.arguments[1];t.__proto__=new T(e.arguments[0]),this._fire(t)})),S(this,"network","onFinished","onRequestFinished"),this.onNavigated=new I(l.InspectedURLChanged)}function g(e){this._id=e}function m(){const e={elements:new q,sources:new H};function t(t){return e[t]}for(const n in e)Object.defineProperty(this,n,{get:t.bind(null,n),enumerable:!0});this.applyStyleSheet=function(e){X.sendRequest({command:d.ApplyStyleSheet,styleSheet:e})}}function b(e){this._id=e,e&&(this.onShown=new I(l.ViewShown+e,(function(e){const t=e.arguments[0];"number"==typeof t?this._fire(window.parent.frames[t]):this._fire()})),this.onHidden=new I(l.ViewHidden+e))}function f(e){b.call(this,null),this._hostPanelName=e,this.onSelectionChanged=new I(l.PanelObjectSelected+e)}function R(){this._plugins=new Map}function w(e){return function(){const t={__proto__:e.prototype};e.apply(t,arguments),z(this,t)}}function S(e,t,n,s){let i=!1;e.__defineGetter__(n,(function(){return i||(console.warn(t+"."+n+" is deprecated. Use "+t+"."+s+" instead"),i=!0),e[s]}))}function y(e){const t=e[e.length-1];return"function"==typeof t?t:void 0}p.prototype={addListener:function(e){if("function"!=typeof e)throw"addListener: callback is not a function";0===this._listeners.length&&X.sendRequest({command:d.Subscribe,type:this._type}),this._listeners.push(e),X.registerHandler("notify-"+this._type,this._dispatch.bind(this))},removeListener:function(e){const t=this._listeners;for(let n=0;n<t.length;++n)if(t[n]===e){t.splice(n,1);break}0===this._listeners.length&&X.sendRequest({command:d.Unsubscribe,type:this._type})},_fire:function(e){const t=this._listeners.slice();for(let e=0;e<t.length;++e)t[e].apply(null,arguments)},_dispatch:function(e){this._customDispatch?this._customDispatch.call(this,e):this._fire.apply(this,e.arguments)}},_.prototype={getHAR:function(e){X.sendRequest({command:d.GetHAR},e&&function(t){const n=t&&t.entries||[];for(let e=0;e<n.length;++e)n[e].__proto__=new T(n[e]._requestId),delete n[e]._requestId;e(t)})},addRequestHeaders:function(e){X.sendRequest({command:d.AddRequestHeaders,headers:e,extensionId:window.location.hostname})}},g.prototype={getContent:function(e){X.sendRequest({command:d.GetRequestContent,id:this._id},e&&function(t){e(t.content,t.encoding)})}},m.prototype={create:function(e,t,n,s){const i="extension-panel-"+X.nextObjectId(),o={command:d.CreatePanel,id:i,title:e,icon:t,page:n};X.sendRequest(o,s&&s.bind(this,new v(i)))},setOpenResourceHandler:function(e){const t=X.hasHandler(l.OpenResource);e?X.registerHandler(l.OpenResource,(function(t){h=!0;try{e.call(null,new L(t.resource),t.lineNumber)}finally{h=!1}})):X.unregisterHandler(l.OpenResource),t===!e&&X.sendRequest({command:d.SetOpenResourceHandler,handlerPresent:!!e})},openResource:function(e,t,n){X.sendRequest({command:d.OpenResource,url:e,lineNumber:t},n)},get SearchAction(){return c.panels.SearchAction}},f.prototype={createSidebarPane:function(e,t){const n="extension-sidebar-"+X.nextObjectId(),s={command:d.CreateSidebarPane,panel:this._hostPanelName,id:n,title:e};X.sendRequest(s,t&&function(){t(new C(n))})},__proto__:b.prototype},R.prototype={registerLanguageExtensionPlugin:function(e,t,n){if(this._plugins.has(e))throw new Error("Tried to register a plugin twice");const s=new MessageChannel,i=s.port1;this._plugins.set(e,i),i.onmessage=({data:{requestId:t,method:n,parameters:s}})=>{(function(t,n){switch(t){case u.AddRawModule:return e.addRawModule(n.rawModuleId,n.symbolsURL,n.rawModule);case u.RemoveRawModule:return e.removeRawModule(n.rawModuleId);case u.SourceLocationToRawLocation:return e.sourceLocationToRawLocation(n.sourceLocation);case u.RawLocationToSourceLocation:return e.rawLocationToSourceLocation(n.rawLocation);case u.GetScopeInfo:return e.getScopeInfo(n.type);case u.ListVariablesInScope:return e.listVariablesInScope(n.rawLocation);case u.EvaluateVariable:return e.evaluateVariable(n.name,n.location);case u.GetTypeInfo:return e.getTypeInfo(n.expression,n.context);case u.GetFormatter:return e.getFormatter(n.expressionOrField,n.context);case u.GetFunctionInfo:return e.getFunctionInfo(n.rawLocation);case u.GetInlinedFunctionRanges:return e.getInlinedFunctionRanges(n.rawLocation);case u.GetInlinedCalleesRanges:return e.getInlinedCalleesRanges(n.rawLocation)}throw new Error("Unknown language plugin method "+t)})(n,s).then(e=>i.postMessage({requestId:t,result:e})).catch(e=>i.postMessage({requestId:t,error:{message:e.message}}))},X.sendRequest({command:d.RegisterLanguageExtensionPlugin,pluginName:t,port:s.port2,supportedScriptTypes:n},void 0,[s.port2])}};const E=w(R),x=w(k),I=w(p),v=w(j),C=w(N),O=w(f),T=w(g),L=w(D),A=w(U);class q extends O{constructor(){super("elements")}}class H extends O{constructor(){super("sources")}}function j(e){b.call(this,e),this.onSearch=new I(l.PanelSearch+e)}function N(e){b.call(this,e)}function k(e){this._id=e,this.onClicked=new I(l.ButtonClicked+e)}function F(){}function U(e){this._id=e}function M(e){this.onRecordingStarted=new I(l.RecordingStarted+e,(function(e){const t=e.arguments[0];this._fire(new A(t))})),this.onRecordingStopped=new I(l.RecordingStopped+e)}function V(){this.onResourceAdded=new I(l.ResourceAdded,(function(e){this._fire(new L(e.arguments[0]))})),this.onResourceContentCommitted=new I(l.ResourceContentCommitted,(function(e){this._fire(new L(e.arguments[0]),e.arguments[1])}))}function D(e){this._url=e.url,this._type=e.type}j.prototype={createStatusBarButton:function(e,t,n){const s="button-"+X.nextObjectId(),i={command:d.CreateToolbarButton,panel:this._id,id:s,icon:e,tooltip:t,disabled:!!n};return X.sendRequest(i),new x(s)},show:function(){if(!h)return;const e={command:d.ShowPanel,id:this._id};X.sendRequest(e)},__proto__:b.prototype},N.prototype={setHeight:function(e){X.sendRequest({command:d.SetSidebarHeight,id:this._id,height:e})},setExpression:function(e,t,n){const s={command:d.SetSidebarContent,id:this._id,expression:e,rootTitle:t,evaluateOnPage:!0};"object"==typeof n&&(s.evaluateOptions=n),X.sendRequest(s,y(arguments))},setObject:function(e,t,n){X.sendRequest({command:d.SetSidebarContent,id:this._id,expression:e,rootTitle:t},n)},setPage:function(e){X.sendRequest({command:d.SetSidebarPage,id:this._id,page:e})},__proto__:b.prototype},k.prototype={update:function(e,t,n){const s={command:d.UpdateButton,id:this._id,icon:e,tooltip:t,disabled:!!n};X.sendRequest(s)}},F.prototype={addTraceProvider:function(e,t){const n="extension-trace-provider-"+X.nextObjectId();return X.sendRequest({command:d.AddTraceProvider,id:n,categoryName:e,categoryTooltip:t}),new M(n)}},U.prototype={complete:function(e,t){const n={command:d.CompleteTraceSession,id:this._id,url:e||"",timeOffset:t||0};X.sendRequest(n)}},V.prototype={reload:function(e){let t=null;"object"==typeof e?t=e:"string"==typeof e&&(t={userAgent:e},console.warn("Passing userAgent as string parameter to inspectedWindow.reload() is deprecated. Use inspectedWindow.reload({ userAgent: value}) instead.")),X.sendRequest({command:d.Reload,options:t})},eval:function(e,t){const n=y(arguments);function s(e){e.isError||e.isException?n(void 0,e):n(e.value)}const i={command:d.EvaluateOnInspectedPage,expression:e};return"object"==typeof t&&(i.evaluateOptions=t),X.sendRequest(i,n&&s),null},getResources:function(e){function t(e){return new L(e)}X.sendRequest({command:d.GetPageResources},e&&function(n){e(n.map(t))})}},D.prototype={get url(){return this._url},get type(){return this._type},getContent:function(e){X.sendRequest({command:d.GetResourceContent,url:this._url},e&&function(t){e(t.content,t.encoding)})},setContent:function(e,t,n){X.sendRequest({command:d.SetResourceContent,url:this._url,content:e,commit:t},n)}};let G=[],K=null;function B(){K=null;const e={command:d.ForwardKeyboardEvent,entries:G};X.sendRequest(e),G=[]}function W(){this._callbacks={},this._handlers={},this._lastRequestId=0,this._lastObjectId=0,this.registerHandler("callback",this._onCallback.bind(this));const e=new MessageChannel;this._port=e.port1,this._port.addEventListener("message",this._onMessage.bind(this),!1),this._port.start(),window.parent.postMessage("registerExtension","*",[e.port2])}function z(e,t){for(const n in t){if("_"===n.charAt(0))continue;let s=null;for(let e=t;e&&!s;e=e.__proto__)s=Object.getOwnPropertyDescriptor(e,n);s&&("function"==typeof s.value?e[n]=s.value.bind(t):"function"==typeof s.get?e.__defineGetter__(n,s.get.bind(t)):Object.defineProperty(e,n,s))}}document.addEventListener("keydown",(function(e){const t=document.activeElement;if(t){if(("INPUT"===t.nodeName||"TEXTAREA"===t.nodeName)&&!(e.ctrlKey||e.altKey||e.metaKey))return}let n=0;e.shiftKey&&(n|=1),e.ctrlKey&&(n|=2),e.altKey&&(n|=4),e.metaKey&&(n|=8);const s=255&e.keyCode|n<<8;if(!r.has(s))return;e.preventDefault();const i={eventType:e.type,ctrlKey:e.ctrlKey,altKey:e.altKey,metaKey:e.metaKey,shiftKey:e.shiftKey,keyIdentifier:e.keyIdentifier,key:e.key,code:e.code,location:e.location,keyCode:e.keyCode};G.push(i),K||(K=setTimeout(B,0))}),!1),W.prototype={sendRequest:function(e,t,n){"function"==typeof t&&(e.requestId=this._registerCallback(t)),this._port.postMessage(e,n)},hasHandler:function(e){return!!this._handlers[e]},registerHandler:function(e,t){this._handlers[e]=t},unregisterHandler:function(e){delete this._handlers[e]},nextObjectId:function(){return o.toString()+"_"+ ++this._lastObjectId},_registerCallback:function(e){const t=++this._lastRequestId;return this._callbacks[t]=e,t},_onCallback:function(e){if(e.requestId in this._callbacks){const t=this._callbacks[e.requestId];delete this._callbacks[e.requestId],t(e.result)}},_onMessage:function(e){const t=e.data,n=this._handlers[t.command];n&&n.call(this,t)}};const X=new W,Y=new function(){this.inspectedWindow=new V,this.panels=new m,this.network=new _,this.timeline=new F,this.languageServices=new E,S(this,"webInspector","resources","network")};if(Object.defineProperty(a,"devtools",{value:{},enumerable:!0}),a.devtools.inspectedWindow={},Object.defineProperty(a.devtools.inspectedWindow,"tabId",{get:function(){return t}}),a.devtools.inspectedWindow.__proto__=Y.inspectedWindow,a.devtools.network=Y.network,a.devtools.panels=Y.panels,a.devtools.panels.themeName=n,a.devtools.languageServices=new E,!1!==e.exposeExperimentalAPIs){a.experimental=a.experimental||{},a.experimental.devtools=a.experimental.devtools||{};const e=Object.getOwnPropertyNames(Y);for(let t=0;t<e.length;++t){const n=Object.getOwnPropertyDescriptor(Y,e[t]);n&&Object.defineProperty(a.experimental.devtools,e[t],n)}a.experimental.devtools.inspectedWindow=a.devtools.inspectedWindow}e.exposeWebInspectorNamespace&&(window.webInspector=Y),i(X,Y)},self.buildExtensionAPIInjectedScript=function(e,t,n,s,i){const o=[e,t||null,n,s].map(e=>JSON.stringify(e)).join(",");return i||(i=()=>{}),"(function(injectedScriptId){ "+P.toString()+";("+self.injectedExtensionAPI.toString()+")("+o+","+i+", injectedScriptId);})"};var C=Object.freeze({__proto__:null,defineCommonExtensionSymbols:P});class O extends c.Widget{constructor(e,t,n,s){super(),this.setHideOnDetach(),this.element.className="vbox flex-auto",this.element.tabIndex=-1,this._server=e,this._id=t,this._iframe=document.createElement("iframe"),this._iframe.addEventListener("load",this._onLoad.bind(this),!1),this._iframe.src=n,this._iframe.className=s,this.setDefaultFocusedElement(this.element),this.element.appendChild(this._iframe)}wasShown(){"number"==typeof this._frameIndex&&this._server.notifyViewShown(this._id,this._frameIndex)}willHide(){"number"==typeof this._frameIndex&&this._server.notifyViewHidden(this._id)}_onLoad(){const e=window.frames;this._frameIndex=Array.prototype.indexOf.call(e,this._iframe.contentWindow),this.isShowing()&&this._server.notifyViewShown(this._id,this._frameIndex)}}class T extends c.VBox{constructor(e,t){super(),this._server=e,this._id=t}wasShown(){this._server.notifyViewShown(this._id)}willHide(){this._server.notifyViewHidden(this._id)}}var L=Object.freeze({__proto__:null,ExtensionView:O,ExtensionNotifierView:T});class A extends d.Panel{constructor(e,t,n,s){super(t),this._server=e,this._id=n,this.setHideOnDetach(),this._panelToolbar=new u.Toolbar("hidden",this.element),this._searchableView=new l.SearchableView(this),this._searchableView.show(this.element);new O(e,this._id,s,"extension").show(this._searchableView.element)}addToolbarItem(e){this._panelToolbar.element.classList.remove("hidden"),this._panelToolbar.appendToolbarItem(e)}searchCanceled(){this._server.notifySearchAction(this._id,Extensions.extensionAPI.panels.SearchAction.CancelSearch),this._searchableView.updateSearchMatchesCount(0)}searchableView(){return this._searchableView}performSearch(e,t,n){const s=e.query;this._server.notifySearchAction(this._id,Extensions.extensionAPI.panels.SearchAction.PerformSearch,s)}jumpToNextSearchResult(){this._server.notifySearchAction(this._id,Extensions.extensionAPI.panels.SearchAction.NextSearchResult)}jumpToPreviousSearchResult(){this._server.notifySearchAction(this._id,Extensions.extensionAPI.panels.SearchAction.PreviousSearchResult)}supportsCaseSensitiveSearch(){return!1}supportsRegexSearch(){return!1}}class q{constructor(e,t,n,s,i){this._id=t,this._toolbarButton=new u.ToolbarButton("",""),this._toolbarButton.addEventListener(u.ToolbarButton.Events.Click,e.notifyButtonClicked.bind(e,this._id)),this.update(n,s,i)}update(e,t,n){"string"==typeof e&&this._toolbarButton.setBackgroundImage(e),"string"==typeof t&&this._toolbarButton.setTitle(t),"boolean"==typeof n&&this._toolbarButton.setEnabled(!n)}toolbarButton(){return this._toolbarButton}}class H extends h.SimpleView{constructor(e,t,n,s){super(n),this.element.classList.add("fill"),this._panelName=t,this._server=e,this._id=s}id(){return this._id}panelName(){return this._panelName}setObject(t,n,s){this._createObjectPropertiesView(),this._setObject(e.RemoteObject.fromLocalObject(t),n,s)}setExpression(e,t,n,s,i){this._createObjectPropertiesView(),this._server.evaluate(e,!0,!1,n,s,this._onEvaluate.bind(this,t,i))}setPage(e){this._objectPropertiesView&&(this._objectPropertiesView.detach(),delete this._objectPropertiesView),this._extensionView&&this._extensionView.detach(!0),this._extensionView=new O(this._server,this._id,e,"extension fill"),this._extensionView.show(this.element),this.element.style.height||this.setHeight("150px")}setHeight(e){this.element.style.height=e}_onEvaluate(e,t,n,s,i){n||!s?t(n.toString()):this._setObject(s,e,t)}_createObjectPropertiesView(){this._objectPropertiesView||(this._extensionView&&(this._extensionView.detach(!0),delete this._extensionView),this._objectPropertiesView=new T(this._server,this._id),this._objectPropertiesView.show(this.element))}_setObject(e,t,n){this._objectPropertiesView?(this._objectPropertiesView.element.removeChildren(),p.Renderer.render(e,{title:t,editable:!1}).then(e=>{e?(e.tree&&e.tree.firstChild()&&e.tree.firstChild().expand(),this._objectPropertiesView.element.appendChild(e.node),n()):n()})):n("operation cancelled")}}var j=Object.freeze({__proto__:null,ExtensionPanel:A,ExtensionButton:q,ExtensionSidebarPane:H});class N{constructor(e,t,n,s){this._extensionOrigin=e,this._id=t,this._categoryName=n,this._categoryTooltip=s}start(e){const t=String(++k);G.instance().startTraceRecording(this._id,t,e)}stop(){G.instance().stopTraceRecording(this._id)}shortDisplayName(){return this._categoryName}longDisplayName(){return this._categoryTooltip}persistentIdentifier(){return`${this._extensionOrigin}/${this._categoryName}`}}let k=0;var F=Object.freeze({__proto__:null,ExtensionTraceProvider:N,TracingSession:class{complete(e,t){}}});class U{constructor(e,t,n){this._commands=Extensions.extensionAPI.LanguageExtensionPluginCommands,this._pluginName=e,this._supportedScriptTypes=t,this._port=n,this._port.onmessage=this._onResponse.bind(this),this._nextRequestId=0,this._pendingRequests=new Map}_sendRequest(e,t){return new Promise((n,s)=>{const i=this._nextRequestId++;this._pendingRequests.set(i,{resolve:n,reject:s}),this._port.postMessage({requestId:i,method:e,parameters:t})})}_onResponse({data:{requestId:e,result:t,error:n}}){if(!this._pendingRequests.has(e))return void console.error("No pending request "+e);const{resolve:s,reject:i}=this._pendingRequests.get(e);this._pendingRequests.delete(e),n?i(new Error(n.message)):s(t)}handleScript(e){const t=e.scriptLanguage();return!!t&&!!e.debugSymbols&&t===this._supportedScriptTypes.language&&this._supportedScriptTypes.symbol_types.includes(e.debugSymbols.type)}addRawModule(e,t,n){return this._sendRequest(this._commands.AddRawModule,{rawModuleId:e,symbolsURL:t,rawModule:n})}removeRawModule(e){return this._sendRequest(this._commands.RemoveRawModule,{rawModuleId:e})}sourceLocationToRawLocation(e){return this._sendRequest(this._commands.SourceLocationToRawLocation,{sourceLocation:e})}rawLocationToSourceLocation(e){return this._sendRequest(this._commands.RawLocationToSourceLocation,{rawLocation:e})}getScopeInfo(e){return this._sendRequest(this._commands.GetScopeInfo,{type:e})}listVariablesInScope(e){return this._sendRequest(this._commands.ListVariablesInScope,{rawLocation:e})}evaluateVariable(e,t){return this._sendRequest(this._commands.EvaluateVariable,{name:e,location:t})}getFunctionInfo(e){return this._sendRequest(this._commands.GetFunctionInfo,{rawLocation:e})}getInlinedFunctionRanges(e){return this._sendRequest(this._commands.GetInlinedFunctionRanges,{rawLocation:e})}getInlinedCalleesRanges(e){return this._sendRequest(this._commands.GetInlinedCalleesRanges,{rawLocation:e})}getTypeInfo(e,t){return this._sendRequest(this._commands.GetTypeInfo,{expression:e,context:t})}getFormatter(e,t){return this._sendRequest(this._commands.GetFormatter,{expressionOrField:e,context:t})}dispose(){}}const M=Symbol("extensionOrigin"),V=["chrome://newtab","chrome://new-tab-page"].map(e=>new URL(e).origin);let D;class G extends f.ObjectWrapper{constructor(){super(),this._clientObjects={},this._handlers={},this._subscribers=new Map,this._subscriptionStartHandlers={},this._subscriptionStopHandlers={},this._extraHeaders=new Map,this._requests={},this._lastRequestId=0,this._registeredExtensions=new Map,this._status=new W,this._sidebarPanes=[],this._traceProviders=[],this._traceSessions=new Map,this._extensionsEnabled=!0;const e=Extensions.extensionAPI.Commands;this._registerHandler(e.AddRequestHeaders,this._onAddRequestHeaders.bind(this)),this._registerHandler(e.AddTraceProvider,this._onAddTraceProvider.bind(this)),this._registerHandler(e.ApplyStyleSheet,this._onApplyStyleSheet.bind(this)),this._registerHandler(e.CompleteTraceSession,this._onCompleteTraceSession.bind(this)),this._registerHandler(e.CreatePanel,this._onCreatePanel.bind(this)),this._registerHandler(e.CreateSidebarPane,this._onCreateSidebarPane.bind(this)),this._registerHandler(e.CreateToolbarButton,this._onCreateToolbarButton.bind(this)),this._registerHandler(e.EvaluateOnInspectedPage,this._onEvaluateOnInspectedPage.bind(this)),this._registerHandler(e.ForwardKeyboardEvent,this._onForwardKeyboardEvent.bind(this)),this._registerHandler(e.GetHAR,this._onGetHAR.bind(this)),this._registerHandler(e.GetPageResources,this._onGetPageResources.bind(this)),this._registerHandler(e.GetRequestContent,this._onGetRequestContent.bind(this)),this._registerHandler(e.GetResourceContent,this._onGetResourceContent.bind(this)),this._registerHandler(e.Reload,this._onReload.bind(this)),this._registerHandler(e.SetOpenResourceHandler,this._onSetOpenResourceHandler.bind(this)),this._registerHandler(e.SetResourceContent,this._onSetResourceContent.bind(this)),this._registerHandler(e.SetSidebarHeight,this._onSetSidebarHeight.bind(this)),this._registerHandler(e.SetSidebarContent,this._onSetSidebarContent.bind(this)),this._registerHandler(e.SetSidebarPage,this._onSetSidebarPage.bind(this)),this._registerHandler(e.ShowPanel,this._onShowPanel.bind(this)),this._registerHandler(e.Subscribe,this._onSubscribe.bind(this)),this._registerHandler(e.OpenResource,this._onOpenResource.bind(this)),this._registerHandler(e.Unsubscribe,this._onUnsubscribe.bind(this)),this._registerHandler(e.UpdateButton,this._onUpdateButton.bind(this)),this._registerHandler(e.RegisterLanguageExtensionPlugin,this._registerLanguageExtensionEndpoint.bind(this)),window.addEventListener("message",this._onWindowMessage.bind(this),!1);const t=window.DevToolsAPI&&window.DevToolsAPI.getInspectedTabId&&window.DevToolsAPI.getInspectedTabId();t&&this._setInspectedTabId({data:t}),S.InspectorFrontendHostInstance.events.addEventListener(y.Events.SetInspectedTabId,this._setInspectedTabId,this),this._languageExtensionRequests=new Map,this._languageExtensionEndpoints=[],this._initExtensions()}static instance(e={forceNew:null}){const{forceNew:t}=e;return D&&!t||(D=new G),D}initializeExtensions(){S.InspectorFrontendHostInstance.setAddExtensionCallback(this._addExtension.bind(this))}hasExtensions(){return!!this._registeredExtensions.size}notifySearchAction(e,t,n){this._postNotification(Extensions.extensionAPI.Events.PanelSearch+e,t,n)}notifyViewShown(e,t){this._postNotification(Extensions.extensionAPI.Events.ViewShown+e,t)}notifyViewHidden(e){this._postNotification(Extensions.extensionAPI.Events.ViewHidden+e)}notifyButtonClicked(e){this._postNotification(Extensions.extensionAPI.Events.ButtonClicked+e)}_registerLanguageExtensionEndpoint(e,t){if(!x.experiments.isEnabled("wasmDWARFDebugging"))return this._status.E_FAILED("WebAssembly DWARF support needs to be enabled to use this extension");const{pluginName:n,port:s,supportedScriptTypes:{language:i,symbol_types:o}}=e,r=Array.isArray(o)&&o.every(e=>"string"==typeof e)?o:[],a=new U(n,{language:i,symbol_types:r},s);this._languageExtensionEndpoints.push(a),this.dispatchEventToListeners(K.LanguageExtensionEndpointAdded,a)}get languageExtensionEndpoints(){return this._languageExtensionEndpoints}_inspectedURLChanged(e){if(!this._canInspectURL(e.data.inspectedURL()))return void this._disableExtensions();if(e.data!==t.TargetManager.instance().mainTarget())return;this._requests={};const n=e.data.inspectedURL();this._postNotification(Extensions.extensionAPI.Events.InspectedURLChanged,n)}startTraceRecording(e,t,n){this._traceSessions.set(t,n),this._postNotification("trace-recording-started-"+e,t)}stopTraceRecording(e){this._postNotification("trace-recording-stopped-"+e)}hasSubscribers(e){return this._subscribers.has(e)}_postNotification(e,t){if(!this._extensionsEnabled)return;const n=this._subscribers.get(e);if(!n)return;const s={command:"notify-"+e,arguments:Array.prototype.slice.call(arguments,1)};for(const e of n)e.postMessage(s)}_onSubscribe(e,t){const n=this._subscribers.get(e.type);n?n.add(t):(this._subscribers.set(e.type,new Set([t])),this._subscriptionStartHandlers[e.type]&&this._subscriptionStartHandlers[e.type]())}_onUnsubscribe(e,t){const n=this._subscribers.get(e.type);n&&(n.delete(t),n.size||(this._subscribers.delete(e.type),this._subscriptionStopHandlers[e.type]&&this._subscriptionStopHandlers[e.type]()))}_onAddRequestHeaders(e){const t=e.extensionId;if("string"!=typeof t)return this._status.E_BADARGTYPE("extensionId",typeof t,"string");let s=this._extraHeaders.get(t);s||(s=new Map,this._extraHeaders.set(t,s));for(const t in e.headers)s.set(t,e.headers[t]);const i={};for(const e of this._extraHeaders.values())for(const t of e.keys())"__proto__"!==t&&"string"==typeof e.get(t)&&(i[t]=e.get(t));n.MultitargetNetworkManager.instance().setExtraHTTPHeaders(i)}_onApplyStyleSheet(e){if(!x.experiments.isEnabled("applyCustomStylesheet"))return;const t=createElement("style");t.textContent=e.styleSheet,document.head.appendChild(t),I.instance().addCustomStylesheet(e.styleSheet);for(let e=document.body;e;e=e.traverseNextNode(document.body))e instanceof ShadowRoot&&I.instance().injectCustomStyleSheets(e)}_onCreatePanel(e,t){const n=e.id;if(n in this._clientObjects||_.InspectorView.instance().hasPanel(n))return this._status.E_EXISTS(n);const s=this._expandResourcePath(t[M],e.page);let i=t[M]+e.title;i=i.replace(/\s/g,"");const o=new B(i,e.title,new A(this,i,n,s));return this._clientObjects[n]=o,_.InspectorView.instance().addPanel(o),this._status.OK()}_onShowPanel(e){let t=e.id;const n=this._clientObjects[e.id];n&&n instanceof B&&(t=n.viewId()),_.InspectorView.instance().showPanel(t)}_onCreateToolbarButton(e,t){const n=this._clientObjects[e.panel];if(!(n&&n instanceof B))return this._status.E_NOTFOUND(e.panel);const s=new q(this,e.id,this._expandResourcePath(t[M],e.icon),e.tooltip,e.disabled);return this._clientObjects[e.id]=s,n.widget().then((function(e){e.addToolbarItem(s.toolbarButton())})),this._status.OK()}_onUpdateButton(e,t){const n=this._clientObjects[e.id];return n&&n instanceof q?(n.update(this._expandResourcePath(t[M],e.icon),e.tooltip,e.disabled),this._status.OK()):this._status.E_NOTFOUND(e.id)}_onCompleteTraceSession(e){const t=this._traceSessions.get(e.id);if(!t)return this._status.E_NOTFOUND(e.id);this._traceSessions.delete(e.id),t.complete(e.url,e.timeOffset)}_onCreateSidebarPane(e){if("elements"!==e.panel&&"sources"!==e.panel)return this._status.E_NOTFOUND(e.panel);const t=e.id,n=new H(this,e.panel,e.title,t);return this._sidebarPanes.push(n),this._clientObjects[t]=n,this.dispatchEventToListeners(K.SidebarPaneAdded,n),this._status.OK()}sidebarPanes(){return this._sidebarPanes}_onSetSidebarHeight(e){const t=this._clientObjects[e.id];return t?(t.setHeight(e.height),this._status.OK()):this._status.E_NOTFOUND(e.id)}_onSetSidebarContent(e,t){const n=this._clientObjects[e.id];if(!n)return this._status.E_NOTFOUND(e.id);function s(n){const s=n?this._status.E_FAILED(n):this._status.OK();this._dispatchCallback(e.requestId,t,s)}if(e.evaluateOnPage)return n.setExpression(e.expression,e.rootTitle,e.evaluateOptions,t[M],s.bind(this));n.setObject(e.expression,e.rootTitle,s.bind(this))}_onSetSidebarPage(e,t){const n=this._clientObjects[e.id];if(!n)return this._status.E_NOTFOUND(e.id);n.setPage(this._expandResourcePath(t[M],e.page))}_onOpenResource(e){const t=v.WorkspaceImpl.instance().uiSourceCodeForURL(e.url);if(t)return R.reveal(t.uiLocation(e.lineNumber,0)),this._status.OK();const n=b.resourceForURL(e.url);if(n)return R.reveal(n),this._status.OK();const i=s.NetworkLog.instance().requestForURL(e.url);return i?(R.reveal(i),this._status.OK()):this._status.E_NOTFOUND(e.url)}_onSetOpenResourceHandler(e,t){const n=this._registeredExtensions.get(t[M]).name;e.handlerPresent?w.Linkifier.registerLinkHandler(n,this._handleOpenURL.bind(this,t)):w.Linkifier.unregisterLinkHandler(n)}_handleOpenURL(e,t,n){e.postMessage({command:"open-resource",resource:this._makeResource(t),lineNumber:n+1})}_onReload(e){const t=e.options||{};let s;return n.MultitargetNetworkManager.instance().setUserAgentOverride("string"==typeof t.userAgent?t.userAgent:"",null),t.injectedScript&&(s="(function(){"+t.injectedScript+"})()"),i.ResourceTreeModel.reloadAllPages(!!t.ignoreCache,s),this._status.OK()}_onEvaluateOnInspectedPage(e,t){return this.evaluate(e.expression,!0,!0,e.evaluateOptions,t[M],function(n,s,i){let o;o=n||!s?this._status.E_PROTOCOLERROR(n.toString()):i?{isException:!0,value:s.description}:{value:s.value},this._dispatchCallback(e.requestId,t,o)}.bind(this))}async _onGetHAR(){const e=s.NetworkLog.instance().requests(),t=await o.HARLog.build(e);for(let n=0;n<t.entries.length;++n)t.entries[n]._requestId=this._requestId(e[n]);return t}_makeResource(e){return{url:e.contentURL(),type:e.contentType().name()}}_onGetPageResources(){const e=new Map;function n(t){e.has(t.contentURL())||e.set(t.contentURL(),this._makeResource(t))}let s=v.WorkspaceImpl.instance().uiSourceCodesForProjectType(v.projectTypes.Network);s=s.concat(v.WorkspaceImpl.instance().uiSourceCodesForProjectType(v.projectTypes.ContentScripts)),s.forEach(n.bind(this));for(const e of t.TargetManager.instance().models(i.ResourceTreeModel))e.forAllResources(n.bind(this));return[...e.values()]}async _getResourceContent(e,t,n){const{content:s}=await e.requestContent(),i=await e.contentEncoded();this._dispatchCallback(t.requestId,n,{encoding:i?"base64":"",content:s})}_onGetRequestContent(e,t){const n=this._requestById(e.id);if(!n)return this._status.E_NOTFOUND(e.id);this._getResourceContent(n,e,t)}_onGetResourceContent(e,t){const n=e.url,s=v.WorkspaceImpl.instance().uiSourceCodeForURL(n)||b.resourceForURL(n);if(!s)return this._status.E_NOTFOUND(n);this._getResourceContent(s,e,t)}_onSetResourceContent(e,t){const n=e.url,s=v.WorkspaceImpl.instance().uiSourceCodeForURL(n);if(!s||!s.contentType().isDocumentOrScriptOrStyleSheet()){return i.ResourceTreeModel.resourceForURL(n)?this._status.E_NOTSUPPORTED("Resource is not editable"):this._status.E_NOTFOUND(n)}s.setWorkingCopy(e.content),e.commit&&s.commitWorkingCopy(),function(n){const s=n?this._status.E_FAILED(n):this._status.OK();this._dispatchCallback(e.requestId,t,s)}.call(this,null)}_requestId(e){return e._extensionRequestId||(e._extensionRequestId=++this._lastRequestId,this._requests[e._extensionRequestId]=e),e._extensionRequestId}_requestById(e){return this._requests[e]}_onAddTraceProvider(e,t){const n=new N(t[M],e.id,e.categoryName,e.categoryTooltip);this._clientObjects[e.id]=n,this._traceProviders.push(n),this.dispatchEventToListeners(K.TraceProviderAdded,n)}traceProviders(){return this._traceProviders}_onForwardKeyboardEvent(e){e.entries.forEach((function(e){const t=new window.KeyboardEvent(e.eventType,{key:e.key,code:e.code,keyCode:e.keyCode,location:e.location,ctrlKey:e.ctrlKey,altKey:e.altKey,shiftKey:e.shiftKey,metaKey:e.metaKey});t.__keyCode=function(e){let t=e.keyCode;t||"Escape"===e.key&&(t=27);return t||0}(e),document.dispatchEvent(t)}))}_dispatchCallback(e,t,n){e&&t.postMessage({command:"callback",requestId:e,result:n})}_initExtensions(){this._registerAutosubscriptionHandler(Extensions.extensionAPI.Events.ResourceAdded,v.WorkspaceImpl.instance(),v.Events.UISourceCodeAdded,this._notifyResourceAdded),this._registerAutosubscriptionTargetManagerHandler(Extensions.extensionAPI.Events.NetworkRequestFinished,n.NetworkManager,n.Events.RequestFinished,this._notifyRequestFinished),this._registerSubscriptionHandler(Extensions.extensionAPI.Events.PanelObjectSelected+"elements",function(){g.Context.instance().addFlavorChangeListener(r.DOMNode,this._notifyElementsSelectionChanged,this)}.bind(this),function(){g.Context.instance().removeFlavorChangeListener(r.DOMNode,this._notifyElementsSelectionChanged,this)}.bind(this)),this._registerResourceContentCommittedHandler(this._notifyUISourceCodeContentCommitted),t.TargetManager.instance().addEventListener(t.Events.InspectedURLChanged,this._inspectedURLChanged,this)}_notifyResourceAdded(e){const t=e.data;this._postNotification(Extensions.extensionAPI.Events.ResourceAdded,this._makeResource(t))}_notifyUISourceCodeContentCommitted(e){const t=e.data.uiSourceCode,n=e.data.content;this._postNotification(Extensions.extensionAPI.Events.ResourceContentCommitted,this._makeResource(t),n)}async _notifyRequestFinished(e){const t=e.data,n=await o.Entry.build(t);this._postNotification(Extensions.extensionAPI.Events.NetworkRequestFinished,this._requestId(t),n)}_notifyElementsSelectionChanged(){this._postNotification(Extensions.extensionAPI.Events.PanelObjectSelected+"elements")}sourceSelectionChanged(e,t){this._postNotification(Extensions.extensionAPI.Events.PanelObjectSelected+"sources",{startLine:t.startLine,startColumn:t.startColumn,endLine:t.endLine,endColumn:t.endColumn,url:e})}_setInspectedTabId(e){this._inspectedTabId=e.data}_addExtension(e){const n=e.startPage,s=t.TargetManager.instance().mainTarget().inspectedURL();if(""===s||this._canInspectURL(s)||this._disableExtensions(),this._extensionsEnabled){try{const t=new URL(n).origin;if(!this._registeredExtensions.get(t)){const n=self.buildExtensionAPIInjectedScript(e,this._inspectedTabId,I.instance().themeName(),m.ShortcutRegistry.instance().globalShortcutKeys(),G.instance()._extensionAPITestHook);S.InspectorFrontendHostInstance.setInjectedScriptForOrigin(t,n);const s=e.name||"Extension "+t;this._registeredExtensions.set(t,{name:s})}const s=createElement("iframe");s.src=n,s.dataset.devtoolsExtension=e.name,s.style.display="none",document.body.appendChild(s)}catch(e){return console.error("Failed to initialize extension "+n+":"+e),!1}return!0}}_registerExtension(e,t){this._registeredExtensions.has(e)?(t[M]=e,t.addEventListener("message",this._onmessage.bind(this),!1),t.start()):e!==window.location.origin&&console.error("Ignoring unauthorized client request from "+e)}_onWindowMessage(e){"registerExtension"===e.data&&this._registerExtension(e.origin,e.ports[0])}async _onmessage(e){const t=e.data;let n;n=t.command in this._handlers?this._extensionsEnabled?await this._handlers[t.command](t,e.target):this._status.E_FAILED("Permission denied"):this._status.E_NOTSUPPORTED(t.command),n&&t.requestId&&this._dispatchCallback(t.requestId,e.target,n)}_registerHandler(e,t){console.assert(e),this._handlers[e]=t}_registerSubscriptionHandler(e,t,n){this._subscriptionStartHandlers[e]=t,this._subscriptionStopHandlers[e]=n}_registerAutosubscriptionHandler(e,t,n,s){this._registerSubscriptionHandler(e,t.addEventListener.bind(t,n,s,this),t.removeEventListener.bind(t,n,s,this))}_registerAutosubscriptionTargetManagerHandler(e,n,s,i){this._registerSubscriptionHandler(e,t.TargetManager.instance().addModelListener.bind(t.TargetManager.instance(),n,s,i,this),t.TargetManager.instance().removeModelListener.bind(t.TargetManager.instance(),n,s,i,this))}_registerResourceContentCommittedHandler(e){this._registerSubscriptionHandler(Extensions.extensionAPI.Events.ResourceContentCommitted,function(){v.WorkspaceImpl.instance().addEventListener(v.Events.WorkingCopyCommittedByUser,e,this),v.WorkspaceImpl.instance().setHasResourceContentTrackingExtensions(!0)}.bind(this),function(){v.WorkspaceImpl.instance().setHasResourceContentTrackingExtensions(!1),v.WorkspaceImpl.instance().removeEventListener(v.Events.WorkingCopyCommittedByUser,e,this)}.bind(this))}_expandResourcePath(e,t){if(t)return e+this._normalizePath(t)}_normalizePath(e){const t=e.split("/"),n=[];for(let e=0;e<t.length;++e)"."!==t[e]&&""!==t[e]&&(".."===t[e]?n.pop():n.push(t[e]));return"/"+n.join("/")}evaluate(e,n,s,o,r,c){let d,u,l;if((o=o||{}).frameURL)u=function(e){let t;return i.ResourceTreeModel.frames().some((function(n){return t=n.url===e?n:null,t})),t}(o.frameURL);else{const e=t.TargetManager.instance().mainTarget(),n=e&&e.model(i.ResourceTreeModel);u=n&&n.mainFrame}if(!u)return o.frameURL?console.warn("evaluate: there is no frame with URL "+o.frameURL):console.warn("evaluate: the main frame is not yet available"),this._status.E_NOTFOUND(o.frameURL||"<top>");if(!this._canInspectURL(u.url))return this._status.E_FAILED("Permission denied");o.useContentScriptContext?l=r:o.scriptExecutionContext&&(l=o.scriptExecutionContext);const h=u.resourceTreeModel().target().model(a.RuntimeModel),p=h?h.executionContexts():[];if(l){for(let e=0;e<p.length;++e){const t=p[e];t.frameId!==u.id||t.origin!==l||t.isDefault||(d=t)}if(!d)return console.warn("The JavaScript context "+l+" was not found in the frame "+u.url),this._status.E_NOTFOUND(l)}else{for(let e=0;e<p.length;++e){const t=p[e];t.frameId===u.id&&t.isDefault&&(d=t)}if(!d)return this._status.E_FAILED(u.url+" has no execution context")}if(!this._canInspectURL(d.origin))return this._status.E_FAILED("Permission denied");d.evaluate({expression:e,objectGroup:"extension",includeCommandLineAPI:n,silent:!0,returnByValue:s,generatePreview:!1},!1,!1).then((function(e){if(e.error)return void c(e.error,null,!1);c(null,e.object||null,!!e.exceptionDetails)}))}_canInspectURL(e){let t;try{t=new URL(e)}catch(e){return!1}return!!V.includes(t.origin)||"chrome:"!==t.protocol&&"devtools:"!==t.protocol&&(!t.protocol.startsWith("http")||"chrome.google.com"!==t.hostname||!t.pathname.startsWith("/webstore"))}_disableExtensions(){this._extensionsEnabled=!1}}const K={SidebarPaneAdded:Symbol("SidebarPaneAdded"),TraceProviderAdded:Symbol("TraceProviderAdded"),LanguageExtensionEndpointAdded:Symbol("LanguageExtensionEndpointAdded")};class B extends h.SimpleView{constructor(e,t,n){super(t),this._name=e,this._panel=n}viewId(){return this._name}widget(){return Promise.resolve(this._panel)}}class W{constructor(){function e(e,t){const n=Array.prototype.slice.call(arguments,2),s={code:e,description:t,details:n};return"OK"!==e&&(s.isError=!0,console.error("Extension server error: "+E.vsprintf(t,n))),s}this.OK=e.bind(null,"OK","OK"),this.E_EXISTS=e.bind(null,"E_EXISTS","Object already exists: %s"),this.E_BADARG=e.bind(null,"E_BADARG","Invalid argument %s: %s"),this.E_BADARGTYPE=e.bind(null,"E_BADARGTYPE","Invalid type for argument %s: got %s, expected %s"),this.E_NOTFOUND=e.bind(null,"E_NOTFOUND","Object not found: %s"),this.E_NOTSUPPORTED=e.bind(null,"E_NOTSUPPORTED","Object does not support requested operation: %s"),this.E_PROTOCOLERROR=e.bind(null,"E_PROTOCOLERROR","Inspector protocol error: %s"),this.E_FAILED=e.bind(null,"E_FAILED","Operation failed: %s")}}var z=Object.freeze({__proto__:null,ExtensionServer:G,Events:K,ExtensionStatus:W,Record:void 0});export{C as ExtensionAPI,j as ExtensionPanel,z as ExtensionServer,F as ExtensionTraceProvider,L as ExtensionView};
