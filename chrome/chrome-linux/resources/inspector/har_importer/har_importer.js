import{ResourceType as e}from"../common/common.js";import{NetworkRequest as t,NetworkLog as s}from"../sdk/sdk.js";class r{constructor(e){if(!e||"object"!=typeof e)throw"First parameter is expected to be an object";this._custom=new Map}static _safeDate(e){const t=new Date(e);if(!Number.isNaN(t.getTime()))return t;throw"Invalid date format"}static _safeNumber(e){const t=Number(e);if(!Number.isNaN(t))return t;throw"Casting to number results in NaN"}static _optionalNumber(e){return void 0!==e?r._safeNumber(e):void 0}static _optionalString(e){return void 0!==e?String(e):void 0}customAsString(e){const t=this._custom.get(e);if(t)return String(t)}customAsNumber(e){const t=this._custom.get(e);if(!t)return;const s=Number(t);return Number.isNaN(s)?void 0:s}customAsArray(e){const t=this._custom.get(e);if(t)return Array.isArray(t)?t:void 0}customInitiator(){return this._custom.get("initiator")}}class o extends r{constructor(e){if(super(e),this.version=String(e.version),this.creator=new i(e.creator),this.browser=e.browser?new i(e.browser):void 0,this.pages=Array.isArray(e.pages)?e.pages.map(e=>new n(e)):[],!Array.isArray(e.entries))throw"log.entries is expected to be an array";this.entries=e.entries.map(e=>new c(e)),this.comment=r._optionalString(e.comment)}}class i extends r{constructor(e){super(e),this.name=String(e.name),this.version=String(e.version),this.comment=r._optionalString(e.comment)}}class n extends r{constructor(e){super(e),this.startedDateTime=r._safeDate(e.startedDateTime),this.id=String(e.id),this.title=String(e.title),this.pageTimings=new a(e.pageTimings),this.comment=r._optionalString(e.comment)}}class a extends r{constructor(e){super(e),this.onContentLoad=r._optionalNumber(e.onContentLoad),this.onLoad=r._optionalNumber(e.onLoad),this.comment=r._optionalString(e.comment)}}class c extends r{constructor(e){super(e),this.pageref=r._optionalString(e.pageref),this.startedDateTime=r._safeDate(e.startedDateTime),this.time=r._safeNumber(e.time),this.request=new m(e.request),this.response=new u(e.response),this.cache={},this.timings=new S(e.timings),this.serverIPAddress=r._optionalString(e.serverIPAddress),this.connection=r._optionalString(e.connection),this.comment=r._optionalString(e.comment),this._custom.set("fromCache",r._optionalString(e._fromCache)),this._custom.set("initiator",this._importInitiator(e._initiator)),this._custom.set("priority",r._optionalString(e._priority)),this._custom.set("resourceType",r._optionalString(e._resourceType)),this._custom.set("webSocketMessages",this._importWebSocketMessages(e._webSocketMessages))}_importInitiator(e){if("object"==typeof e)return new y(e)}_importWebSocketMessages(e){if(!Array.isArray(e))return;const t=[];for(const s of e){if("object"!=typeof s)return;t.push(new b(s))}return t}}class m extends r{constructor(e){super(e),this.method=String(e.method),this.url=String(e.url),this.httpVersion=String(e.httpVersion),this.cookies=Array.isArray(e.cookies)?e.cookies.map(e=>new p(e)):[],this.headers=Array.isArray(e.headers)?e.headers.map(e=>new d(e)):[],this.queryString=Array.isArray(e.queryString)?e.queryString.map(e=>new h(e)):[],this.postData=e.postData?new l(e.postData):void 0,this.headersSize=r._safeNumber(e.headersSize),this.bodySize=r._safeNumber(e.bodySize),this.comment=r._optionalString(e.comment)}}class u extends r{constructor(e){super(e),this.status=r._safeNumber(e.status),this.statusText=String(e.statusText),this.httpVersion=String(e.httpVersion),this.cookies=Array.isArray(e.cookies)?e.cookies.map(e=>new p(e)):[],this.headers=Array.isArray(e.headers)?e.headers.map(e=>new d(e)):[],this.content=new _(e.content),this.redirectURL=String(e.redirectURL),this.headersSize=r._safeNumber(e.headersSize),this.bodySize=r._safeNumber(e.bodySize),this.comment=r._optionalString(e.comment),this._custom.set("transferSize",r._optionalNumber(e._transferSize)),this._custom.set("error",r._optionalString(e._error))}}class p extends r{constructor(e){super(e),this.name=String(e.name),this.value=String(e.value),this.path=r._optionalString(e.path),this.domain=r._optionalString(e.domain),this.expires=e.expires?r._safeDate(e.expires):void 0,this.httpOnly=void 0!==e.httpOnly?!!e.httpOnly:void 0,this.secure=void 0!==e.secure?!!e.secure:void 0,this.comment=r._optionalString(e.comment)}}class d extends r{constructor(e){super(e),this.name=String(e.name),this.value=String(e.value),this.comment=r._optionalString(e.comment)}}class h extends r{constructor(e){super(e),this.name=String(e.name),this.value=String(e.value),this.comment=r._optionalString(e.comment)}}class l extends r{constructor(e){super(e),this.mimeType=String(e.mimeType),this.params=Array.isArray(e.params)?e.params.map(e=>new g(e)):[],this.text=String(e.text),this.comment=r._optionalString(e.comment)}}class g extends r{constructor(e){super(e),this.name=String(e.name),this.value=r._optionalString(e.value),this.fileName=r._optionalString(e.fileName),this.contentType=r._optionalString(e.contentType),this.comment=r._optionalString(e.comment)}}class _ extends r{constructor(e){super(e),this.size=r._safeNumber(e.size),this.compression=r._optionalNumber(e.compression),this.mimeType=String(e.mimeType),this.text=r._optionalString(e.text),this.encoding=r._optionalString(e.encoding),this.comment=r._optionalString(e.comment)}}class S extends r{constructor(e){super(e),this.blocked=r._optionalNumber(e.blocked),this.dns=r._optionalNumber(e.dns),this.connect=r._optionalNumber(e.connect),this.send=r._safeNumber(e.send),this.wait=r._safeNumber(e.wait),this.receive=r._safeNumber(e.receive),this.ssl=r._optionalNumber(e.ssl),this.comment=r._optionalString(e.comment),this._custom.set("blocked_queueing",r._optionalNumber(e._blocked_queueing)),this._custom.set("blocked_proxy",r._optionalNumber(e._blocked_proxy))}}class y extends r{constructor(e){super(e),this.type=r._optionalString(e.type),this.url=r._optionalString(e.url),this.lineNumber=r._optionalNumber(e.lineNumber)}}class b extends r{constructor(e){super(e),this.time=r._optionalNumber(e.time),this.opcode=r._optionalNumber(e.opcode),this.data=r._optionalString(e.data),this.type=r._optionalString(e.type)}}var f=Object.freeze({__proto__:null,HARRoot:class extends r{constructor(e){super(e),this.log=new o(e.log)}},HARLog:o,HARPage:n,HAREntry:c,HARParam:g,HARTimings:S,HARInitiator:y});class N{static requestsFromHARLog(e){const s=new Map;for(const t of e.pages)s.set(t.id,t);e.entries.sort((e,t)=>e.startedDateTime.valueOf()-t.startedDateTime.valueOf());const r=new Map,o=[];for(const i of e.entries){const e=i.pageref;if(void 0===e)continue;let n=r.get(e);const a=n?n.mainRequest.url():i.request.url;let c=null;const m=i.customInitiator();m&&(c={type:m.type,url:m.url,lineNumber:m.lineNumber});const u=new t.NetworkRequest("har-"+o.length,i.request.url,a,"","",c),p=s.get(e);!n&&p&&(n=N._buildPageLoad(p,u),r.set(e,n)),N._fillRequestFromHAREntry(u,i,n),n&&n.bindRequest(u),o.push(u)}return o}static _buildPageLoad(e,t){const r=new s.PageLoad(t);return r.startTime=e.startedDateTime.valueOf(),r.contentLoadTime=1e3*Number(e.pageTimings.onContentLoad),r.loadTime=1e3*Number(e.pageTimings.onLoad),r}static _fillRequestFromHAREntry(e,s,r){s.request.postData?e.setRequestFormData(!0,s.request.postData.text):e.setRequestFormData(!1,null),e.connectionId=s.connection||"",e.requestMethod=s.request.method,e.setRequestHeaders(s.request.headers),s.response.content.mimeType&&"x-unknown"!==s.response.content.mimeType&&(e.mimeType=s.response.content.mimeType),e.responseHeaders=s.response.headers,e.statusCode=s.response.status,e.statusText=s.response.statusText;let o=s.response.httpVersion.toLowerCase();"http/2.0"===o&&(o="h2"),e.protocol=o.replace(/^http\/2\.0?\+quic/,"http/2+quic");const i=s.startedDateTime.getTime()/1e3;e.setIssueTime(i,i);const n=s.response.content.size>0?s.response.content.size:0,a=s.response.headersSize>0?s.response.headersSize:0,c=s.response.bodySize>0?s.response.bodySize:0;e.resourceSize=n||a+c;let m=s.response.customAsNumber("transferSize");void 0===m&&(m=s.response.headersSize+s.response.bodySize),e.setTransferSize(m>=0?m:0);const u=s.customAsString("fromCache");"memory"===u?e.setFromMemoryCache():"disk"===u&&e.setFromDiskCache();const p=s.response.content.text,d={error:null,content:p||null,encoded:"base64"===s.response.content.encoding};e.setContentDataProvider(async()=>d),N._setupTiming(e,i,s.time,s.timings),e.setRemoteAddress(s.serverIPAddress||"",80),e.setResourceType(N._getResourceType(e,s,r));const h=s.customAsString("priority");h&&Protocol.Network.ResourcePriority.hasOwnProperty(h)&&e.setPriority(h);const l=s.customAsArray("webSocketMessages");if(l)for(const s of l){if(void 0===s.time)continue;if(!Object.values(t.WebSocketFrameType).includes(s.type))continue;if(void 0===s.opcode)continue;if(void 0===s.data)continue;const r=s.type===t.WebSocketFrameType.Send;e.addFrame({time:s.time,text:s.data,opCode:s.opcode,mask:r,type:s.type})}e.finished=!0}static _getResourceType(t,s,r){const o=s.customAsString("resourceType");if(o){const t=e.ResourceType.fromName(o);if(t)return t}if(r&&r.mainRequest===t)return e.resourceTypes.Document;const i=e.ResourceType.fromMimeType(s.response.content.mimeType);if(i!==e.resourceTypes.Other)return i;const n=e.ResourceType.fromURL(s.request.url);return n||e.resourceTypes.Other}static _setupTiming(e,t,s,r){function o(e){return void 0===e||e<0?-1:(i+=e,i)}let i=r.blocked&&r.blocked>=0?r.blocked:0;const n=r.customAsNumber("blocked_proxy")||-1,a=r.customAsNumber("blocked_queueing")||-1,c=r.ssl&&r.ssl>=0?r.ssl:0;r.connect&&r.connect>0&&(r.connect-=c);const m={proxyStart:n>0?i-n:-1,proxyEnd:n>0?i:-1,requestTime:t+(a>0?a:0)/1e3,dnsStart:r.dns&&r.dns>=0?i:-1,dnsEnd:o(r.dns),connectStart:r.connect&&r.connect>=0?i:-1,connectEnd:o(r.connect)+c,sslStart:r.ssl&&r.ssl>=0?i:-1,sslEnd:o(r.ssl),workerStart:-1,workerReady:-1,workerFetchStart:-1,workerRespondWithSettled:-1,sendStart:r.send>=0?i:-1,sendEnd:o(r.send),pushStart:0,pushEnd:0,receiveHeadersEnd:o(r.wait)};o(r.receive),e.timing=m,e.endTime=t+Math.max(s,i)/1e3}}var T=Object.freeze({__proto__:null,Importer:N});export{f as HARFormat,T as HARImporter};
