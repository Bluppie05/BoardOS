import{UIString as t,Revealer as e,ObjectWrapper as i,Settings as n}from"../common/common.js";import{NetworkManager as o,SDKModel as s,EmulationModel as r}from"../sdk/sdk.js";import{userMetrics as l,UserMetrics as a}from"../host/host.js";import{ARIAUtils as d,Toolbar as c,Icon as h,InspectorView as g,Widget as u,UIUtils as p,ListWidget as C}from"../ui/ui.js";const w={NoThrottling:1,MidTierMobile:4,LowEndMobile:6},k={title:o.NoThrottlingConditions.title,description:t.UIString("No throttling"),network:o.NoThrottlingConditions,cpuThrottlingRate:w.NoThrottling},_={title:o.OfflineConditions.title,description:t.UIString("No internet connectivity"),network:o.OfflineConditions,cpuThrottlingRate:w.NoThrottling},m={title:t.UIString("Low-end mobile"),description:t.UIString("Slow 3G & 6x CPU slowdown"),network:o.Slow3GConditions,cpuThrottlingRate:w.LowEndMobile},v={title:t.UIString("Mid-tier mobile"),description:t.UIString("Fast 3G & 4x CPU slowdown"),network:o.Fast3GConditions,cpuThrottlingRate:w.MidTierMobile},b={title:t.UIString("Custom"),description:t.UIString("Check Network and Performance panels")},T=[v,m,b],N=[_],f=[o.Fast3GConditions,o.Slow3GConditions,o.OfflineConditions],M=[w.NoThrottling,w.MidTierMobile,w.LowEndMobile];var S=Object.freeze({__proto__:null,CPUThrottlingRates:w,NoThrottlingConditions:k,OfflineConditions:_,LowEndMobileConditions:m,MidTierMobileConditions:v,CustomConditions:b,mobilePresets:T,advancedMobilePresets:N,networkPresets:f,cpuThrottlingPresets:M,Conditions:void 0,NetworkThrottlingConditionsGroup:void 0,MobileThrottlingConditionsGroup:void 0,ConditionsList:void 0,PlaceholderConditions:void 0});class I{constructor(t,e,i){this._populateCallback=t,this._selectCallback=e,this._customNetworkConditionsSetting=i,this._customNetworkConditionsSetting.addChangeListener(this._populateOptions,this),o.MultitargetNetworkManager.instance().addEventListener(o.MultitargetNetworkManager.Events.ConditionsChanged,()=>{this._networkConditionsChanged()},this),this._options,this._populateOptions()}revealAndUpdate(){e.reveal(this._customNetworkConditionsSetting),this._networkConditionsChanged()}optionSelected(t){o.MultitargetNetworkManager.instance().setNetworkConditions(t)}_populateOptions(){const e={title:t.UIString("Disabled"),items:[o.NoThrottlingConditions]},i={title:t.UIString("Presets"),items:f},n={title:t.UIString("Custom"),items:this._customNetworkConditionsSetting.get()};if(this._options=this._populateCallback([e,i,n]),!this._networkConditionsChanged())for(let t=this._options.length-1;t>=0;t--)if(this._options[t]){this.optionSelected(this._options[t]);break}}_networkConditionsChanged(){const t=o.MultitargetNetworkManager.instance().networkConditions();for(let e=0;e<this._options.length;++e){const i=this._options[e];if(i&&i.download===t.download&&i.upload===t.upload&&i.latency===t.latency&&i.title===t.title)return this._selectCallback(e),!0}return!1}}var x=Object.freeze({__proto__:null,NetworkThrottlingSelector:I});let U;class R extends i.ObjectWrapper{constructor(){super(),this._cpuThrottlingRate=w.NoThrottling,this._cpuThrottlingControls=new Set,this._cpuThrottlingRates=M,this._customNetworkConditionsSetting=n.Settings.instance().moduleSetting("customNetworkConditions"),this._currentNetworkThrottlingConditions=o.NoThrottlingConditions,this._lastNetworkThrottlingConditions,o.MultitargetNetworkManager.instance().addEventListener(o.MultitargetNetworkManager.Events.ConditionsChanged,()=>{this._lastNetworkThrottlingConditions=this._currentNetworkThrottlingConditions,this._currentNetworkThrottlingConditions=o.MultitargetNetworkManager.instance().networkConditions()}),s.TargetManager.instance().observeModels(r.EmulationModel,this)}static instance(t={forceNew:null}){const{forceNew:e}=t;return U&&!e||(U=new R),U}decorateSelectWithNetworkThrottling(t){let e=[];const i=new I((function(i){t.removeChildren(),e=[];for(let n=0;n<i.length;++n){const o=i[n],s=t.createChild("optgroup");s.label=o.title;for(const t of o.items){const i=t.title,n=new Option(i,i);d.setAccessibleName(n,ls`${o.title}: ${i}`),s.appendChild(n),e.push(t)}if(n===i.length-1){const t=new Option(ls`Add…`,ls`Add…`);d.setAccessibleName(t,ls`Add ${o.title}`),s.appendChild(t),e.push(null)}}return e}),(function(e){t.selectedIndex!==e&&(t.selectedIndex=e)}),this._customNetworkConditionsSetting);return t.addEventListener("change",(function(){if(t.selectedIndex===t.options.length-1)i.revealAndUpdate();else{const n=e[t.selectedIndex];n&&i.optionSelected(n)}}),!1),i}createOfflineToolbarCheckbox(){const e=new c.ToolbarCheckbox(t.UIString("Offline"),t.UIString("Force disconnected from network"),function(){e.checked()?o.MultitargetNetworkManager.instance().setNetworkConditions(o.OfflineConditions):o.MultitargetNetworkManager.instance().setNetworkConditions(this._lastNetworkThrottlingConditions)}.bind(this));return o.MultitargetNetworkManager.instance().addEventListener(o.MultitargetNetworkManager.Events.ConditionsChanged,(function(){e.setChecked(o.MultitargetNetworkManager.instance().networkConditions()===o.OfflineConditions)})),e.setChecked(o.MultitargetNetworkManager.instance().networkConditions()===o.OfflineConditions),e}createMobileThrottlingButton(){const e=new c.ToolbarMenuButton((function(e){for(let s=0;s<i.length;++s){const r=i[s];r&&(r.title===b.title&&r.description===b.description||e.defaultSection().appendCheckboxItem(t.UIString(r.title),o.optionSelected.bind(o,r),n===s))}}));e.setTitle(t.UIString("Throttling")),e.setGlyph(""),e.turnIntoSelect(),e.setDarkText();let i=[],n=-1;const o=new L((function(t){i=[];for(const e of t){for(const t of e.items)i.push(t);i.push(null)}return i}),(function(t){n=t;const o=i[t];o&&(e.setText(o.title),e.setTitle(o.description))}));return e}cpuThrottlingRate(){return this._cpuThrottlingRate}setCPUThrottlingRate(e){this._cpuThrottlingRate=e;for(const t of s.TargetManager.instance().models(r.EmulationModel))t.setCPUThrottlingRate(this._cpuThrottlingRate);let i=null;this._cpuThrottlingRate!==w.NoThrottling&&(l.actionTaken(a.Action.CpuThrottlingEnabled),i=h.Icon.create("smallicon-warning"),i.title=t.UIString("CPU throttling is enabled"));const n=this._cpuThrottlingRates.indexOf(this._cpuThrottlingRate);for(const t of this._cpuThrottlingControls)t.setSelectedIndex(n);g.InspectorView.instance().setPanelIcon("timeline",i),this.dispatchEventToListeners(E.RateChanged,this._cpuThrottlingRate)}modelAdded(t){this._cpuThrottlingRate!==w.NoThrottling&&t.setCPUThrottlingRate(this._cpuThrottlingRate)}modelRemoved(t){}createCPUThrottlingSelector(){const e=new c.ToolbarComboBox(t=>this.setCPUThrottlingRate(this._cpuThrottlingRates[t.target.selectedIndex]),ls`CPU throttling`);this._cpuThrottlingControls.add(e);const i=this._cpuThrottlingRate;for(let n=0;n<this._cpuThrottlingRates.length;++n){const o=this._cpuThrottlingRates[n],s=1===o?t.UIString("No throttling"):t.UIString("%d× slowdown",o),r=e.createOption(s);e.addOption(r),i===o&&e.setSelectedIndex(n)}return e}}const E={RateChanged:Symbol("RateChanged")};function P(){return R.instance()}var O=Object.freeze({__proto__:null,ThrottlingManager:R,Events:E,ActionDelegate:class{handleAction(t,e){return"network-conditions.network-online"===e?(o.MultitargetNetworkManager.instance().setNetworkConditions(o.NoThrottlingConditions),!0):"network-conditions.network-low-end-mobile"===e?(o.MultitargetNetworkManager.instance().setNetworkConditions(o.Slow3GConditions),!0):"network-conditions.network-mid-tier-mobile"===e?(o.MultitargetNetworkManager.instance().setNetworkConditions(o.Fast3GConditions),!0):"network-conditions.network-offline"===e&&(o.MultitargetNetworkManager.instance().setNetworkConditions(o.OfflineConditions),!0)}},throttlingManager:P});class L{constructor(t,e){this._populateCallback=t,this._selectCallback=e,P().addEventListener(E.RateChanged,this._conditionsChanged,this),o.MultitargetNetworkManager.instance().addEventListener(o.MultitargetNetworkManager.Events.ConditionsChanged,this._conditionsChanged,this),this._options=this._populateOptions(),this._conditionsChanged()}optionSelected(t){o.MultitargetNetworkManager.instance().setNetworkConditions(t.network),P().setCPUThrottlingRate(t.cpuThrottlingRate)}_populateOptions(){const e={title:t.UIString("Disabled"),items:[k]},i={title:t.UIString("Presets"),items:T},n={title:t.UIString("Advanced"),items:N};return this._populateCallback([e,i,n])}_conditionsChanged(){const t=o.MultitargetNetworkManager.instance().networkConditions(),e=P().cpuThrottlingRate();for(let i=0;i<this._options.length;++i){const n=this._options[i];if(n&&"network"in n&&n.network===t&&n.cpuThrottlingRate===e)return void this._selectCallback(i)}this._selectCallback(this._options.indexOf(b))}}var y=Object.freeze({__proto__:null,MobileThrottlingSelector:L});var A=Object.freeze({__proto__:null,NetworkPanelIndicator:class{constructor(){if(!g.InspectorView.instance().hasPanel("network"))return;const e=o.MultitargetNetworkManager.instance();function i(){let i=null;e.isThrottling()?(i=h.Icon.create("smallicon-warning"),i.title=t.UIString("Network throttling is enabled")):o.MultitargetNetworkManager.instance().isIntercepting()?(i=h.Icon.create("smallicon-warning"),i.title=t.UIString("Requests may be rewritten by local overrides")):e.isBlocking()&&(i=h.Icon.create("smallicon-warning"),i.title=t.UIString("Requests may be blocked")),g.InspectorView.instance().setPanelIcon("network",i)}e.addEventListener(o.MultitargetNetworkManager.Events.ConditionsChanged,i),e.addEventListener(o.MultitargetNetworkManager.Events.BlockedPatternsChanged,i),e.addEventListener(o.MultitargetNetworkManager.Events.InterceptorsChanged,i),i()}}});class B extends u.VBox{constructor(){super(!0),this.registerRequiredCSS("mobile_throttling/throttlingSettingsTab.css",{enableLegacyPatching:!0});const e=this.contentElement.createChild("div","header");e.textContent=ls`Network Throttling Profiles`,d.markAsHeading(e,1);const i=p.createTextButton(t.UIString("Add custom profile..."),this._addButtonClicked.bind(this),"add-conditions-button");this.contentElement.appendChild(i),this._list=new C.ListWidget(this),this._list.element.classList.add("conditions-list"),this._list.registerRequiredCSS("mobile_throttling/throttlingSettingsTab.css",{enableLegacyPatching:!0}),this._list.show(this.contentElement),this._customSetting=n.Settings.instance().moduleSetting("customNetworkConditions"),this._customSetting.addChangeListener(this._conditionsUpdated,this),this.setDefaultFocusedElement(i)}wasShown(){super.wasShown(),this._conditionsUpdated()}_conditionsUpdated(){this._list.clear();const t=this._customSetting.get();for(let e=0;e<t.length;++e)this._list.appendItem(t[e],!0);this._list.appendSeparator()}_addButtonClicked(){this._list.addNewItem(this._customSetting.get().length,{title:"",download:-1,upload:-1,latency:0})}renderItem(e,i){const n=document.createElement("div");n.classList.add("conditions-list-item");const o=n.createChild("div","conditions-list-text conditions-list-title").createChild("div","conditions-list-title-text");return o.textContent=e.title,o.title=e.title,n.createChild("div","conditions-list-separator"),n.createChild("div","conditions-list-text").textContent=j(e.download),n.createChild("div","conditions-list-separator"),n.createChild("div","conditions-list-text").textContent=j(e.upload),n.createChild("div","conditions-list-separator"),n.createChild("div","conditions-list-text").textContent=t.UIString("%dms",e.latency),n}removeItemRequested(t,e){const i=this._customSetting.get();i.splice(e,1),this._customSetting.set(i)}commitEdit(t,e,i){t.title=e.control("title").value.trim();const n=e.control("download").value.trim();t.download=n?125*parseInt(n,10):-1;const o=e.control("upload").value.trim();t.upload=o?125*parseInt(o,10):-1;const s=e.control("latency").value.trim();t.latency=s?parseInt(s,10):0;const r=this._customSetting.get();i&&r.push(t),this._customSetting.set(r)}beginEdit(t){const e=this._createEditor();return e.control("title").value=t.title,e.control("download").value=t.download<=0?"":String(t.download/125),e.control("upload").value=t.upload<=0?"":String(t.upload/125),e.control("latency").value=t.latency?String(t.latency):"",e}_createEditor(){if(this._editor)return this._editor;const t=new C.Editor;this._editor=t;const e=t.contentElement(),i=e.createChild("div","conditions-edit-row"),n=i.createChild("div","conditions-list-text conditions-list-title"),o=ls`Profile Name`;n.textContent=o,i.createChild("div","conditions-list-separator conditions-list-separator-invisible");const s=i.createChild("div","conditions-list-text"),r=ls`Download`;s.textContent=r,i.createChild("div","conditions-list-separator conditions-list-separator-invisible");const l=i.createChild("div","conditions-list-text"),a=ls`Upload`;l.textContent=a,i.createChild("div","conditions-list-separator conditions-list-separator-invisible");const c=i.createChild("div","conditions-list-text"),h=ls`Latency`;c.textContent=h;const g=e.createChild("div","conditions-edit-row"),u=t.createInput("title","text","",(function(t,e,i){const n=i.value.trim(),o=n.length>0&&n.length<=49;if(!o){const t=ls`Profile Name characters length must be between 1 to ${49} inclusive`;return{valid:o,errorMessage:t}}return{valid:o,errorMessage:void 0}}));d.setAccessibleName(u,o),g.createChild("div","conditions-list-text conditions-list-title").appendChild(u),g.createChild("div","conditions-list-separator conditions-list-separator-invisible");let p=g.createChild("div","conditions-list-text");const w=t.createInput("download","text",ls`kb/s`,b);p.appendChild(w),d.setAccessibleName(w,r);const k=p.createChild("div","conditions-edit-optional"),_=ls`optional`;k.textContent=_,d.setDescription(w,_),g.createChild("div","conditions-list-separator conditions-list-separator-invisible"),p=g.createChild("div","conditions-list-text");const m=t.createInput("upload","text",ls`kb/s`,b);d.setAccessibleName(m,a),p.appendChild(m);p.createChild("div","conditions-edit-optional").textContent=_,d.setDescription(m,_),g.createChild("div","conditions-list-separator conditions-list-separator-invisible"),p=g.createChild("div","conditions-list-text");const v=t.createInput("latency","text",ls`ms`,(function(t,e,i){const n=i.value.trim(),o=Number(n),s=Number.isInteger(o)&&o>=0&&o<=1e6;if(!s){const t=ls`Latency must be an integer between ${0}ms to ${1e6}ms inclusive`;return{valid:s,errorMessage:t}}return{valid:s,errorMessage:void 0}}));d.setAccessibleName(v,h),p.appendChild(v);return p.createChild("div","conditions-edit-optional").textContent=_,d.setDescription(v,_),t;function b(t,e,i){const n=i.value.trim(),o=Number(n),s=i.getAttribute("aria-label"),r=!Number.isNaN(o)&&o>=0&&o<=1e7;if(!r){return{valid:r,errorMessage:ls`${s} must be a number between ${0}kb/s to ${1e7}kb/s inclusive`}}return{valid:r,errorMessage:void 0}}}}function j(e,i){if(e<0)return"";const n=e/125,o=i?"":" ";return n<1e3?t.UIString("%d%skB/s",n,o):n<1e4?t.UIString("%.1f%sMB/s",n/1e3,o):t.UIString("%d%sMB/s",n/1e3|0,o)}var G=Object.freeze({__proto__:null,ThrottlingSettingsTab:B,throughputText:j});export{y as MobileThrottlingSelector,A as NetworkPanelIndicator,x as NetworkThrottlingSelector,O as ThrottlingManager,S as ThrottlingPresets,G as ThrottlingSettingsTab};
