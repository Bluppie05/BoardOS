import{StringUtilities as e}from"../platform/platform.js";import{Revealer as t,UIString as s,Settings as i,Progress as n}from"../common/common.js";import{Linkifier as h}from"../components/components.js";import{TextRange as r}from"../text_utils/text_utils.js";import{Widget as a,TreeOutline as c,ARIAUtils as o,UIUtils as l,HistoryInput as _,Toolbar as u,ProgressIndicator as d,EmptyWidget as g,KeyboardShortcut as p}from"../ui/ui.js";class m{constructor(e,t,s){this._query=e,this._ignoreCase=t,this._isRegex=s,this._parse()}static fromPlainObject(e){return new m(e.query,e.ignoreCase,e.isRegex)}query(){return this._query}ignoreCase(){return this._ignoreCase}isRegex(){return this._isRegex}toPlainObject(){return{query:this.query(),ignoreCase:this.ignoreCase(),isRegex:this.isRegex()}}_parse(){const e=/(\s*(?!-?f(ile)?:)[^\\ ]|\\.)+/,t=e.source+"(\\s+"+e.source+")*",s=["(\\s*"+S.source+"\\s*)","("+/"([^\\"]|\\.)+"/.source+")","("+t+")"].join("|"),i=new RegExp(s,"g"),n=this._query.match(i)||[];this._fileQueries=[],this._queries=[];for(let e=0;e<n.length;++e){const t=n[e];if(!t)continue;const s=this._parseFileQuery(t);if(s)this._fileQueries.push(s),this._fileRegexQueries=this._fileRegexQueries||[],this._fileRegexQueries.push({regex:new RegExp(s.text,this.ignoreCase()?"i":""),isNegative:s.isNegative});else if(this._isRegex)this._queries.push(t);else if(t.startsWith('"')){if(!t.endsWith('"'))continue;this._queries.push(this._parseQuotedQuery(t))}else this._queries.push(this._parseUnquotedQuery(t))}}filePathMatchesFileQuery(e){if(!this._fileRegexQueries)return!0;for(let t=0;t<this._fileRegexQueries.length;++t)if(!!e.match(this._fileRegexQueries[t].regex)===this._fileRegexQueries[t].isNegative)return!1;return!0}queries(){return this._queries||[]}_parseUnquotedQuery(e){return e.replace(/\\(.)/g,"$1")}_parseQuotedQuery(e){return e.substring(1,e.length-1).replace(/\\(.)/g,"$1")}_parseFileQuery(t){const s=t.match(S);if(!s)return null;const i=!!s[1];t=s[3];let n="";for(let s=0;s<t.length;++s){const i=t[s];if("*"===i)n+=".*";else if("\\"===i){++s;" "===t[s]&&(n+=" ")}else-1!==e.regexSpecialCharacters().indexOf(t.charAt(s))&&(n+="\\"),n+=t.charAt(s)}return new C(n,i)}}const S=/(-)?f(ile)?:((?:[^\\ ]|\\.)+)/;class C{constructor(e,t){this.text=e,this.isNegative=t}}var f=Object.freeze({__proto__:null,SearchConfig:m,FilePatternRegex:S,QueryTerm:C,SearchResult:class{label(){throw new Error("not implemented here")}description(){throw new Error("not implemented here")}matchesCount(){throw new Error("not implemented here")}matchLabel(e){throw new Error("not implemented here")}matchLineContent(e){throw new Error("not implemented here")}matchRevealable(e){throw new Error("not implemented here")}},SearchScope:class{performSearch(e,t,s,i){}performIndexing(e){}stopSearch(){}},RegexQuery:void 0});class x extends a.VBox{constructor(e){super(!0),this._searchConfig=e,this._searchResults=[],this._treeOutline=new c.TreeOutlineInShadow,this._treeOutline.hideOverflow(),this._treeOutline.registerRequiredCSS("search/searchResultsPane.css",{enableLegacyPatching:!0}),this.contentElement.appendChild(this._treeOutline.element),this._matchesExpandedCount=0}addSearchResult(e){this._searchResults.push(e),this._addTreeElement(e)}_addTreeElement(e){const t=new E(this._searchConfig,e);this._treeOutline.appendChild(t),this._treeOutline.selectedTreeElement||t.select(!0,!0),this._matchesExpandedCount<R&&t.expand(),this._matchesExpandedCount+=e.matchesCount()}}const R=20;class E extends c.TreeElement{constructor(e,t){super("",!0),this._searchConfig=e,this._searchResult=t,this._initialized=!1,this.toggleOnClick=!0}onexpand(){this._initialized||(this._updateMatchesUI(),this._initialized=!0)}_updateMatchesUI(){this.removeChildren();const e=Math.min(this._searchResult.matchesCount(),20);e<this._searchResult.matchesCount()?(this._appendSearchMatches(0,e-1),this._appendShowMoreMatchesElement(e-1)):this._appendSearchMatches(0,e)}onattach(){this._updateSearchMatches()}_updateSearchMatches(){this.listItemElement.classList.add("search-result");const e=s(this._searchResult.label(),"search-result-file-name");e.appendChild(s("—","search-result-dash")),e.appendChild(s(this._searchResult.description(),"search-result-qualifier")),this.tooltip=this._searchResult.description(),this.listItemElement.appendChild(e);const t=document.createElement("span");function s(e,t){const s=document.createElement("span");return s.className=t,s.textContent=e,s}t.className="search-result-matches-count",t.textContent=""+this._searchResult.matchesCount(),o.setAccessibleName(t,ls`Matches Count ${this._searchResult.matchesCount()}`),this.listItemElement.appendChild(t),this.expanded&&this._updateMatchesUI()}_appendSearchMatches(s,i){const n=this._searchResult,r=this._searchConfig.queries(),a=[];for(let t=0;t<r.length;++t)a.push(e.createSearchRegex(r[t],!this._searchConfig.ignoreCase(),this._searchConfig.isRegex()));for(let e=s;e<i;++e){const s=n.matchLineContent(e).trim();let i=[];for(let e=0;e<a.length;++e)i=i.concat(this._regexMatchRanges(s,a[e]));const r=h.Linkifier.linkifyRevealable(n.matchRevealable(e),"");r.classList.add("search-match-link");const l=document.createElement("span");l.classList.add("search-match-line-number");const _=n.matchLabel(e);l.textContent=_,"number"!=typeof _||isNaN(_)?o.setAccessibleName(l,ls`${_}`):o.setAccessibleName(l,ls`Line ${_}`),r.appendChild(l);const u=this._createContentSpan(s,i);r.appendChild(u);const d=new c.TreeElement;this.appendChild(d),d.listItemElement.className="search-match",d.listItemElement.appendChild(r),d.listItemElement.addEventListener("keydown",s=>{isEnterKey(s)&&(s.consume(!0),t.reveal(n.matchRevealable(e)))}),d.tooltip=s}}_appendShowMoreMatchesElement(e){const t=this._searchResult.matchesCount()-e,i=s.UIString("Show %d more",t),n=new c.TreeElement(i);this.appendChild(n),n.listItemElement.classList.add("show-more-matches"),n.onselect=this._showMoreMatchesElementSelected.bind(this,n,e)}_createContentSpan(e,t){let s=0;t.length>0&&t[0].offset>20&&(s=15),e=e.substring(s,1e3+s),s&&(t=t.map(e=>new r.SourceRange(e.offset-s+1,e.length)),e="…"+e);const i=document.createElement("span");return i.className="search-match-content",i.textContent=e,o.setAccessibleName(i,e+" line"),l.highlightRangesWithStyleClass(i,t,"highlighted-match"),i}_regexMatchRanges(e,t){let s;t.lastIndex=0;const i=[];for(;t.lastIndex<e.length&&(s=t.exec(e));)i.push(new r.SourceRange(s.index,s[0].length));return i}_showMoreMatchesElementSelected(e,t){return this.removeChild(e),this._appendSearchMatches(t,this._searchResult.matchesCount()),!1}}var I=Object.freeze({__proto__:null,SearchResultsPane:x,matchesExpandedByDefault:R,matchesShownAtOnce:20,SearchResultsTreeElement:E});class w extends a.VBox{constructor(e){super(!0),this.setMinimumSize(0,40),this.registerRequiredCSS("search/searchView.css",{enableLegacyPatching:!0}),this._focusOnShow=!1,this._isIndexing=!1,this._searchId=1,this._searchMatchesCount=0,this._searchResultsCount=0,this._nonEmptySearchResultsCount=0,this._searchingView=null,this._notFoundView=null,this._searchConfig=null,this._pendingSearchConfig=null,this._searchResultsPane=null,this._progressIndicator=null,this._visiblePane=null,this.contentElement.classList.add("search-view"),this._searchPanelElement=this.contentElement.createChild("div","search-drawer-header"),this._searchResultsElement=this.contentElement.createChild("div"),this._searchResultsElement.className="search-results";const t=document.createElement("div");t.style.flex="auto",t.style.justifyContent="start",t.style.maxWidth="300px",this._search=_.HistoryInput.create(),this._search.addEventListener("keydown",e=>{this._onKeyDown(e)}),t.appendChild(this._search),this._search.placeholder=s.UIString("Search"),this._search.setAttribute("type","text"),this._search.setAttribute("results","0"),this._search.setAttribute("size","42"),o.setAccessibleName(this._search,ls`Search Query`);const n=new u.ToolbarItem(t),h=new u.Toolbar("search-toolbar",this._searchPanelElement);this._matchCaseButton=w._appendToolbarToggle(h,"Aa",s.UIString("Match Case")),this._regexButton=w._appendToolbarToggle(h,".*",s.UIString("Use Regular Expression")),h.appendToolbarItem(n);const r=new u.ToolbarButton(s.UIString("Refresh"),"largeicon-refresh"),a=new u.ToolbarButton(s.UIString("Clear"),"largeicon-clear");h.appendToolbarItem(r),h.appendToolbarItem(a),r.addEventListener(u.ToolbarButton.Events.Click,()=>this._onAction()),a.addEventListener(u.ToolbarButton.Events.Click,()=>{this._resetSearch(),this._onSearchInputClear()});const c=this.contentElement.createChild("div","search-toolbar-summary");this._searchMessageElement=c.createChild("div","search-message"),this._searchProgressPlaceholderElement=c.createChild("div","flex-centered"),this._searchResultsMessageElement=c.createChild("div","search-message"),this._advancedSearchConfig=i.Settings.instance().createLocalSetting(e+"SearchConfig",new m("",!0,!1).toPlainObject()),this._load(),this._searchScope=null}static _appendToolbarToggle(e,t,s){const i=new u.ToolbarToggle(s);return i.setText(t),i.addEventListener(u.ToolbarButton.Events.Click,()=>i.setToggled(!i.toggled())),e.appendToolbarItem(i),i}_buildSearchConfig(){return new m(this._search.value,!this._matchCaseButton.toggled(),this._regexButton.toggled())}async toggle(e,t){e&&(this._search.value=e),this.isShowing()?this.focus():this._focusOnShow=!0,this._initScope(),t?this._onAction():this._startIndexing()}createScope(){throw new Error("Not implemented")}_initScope(){this._searchScope=this.createScope()}wasShown(){this._focusOnShow&&(this.focus(),this._focusOnShow=!1)}_onIndexingFinished(){if(!this._progressIndicator)return;const e=!this._progressIndicator.isCanceled();if(this._progressIndicator.done(),this._progressIndicator=null,this._isIndexing=!1,this._indexingFinished(e),e||(this._pendingSearchConfig=null),!this._pendingSearchConfig)return;const t=this._pendingSearchConfig;this._pendingSearchConfig=null,this._innerStartSearch(t)}_startIndexing(){this._isIndexing=!0,this._progressIndicator&&this._progressIndicator.done(),this._progressIndicator=new d.ProgressIndicator,this._searchMessageElement.textContent=s.UIString("Indexing…"),this._progressIndicator.show(this._searchProgressPlaceholderElement),this._searchScope&&this._searchScope.performIndexing(new n.ProgressProxy(this._progressIndicator,this._onIndexingFinished.bind(this)))}_onSearchInputClear(){this._search.value="",this._save(),this.focus()}_onSearchResult(e,t){e===this._searchId&&this._progressIndicator&&(this._progressIndicator&&this._progressIndicator.isCanceled()?this._onIndexingFinished():(this._addSearchResult(t),t.matchesCount()&&(this._searchResultsPane||(this._searchResultsPane=new x(this._searchConfig),this._showPane(this._searchResultsPane)),this._searchResultsPane.addSearchResult(t))))}_onSearchFinished(e,t){e===this._searchId&&this._progressIndicator&&(this._searchResultsPane||this._nothingFound(),this._searchFinished(t),this._searchConfig=null,o.alert(this._searchMessageElement.textContent+" "+this._searchResultsMessageElement.textContent,this._searchMessageElement))}async _startSearch(e){this._resetSearch(),++this._searchId,this._initScope(),this._isIndexing||this._startIndexing(),this._pendingSearchConfig=e}_innerStartSearch(e){this._searchConfig=e,this._progressIndicator&&this._progressIndicator.done(),this._progressIndicator=new d.ProgressIndicator,this._searchStarted(this._progressIndicator),this._searchScope&&this._searchScope.performSearch(e,this._progressIndicator,this._onSearchResult.bind(this,this._searchId),this._onSearchFinished.bind(this,this._searchId))}_resetSearch(){this._stopSearch(),this._showPane(null),this._searchResultsPane=null,this._clearSearchMessage()}_clearSearchMessage(){this._searchMessageElement.textContent="",this._searchResultsMessageElement.textContent=""}_stopSearch(){this._progressIndicator&&!this._isIndexing&&this._progressIndicator.cancel(),this._searchScope&&this._searchScope.stopSearch(),this._searchConfig=null}_searchStarted(e){this._resetCounters(),this._searchingView||(this._searchingView=new g.EmptyWidget(s.UIString("Searching…"))),this._showPane(this._searchingView),this._searchMessageElement.textContent=s.UIString("Searching…"),e.show(this._searchProgressPlaceholderElement),this._updateSearchResultsMessage()}_indexingFinished(e){this._searchMessageElement.textContent=e?"":s.UIString("Indexing interrupted.")}_updateSearchResultsMessage(){this._searchMatchesCount&&this._searchResultsCount?1===this._searchMatchesCount&&1===this._nonEmptySearchResultsCount?this._searchResultsMessageElement.textContent=s.UIString("Found 1 matching line in 1 file."):this._searchMatchesCount>1&&1===this._nonEmptySearchResultsCount?this._searchResultsMessageElement.textContent=s.UIString("Found %d matching lines in 1 file.",this._searchMatchesCount):this._searchResultsMessageElement.textContent=s.UIString("Found %d matching lines in %d files.",this._searchMatchesCount,this._nonEmptySearchResultsCount):this._searchResultsMessageElement.textContent=""}_showPane(e){this._visiblePane&&this._visiblePane.detach(),e&&e.show(this._searchResultsElement),this._visiblePane=e}_resetCounters(){this._searchMatchesCount=0,this._searchResultsCount=0,this._nonEmptySearchResultsCount=0}_nothingFound(){this._notFoundView||(this._notFoundView=new g.EmptyWidget(s.UIString("No matches found."))),this._showPane(this._notFoundView),this._searchResultsMessageElement.textContent=s.UIString("No matches found.")}_addSearchResult(e){const t=e.matchesCount();this._searchMatchesCount+=t,this._searchResultsCount++,t&&this._nonEmptySearchResultsCount++,this._updateSearchResultsMessage()}_searchFinished(e){this._searchMessageElement.textContent=e?s.UIString("Search finished."):s.UIString("Search interrupted.")}focus(){this._search.focus(),this._search.select()}willHide(){this._stopSearch()}_onKeyDown(e){switch(e.keyCode){case p.Keys.Enter.code:this._onAction()}}_save(){this._advancedSearchConfig.set(this._buildSearchConfig().toPlainObject())}_load(){const e=m.fromPlainObject(this._advancedSearchConfig.get());this._search.value=e.query(),this._matchCaseButton.setToggled(!e.ignoreCase()),this._regexButton.setToggled(e.isRegex())}_onAction(){o.alert(" ",this._searchMessageElement);const e=this._buildSearchConfig();e.query()&&e.query().length&&(this._save(),this._startSearch(e))}}var b=Object.freeze({__proto__:null,SearchView:w});export{f as SearchConfig,I as SearchResultsPane,b as SearchView};
