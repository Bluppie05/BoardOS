import{Throttler as e}from"../common/common.js";import{FrameManager as t,OverlayModel as i,PageResourceLoader as s}from"../sdk/sdk.js";import{Widget as r,UIUtils as o,Toolbar as a}from"../ui/ui.js";import{DataGrid as l,SortableDataGrid as n}from"../data_grid/data_grid.js";import{InspectorFrontendHost as h}from"../host/host.js";import{ls as d}from"../platform/platform.js";import{TextRange as c}from"../text_utils/text_utils.js";class u extends r.VBox{constructor(e){super(!0),this._nodeForItem=new Map,this._isVisibleFilter=e,this._highlightRegExp=null,this.registerRequiredCSS("developer_resources/developerResourcesListView.css",{enableLegacyPatching:!0});const t=[{id:"status",title:d`Status`,width:"60px",fixedWidth:!0,sortable:!0},{id:"url",title:d`URL`,width:"250px",fixedWidth:!1,sortable:!0},{id:"initiator",title:d`Initiator`,width:"80px",fixedWidth:!1,sortable:!0},{id:"size",title:d`Total Bytes`,width:"80px",fixedWidth:!0,sortable:!0,align:l.Align.Right},{id:"errorMessage",title:d`Error`,width:"200px",fixedWidth:!1,sortable:!0}];this._dataGrid=new n.SortableDataGrid({displayName:d`Developer Resources`,columns:t,editCallback:void 0,refreshCallback:void 0,deleteCallback:void 0}),this._dataGrid.setResizeMethod(l.ResizeMethod.Last),this._dataGrid.element.classList.add("flex-auto"),this._dataGrid.addEventListener(l.Events.SortingChanged,this._sortingChanged,this),this._dataGrid.setRowContextMenuCallback(this._populateContextMenu.bind(this));const i=this._dataGrid.asWidget();i.show(this.contentElement),this.setDefaultFocusedChild(i)}_populateContextMenu(e,t){const i=t.item;e.clipboardSection().appendItem(d`Copy URL`,()=>{h.InspectorFrontendHostInstance.copyText(i.url)}),i.initiator.initiatorUrl&&e.clipboardSection().appendItem(d`Copy initiator URL`,()=>{h.InspectorFrontendHostInstance.copyText(i.initiator.initiatorUrl)})}update(e){let t=!1;const i=this._dataGrid.rootNode();for(const s of e){let e=this._nodeForItem.get(s);e?this._isVisibleFilter(e.item)&&(t=e._refreshIfNeeded()||t):(e=new g(s),this._nodeForItem.set(s,e),this._isVisibleFilter(e.item)&&(i.appendChild(e),t=!0))}t&&this._sortingChanged()}reset(){this._nodeForItem.clear(),this._dataGrid.rootNode().removeChildren()}updateFilterAndHighlight(e){this._highlightRegExp=e;let t=!1;for(const e of this._nodeForItem.values()){const i=this._isVisibleFilter(e.item),s=!!e.parent;i&&e._setHighlight(this._highlightRegExp),i!==s&&(t=!0,i?this._dataGrid.rootNode().appendChild(e):e.remove())}t&&this._sortingChanged()}_sortingChanged(){const e=this._dataGrid.sortColumnId();if(!e)return;const t=g.sortFunctionForColumn(e);t&&this._dataGrid.sortNodes(t,!this._dataGrid.isSortOrderAscending())}}class g extends n.SortableDataGridNode{constructor(e){super(),this.item=e,this._highlightRegExp=null}_setHighlight(e){this._highlightRegExp!==e&&(this._highlightRegExp=e,this.refresh())}_refreshIfNeeded(){return this.refresh(),!0}createCell(e){const s=this.createTD(e);switch(e){case"url":{s.title=this.item.url;const t=s.createChild("div","url-outer"),i=t.createChild("div","url-prefix"),r=t.createChild("div","url-suffix"),o=/^(.*)(\/[^/]*)$/.exec(this.item.url);i.textContent=o?o[1]:this.item.url,r.textContent=o?o[2]:"",this._highlightRegExp&&this._highlight(t,this.item.url),this.setCellAccessibleName(this.item.url,s,e);break}case"initiator":{const r=this.item.initiator.initiatorUrl||"";s.textContent=r,s.title=r,this.setCellAccessibleName(r,s,e),s.onmouseenter=()=>{const e=t.FrameManager.instance().getFrame(this.item.initiator.frameId||"");e&&e.highlight()},s.onmouseleave=()=>i.OverlayModel.hideDOMNodeHighlight();break}case"status":null===this.item.success?s.textContent=d`pending`:s.textContent=this.item.success?d`success`:d`failure`;break;case"size":{const t=this.item.size;if(null!==t){s.createChild("span").textContent=Number.withThousandsSeparator(t);const i=1===t?d`1 byte`:d`${t} bytes`;this.setCellAccessibleName(i,s,e)}break}case"errorMessage":s.classList.add("error-message"),this.item.errorMessage&&(s.textContent=this.item.errorMessage,this._highlightRegExp&&this._highlight(s,this.item.errorMessage))}return s}_highlight(e,t){if(!this._highlightRegExp)return;const i=this._highlightRegExp.exec(t);if(!i||!i.length)return;const s=new c.SourceRange(i.index,i[0].length);o.highlightRangesWithStyleClass(e,[s],"filter-highlight")}static sortFunctionForColumn(e){const t=e=>null===e?-1:Number(e);switch(e){case"url":return(e,t)=>e.item.url.localeCompare(t.item.url);case"status":return(e,i)=>t(e.item.success)-t(i.item.success);case"size":return(e,i)=>t(e.item.size)-t(i.item.size);case"initiator":return(e,t)=>(e.item.initiator.initiatorUrl||"").localeCompare(t.item.initiator.initiatorUrl||"");case"errorMessage":return(e,t)=>(e.item.errorMessage||"").localeCompare(t.item.errorMessage||"");default:return console.assert(!1,"Unknown sort field: "+e),null}}}class p extends r.VBox{constructor(){super(!0),this.registerRequiredCSS("developer_resources/developerResourcesView.css",{enableLegacyPatching:!0});const t=this.contentElement.createChild("div","developer-resource-view-toolbar-container"),i=new a.Toolbar("developer-resource-view-toolbar",t);this._textFilterRegExp=null;this._filterInput=new a.ToolbarInput(ls`Enter text to search the URL and Error columns`,"",1),this._filterInput.addEventListener(a.ToolbarInput.Event.TextChanged,this._onFilterChanged,this),i.appendToolbarItem(this._filterInput);const r=s.getLoadThroughTargetSetting(),o=new a.ToolbarSettingCheckbox(r,ls`Load HTTP(S) developer resources through the inspected target`,ls`Enable loading through target`);i.appendToolbarItem(o),this._coverageResultsElement=this.contentElement.createChild("div","developer-resource-view-results"),this._listView=new u(this._isVisible.bind(this)),this._listView.show(this._coverageResultsElement),this._statusToolbarElement=this.contentElement.createChild("div","developer-resource-view-toolbar-summary"),this._statusMessageElement=this._statusToolbarElement.createChild("div","developer-resource-view-message"),this._throttler=new e.Throttler(100),this._loader=s.PageResourceLoader.instance(),this._loader.addEventListener(s.Events.Update,this._onUpdate,this),this._onUpdate()}_onUpdate(){this._throttler.schedule(this._update.bind(this))}async _update(){this._listView.reset(),this._listView.update(this._loader.getResourcesLoaded().values()),this._updateStats()}_updateStats(){const{loading:e,resources:t}=this._loader.getNumberOfResources();this._statusMessageElement.textContent=e>0?`${t} resources, ${e} currently loading`:t+" resources"}_isVisible(e){return!this._textFilterRegExp||this._textFilterRegExp.test(e.url)||this._textFilterRegExp.test(e.errorMessage||"")}_onFilterChanged(){if(!this._listView)return;const e=this._filterInput.value();this._textFilterRegExp=e?createPlainTextSearchRegex(e,"i"):null,this._listView.updateFilterAndHighlight(this._textFilterRegExp),this._updateStats()}}var m=Object.freeze({__proto__:null,DeveloperResourcesView:p});export{m as DeveloperResourcesView};
