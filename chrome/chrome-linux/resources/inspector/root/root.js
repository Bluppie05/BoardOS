const originalConsole=console,originalAssert=console.assert,queryParamsObject=new URLSearchParams(location.search);let importScriptPathPrefix,runtimePlatform="",l10nCallback,runtimeInstance;function getRemoteBase(e=self.location.toString()){const t=new URL(e),s=t.searchParams.get("remoteBase");if(!s)return null;const n=/\/serve_file\/(@[0-9a-zA-Z]+)\/?$/.exec(s);return n?{base:`${t.origin}/remote/serve_file/${n[1]}/`,version:n[1]}:null}const constructedInstances=new WeakMap;class Runtime{constructor(e){this._modules=[],this._modulesMap={},this._extensions=[],this._cachedTypeClasses={},this._descriptorsMap={};for(const t of e)this._registerModule(t)}static instance(e={forceNew:null,moduleDescriptors:null}){const{forceNew:t,moduleDescriptors:s}=e;if(!runtimeInstance||t){if(!s)throw new Error("Unable to create settings: targetManager and workspace must be provided: "+(new Error).stack);runtimeInstance=new Runtime(s)}return runtimeInstance}static removeInstance(){runtimeInstance=void 0}loadBinaryResourcePromise(e){return internalLoadResourcePromise(e,!0)}loadTextResourcePromise(e){return internalLoadResourcePromise(e,!1)}static normalizePath(e){if(-1===e.indexOf("..")&&-1===e.indexOf("."))return e;const t=[],s=e.split("/");for(const e of s)"."!==e&&(".."===e?t.pop():e&&t.push(e));let n=t.join("/");return"/"===n[n.length-1]||("/"===e[0]&&n&&(n="/"+n),"/"!==e[e.length-1]&&"."!==s[s.length-1]&&".."!==s[s.length-1]||(n+="/")),n}static queryParam(e){return queryParamsObject.get(e)}static _experimentsSetting(){try{return JSON.parse(self.localStorage&&self.localStorage.experiments?self.localStorage.experiments:"{}")}catch(e){return console.error("Failed to parse localStorage['experiments']"),{}}}static _assert(e,t){e||originalAssert.call(originalConsole,e,t+" "+(new Error).stack)}static setPlatform(e){runtimePlatform=e}static _isDescriptorEnabled(e){const t=e.experiment;if("*"===t)return!0;if(t&&t.startsWith("!")&&experiments.isEnabled(t.substring(1)))return!1;if(t&&!t.startsWith("!")&&!experiments.isEnabled(t))return!1;const s=e.condition;return!(s&&!s.startsWith("!")&&!Runtime.queryParam(s))&&!(s&&s.startsWith("!")&&Runtime.queryParam(s.substring(1)))}static resolveSourceURL(e){let t=self.location.href;return self.location.search&&(t=t.replace(self.location.search,"")),t=t.substring(0,t.lastIndexOf("/")+1)+e,"\n/*# sourceURL="+t+" */"}static setL10nCallback(e){l10nCallback=e}module(e){return this._modulesMap[e]}_registerModule(e){const t=new Module(this,e);this._modules.push(t),this._modulesMap[e.name]=t}loadModulePromise(e){return this._modulesMap[e]._loadPromise()}loadAutoStartModules(e){const t=[];for(const s of e)t.push(this.loadModulePromise(s));return Promise.all(t)}_checkExtensionApplicability(e,t){if(!t)return!1;const s=e.descriptor().contextTypes;if(!s)return!0;for(let e=0;e<s.length;++e){const n=this._resolve(s[e]);if(!!n&&t(n))return!0}return!1}isExtensionApplicableToContext(e,t){return!t||this._checkExtensionApplicability(e,(function(e){return t instanceof e}))}isExtensionApplicableToContextTypes(e,t){if(!e.descriptor().contextTypes)return!0;let s=null;return t&&(s=e=>t.has(e)),this._checkExtensionApplicability(e,s)}extensions(e,t,s){return this._extensions.filter((function(s){if(s._type!==e&&s._typeClass()!==e)return!1;if(!s.enabled())return!1;return!t||s.isApplicable(t)})).sort(s?function(e,t){const s=e.title()||"",n=t.title()||"";return s.localeCompare(n)}:function(e,t){const s=e.descriptor().order||0,n=t.descriptor().order||0;return s-n})}extension(e,t){return this.extensions(e,t)[0]||null}allInstances(e,t){return Promise.all(this.extensions(e,t).map(e=>e.instance()))}_resolve(e){if(!this._cachedTypeClasses[e]){const t=e.split(".");let s=self;for(let e=0;s&&e<t.length;++e)s=s[t[e]];s&&(this._cachedTypeClasses[e]=s)}return this._cachedTypeClasses[e]||null}sharedInstance(e){const t=Object.getOwnPropertyDescriptor(e,"instance");if(t){const e=t.value;if(e instanceof Function)return e.call(null)}let s=constructedInstances.get(e);return s||(s=new e,constructedInstances.set(e,s)),s}}class ModuleDescriptor{constructor(){this.name,this.extensions,this.dependencies,this.scripts,this.modules,this.resources,this.condition,this.experiment}}class RuntimeExtensionDescriptor{constructor(){this.type,this.className,this.factoryName,this.contextTypes,this.bindings,this.order,this.extension,this.actionId,this.experiment,this.condition,this.settingName,this.settingType,this.defaultValue,this.storageType,this.userActionCondition,this.startPage,this.name,this.destination,this.color,this.prefix,this.decoratorType,this.category,this.tags,this.reloadRequired,this.id,this.location,this.title,this.options,this.settings,this.device,this.viewId,this.persistence,this.setting,this.name}}let Option;class Module{constructor(e,t){this._manager=e,this._descriptor=t,this._name=t.name,this._extensions=[],this._extensionsByClassName=new Map;const s=t.extensions;for(let e=0;s&&e<s.length;++e){const t=new Extension(this,s[e]);this._manager._extensions.push(t),this._extensions.push(t)}this._loadedForTest=!1}name(){return this._name}enabled(){return Runtime._isDescriptorEnabled(this._descriptor)}resource(e){const t=this._name+"/"+e,s=cachedResources.get(t);if(!s)throw new Error(t+" not preloaded. Check module.json");return s}_loadPromise(){if(!this.enabled())return Promise.reject(new Error("Module "+this._name+" is not enabled"));if(this._pendingLoadPromise)return this._pendingLoadPromise;const e=this._descriptor.dependencies,t=[];for(let s=0;e&&s<e.length;++s)t.push(this._manager._modulesMap[e[s]]._loadPromise());return this._pendingLoadPromise=Promise.all(t).then(this._loadModules.bind(this)).then(()=>(this._loadedForTest=!0,this._loadedForTest)),this._pendingLoadPromise}async _loadModules(){const legacyFileName=this._name+"-legacy.js",moduleFileName=this._name+"_module.js",entrypointFileName=this._name+".js";this._descriptor.modules.includes(moduleFileName)&&await eval(`import('../${this._name}/${moduleFileName}')`);const fileName=this._descriptor.modules.includes(legacyFileName)?legacyFileName:entrypointFileName;await eval(`import('../${this._name}/${fileName}')`)}_modularizeURL(e){return Runtime.normalizePath(this._name+"/"+e)}fetchResource(e){return loadResourcePromise(getResourceURL(this._modularizeURL(e)))}substituteURL(e){return e.replace(/@url\(([^\)]*?)\)/g,function(e,t){return importScriptPathPrefix+this._modularizeURL(t)}.bind(this))}}class Extension{constructor(e,t){this._module=e,this._descriptor=t,this._type=t.type,this._hasTypeClass="@"===this._type.charAt(0),this._className=t.className||null,this._factoryName=t.factoryName||null}descriptor(){return this._descriptor}module(){return this._module}enabled(){return this._module.enabled()&&Runtime._isDescriptorEnabled(this.descriptor())}_typeClass(){return this._hasTypeClass?this._module._manager._resolve(this._type.substring(1)):null}isApplicable(e){return this._module._manager.isExtensionApplicableToContext(this,e)}instance(){return this._module._loadPromise().then(this._createInstance.bind(this))}canInstantiate(){return!(!this._className&&!this._factoryName)}_createInstance(){const e=this._className||this._factoryName;if(!e)throw new Error("Could not instantiate extension with no class");const t=self.eval(e);if(!(t instanceof Function))throw new Error("Could not instantiate: "+e);return this._className?this._module._manager.sharedInstance(t):new t(this)}title(){const e=this._descriptor["title-"+runtimePlatform]||this._descriptor.title;return e&&l10nCallback?l10nCallback(e):e}hasContextType(e){const t=this.descriptor().contextTypes;if(!t)return!1;for(let s=0;s<t.length;++s)if(e===this._module._manager._resolve(t[s]))return!0;return!1}}class ExperimentsSupport{constructor(){this._experiments=[],this._experimentNames=new Set,this._enabledTransiently=new Set,this._enabledByDefault=new Set,this._serverEnabled=new Set}allConfigurableExperiments(){const e=[];for(const t of this._experiments)this._enabledTransiently.has(t.name)||e.push(t);return e}enabledExperiments(){return this._experiments.filter(e=>e.isEnabled())}_setExperimentsSetting(e){self.localStorage&&(self.localStorage.experiments=JSON.stringify(e))}register(e,t,s){Runtime._assert(!this._experimentNames.has(e),"Duplicate registration of experiment "+e),this._experimentNames.add(e),this._experiments.push(new Experiment(this,e,t,!!s))}isEnabled(e){return this._checkExperiment(e),!1!==Runtime._experimentsSetting()[e]&&(!(!this._enabledTransiently.has(e)&&!this._enabledByDefault.has(e))||(!!this._serverEnabled.has(e)||!!Runtime._experimentsSetting()[e]))}setEnabled(e,t){this._checkExperiment(e);const s=Runtime._experimentsSetting();s[e]=t,this._setExperimentsSetting(s)}enableExperimentsTransiently(e){for(const t of e)this._checkExperiment(t),this._enabledTransiently.add(t)}enableExperimentsByDefault(e){for(const t of e)this._checkExperiment(t),this._enabledByDefault.add(t)}setServerEnabledExperiments(e){for(const t of e)this._checkExperiment(t),this._serverEnabled.add(t)}enableForTest(e){this._checkExperiment(e),this._enabledTransiently.add(e)}clearForTest(){this._experiments=[],this._experimentNames.clear(),this._enabledTransiently.clear(),this._enabledByDefault.clear(),this._serverEnabled.clear()}cleanUpStaleExperiments(){const e=Runtime._experimentsSetting(),t={};for(const{name:s}of this._experiments)if(e.hasOwnProperty(s)){const n=e[s];(n||this._enabledByDefault.has(s))&&(t[s]=n)}this._setExperimentsSetting(t)}_checkExperiment(e){Runtime._assert(this._experimentNames.has(e),"Unknown experiment "+e)}}class Experiment{constructor(e,t,s,n){this.name=t,this.title=s,this.unstable=n,this._experiments=e}isEnabled(){return this._experiments.isEnabled(this.name)}setEnabled(e){this._experiments.setEnabled(this.name,e)}}function internalLoadResourcePromise(e,t){return new Promise((function(s,n){const i=new XMLHttpRequest;i.open("GET",e,!0),t&&(i.responseType="arraybuffer");i.onreadystatechange=function(r){if(i.readyState!==XMLHttpRequest.DONE)return;const{response:o}=r.target,a=t?(new TextDecoder).decode(o):o,l=/^HTTP\/1.1 404/.test(a)?404:i.status;-1===[0,200,304].indexOf(l)?n(new Error("While loading from url "+e+" server responded with a status of "+l)):s(o)},i.send(null)}))}function loadResourcePromise(e){return internalLoadResourcePromise(e,!1)}function getResourceURL(e,t){const s=(t||importScriptPathPrefix)+e,n=s.indexOf("://")+3;let i=s.indexOf("/",n);return-1===i&&(i=s.length),s.substring(0,i)+Runtime.normalizePath(s.substring(i))}!function(){const e=self.location?self.location.origin+self.location.pathname:"";importScriptPathPrefix=e.substring(0,e.lastIndexOf("/")+1)}();const experiments=new ExperimentsSupport,cachedResources=new Map;let appStartedPromiseCallback;globalThis.EXPORTED_CACHED_RESOURCES_ONLY_FOR_LIGHTHOUSE=cachedResources;const appStarted=new Promise(e=>{appStartedPromiseCallback=e});var Runtime$1=Object.freeze({__proto__:null,getRemoteBase:getRemoteBase,Runtime:Runtime,ModuleDescriptor:ModuleDescriptor,RuntimeExtensionDescriptor:RuntimeExtensionDescriptor,Option:Option,Module:Module,Extension:Extension,ExperimentsSupport:ExperimentsSupport,loadResourcePromise:loadResourcePromise,experiments:experiments,cachedResources:cachedResources,get appStartedPromiseCallback(){return appStartedPromiseCallback},appStarted:appStarted});export{Runtime$1 as Runtime};
