import{DebuggerWorkspaceBinding,CSSWorkspaceBinding}from"../bindings/bindings.js";import{InspectorBackend}from"../protocol_client/protocol_client.js";import{ViewManager,InspectorView,SyntaxHighlighter,UIUtils}from"../ui/ui.js";import{Workspace}from"../workspace/workspace.js";function isDebugTest(){return!self.testRunner||!!Root.Runtime.queryParam("debugFrontend")}function _printDevToolsConsole(){isDebugTest()||(console.log=(...e)=>{addResult("log: "+e)},console.error=(...e)=>{addResult("error: "+e)},console.info=(...e)=>{addResult("info: "+e)},console.assert=(e,...t)=>{e||addResult("ASSERTION FAILURE: "+t.join(" "))})}self.onerror=(e,t,n,r,o)=>{addResult("TEST ENDED IN ERROR: "+o.stack),completeTest()},self.addEventListener("unhandledrejection",e=>{addResult("PROMISE FAILURE: "+e.reason.stack),completeTest()}),_printDevToolsConsole();let _results=[],_innerAddResult=e=>{_results.push(String(e))};function setInnerResult(e){_innerAddResult=e}function addResult(e){_innerAddResult(e)}let completed=!1,_innerCompleteTest=()=>{completed||(completed=!0,flushResults(),self.testRunner.notifyDone())},_resolveOnFinishInits;function setInnerCompleteTest(e){_innerCompleteTest=e}function completeTest(){_innerCompleteTest()}function flushResults(){Array.prototype.forEach.call(document.documentElement.childNodes,e=>e.remove());const e=document.createElement("div");e.style&&(e.style.whiteSpace="pre",e.style.height="10px",e.style.overflow="hidden"),document.documentElement.appendChild(e);for(let t=0;t<_results.length;t++)e.appendChild(document.createTextNode(_results[t])),e.appendChild(document.createElement("br"));_results=[]}function addResults(e){if(e)for(let t=0,n=e.length;t<n;++t)addResult(e[t])}function runTests(e){!function t(){const n=e.shift();if(!n)return void completeTest();addResult("\ntest: "+n.name);let r=n();r instanceof Promise||(r=Promise.resolve());r.then(t)}()}function addSniffer(e,t,n,r){n=safeWrap(n);const o=e[t];if("function"!=typeof o)throw new Error("Cannot find method to override: "+t);e[t]=function(a){let s;try{s=o.apply(this,arguments)}finally{r||(e[t]=o)}try{Array.prototype.push.call(arguments,s),n.apply(this,arguments)}catch(e){throw new Error("Exception in overriden method '"+t+"': "+e)}return s}}function addSnifferPromise(e,t){return new Promise((function(n,r){const o=e[t];"function"==typeof o?e[t]=function(a){let s;try{s=o.apply(this,arguments)}finally{e[t]=o}try{Array.prototype.push.call(arguments,s),n.apply(this,arguments)}catch(e){r("Exception in overridden method '"+t+"': "+e),completeTest()}return s}:r("Cannot find method to override: "+t)}))}async function loadModule(e){const t=new Promise(e=>{_resolveOnFinishInits=e});if(await self.runtime.loadModulePromise(e),_pendingInits)return t}function showPanel(e){return ViewManager.ViewManager.instance().showView(e)}function createKeyEvent(e,t,n,r,o){return new KeyboardEvent("keydown",{key:e,bubbles:!0,cancelable:!0,ctrlKey:!!t,altKey:!!n,shiftKey:!!r,metaKey:!!o})}function safeWrap(e,t){return function(){if(!e)return;const n=this;try{return e.apply(n,arguments)}catch(n){addResult("Exception while running: "+e+"\n"+(n.stack||n)),t?safeWrap(t)():completeTest()}}}function safeAsyncWrap(e){return async function(){if(!e)return;const t=this;try{return await e.apply(t,arguments)}catch(t){addResult("Exception while running: "+e+"\n"+(t.stack||t)),completeTest()}}}function textContentWithLineBreaks(e){function t(t){let n=0;for(;t&&t!==e;)"OL"!==t.nodeName||t.classList&&t.classList.contains("object-properties-section")||++n,t=t.parentNode;return Array(4*n+1).join(" ")}let n="",r=e,o=!1;for(;r.traverseNextNode(e);)if(r=r.traverseNextNode(e),r.nodeType===Node.TEXT_NODE)n+=r.nodeValue;else if("LI"===r.nodeName||"TR"===r.nodeName)o?o=!1:n+="\n"+t(r);else{if("STYLE"===r.nodeName){r=r.traverseNextNode(e);continue}r.classList&&r.classList.contains("object-properties-section")&&(o=!0)}return n}function textContentWithoutStyles(e){let t="",n=e;for(;n.traverseNextNode(e);)n=n.traverseNextNode(e),n.nodeType===Node.TEXT_NODE?t+=n.nodeValue:"STYLE"===n.nodeName&&(n=n.traverseNextNode(e));return t}async function evaluateInPageRemoteObject(e){const t=await _evaluateInPage(e);return TestRunner.runtimeModel.createRemoteObject(t.result)}async function evaluateInPage(e,t){const n=await _evaluateInPage(e);safeWrap(t)(n.result.value,n.exceptionDetails)}self.TestRunner=self.TestRunner||{};let _evaluateInPageCounter=0;async function _evaluateInPage(e){const t=(new Error).stack.split("at "),n=Root.Runtime.queryParam("test"),r=t.reduce((e,t)=>t.includes(n)?t:e,t[t.length-2]).trim().split("/"),o=r[r.length-1].slice(0,-1).split(":"),a=o[0],s=`test://evaluations/${_evaluateInPageCounter++}/`+a,i=parseInt(o[1],10);-1===(e="\n".repeat(i-1)+e).indexOf("sourceURL=")&&(e+="//# sourceURL="+s);const u=await TestRunner.RuntimeAgent.invoke_evaluate({expression:e,objectGroup:"console"}),d=u[InspectorBackend.ProtocolError];return d?(addResult("Error: "+d),void completeTest()):u}async function evaluateInPageAnonymously(e,t){const n=await TestRunner.RuntimeAgent.invoke_evaluate({expression:e,objectGroup:"console",userGesture:t});if(!n[InspectorBackend.ProtocolError])return n.result.value;addResult("Error: "+(n.exceptionDetails&&n.exceptionDetails.text||"exception from evaluateInPageAnonymously.")),completeTest()}function evaluateInPagePromise(e){return new Promise(t=>evaluateInPage(e,t))}async function evaluateInPageAsync(e){const t=await TestRunner.RuntimeAgent.invoke_evaluate({expression:e,objectGroup:"console",includeCommandLineAPI:!1,awaitPromise:!0}),n=t[InspectorBackend.ProtocolError];if(!n&&!t.exceptionDetails)return t.result.value;addResult("Error: "+(n||t.exceptionDetails&&t.exceptionDetails.text||"exception while evaluation in page.")),completeTest()}function callFunctionInPageAsync(e,t){return evaluateInPageAsync(e+"("+(t=t||[]).map(e=>JSON.stringify(e)).join(",")+")")}function evaluateInPageWithTimeout(e,t){evaluateInPageAnonymously("setTimeout(unescape('"+escape(e)+"'), 1)",t)}function evaluateFunctionInOverlay(e,t){const n='internals.evaluateInInspectorOverlay("(" + '+e+' + ")()")';TestRunner.runtimeModel.executionContexts()[0].evaluate({expression:n,objectGroup:"",includeCommandLineAPI:!1,silent:!1,returnByValue:!0,generatePreview:!1},!1,!1).then(e=>{t(e.object.value)})}function check(e,t){e||addResult("FAIL: "+t)}function deprecatedRunAfterPendingDispatches(e){ProtocolClient.test.deprecatedRunAfterPendingDispatches(e)}function loadHTML(e){if(!e.includes("<base")){const t=/(<!DOCTYPE.*?>)/i,n=`<base href="${url()}">`;e=e.match(t)?e.replace(t,"$1"+n):n+e}return evaluateInPageAnonymously(`document.write(\`${e=e.replace(/'/g,"\\'").replace(/\n/g,"\\n")}\`);document.close();`)}function addScriptTag(e){return evaluateInPageAsync(`\n    (function(){\n      let script = document.createElement('script');\n      script.src = '${e}';\n      document.head.append(script);\n      return new Promise(f => script.onload = f);\n    })();\n  `)}function addStylesheetTag(e){return evaluateInPageAsync(`\n    (function(){\n      const link = document.createElement('link');\n      link.rel = 'stylesheet';\n      link.href = '${e}';\n      link.onload = onload;\n      document.head.append(link);\n      let resolve;\n      const promise = new Promise(r => resolve = r);\n      function onload() {\n        // TODO(chenwilliam): It shouldn't be necessary to force\n        // style recalc here but some tests rely on it.\n        window.getComputedStyle(document.body).color;\n        resolve();\n      }\n      return promise;\n    })();\n  `)}function addHTMLImport(e){return evaluateInPageAsync(`\n    (function(){\n      const link = document.createElement('link');\n      link.rel = 'import';\n      link.href = '${e}';\n      const promise = new Promise(r => link.onload = r);\n      document.body.append(link);\n      return promise;\n    })();\n  `)}function addIframe(e,t={}){return t.id=t.id||"",t.name=t.name||"",evaluateInPageAsync(`\n    (function(){\n      const iframe = document.createElement('iframe');\n      iframe.src = '${e}';\n      iframe.id = '${t.id}';\n      iframe.name = '${t.name}';\n      document.body.appendChild(iframe);\n      return new Promise(f => iframe.onload = f);\n    })();\n  `)}let _pendingInits=0;async function deprecatedInitAsync(e){_pendingInits++,await TestRunner.RuntimeAgent.invoke_evaluate({expression:e,objectGroup:"console"}),_pendingInits--,_pendingInits||_resolveOnFinishInits()}function markStep(e){addResult("\nRunning: "+e)}function startDumpingProtocolMessages(){ProtocolClient.test.dumpProtocol=self.testRunner.logToStderr.bind(self.testRunner)}function addScriptForFrame(e,t,n){t+="\n//# sourceURL="+e;const r=TestRunner.runtimeModel.executionContexts().find(e=>e.frameId===n.id);TestRunner.RuntimeAgent.evaluate(t,"console",!1,!1,r.id)}const formatters={formatAsTypeName:e=>"<"+typeof e+">",formatAsTypeNameOrNull:e=>null===e?"null":formatters.formatAsTypeName(e),formatAsRecentTime(e){if("object"!=typeof e||!(e instanceof Date))return formatters.formatAsTypeName(e);const t=Date.now()-e;return 0<=t&&t<18e5?"<plausible>":e},formatAsURL(e){if(!e)return e;const t=e.lastIndexOf("devtools/");return t<0?e:".../"+e.substr(t)},formatAsDescription:e=>e?'"'+e.replace(/^function [gs]et /,"function ")+'"':e};function addObject(e,t,n,r){n=n||"",addResult((r=r||n)+"{");const o=Object.keys(e);o.sort();for(let r=0;r<o.length;++r){const a=o[r];if(!e.hasOwnProperty(a))continue;const s="    "+n+a+" : ",i=e[a];if(t&&t[a]){const e=t[a];if("skip"!==e){addResult(s+(0,formatters[e])(i))}}else dump(i,t,"    "+n,s)}addResult(n+"}")}function addArray(e,t,n,r){n=n||"",addResult((r=r||n)+"[");for(let r=0;r<e.length;++r)dump(e[r],t,n+"    ");addResult(n+"]")}function dumpDeepInnerHTML(e){!function e(t,n){const r=[];if(n.nodeType===Node.TEXT_NODE)return void(n.parentElement&&"STYLE"===n.parentElement.nodeName||addResult(n.nodeValue));r.push("<"+n.nodeName);const o=n.attributes;for(let e=0;o&&e<o.length;++e)r.push(o[e].name+"="+o[e].value);r.push(">"),addResult(t+r.join(" "));for(let r=n.firstChild;r;r=r.nextSibling)e(t+"    ",r);n.shadowRoot&&e(t+"    ",n.shadowRoot),addResult(t+"</"+n.nodeName+">")}("",e)}function deepTextContent(e){if(!e)return"";if(e.nodeType===Node.TEXT_NODE&&e.nodeValue)return e.parentElement&&"STYLE"===e.parentElement.nodeName?"":e.nodeValue;let t="";const n=e.childNodes;for(let e=0;e<n.length;++e)t+=deepTextContent(n[e]);return e.shadowRoot&&(t+=deepTextContent(e.shadowRoot)),t}function dump(e,t,n,r){(r=r||n)&&r.length>80?addResult(r+"was skipped due to prefix length limit"):null===e?addResult(r+"null"):e&&e.constructor&&"Array"===e.constructor.name?addArray(e,t,n,r):"object"==typeof e?addObject(e,t,n,r):addResult("string"==typeof e?r+'"'+e+'"':r+e)}function dumpObjectPropertyTreeElement(e){addResult((e.expanded?"[expanded]":"[collapsed]")+" "+e.listItemElement.deepTextContent());for(let t=0;t<e.childCount();++t){const n=e.childAt(t).property;addResult("    "+n.name+": "+n.value._description)}}function waitForEvent(e,t,n){return n=n||function(){return!0},new Promise(r=>{t.addEventListener(e,(function o(a){if(!n(a.data))return;t.removeEventListener(e,o),r(a.data)}))})}function waitForTarget(e){e=e||(e=>!0);for(const t of self.SDK.targetManager.targets())if(e(t))return Promise.resolve(t);return new Promise(t=>{const n={targetAdded:function(r){e(r)&&(self.SDK.targetManager.unobserveTargets(n),t(r))},targetRemoved:function(){}};self.SDK.targetManager.observeTargets(n)})}function waitForTargetRemoved(e){return new Promise(t=>{const n={targetRemoved:function(r){r===e&&(self.SDK.targetManager.unobserveTargets(n),t(r))},targetAdded:function(){}};self.SDK.targetManager.observeTargets(n)})}function waitForExecutionContext(e){return e.executionContexts().length?Promise.resolve(e.executionContexts()[0]):e.once(SDK.RuntimeModel.Events.ExecutionContextCreated)}function waitForExecutionContextDestroyed(e){const t=e.runtimeModel;return-1===t.executionContexts().indexOf(e)?Promise.resolve():waitForEvent(SDK.RuntimeModel.Events.ExecutionContextDestroyed,t,t=>t===e)}function assertGreaterOrEqual(e,t,n){e<t&&addResult("FAILED: "+(n?n+": ":"")+e+" < "+t)}let _pageLoadedCallback;function navigate(e,t){_pageLoadedCallback=safeWrap(t),TestRunner.resourceTreeModel.addEventListener(SDK.ResourceTreeModel.Events.Load,_pageNavigated),evaluateInPageAnonymously("window.location.replace('"+e+"')")}function navigatePromise(e){return new Promise(t=>navigate(e,t))}function _pageNavigated(){TestRunner.resourceTreeModel.removeEventListener(SDK.ResourceTreeModel.Events.Load,_pageNavigated),_handlePageLoaded()}function hardReloadPage(e){_innerReloadPage(!0,void 0,e)}function reloadPage(e){_innerReloadPage(!1,void 0,e)}function reloadPageWithInjectedScript(e,t){_innerReloadPage(!1,e,t)}function reloadPagePromise(){return new Promise(e=>reloadPage(e))}function _innerReloadPage(e,t,n){_pageLoadedCallback=safeWrap(n),TestRunner.resourceTreeModel.addEventListener(SDK.ResourceTreeModel.Events.Load,pageLoaded),TestRunner.resourceTreeModel.reloadPage(e,t)}function pageLoaded(){TestRunner.resourceTreeModel.removeEventListener(SDK.ResourceTreeModel.Events.Load,pageLoaded),addResult("Page reloaded."),_handlePageLoaded()}async function _handlePageLoaded(){if(await waitForExecutionContext(TestRunner.runtimeModel),_pageLoadedCallback){const e=_pageLoadedCallback;_pageLoadedCallback=void 0,e()}}function waitForPageLoad(e){TestRunner.resourceTreeModel.addEventListener(SDK.ResourceTreeModel.Events.Load,(function t(){TestRunner.resourceTreeModel.removeEventListener(SDK.ResourceTreeModel.Events.Load,t),e()}))}function runWhenPageLoads(e){const t=_pageLoadedCallback;_pageLoadedCallback=safeWrap((function(){t&&t(),e()}))}function runTestSuite(e){const t=e.slice();!function e(){if(!t.length)return void completeTest();const n=t.shift();addResult(""),addResult("Running: "+/function\s([^(]*)/.exec(n)[1]),safeWrap(n)(e)}()}async function runAsyncTestSuite(e){for(const t of e)addResult(""),addResult("Running: "+/function\s([^(]*)/.exec(t)[1]),await safeAsyncWrap(t)();completeTest()}function assertEquals(e,t,n){if(e===t)return;let r;throw r=n?"Failure ("+n+"):":"Failure:",new Error(r+" expected <"+e+"> found <"+t+">")}function assertTrue(e,t){assertEquals(!0,!!e,t)}function override(e,t,n,r){n=safeWrap(n);const o=e[t];if("function"!=typeof o)throw new Error("Cannot find method to override: "+t);return e[t]=function(a){try{return n.apply(this,arguments)}catch(e){throw new Error("Exception in overriden method '"+t+"': "+e)}finally{r||(e[t]=o)}},o}function clearSpecificInfoFromStackFrames(e){let t=e.replace(/\(file:\/\/\/(?:[^)]+\)|[\w\/:-]+)/g,"(...)");return t=t.replace(/\(http:\/\/(?:[^)]+\)|[\w\/:-]+)/g,"(...)"),t=t.replace(/\(test:\/\/(?:[^)]+\)|[\w\/:-]+)/g,"(...)"),t=t.replace(/\(<anonymous>:[^)]+\)/g,"(...)"),t=t.replace(/VM\d+/g,"VM"),t.replace(/\s*at[^()]+\(native\)/g,"")}function hideInspectorView(){InspectorView.InspectorView.instance().element.setAttribute("style","display:none !important")}function mainFrame(){return TestRunner.resourceTreeModel.mainFrame}class StringOutputStream{constructor(e){this._callback=e,this._buffer=""}async open(e){return!0}async write(e){this._buffer+=e}async close(){this._callback(this._buffer)}}class MockSetting{constructor(e){this._value=e}get(){return this._value}set(e){this._value=e}}function loadedModules(){return self.runtime._modules.filter(e=>e._loadedForTest).filter(e=>"help"!==e.name()).filter(e=>-1===e.name().indexOf("test_runner"))}function dumpLoadedModules(e){const t=new Set(e||[]);addResult("Loaded modules:");const n=loadedModules().sort((function(e,t){return String.naturalOrderComparator(e._descriptor.name,t._descriptor.name)}));for(const e of n)t.has(e)||addResult("    "+e._descriptor.name);return n}function waitForUISourceCode(e,t){function n(n){return(!t||n.project().type()===t)&&(!(!t&&n.project().type()===Workspace.projectTypes.Service)&&!(e&&!n.url().endsWith(e)))}for(const t of self.Workspace.workspace.uiSourceCodes())if(e&&n(t))return Promise.resolve(t);return waitForEvent(Workspace.Events.UISourceCodeAdded,self.Workspace.workspace,n)}function waitForUISourceCodeRemoved(e){self.Workspace.workspace.once(Workspace.Events.UISourceCodeRemoved).then(e)}function url(e=""){const t=Root.Runtime.queryParam("test");return new URL(e,t+"/../").href}function dumpSyntaxHighlight(e,t){const n=document.createElement("span");n.textContent=e;return new SyntaxHighlighter.SyntaxHighlighter(t,!1).syntaxHighlightNode(n).then((function(){const t=[];for(let e=0;e<n.childNodes.length;e++)n.childNodes[e].getAttribute?t.push(n.childNodes[e].getAttribute("class")):t.push("*");addResult(e+": "+t.join(", "))}))}const findIndexesOfSubString=function(e,t){const n=[];let r=e.indexOf(t);for(;-1!==r;)n.push(r),r=e.indexOf(t,r+t.length);return n},findLineEndingIndexes=function(e){const t=findIndexesOfSubString(e,"\n");return t.push(e.length),t};async function dumpInspectedPageElementText(e){addResult(await evaluateInPageAsync(`document.querySelector('${e}').innerText`))}async function waitForPendingLiveLocationUpdates(){await DebuggerWorkspaceBinding.DebuggerWorkspaceBinding.instance().pendingLiveLocationChangesPromise(),await CSSWorkspaceBinding.CSSWorkspaceBinding.instance().pendingLiveLocationChangesPromise()}self.testRunner,TestRunner.StringOutputStream=StringOutputStream,TestRunner.MockSetting=MockSetting,TestRunner.formatters=formatters,TestRunner.flushResults=flushResults,TestRunner.completeTest=completeTest,TestRunner.addResult=addResult,TestRunner.addResults=addResults,TestRunner.runTests=runTests,TestRunner.addSniffer=addSniffer,TestRunner.addSnifferPromise=addSnifferPromise,TestRunner.showPanel=showPanel,TestRunner.createKeyEvent=createKeyEvent,TestRunner.safeWrap=safeWrap,TestRunner.safeAsyncWrap=safeAsyncWrap,TestRunner.textContentWithLineBreaks=textContentWithLineBreaks,TestRunner.textContentWithoutStyles=textContentWithoutStyles,TestRunner.evaluateInPagePromise=evaluateInPagePromise,TestRunner.callFunctionInPageAsync=callFunctionInPageAsync,TestRunner.evaluateInPageWithTimeout=evaluateInPageWithTimeout,TestRunner.evaluateFunctionInOverlay=evaluateFunctionInOverlay,TestRunner.check=check,TestRunner.deprecatedRunAfterPendingDispatches=deprecatedRunAfterPendingDispatches,TestRunner.loadHTML=loadHTML,TestRunner.addScriptTag=addScriptTag,TestRunner.addStylesheetTag=addStylesheetTag,TestRunner.addHTMLImport=addHTMLImport,TestRunner.addIframe=addIframe,TestRunner.markStep=markStep,TestRunner.startDumpingProtocolMessages=startDumpingProtocolMessages,TestRunner.addScriptForFrame=addScriptForFrame,TestRunner.addObject=addObject,TestRunner.addArray=addArray,TestRunner.dumpDeepInnerHTML=dumpDeepInnerHTML,TestRunner.deepTextContent=deepTextContent,TestRunner.dump=dump,TestRunner.dumpObjectPropertyTreeElement=dumpObjectPropertyTreeElement,TestRunner.waitForEvent=waitForEvent,TestRunner.waitForTarget=waitForTarget,TestRunner.waitForTargetRemoved=waitForTargetRemoved,TestRunner.waitForExecutionContext=waitForExecutionContext,TestRunner.waitForExecutionContextDestroyed=waitForExecutionContextDestroyed,TestRunner.assertGreaterOrEqual=assertGreaterOrEqual,TestRunner.navigate=navigate,TestRunner.navigatePromise=navigatePromise,TestRunner.hardReloadPage=hardReloadPage,TestRunner.reloadPage=reloadPage,TestRunner.reloadPageWithInjectedScript=reloadPageWithInjectedScript,TestRunner.reloadPagePromise=reloadPagePromise,TestRunner.pageLoaded=pageLoaded,TestRunner.waitForPageLoad=waitForPageLoad,TestRunner.runWhenPageLoads=runWhenPageLoads,TestRunner.runTestSuite=runTestSuite,TestRunner.assertEquals=assertEquals,TestRunner.assertTrue=assertTrue,TestRunner.override=override,TestRunner.clearSpecificInfoFromStackFrames=clearSpecificInfoFromStackFrames,TestRunner.hideInspectorView=hideInspectorView,TestRunner.mainFrame=mainFrame,TestRunner.loadedModules=loadedModules,TestRunner.dumpLoadedModules=dumpLoadedModules,TestRunner.waitForUISourceCode=waitForUISourceCode,TestRunner.waitForUISourceCodeRemoved=waitForUISourceCodeRemoved,TestRunner.url=url,TestRunner.dumpSyntaxHighlight=dumpSyntaxHighlight,TestRunner.loadModule=loadModule,TestRunner.evaluateInPageRemoteObject=evaluateInPageRemoteObject,TestRunner.evaluateInPage=evaluateInPage,TestRunner.evaluateInPageAnonymously=evaluateInPageAnonymously,TestRunner.evaluateInPageAsync=evaluateInPageAsync,TestRunner.deprecatedInitAsync=deprecatedInitAsync,TestRunner.runAsyncTestSuite=runAsyncTestSuite,TestRunner.dumpInspectedPageElementText=dumpInspectedPageElementText,TestRunner.waitForPendingLiveLocationUpdates=waitForPendingLiveLocationUpdates,TestRunner.findLineEndingIndexes=findLineEndingIndexes,TestRunner.isScrolledToBottom=UIUtils.isScrolledToBottom,TestRunner.CustomFormatters;var TestRunner$1=Object.freeze({__proto__:null,isDebugTest:isDebugTest,_printDevToolsConsole:_printDevToolsConsole,setInnerResult:setInnerResult,addResult:addResult,setInnerCompleteTest:setInnerCompleteTest,completeTest:completeTest,flushResults:flushResults,addResults:addResults,runTests:runTests,addSniffer:addSniffer,addSnifferPromise:addSnifferPromise,loadModule:loadModule,showPanel:showPanel,createKeyEvent:createKeyEvent,safeWrap:safeWrap,safeAsyncWrap:safeAsyncWrap,textContentWithLineBreaks:textContentWithLineBreaks,textContentWithoutStyles:textContentWithoutStyles,evaluateInPageRemoteObject:evaluateInPageRemoteObject,evaluateInPage:evaluateInPage,_evaluateInPage:_evaluateInPage,evaluateInPageAnonymously:evaluateInPageAnonymously,evaluateInPagePromise:evaluateInPagePromise,evaluateInPageAsync:evaluateInPageAsync,callFunctionInPageAsync:callFunctionInPageAsync,evaluateInPageWithTimeout:evaluateInPageWithTimeout,evaluateFunctionInOverlay:evaluateFunctionInOverlay,check:check,deprecatedRunAfterPendingDispatches:deprecatedRunAfterPendingDispatches,loadHTML:loadHTML,addScriptTag:addScriptTag,addStylesheetTag:addStylesheetTag,addHTMLImport:addHTMLImport,addIframe:addIframe,deprecatedInitAsync:deprecatedInitAsync,markStep:markStep,startDumpingProtocolMessages:startDumpingProtocolMessages,addScriptForFrame:addScriptForFrame,formatters:formatters,addObject:addObject,addArray:addArray,dumpDeepInnerHTML:dumpDeepInnerHTML,deepTextContent:deepTextContent,dump:dump,dumpObjectPropertyTreeElement:dumpObjectPropertyTreeElement,waitForEvent:waitForEvent,waitForTarget:waitForTarget,waitForTargetRemoved:waitForTargetRemoved,waitForExecutionContext:waitForExecutionContext,waitForExecutionContextDestroyed:waitForExecutionContextDestroyed,assertGreaterOrEqual:assertGreaterOrEqual,navigate:navigate,navigatePromise:navigatePromise,_pageNavigated:_pageNavigated,hardReloadPage:hardReloadPage,reloadPage:reloadPage,reloadPageWithInjectedScript:reloadPageWithInjectedScript,reloadPagePromise:reloadPagePromise,_innerReloadPage:_innerReloadPage,pageLoaded:pageLoaded,_handlePageLoaded:_handlePageLoaded,waitForPageLoad:waitForPageLoad,runWhenPageLoads:runWhenPageLoads,runTestSuite:runTestSuite,runAsyncTestSuite:runAsyncTestSuite,assertEquals:assertEquals,assertTrue:assertTrue,override:override,clearSpecificInfoFromStackFrames:clearSpecificInfoFromStackFrames,hideInspectorView:hideInspectorView,mainFrame:mainFrame,StringOutputStream:StringOutputStream,MockSetting:MockSetting,loadedModules:loadedModules,dumpLoadedModules:dumpLoadedModules,waitForUISourceCode:waitForUISourceCode,waitForUISourceCodeRemoved:waitForUISourceCodeRemoved,url:url,dumpSyntaxHighlight:dumpSyntaxHighlight,findLineEndingIndexes:findLineEndingIndexes,dumpInspectedPageElementText:dumpInspectedPageElementText,waitForPendingLiveLocationUpdates:waitForPendingLiveLocationUpdates});function _setupTestHelpers(e){self.TestRunner.BrowserAgent=e.browserAgent(),self.TestRunner.CSSAgent=e.cssAgent(),self.TestRunner.DeviceOrientationAgent=e.deviceOrientationAgent(),self.TestRunner.DOMAgent=e.domAgent(),self.TestRunner.DOMDebuggerAgent=e.domdebuggerAgent(),self.TestRunner.DebuggerAgent=e.debuggerAgent(),self.TestRunner.EmulationAgent=e.emulationAgent(),self.TestRunner.HeapProfilerAgent=e.heapProfilerAgent(),self.TestRunner.InputAgent=e.inputAgent(),self.TestRunner.InspectorAgent=e.inspectorAgent(),self.TestRunner.NetworkAgent=e.networkAgent(),self.TestRunner.OverlayAgent=e.overlayAgent(),self.TestRunner.PageAgent=e.pageAgent(),self.TestRunner.ProfilerAgent=e.profilerAgent(),self.TestRunner.RuntimeAgent=e.runtimeAgent(),self.TestRunner.TargetAgent=e.targetAgent(),self.TestRunner.networkManager=e.model(SDK.NetworkManager),self.TestRunner.securityOriginManager=e.model(SDK.SecurityOriginManager),self.TestRunner.resourceTreeModel=e.model(SDK.ResourceTreeModel),self.TestRunner.debuggerModel=e.model(SDK.DebuggerModel),self.TestRunner.runtimeModel=e.model(SDK.RuntimeModel),self.TestRunner.domModel=e.model(SDK.DOMModel),self.TestRunner.domDebuggerModel=e.model(SDK.DOMDebuggerModel),self.TestRunner.cssModel=e.model(SDK.CSSModel),self.TestRunner.cpuProfilerModel=e.model(SDK.CPUProfilerModel),self.TestRunner.overlayModel=e.model(SDK.OverlayModel),self.TestRunner.serviceWorkerManager=e.model(SDK.ServiceWorkerManager),self.TestRunner.tracingManager=e.model(SDK.TracingManager),self.TestRunner.mainTarget=e}async function _executeTestScript(){const testScriptURL=Root.Runtime.queryParam("test");if(isDebugTest())return setInnerResult(console.log),setInnerCompleteTest(()=>console.log("Test completed")),void(self.test=async function(){await eval(`import("${testScriptURL}")`)});try{await eval(`import("${testScriptURL}")`)}catch(e){addResult("TEST ENDED EARLY DUE TO UNCAUGHT ERROR:"),addResult(e&&e.stack||e),addResult("=== DO NOT COMMIT THIS INTO -expected.txt ==="),completeTest()}}let _startedTest=!1;class _TestObserver{targetAdded(e){"main"===e.id()&&_setupTestHelpers(e),_startedTest||(_startedTest=!0,loadHTML(`\n      <head>\n        <base href="${url()}">\n      </head>\n      <body>\n      </body>\n    `).then(()=>_executeTestScript()))}targetRemoved(e){}}SDK.targetManager.observeTargets(new _TestObserver);export{TestRunner$1 as TestRunner,_TestObserver,_executeTestScript};
