import{UIString as e,Revealer as t,Console as n,JavaScriptMetaData as i}from"../common/common.js";import{UIUtils as s,Context as r,TreeOutline as o,Utils as a,Fragment as l,ContextMenu as c,ARIAUtils as p,TextPrompt as d,Icon as h,Geometry as u,GlassPane as m}from"../ui/ui.js";import{userMetrics as b,UserMetrics as _,InspectorFrontendHost as y}from"../host/host.js";import{StringUtilities as f,NumberUtilities as g}from"../platform/platform.js";import{RemoteObject as x,RuntimeModel as v,OverlayModel as C,ConsoleModel as w,SDKModel as E,DebuggerModel as j}from"../sdk/sdk.js";import{TextRange as P}from"../text_utils/text_utils.js";import{FormatterWorkerPool as O}from"../formatter/formatter.js";import{Runtime as S}from"../root/root.js";import{Linkifier as L}from"../components/components.js";class T{static _objectPropertyComparator(e,t){return n(e)-n(t);function n(e){const t=I;return e.name===t.PromiseState?1:e.name===t.PromiseResult?2:e.name===t.GeneratorState||e.name===t.PrimitiveValue?3:"function"===e.type||e.name.startsWith("#")?5:4}}appendObjectPreview(e,t,n){const i=t.description,r=new Set(["null","regexp","error","internal#entry","trustedtype"]);if("object"!==t.type||r.has(t.subtype)||n)return void e.appendChild(this.renderPropertyPreview(t.type,t.subtype,t.className,i));const o="array"===t.subtype||"typedarray"===t.subtype;if(i){let n;if(o){const e=x.RemoteObject.arrayLength(t),s=e>1?"("+e+")":"",r=x.RemoteObject.arrayNameFromDescription(i);n="Array"===r?s:r+s}else{n="Object"===i?"":i}n.length>0&&(e.createChild("span","object-description").textContent=n+" ")}const a=e.createChild("span","object-properties-preview");if(s.createTextChild(a,o?"[":"{"),t.entries?this._appendEntriesPreview(a,t):o?this._appendArrayPropertiesPreview(a,t):this._appendObjectPropertiesPreview(a,t),t.overflow){const e=a.textContent.length>1?", …":"…";a.createChild("span").textContent=e}s.createTextChild(a,o?"]":"}")}_abbreviateFullQualifiedClassName(e){const t=e.split(".");for(let e=0;e<t.length-1;++e)t[e]=t[e].trimMiddle(3);return t.join(".")}_appendObjectPropertiesPreview(e,t){const n=I,i=t.properties.filter(e=>"accessor"!==e.type).sort(T._objectPropertyComparator);for(let r=0;r<i.length;++r){r>0&&s.createTextChild(e,", ");const o=i[r],a=o.name;if("promise"===t.subtype&&a===n.PromiseState){e.appendChild(this._renderDisplayName("<"+o.value+">"));const t=r+1<i.length?i[r+1]:null;t&&t.name===n.PromiseResult&&("pending"!==o.value&&(s.createTextChild(e,": "),e.appendChild(this._renderPropertyPreviewOrAccessor([t]))),r++)}else"generator"===t.subtype&&a===n.GeneratorState?e.appendChild(this._renderDisplayName("<"+o.value+">")):(a===n.PrimitiveValue||(e.appendChild(this._renderDisplayName(a)),s.createTextChild(e,": ")),e.appendChild(this._renderPropertyPreviewOrAccessor([o])))}}_appendArrayPropertiesPreview(t,n){const i=x.RemoteObject.arrayLength(n),r=n.properties.filter(e=>-1!==a(e.name)).sort((function(e,t){return a(e.name)-a(t.name)})),o=n.properties.filter(e=>-1===a(e.name)).sort(T._objectPropertyComparator);function a(e){const t=e>>>0;return String(t)===e&&t<i?t:-1}const l=!n.overflow;let c=-1,p=!1;for(let e=0;e<r.length;++e){p&&s.createTextChild(t,", ");const n=r[e],i=a(n.name);l&&i-c>1&&(d(i),s.createTextChild(t,", ")),l||e===i||(t.appendChild(this._renderDisplayName(n.name)),s.createTextChild(t,": ")),t.appendChild(this._renderPropertyPreviewOrAccessor([n])),c=i,p=!0}l&&i-c>1&&(p&&s.createTextChild(t,", "),d(i));for(let e=0;e<o.length;++e){p&&s.createTextChild(t,", ");const n=o[e];t.appendChild(this._renderDisplayName(n.name)),s.createTextChild(t,": "),t.appendChild(this._renderPropertyPreviewOrAccessor([n])),p=!0}function d(n){const i=t.createChild("span","object-value-undefined"),s=n-c-1;i.textContent=1!==s?e.UIString("empty × %d",s):e.UIString("empty"),p=!0}}_appendEntriesPreview(e,t){for(let n=0;n<t.entries.length;++n){n>0&&s.createTextChild(e,", ");const i=t.entries[n];i.key&&(this.appendObjectPreview(e,i.key,!0),s.createTextChild(e," => ")),this.appendObjectPreview(e,i.value,!0)}}_renderDisplayName(e){const t=document.createElement("span");t.classList.add("name");const n=/^\s|\s$|^$|\n/.test(e);return t.textContent=n?'"'+e.replace(/\n/g,"↵")+'"':e,t}_renderPropertyPreviewOrAccessor(e){const t=e.peekLast();return this.renderPropertyPreview(t.type,t.subtype,t.className,t.value)}renderPropertyPreview(t,n,i,r){const o=document.createElement("span");if(o.classList.add("object-value-"+(n||t)),r=r||"","accessor"===t)return o.textContent="(...)",o.title=e.UIString("The property is computed with a getter"),o;if("function"===t)return o.textContent="ƒ",o;if("object"===t&&"trustedtype"===n&&i)return A(o,r,i),o;if("object"===t&&"node"===n&&r)return k(o,r),o;if("string"===t)return s.createTextChildren(o,'"',r.replace(/\n/g,"↵"),'"'),o;if("object"===t&&!n){let e=this._abbreviateFullQualifiedClassName(r);return"Object"===e&&(e="{…}"),o.textContent=e,o.title=r,o}return o.textContent=r,o}}const I={GeneratorState:"[[GeneratorState]]",PrimitiveValue:"[[PrimitiveValue]]",PromiseState:"[[PromiseState]]",PromiseResult:"[[PromiseResult]]"},k=function(e,t){const n=t.match(/([^#.]+)(#[^.]+)?(\..*)?/);e.createChild("span","webkit-html-tag-name").textContent=n[1],n[2]&&(e.createChild("span","webkit-html-attribute-value").textContent=n[2]),n[3]&&(e.createChild("span","webkit-html-attribute-name").textContent=n[3])},A=function(e,t,n){s.createTextChildren(e,n+" ");const i=document.createElement("span");i.classList.add("object-value-string"),s.createTextChildren(i,'"',t.replace(/\n/g,"↵"),'"'),e.appendChild(i)};var F=Object.freeze({__proto__:null,RemoteObjectPreviewFormatter:T,createSpansForNodeTitle:k,createSpanForTrustedType:A});class N{static wrapObjectLiteral(e){if(!/^\s*\{/.test(e)||!/\}\s*$/.test(e))return e;const t=(async()=>0).constructor;try{t("return "+e+";");const n="("+e+")";return t(n),n}catch(t){return e}}static preprocessExpression(e){return N.wrapObjectLiteral(e)}static async evaluateAndBuildPreview(e,t,n,i,s){const o=window.ObjectUI.JavaScriptREPL,a=r.Context.instance().flavor(v.ExecutionContext),l=void 0!==o._MaxLengthForEvaluation?o._MaxLengthForEvaluation:M,c=e.length>l;if(!e||!a||t&&c)return{preview:document.createDocumentFragment(),result:null};const p={expression:N.preprocessExpression(e),generatePreview:!0,includeCommandLineAPI:!0,throwOnSideEffect:t,timeout:n,objectGroup:s,disableBreaks:!0,replMode:!0,silent:void 0,returnByValue:void 0,allowUnsafeEvalBlockedByCSP:void 0},d=await a.evaluate(p,!1,!1);return{preview:N._buildEvaluationPreview(d,i),result:d}}static _buildEvaluationPreview(e,t){const n=document.createDocumentFragment();if("error"in e)return n;if(e.exceptionDetails&&e.exceptionDetails.exception&&e.exceptionDetails.exception.description){const i=e.exceptionDetails.exception.description;return(i.startsWith("TypeError: ")||t)&&(n.createChild("span").textContent=e.exceptionDetails.text+" "+i),n}const i=new T,{preview:s,type:r,subtype:o,className:a,description:l}=e.object;if(s&&"object"===r&&"node"!==o&&"trustedtype"!==o)i.appendObjectPreview(n,s,!1);else{const e=i.renderPropertyPreview(r,o,a,(l||"").trimEndWithMaxLength(400));n.appendChild(e)}return n}}const M=2e3;var D=Object.freeze({__proto__:null,JavaScriptREPL:N,MaxLengthForEvaluation:M});class R extends o.TreeOutlineInShadow{constructor(e,t,n,i,s,r,o){super(),this._object=e,this._editable=!0,o||this.hideOverflow(),this.setFocusable(!0),this.setShowSelectionOnKeyboardFocus(!0),this._objectTreeElement=new $(e,n,i,s,r),this.appendChild(this._objectTreeElement),"string"!=typeof t&&t?(this.titleElement=t,this.element.appendChild(t)):(this.titleElement=this.element.createChild("span"),this.titleElement.textContent=t||""),this.titleElement.hasAttribute("tabIndex")||(this.titleElement.tabIndex=-1),this.element._section=this,this.registerRequiredCSS("object_ui/objectValue.css",{enableLegacyPatching:!0}),this.registerRequiredCSS("object_ui/objectPropertiesSection.css",{enableLegacyPatching:!0}),this.rootElement().childrenListElement.classList.add("source-code","object-properties-section")}static defaultObjectPresentation(e,t,n,i){const s=R.defaultObjectPropertiesSection(e,t,n,i);return e.hasChildren?s.element:s.titleElement}static defaultObjectPropertiesSection(e,t,n,i){const s=document.createElement("span");s.classList.add("source-code");const r=a.createShadowRootWithCoreStyles(s,{cssFile:"object_ui/objectValue.css",enableLegacyPatching:!0,delegatesFocus:void 0}),o=R.createPropertyValue(e,!1,!0);r.appendChild(o.element);const l=new R(e,s,t);return l.editable=!1,n&&l.skipProto(),i&&l.setEditable(!1),l}static CompareProperties(e,t){const n=e.name,i=t.name;return"__proto__"===n?1:"__proto__"===i?-1:!e.enumerable&&t.enumerable?1:!t.enumerable&&e.enumerable?-1:n.startsWith("_")&&!i.startsWith("_")?1:i.startsWith("_")&&!n.startsWith("_")?-1:e.symbol&&!t.symbol?1:t.symbol&&!e.symbol?-1:e.private&&!t.private?1:t.private&&!e.private?-1:String.naturalOrderComparator(n,i)}static createNameElement(e,t){return null===e?l.html`<span class="name"></span>`:/^\s|\s$|^$|\n/.test(e)?l.html`<span class="name">"${e.replace(/\n/g,"↵")}"</span>`:t?l.html`<span class="name">
        <span class="private-property-hash">${e[0]}</span>${e.substring(1)}
      </span>`:l.html`<span class="name">${e}</span>`}static valueElementForFunctionDescription(e,t,n){const i=document.createElement("span");i.classList.add("object-value-function");const r=(e=e||"").replace(/^function [gs]et /,"function ").replace(/^function [gs]et\(/,"function(").replace(/^[gs]et /,"");n=n||"";const o=r.match(/^(async\s+function)/),a=r.startsWith("function*"),l=r.startsWith("*"),c=!a&&r.startsWith("function"),p=r.startsWith("class ")||r.startsWith("class{"),d=r.indexOf("=>"),h=!o&&!a&&!c&&!p&&d>0;let u;if(p){u=r.substring("class".length);const e=/^[^{\s]+/.exec(u.trim());let t=n;e&&(t=e[0].trim()||n),b("class",u,t)}else if(o)u=r.substring(o[1].length),b("async ƒ",u,m(u));else if(a)u=r.substring("function*".length),b("ƒ*",u,m(u));else if(l)u=r.substring("*".length),b("ƒ*",u,m(u));else if(c)u=r.substring("function".length),b("ƒ",u,m(u));else if(h){const e=60;let t=r;n?t=n+"()":r.length>e&&(t=r.substring(0,d+2)+" {…}"),b("",r,t)}else b("ƒ",r,m(r));return i.title=e.trimEndWithMaxLength(500),i;function m(e){const t=e.indexOf("("),i=e.match(/\)\s*{/);if(-1!==t&&i&&i.index>t){return(e.substring(0,t).trim()||n)+e.substring(t,i.index+1)}return n+"()"}function b(e,n,r){e.length&&(i.createChild("span","object-value-function-prefix").textContent=e+" "),t?s.createTextChild(i,n.trim().trimEndWithMaxLength(200)):s.createTextChild(i,r.replace(/\n/g," "))}}static createPropertyValueWithCustomSupport(e,t,n,i,s){if(e.customPreview()){const t=new Q(e).element;return t.classList.add("object-properties-section-custom-section"),new H(t)}return R.createPropertyValue(e,t,n,i,s)}static createPropertyValue(n,i,r,o,a){let l;const c=n.type,p=n.subtype,d=n.description,h=n.className;if("object"===c&&"internal#location"===p){const t=n.debuggerModel().createRawLocationByScriptId(n.value.scriptId,n.value.lineNumber,n.value.columnNumber);if(t&&a)return new H(a.linkifyRawLocation(t,""));l=new H(function(){const t=document.createElement("span");return t.textContent="<"+e.UIString("unknown")+">",t.title=d||"",t}())}else if("string"===c&&"string"==typeof d)l=u();else if("object"===c&&"trustedtype"===p)l=function(){const e=document.createElement("span");e.classList.add("object-value-trustedtype");const t=`${h} "${d}"`;let n;if(t.length>(self.ObjectUI.ObjectPropertiesSection._maxRenderableStringLength||W))n=new z(e,t,50);else{const i=u();s.createTextChild(e,h+" "),e.appendChild(i.element),n=new H(e),e.title=t}return n}();else if("function"===c)l=new H(R.valueElementForFunctionDescription(d));else if("object"===c&&"node"===p&&d)l=new H(function(){const e=document.createElement("span");return e.classList.add("object-value-node"),k(e,d),e.addEventListener("click",e=>{t.reveal(n),e.consume(!0)},!1),e.addEventListener("mousemove",()=>C.OverlayModel.highlightObjectAsDOMNode(n),!1),e.addEventListener("mouseleave",()=>C.OverlayModel.hideDOMNodeHighlight(),!1),e}());else if("number"===c&&d&&-1!==d.indexOf("e"))l=new H(function(){const e=document.createElement("span");e.classList.add("object-value-number");const t=d.split("e");return e.createChild("span","object-value-scientific-notation-mantissa").textContent=t[0],e.createChild("span","object-value-scientific-notation-exponent").textContent="e"+t[1],e.classList.add("object-value-scientific-notation-number"),e.title=d||"",e}()),o&&o.classList.add("hbox");else{const e=document.createElement("span");if(e.classList.add("object-value-"+(p||c)),n.preview&&r){(new T).appendObjectPreview(e,n.preview,!1),l=new H(e),l.element.title=d||""}else d.length>(self.ObjectUI.ObjectPropertiesSection._maxRenderableStringLength||W)?l=new z(e,d,50):(l=new H(e),l.element.textContent=d,l.element.title=d||"")}if(i){const e=document.createElement("span");e.classList.add("error"),e.classList.add("value"),e.appendChild(s.formatLocalized("[Exception: %s]",[l.element])),l.element=e}return l.element.classList.add("value"),l;function u(){const e=document.createElement("span");e.classList.add("object-value-string");const t=d.replace(/\n/g,"↵");let n;return e.createChild("span","object-value-string-quote").textContent='"',d.length>(self.ObjectUI.ObjectPropertiesSection._maxRenderableStringLength||W)?n=new z(e,t,50):(s.createTextChild(e,t),n=new H(e),e.title=d||""),e.createChild("span","object-value-string-quote").textContent='"',n}}static formatObjectAsFunction(e,n,i,s){return e.debuggerModel().functionDetailsPromise(e).then((function(r){i&&r&&r.location&&(n.classList.add("linkified"),n.addEventListener("click",()=>t.reveal(r.location)&&!1));let o=s?"":"anonymous";r&&r.functionName&&(o=r.functionName);const a=R.valueElementForFunctionDescription(e.description,s,o);n.appendChild(a)}))}static _isDisplayableProperty(e,t){if(!t||!t.synthetic)return!0;const n=e.name;return!("[[Entries]]"===t.name&&("length"===n||"__proto__"===n))}skipProto(){this._skipProto=!0}expand(){this._objectTreeElement.expand()}setEditable(e){this._editable=e}objectTreeElement(){return this._objectTreeElement}enableContextMenu(){this.element.addEventListener("contextmenu",this._contextMenuEventFired.bind(this),!1)}_contextMenuEventFired(e){const t=new c.ContextMenu(e);t.appendApplicableItems(this._object),this._object instanceof x.LocalJSONObject&&(t.viewSection().appendItem(ls`Expand recursively`,this._objectTreeElement.expandRecursively.bind(this._objectTreeElement,Number.MAX_VALUE)),t.viewSection().appendItem(ls`Collapse children`,this._objectTreeElement.collapseChildren.bind(this._objectTreeElement))),t.show()}titleLessMode(){this._objectTreeElement.listItemElement.classList.add("hidden"),this._objectTreeElement.childrenListElement.classList.add("title-less-mode"),this._objectTreeElement.expand()}}const W=1e4;class V extends o.TreeOutlineInShadow{constructor(e){super(),this.registerRequiredCSS("object_ui/objectValue.css",{enableLegacyPatching:!0}),this.registerRequiredCSS("object_ui/objectPropertiesSection.css",{enableLegacyPatching:!0}),this._editable=!(e&&e.readOnly),this.contentElement.classList.add("source-code"),this.contentElement.classList.add("object-properties-section"),this.hideOverflow()}}class $ extends o.TreeElement{constructor(e,t,n,i,s){super(createElement("slot")),this._object=e,this._extraProperties=s||[],this._ignoreHasOwnProperty=!!i,this._emptyPlaceholder=n,this.setExpandable(!0),this.selectable=!0,this.toggleOnClick=!0,this.listItemElement.classList.add("object-properties-section-root-element"),this._linkifier=t}onexpand(){this.treeOutline&&this.treeOutline.element.classList.add("expanded")}oncollapse(){this.treeOutline&&this.treeOutline.element.classList.remove("expanded")}ondblclick(e){return!0}async onpopulate(){return B._populate(this,this._object,!!this.treeOutline._skipProto,this._linkifier,this._emptyPlaceholder,this._ignoreHasOwnProperty,this._extraProperties)}}class B extends o.TreeElement{constructor(e,t){super(),this.property=e,this.toggleOnClick=!0,this._highlightChanges=[],this._linkifier=t,this._maxNumPropertiesToShow=200,this.listItemElement.addEventListener("contextmenu",this._contextMenuFired.bind(this),!1),p.setAccessibleName(this.listItemElement,this.property.name)}static async _populate(e,t,n,i,s,r,o,a){if(t.arrayLength()>100)return e.removeChildren(),void U._populateArray(e,t,0,t.arrayLength()-1,i);let l;l=r?await t.getAllProperties(!1,!0):await x.RemoteObject.loadFromObjectPerProto(t,!0);const c=l.properties,p=l.internalProperties;if(e.removeChildren(),c){o=o||[];for(let e=0;e<o.length;++e)c.push(o[e]);B.populateWithProperties(e,c,p,n,a||t,i,s)}}static populateWithProperties(e,t,n,i,s,r,o){t.sort(R.CompareProperties);const a=(n=n||[]).find(e=>"[[Entries]]"===e.name);if(a){a.parentObject=s;const t=new B(a,r);t.setExpandable(!0),t.expand(),e.appendChild(t)}const l=[];let c=null;for(let n=0;n<t.length;++n){const i=t[n];if(i.parentObject=s,!R._isDisplayableProperty(i,e.property))continue;if("__proto__"===i.name&&!i.isAccessorProperty()){c=i;continue}if(i.isOwn&&i.getter){const e=new x.RemoteObjectProperty("get "+i.name,i.getter,!1);e.parentObject=s,l.push(e)}if(i.isOwn&&i.setter){const e=new x.RemoteObjectProperty("set "+i.name,i.setter,!1);e.parentObject=s,l.push(e)}(i.getter||!i.isAccessorProperty())&&"__proto__"!==i.name&&e.appendChild(new B(i,r))}for(let t=0;t<l.length;++t)e.appendChild(new B(l[t],r));!i&&c&&e.appendChild(new B(c,r));for(const t of n){t.parentObject=s;const n=new B(t,r);"[[Entries]]"!==t.name&&e.appendChild(n)}B._appendEmptyPlaceholderIfNeeded(e,o)}static _appendEmptyPlaceholderIfNeeded(t,n){if(t.childCount())return;const i=document.createElement("div");i.classList.add("gray-info-message"),i.textContent=n||e.UIString("No properties");const s=new o.TreeElement(i);t.appendChild(s)}static createRemoteObjectAccessorPropertySpan(t,n,i){const s=createElement("span"),r=s.createChild("span");if(r.textContent=e.UIString("(...)"),!t)return s;function o(e){let t=this;const n=JSON.parse(e);for(let e=0,i=n.length;e<i;++e)t=t[n[e]];return t}return r.classList.add("object-value-calculate-value-button"),r.title=e.UIString("Invoke property getter"),r.addEventListener("click",(function(e){e.consume(),t.callFunction(o,[{value:JSON.stringify(n)}]).then(i)}),!1),s}setSearchRegex(e,t){let n=s.highlightedSearchResultClassName;t&&(n+=" "+t),this.revertHighlightChanges(),this._applySearch(e,this.nameElement,n);return"object"!==this.property.value.type&&this._applySearch(e,this.valueElement,n),!!this._highlightChanges.length}_applySearch(e,t,n){const i=[],r=t.textContent;e.lastIndex=0;let o=e.exec(r);for(;o;)i.push(new P.SourceRange(o.index,o[0].length)),o=e.exec(r);i.length&&s.highlightRangesWithStyleClass(t,i,n,this._highlightChanges)}_showAllPropertiesElementSelected(e){return this.removeChild(e),this.children().forEach(e=>{e.hidden=!1}),!1}_createShowAllPropertiesButton(){const t=document.createElement("div");t.classList.add("object-value-calculate-value-button"),t.textContent=e.UIString("(...)"),t.title=e.UIString("Show all %d",this.childCount());const n=this.children();for(let e=this._maxNumPropertiesToShow;e<this.childCount();++e)n[e].hidden=!0;const i=new o.TreeElement(t);i.onselect=this._showAllPropertiesElementSelected.bind(this,i),this.appendChild(i)}revertHighlightChanges(){s.revertDomChanges(this._highlightChanges),this._highlightChanges=[]}async onpopulate(){const e=this.property.value;console.assert(e);const t=!this.treeOutline||this.treeOutline._skipProto,n="__proto__"!==this.property.name?e:this.property.parentObject;await B._populate(this,e,t,this._linkifier,void 0,void 0,void 0,n),this.childCount()>this._maxNumPropertiesToShow&&this._createShowAllPropertiesButton()}ondblclick(e){const t=e.target.isSelfOrDescendant(this.valueElement)||this.expandedValueElement&&e.target.isSelfOrDescendant(this.expandedValueElement);return this.property.value&&!this.property.value.customPreview()&&t&&(this.property.writable||this.property.setter)&&this._startEditing(),!1}onenter(){return!(this.property.value.customPreview()||!this.property.writable&&!this.property.setter)&&(this._startEditing(),!0)}onattach(){this.update(),this._updateExpandable()}onexpand(){this._showExpandedValueElement(!0)}oncollapse(){this._showExpandedValueElement(!1)}_showExpandedValueElement(e){this.expandedValueElement&&(e?this._rowContainer.replaceChild(this.expandedValueElement,this.valueElement):this._rowContainer.replaceChild(this.valueElement,this.expandedValueElement))}_createExpandedValueElement(e){if(!(e.hasChildren&&!e.customPreview()&&"node"!==e.subtype&&"function"!==e.type&&("object"!==e.type||e.preview)))return null;const t=document.createElement("span");return t.classList.add("value"),"Object"===e.description?t.textContent="":t.setTextContentTruncatedIfNeeded(e.description||""),t.classList.add("object-value-"+(e.subtype||e.type)),t.title=e.description||"",t}update(){this.nameElement=R.createNameElement(this.property.name,this.property.private),this.property.enumerable||this.nameElement.classList.add("object-properties-section-dimmed"),this.property.synthetic&&this.nameElement.classList.add("synthetic-property"),this._updatePropertyPath();const t=this.property.synthetic&&"[[Entries]]"===this.property.name;if(t)this.valueElement=document.createElement("span"),this.valueElement.classList.add("value");else if(this.property.value){const e="__proto__"!==this.property.name;this.propertyValue=R.createPropertyValueWithCustomSupport(this.property.value,this.property.wasThrown,e,this.listItemElement,this._linkifier),this.valueElement=this.propertyValue.element}else this.property.getter?this.valueElement=B.createRemoteObjectAccessorPropertySpan(this.property.parentObject,[this.property.name],this._onInvokeGetterClick.bind(this)):(this.valueElement=document.createElement("span"),this.valueElement.classList.add("object-value-undefined"),this.valueElement.textContent=e.UIString("<unreadable>"),this.valueElement.title=e.UIString("No property getter"));const n=this.valueElement.textContent;this.property.value&&n&&!this.property.wasThrown&&(this.expandedValueElement=this._createExpandedValueElement(this.property.value)),this.listItemElement.removeChildren(),this._rowContainer=t?l.html`<span class='name-and-value'>${this.nameElement}</span>`:l.html`<span class='name-and-value'>${this.nameElement}: ${this.valueElement}</span>`,this.listItemElement.appendChild(this._rowContainer)}_updatePropertyPath(){if(this.nameElement.title)return;const e=this.property.name;if(this.property.synthetic)return void(this.nameElement.title=e);const t=this.parent.nameElement&&!this.parent.property.synthetic?this.parent.nameElement.title:"";this.property.private||/^(?:[$_\p{ID_Start}])(?:[$_\u200C\u200D\p{ID_Continue}])*$/u.test(e)?this.nameElement.title=t?`${t}.${e}`:e:/^(?:0|[1-9]\d*)$/.test(e)?this.nameElement.title=`${t}[${e}]`:this.nameElement.title=`${t}[${JSON.stringify(e)}]`}_contextMenuFired(e){const t=new c.ContextMenu(e);if(t.appendApplicableItems(this),this.property.symbol&&t.appendApplicableItems(this.property.symbol),this.property.value&&(t.appendApplicableItems(this.property.value),this.property.parentObject instanceof x.LocalJSONObject)){const{value:{value:e}}=this.property,n="object"==typeof e?JSON.stringify(e,null,2):e,i=()=>{b.actionTaken(_.Action.NetworkPanelCopyValue),y.InspectorFrontendHostInstance.copyText(n)};t.clipboardSection().appendItem(ls`Copy value`,i)}if(!this.property.synthetic&&this.nameElement&&this.nameElement.title){const e=y.InspectorFrontendHostInstance.copyText.bind(y.InspectorFrontendHostInstance,this.nameElement.title);t.clipboardSection().appendItem(ls`Copy property path`,e)}this.property.parentObject instanceof x.LocalJSONObject&&(t.viewSection().appendItem(ls`Expand recursively`,this.expandRecursively.bind(this,Number.MAX_VALUE)),t.viewSection().appendItem(ls`Collapse children`,this.collapseChildren.bind(this))),this.propertyValue&&this.propertyValue.appendApplicableItems(e,t),t.show()}_startEditing(){if(this._prompt||!this.treeOutline._editable||this._readOnly)return;this._editableDiv=this._rowContainer.createChild("span","editable-div");let t=this.property.value.description;"string"===this.property.value.type&&"string"==typeof t&&(t=`"${t}"`),this._editableDiv.setTextContentTruncatedIfNeeded(t,e.UIString("<string is too large to edit>"));const n=this._editableDiv.textContent;this.setExpandable(!1),this.listItemElement.classList.add("editing-sub-part"),this.valueElement.classList.add("hidden"),this._prompt=new J;const i=this._prompt.attachAndStartEditing(this._editableDiv,this._editingCommitted.bind(this,n));i.classList.add("property-prompt"),this.listItemElement.getComponentSelection().selectAllChildren(this._editableDiv),i.addEventListener("keydown",this._promptKeyDown.bind(this,n),!1)}_editingEnded(){this._prompt.detach(),delete this._prompt,this._editableDiv.remove(),this._updateExpandable(),this.listItemElement.scrollLeft=0,this.listItemElement.classList.remove("editing-sub-part"),this.select()}_editingCancelled(){this.valueElement.classList.remove("hidden"),this._editingEnded()}async _editingCommitted(e){const t=this._prompt.text();t!==e?(this._editingEnded(),await this._applyExpression(t)):this._editingCancelled()}_promptKeyDown(e,t){return isEnterKey(t)?(t.consume(),void this._editingCommitted(e)):"Escape"===t.key?(t.consume(),void this._editingCancelled()):void 0}async _applyExpression(e){const t=x.RemoteObject.toCallArgument(this.property.symbol||this.property.name);if(e=N.wrapObjectLiteral(e.trim()),this.property.synthetic){let t=!1;if(e&&(t=await this.property.setSyntheticValue(e)),t){const e=this.parent;e.invalidateChildren(),e.onpopulate()}else this.update();return}const n=e?this.property.parentObject.setPropertyValue(t,e):this.property.parentObject.deleteProperty(t);if(await n)this.update();else if(e){const e=this.parent;e.invalidateChildren(),e.onpopulate()}else this.parent.removeChild(this)}_onInvokeGetterClick(e){e.object&&(this.property.value=e.object,this.property.wasThrown=e.wasThrown,this.update(),this.invalidateChildren(),this._updateExpandable())}_updateExpandable(){this.property.value?this.setExpandable(!this.property.value.customPreview()&&this.property.value.hasChildren&&!this.property.wasThrown):this.setExpandable(!1)}path(){return this.nameElement.title}}class U extends o.TreeElement{constructor(e,t,n,i,s){super(f.sprintf("[%d … %d]",t,n),!0),this.toggleOnClick=!0,this._fromIndex=t,this._toIndex=n,this._object=e,this._readOnly=!0,this._propertyCount=i,this._linkifier=s}static async _populateArray(e,t,n,i,s){await U._populateRanges(e,t,n,i,!0,s)}static async _populateRanges(e,t,n,i,s,r){const o=await t.callFunctionJSON((function(e,t,n,i,s){let r=null;const o=t-e>=i&&ArrayBuffer.isView(this),a=o&&t-e>=s;function*l(n){if(t-e<i)for(let i=e;i<=t;++i)i in n&&(yield i);else{r=r||Object.getOwnPropertyNames(n);for(let n=0;n<r.length;++n){const i=r[n],s=i>>>0;""+s===i&&e<=s&&s<=t&&(yield s)}}}let c=0;if(o)c=t-e+1;else for(const e of l(this))++c;let p=c;p=c<=n?c:Math.pow(n,Math.ceil(Math.log(c)/Math.log(n))-1);const d=[];if(o)for(let n=e;n<=t;n+=p){const e=n;let i=e+p-1;i>t&&(i=t),d.push([e,i,i-e+1])}else{c=0;let e=-1,t=0;for(const n of l(this))-1===e&&(e=n),t=n,++c===p&&(d.push([e,t,c]),c=0,e=-1);c>0&&d.push([e,t,c])}return{ranges:d,skipGetOwnPropertyNames:a}}),[{value:n},{value:i},{value:U._bucketThreshold},{value:U._sparseIterationThreshold},{value:U._getOwnPropertyNamesThreshold}]);await async function(n){if(!n)return;const i=n.ranges;if(1===i.length)await U._populateAsFragment(e,t,i[0][0],i[0][1],r);else for(let n=0;n<i.length;++n){const s=i[n][0],o=i[n][1],a=i[n][2];s===o?await U._populateAsFragment(e,t,s,o,r):e.appendChild(new U(t,s,o,a,r))}s&&await U._populateNonIndexProperties(e,t,n.skipGetOwnPropertyNames,r)}(o)}static async _populateAsFragment(e,t,n,i,s){const r=await t.callFunction((function(e,t,n){const i=Object.create(null);if(t-e<n)for(let n=e;n<=t;++n)n in this&&(i[n]=this[n]);else{const n=Object.getOwnPropertyNames(this);for(let s=0;s<n.length;++s){const r=n[s],o=r>>>0;String(o)===r&&e<=o&&o<=t&&(i[o]=this[o])}}return i}),[{value:n},{value:i},{value:U._sparseIterationThreshold}]);if(!r.object||r.wasThrown)return;const o=r.object,a=await o.getAllProperties(!1,!0);o.release();const l=a.properties;if(l){l.sort(R.CompareProperties);for(let t=0;t<l.length;++t){l[t].parentObject=this._object;const n=new B(l[t],s);n._readOnly=!0,e.appendChild(n)}}}static async _populateNonIndexProperties(e,t,n,i){const s=await t.callFunction((function(e){const t={__proto__:this.__proto__};if(e)return t;const n=Object.getOwnPropertyNames(this);for(let e=0;e<n.length;++e){const i=n[e];if(String(i>>>0)===i&&i>>>0!=4294967295)continue;const s=Object.getOwnPropertyDescriptor(this,i);s&&Object.defineProperty(t,i,s)}return t}),[{value:n}]);if(!s.object||s.wasThrown)return;const r=await s.object.getOwnProperties(!0);if(s.object.release(),!r.properties)return;const o=r.properties;o.sort(R.CompareProperties);for(const t of o){if(t.parentObject=this._object,!R._isDisplayableProperty(t,e.property))continue;const n=new B(t,i);n._readOnly=!0,e.appendChild(n)}}async onpopulate(){this._propertyCount>=U._bucketThreshold?await U._populateRanges(this,this._object,this._fromIndex,this._toIndex,!1,this._linkifier):await U._populateAsFragment(this,this._object,this._fromIndex,this._toIndex,this._linkifier)}onattach(){this.listItemElement.classList.add("object-properties-section-name")}}U._bucketThreshold=100,U._sparseIterationThreshold=25e4,U._getOwnPropertyNamesThreshold=5e5;class J extends d.TextPrompt{constructor(){super(),this.initialize(ObjectUI.javaScriptAutocomplete.completionsForTextInCurrentContext.bind(ObjectUI.javaScriptAutocomplete))}}class G{constructor(e){this._expandedProperties=new Set,e.addEventListener(o.Events.ElementAttached,this._elementAttached,this),e.addEventListener(o.Events.ElementExpanded,this._elementExpanded,this),e.addEventListener(o.Events.ElementCollapsed,this._elementCollapsed,this)}watchSection(e,t){t[G._treeOutlineId]=e,this._expandedProperties.has(e)&&t.expand()}stopWatchSectionsWithId(e){for(const t of this._expandedProperties)t.startsWith(e+":")&&this._expandedProperties.delete(t)}_elementAttached(e){const t=e.data;t.isExpandable()&&this._expandedProperties.has(this._propertyPath(t))&&t.expand()}_elementExpanded(e){const t=e.data;this._expandedProperties.add(this._propertyPath(t))}_elementCollapsed(e){const t=e.data;this._expandedProperties.delete(this._propertyPath(t))}_propertyPath(e){const t=e[G._cachedPathSymbol];if(t)return t;let n=e,i=n;const s=e.treeOutline.rootElement();let r;for(;n!==s;){let e="";e=n.property?n.property.name:"string"==typeof n.title?n.title:n.title.textContent,r=e+(r?"."+r:""),i=n,n=n.parent}return r=i[G._treeOutlineId]+(r?":"+r:""),e[G._cachedPathSymbol]=r,r}}G._cachedPathSymbol=Symbol("cachedPath"),G._treeOutlineId=Symbol("treeOutlineId");class H{constructor(e){this.element=e}appendApplicableItems(e,t,n){}}class z extends H{constructor(e,t,n){super(e);const i=e.createChild("span");this._text=t,this._maxLength=n,i.textContent=t.slice(0,n),i.title=t.slice(0,n)+"…",this._expandElement=i.createChild("span"),this._maxDisplayableTextLength=1e7;const s=f.countWtf8Bytes(t),r=g.bytesToString(s);this._text.length<this._maxDisplayableTextLength?(this._expandElementText=ls`Show more (${r})`,this._expandElement.setAttribute("data-text",this._expandElementText),this._expandElement.classList.add("expandable-inline-button"),this._expandElement.addEventListener("click",this._expandText.bind(this)),this._expandElement.addEventListener("keydown",e=>{"Enter"!==e.key&&" "!==e.key||this._expandText()}),p.markAsButton(this._expandElement)):(this._expandElement.setAttribute("data-text",ls`long text was truncated (${r})`),this._expandElement.classList.add("undisplayable-text")),this._copyButtonText=ls`Copy`;const o=i.createChild("span","expandable-inline-button");o.setAttribute("data-text",this._copyButtonText),o.addEventListener("click",this._copyText.bind(this)),o.addEventListener("keydown",e=>{"Enter"!==e.key&&" "!==e.key||this._copyText()}),p.markAsButton(o)}appendApplicableItems(e,t,n){this._text.length<this._maxDisplayableTextLength&&this._expandElement&&t.clipboardSection().appendItem(this._expandElementText,this._expandText.bind(this)),t.clipboardSection().appendItem(this._copyButtonText,this._copyText.bind(this))}_expandText(){this._expandElement&&(this._expandElement.parentElement&&this._expandElement.parentElement.insertBefore(createTextNode(this._text.slice(this._maxLength)),this._expandElement),this._expandElement.remove(),this._expandElement=null)}_copyText(){y.InspectorFrontendHostInstance.copyText(this._text)}}var q=Object.freeze({__proto__:null,ObjectPropertiesSection:R,maxRenderableStringLength:W,ObjectPropertiesSectionsTreeOutline:V,RootElement:$,InitialVisibleChildrenLimit:200,ObjectPropertyTreeElement:B,ArrayGroupingTreeElement:U,ObjectPropertyPrompt:J,ObjectPropertiesSectionsTreeExpandController:G,Renderer:class{render(e,t){if(!(e instanceof x.RemoteObject))return Promise.reject(new Error("Can't render "+e));const n=(t=t||{}).title,i=new R(e,n);return n||i.titleLessMode(),i.editable=!!t.editable,Promise.resolve({node:i.element,tree:i})}},ObjectPropertyValue:H,ExpandableTextPropertyValue:z,TreeOutlineOptions:void 0});class K{constructor(e){this._sectionElement=document.createElement("span"),this._sectionElement.classList.add("custom-expandable-section"),this._object=e,this._expanded=!1,this._cachedContent=null;const t=e.customPreview();if(!t)return;let i;try{i=JSON.parse(t.header)}catch(e){return void n.Console.instance().error("Broken formatter: header is invalid json "+e)}this._header=this._renderJSONMLTag(i),this._header.nodeType!==Node.TEXT_NODE?(t.bodyGetterId&&(this._header instanceof Element&&this._header.classList.add("custom-expandable-section-header"),this._header.addEventListener("click",this._onClick.bind(this),!1),this._expandIcon=h.Icon.create("smallicon-triangle-right","custom-expand-icon"),this._header.insertBefore(this._expandIcon,this._header.firstChild)),this._sectionElement.appendChild(this._header)):n.Console.instance().error("Broken formatter: header should be an element node.")}element(){return this._sectionElement}_renderJSONMLTag(e){if(!Array.isArray(e))return document.createTextNode(e+"");const t=e;return"object"===t[0]?this._layoutObjectTag(t):this._renderElement(t)}_renderElement(e){const t=e.shift();if(!K._allowedTags.has(t))return n.Console.instance().error("Broken formatter: element "+t+" is not allowed!"),document.createElement("span");const i=document.createElement(t);if("object"==typeof e[0]&&!Array.isArray(e[0])){const t=e.shift();for(const e in t){const n=t[e];"style"===e&&"string"==typeof n&&i.setAttribute(e,n)}}return this._appendJsonMLTags(i,e),i}_layoutObjectTag(e){e.shift();const t=e.shift(),n=this._object.runtimeModel().createRemoteObject(t);if(n.customPreview())return new K(n).element();const i=R.defaultObjectPresentation(n);return i.classList.toggle("custom-expandable-section-standard-section",n.hasChildren),i}_appendJsonMLTags(e,t){for(let n=0;n<t.length;++n)e.appendChild(this._renderJSONMLTag(t[n]))}_onClick(e){e.consume(!0),this._cachedContent?this._toggleExpand():this._loadBody()}_toggleExpand(){this._expanded=!this._expanded,this._header instanceof Element&&this._header.classList.toggle("expanded",this._expanded),this._cachedContent instanceof Element&&this._cachedContent.classList.toggle("hidden",!this._expanded),this._expandIcon&&(this._expanded?this._expandIcon.setIconType("smallicon-triangle-down"):this._expandIcon.setIconType("smallicon-triangle-right"))}async _loadBody(){const e=this._object.customPreview();if(e&&e.bodyGetterId){const t=await this._object.callFunctionJSON(e=>e(),[{objectId:e.bodyGetterId}]);if(!t)return;this._cachedContent=this._renderJSONMLTag(t),this._sectionElement.appendChild(this._cachedContent),this._toggleExpand()}}}class Q{constructor(e){this._object=e,this._customPreviewSection=new K(e),this.element=document.createElement("span"),this.element.classList.add("source-code");const t=a.createShadowRootWithCoreStyles(this.element,{cssFile:"object_ui/customPreviewComponent.css",enableLegacyPatching:!0,delegatesFocus:void 0});this.element.addEventListener("contextmenu",this._contextMenuEventFired.bind(this),!1),t.appendChild(this._customPreviewSection.element())}expandIfPossible(){const e=this._object.customPreview();e&&e.bodyGetterId&&this._customPreviewSection&&this._customPreviewSection._loadBody()}_contextMenuEventFired(t){const n=new c.ContextMenu(t);this._customPreviewSection&&n.revealSection().appendItem(e.UIString("Show as JavaScript object"),this._disassemble.bind(this)),n.appendApplicableItems(this._object),n.show()}_disassemble(){this.element.shadowRoot&&(this.element.shadowRoot.textContent="",this._customPreviewSection=null,this.element.shadowRoot.appendChild(R.defaultObjectPresentation(this._object)))}}K._allowedTags=new Set(["span","div","ol","li","table","tr","td"]);var X=Object.freeze({__proto__:null,CustomPreviewSection:K,CustomPreviewComponent:Q});class Z{constructor(){this._expressionCache=new Map,w.ConsoleModel.instance().addEventListener(w.Events.CommandEvaluated,this._clearCache,this),r.Context.instance().addFlavorChangeListener(v.ExecutionContext,this._clearCache,this),E.TargetManager.instance().addModelListener(j.DebuggerModel,j.Events.DebuggerResumed,this._clearCache,this),E.TargetManager.instance().addModelListener(j.DebuggerModel,j.Events.DebuggerPaused,this._clearCache,this)}_clearCache(){this._expressionCache.clear()}async completionsForTextInCurrentContext(e,t,n){const i=e.trim(),[s,r]=await Promise.all([this._mapCompletions(i,t),this._completionsForExpression(i,t,n)]);return s.concat(r)}async argumentsHint(e){const t=await O.formatterWorkerPool().findLastFunctionCall(e);if(!t)return null;const n=r.Context.instance().flavor(v.ExecutionContext);if(!n)return null;const i=await n.evaluate({expression:t.baseExpression,objectGroup:"argumentsHint",includeCommandLineAPI:!0,silent:!0,returnByValue:!1,generatePreview:!1,throwOnSideEffect:!0,timeout:500},!1,!1);if(!i||i.exceptionDetails||!i.object||"function"!==i.object.type)return n.runtimeModel.releaseObjectGroup("argumentsHint"),null;const s=await this._argumentsForFunction(i.object,async()=>{const e=await n.evaluate({expression:t.receiver,objectGroup:"argumentsHint",includeCommandLineAPI:!0,silent:!0,returnByValue:!1,generatePreview:!1,throwOnSideEffect:!0,timeout:500},!1,!1);return e&&!e.exceptionDetails&&e.object?e.object:null},t.functionName);return n.runtimeModel.releaseObjectGroup("argumentsHint"),s.length&&(1!==s.length||s[0]&&s[0].length)?{args:s,argumentIndex:t.argumentIndex}:null}async _argumentsForFunction(e,t,n){const s=e.description;if(!s.endsWith("{ [native code] }"))return[await O.formatterWorkerPool().argumentsList(s)];if("function () { [native code] }"===s){const t=(await e.getOwnProperties(!1)).internalProperties||[],n=t.find(e=>"[[TargetFunction]]"===e.name),i=t.find(e=>"[[BoundArgs]]"===e.name),s=t.find(e=>"[[BoundThis]]"===e.name);if(s&&n&&i){const e=await this._argumentsForFunction(n.value,()=>Promise.resolve(s.value)),t=x.RemoteObject.arrayLength(i.value),r=[];for(const n of e){const e=n.slice(0,t).findIndex(e=>e.startsWith("..."));-1!==e?r.push(n.slice(e)):r.push(n.slice(t))}return r}}const r=await S.Runtime.instance().extension(i.JavaScriptMetaData).instance(),o=/^function ([^(]*)\(/.exec(s)[1]||n;if(!o)return[];const a=r.signaturesForNativeFunction(o);if(a)return a;const l=await t();if(!l)return[];const c=l.className;if(r.signaturesForInstanceMethod(o,c))return r.signaturesForInstanceMethod(o,c);if("function"===l.type&&l.description.endsWith("{ [native code] }")){const e=/^function ([^(]*)\(/.exec(l.description)[1],t=r.signaturesForStaticMethod(o,e);if(t)return t}let p;if(p="number"===l.type?["Number","Object"]:"string"===l.type?["String","Object"]:"symbol"===l.type?["Symbol","Object"]:"bigint"===l.type?["BigInt","Object"]:"boolean"===l.type?["Boolean","Object"]:"undefined"===l.type||"null"===l.subtype?[]:await l.callFunctionJSON((function(){const e=[];for(let t=this;t;t=Object.getPrototypeOf(t))"object"==typeof t&&t.constructor&&t.constructor.name&&(e[e.length]=t.constructor.name);return e}),[]),!p)return[];for(const e of p){const t=r.signaturesForInstanceMethod(o,e);if(t)return t}return[]}async _mapCompletions(t,n){const i=t.match(/\.\s*(get|set|delete)\s*\(\s*$/),s=r.Context.instance().flavor(v.ExecutionContext);if(!s||!i)return[];const o=await O.formatterWorkerPool().findLastExpression(t.substring(0,i.index));if(!o)return[];const a=await s.evaluate({expression:o,objectGroup:"mapCompletion",includeCommandLineAPI:!0,silent:!0,returnByValue:!1,generatePreview:!1,throwOnSideEffect:!0,timeout:500},!1,!1);if(a.error||a.exceptionDetails||"map"!==a.object.subtype)return[];const l=((await a.object.getOwnProperties(!1)).internalProperties||[]).find(e=>"[[Entries]]"===e.name);if(!l)return[];const c=await l.value.callFunctionJSON((function(){const e={__proto__:null};for(let t=0;t<this.length;t++)"string"==typeof this[t].key&&(e[this[t].key]=!0);return e}));return s.runtimeModel.releaseObjectGroup("mapCompletion"),function(t){const s=[],r=[],o=[],a=[];let l='"';n.startsWith("'")&&(l="'");let c=")";-1!==i[0].indexOf("set")&&(c=", ");const p=t.length<1e3?String.naturalOrderComparator:void 0,d=t.sort(p).map(e=>l+e+l);for(const e of d){if(e.length<n.length)continue;if(n.length&&-1===e.toLowerCase().indexOf(n.toLowerCase()))continue;const t=e.split("\n").join("\\n"),i=t+c;e.startsWith(n)?s.push({text:i,title:t,priority:4}):e.toLowerCase().startsWith(n.toLowerCase())?r.push({text:i,title:t,priority:3}):-1!==e.indexOf(n)?o.push({text:i,title:t,priority:2}):a.push({text:i,title:t,priority:1})}const h=s.concat(r,o,a);h.length&&(h[0].subtitle=e.UIString("Keys"));return h}(Object.keys(c))}async _completionsForExpression(t,n,i){const s=r.Context.instance().flavor(v.ExecutionContext);if(!s)return[];let o;if(t.endsWith("?.")?o=await O.formatterWorkerPool().findLastExpression(t.substring(0,t.length-2)):(t.endsWith(".")||t.endsWith("["))&&(o=await O.formatterWorkerPool().findLastExpression(t.substring(0,t.length-1))),!o){if(t.endsWith("."))return[];o=""}const a=o,l=t.endsWith("."),c=!!a&&t.endsWith("[");if(a&&!isNaN(a)||!a&&n&&!isNaN(n))return[];if(!n&&!a&&!i)return[];const p=s.debuggerModel.selectedCallFrame();let d;let h=this._expressionCache.get(a);if(h&&h.date+1e4>Date.now())d=await h.value;else if(!a&&p)h={date:Date.now(),value:async function(e){const t=[{items:["this"]}],n=e.scopeChain(),i=[];for(const e of n)i.push(e.object().getAllProperties(!1,!1).then(t=>({properties:t.properties,name:e.name()})));const r=await Promise.all(i);s.runtimeModel.releaseObjectGroup("completion");for(const e of r)t.push({title:e.name,items:e.properties.map(e=>e.name).sort()});return t}(p)},this._expressionCache.set(a,h),d=await h.value;else{const e=s.evaluate({expression:a,objectGroup:"completion",includeCommandLineAPI:!0,silent:!0,returnByValue:!1,generatePreview:!1,throwOnSideEffect:!0,timeout:500},!1,!1);h={date:Date.now(),value:e.then(e=>u.call(this,e))},this._expressionCache.set(a,h),d=await h.value}return this._receivedPropertyNames(d.slice(0),l,c,a,n);async function u(t){if(t.error||t.exceptionDetails||!t.object)return[];let n=t.object;for(;n&&"object"===n.type&&"proxy"===n.subtype;){const e=((await n.getOwnProperties(!1)).internalProperties||[]).find(e=>"[[Target]]"===e.name);n=e?e.value:null}if(!n)return[];let i=[];if("object"===n.type||"function"===n.type)i=await n.callFunctionJSON(r,[x.RemoteObject.toCallArgument(n.subtype)])||[];else if("string"===n.type||"number"===n.type||"boolean"===n.type||"bigint"===n.type){const e=await s.evaluate({expression:"("+r+')("'+n.type+'")',objectGroup:"completion",includeCommandLineAPI:!1,silent:!0,returnByValue:!0,generatePreview:!1},!1,!1);e.object&&!e.exceptionDetails&&(i=e.object.value||[])}if(s.runtimeModel.releaseObjectGroup("completion"),!a){const t=await s.globalLexicalScopeNames();i.length?i[0].items=i[0].items.concat(t):i.push({items:t.sort(),title:e.UIString("Lexical scope variables")})}for(const e of i){for(let t=0;t<e.items.length;t++)e.items[t]=e.items[t].replace(/\n/g,"\\n");e.items.sort(e.items.length<1e3?this._itemComparator:void 0)}return i;function r(e){let t;t="string"===e?new String(""):"number"===e?new Number(0):"bigint"===e?Object(BigInt(0)):"boolean"===e?new Boolean(!1):this;const n=[];try{for(let i=t;i;i=Object.getPrototypeOf(i)){if(("array"===e||"typedarray"===e)&&i===t&&i.length>9999)continue;const s={items:[],__proto__:null};try{"object"==typeof i&&Object.prototype.hasOwnProperty.call(i,"constructor")&&i.constructor&&i.constructor.name&&(s.title=i.constructor.name)}catch(e){}n[n.length]=s;const r=Object.getOwnPropertyNames(i),o=Array.isArray(i);for(let e=0;e<r.length&&s.items.length<1e4;++e)o&&/^[0-9]/.test(r[e])||(s.items[s.items.length]=r[e])}}catch(e){}return n}}}_receivedPropertyNames(e,t,n,i,s){if(!e)return[];if(!t&&!n){const t=["dir","dirxml","keys","values","profile","profileEnd","monitorEvents","unmonitorEvents","inspect","copy","clear","getEventListeners","debug","undebug","monitor","unmonitor","table","queryObjects","$","$$","$x","$0","$_"];e.push({items:t})}return this._completionsForQuery(t,n,i,s,e)}_completionsForQuery(e,t,n,i,s){const r=t&&i.startsWith("'")?"'":'"';if(!n){const e=["await","break","case","catch","class","const","continue","debugger","default","delete","do","else","exports","extends","finally","for","function","if","import","in","instanceof","new","return","super","switch","this","throw","try","typeof","var","void","while","with","yield","let","static","async","of"];s.push({title:ls`keywords`,items:e.sort()})}const o=new Set;let a,l=[];const c=/^[a-zA-Z_$\u008F-\uFFFF][a-zA-Z0-9_$\u008F-\uFFFF]*$/,p=i.toLowerCase();for(const e of s){const n=[],s=[],d=[],h=[];for(let a=0;a<e.items.length;a++){let l=e.items[a];if(!t&&!c.test(l))continue;if(t&&(/^[0-9]+$/.test(l)||(l=r+f.escapeCharacters(l,r+"\\")+r),l+="]"),o.has(l))continue;if(l.length<i.length)continue;const u=l.toLowerCase();i.length&&-1===u.indexOf(p)||(o.add(l),l.startsWith(i)?n.push({text:l,priority:l===i?5:4}):u.startsWith(p)?s.push({text:l,priority:3}):-1!==l.indexOf(i)?d.push({text:l,priority:2}):h.push({text:l,priority:1}))}const u=n.concat(s,d,h);u.length&&e.title!==a&&(u[0].subtitle=e.title,a=e.title),l=l.concat(u),l.forEach(e=>{e.text.endsWith("]")&&(e.title=e.text.substring(0,e.text.length-1))})}return l}_itemComparator(e,t){const n=e.startsWith("_"),i=t.startsWith("_");return n&&!i?1:i&&!n?-1:String.naturalOrderComparator(e,t)}static async isExpressionComplete(e){const t=r.Context.instance().flavor(v.ExecutionContext);if(!t)return!0;const n=await t.runtimeModel.compileScript(e,"",!1,t.id);if(!n||!n.exceptionDetails)return!0;const i=n.exceptionDetails.exception.description;return!i.startsWith("SyntaxError: Unexpected end of input")&&!i.startsWith("SyntaxError: Unterminated template literal")}}class Y{constructor(e){this._editor=e}static createConfigForEditor(e){const t=new Y(e);return{substituteRangeCallback:t._substituteRange.bind(t),suggestionsCallback:t._suggestionsCallback.bind(t),tooltipCallback:t._tooltipCallback.bind(t)}}_substituteRange(e,t){const n=this._editor.tokenAtTextPosition(e,t);if(n&&"js-string"===n.type)return new P.TextRange(e,n.startColumn,e,t);const i=this._editor.line(e);let s;for(s=t-1;s>=0&&-1===" =:[({;,!+-*/&|^<>.\t\r\n".indexOf(i.charAt(s));s--);return new P.TextRange(e,s+1,e,t)}async _suggestionsCallback(e,t,n){const i=this._editor.text(e),s=this._editor.text(new P.TextRange(0,0,e.startLine,e.startColumn)),r=this._editor.tokenAtTextPosition(t.startLine,t.startColumn);if(r){const e=new Set(["js-comment","js-string-2","js-def"]),t=s.trim();if(t.endsWith("[")||t.match(/\.\s*(get|set|delete)\s*\(\s*$/)||e.add("js-string"),t.endsWith(".")||e.add("js-property"),e.has(r.type))return[]}const o=this._editor.line(e.startLine).substring(e.startColumn),a=await ObjectUI.javaScriptAutocomplete.completionsForTextInCurrentContext(s,i,n);return!n&&o&&o!==i&&a.some(e=>o.startsWith(e.text)&&i.length!==e.text.length)?[]:a}async _tooltipCallback(e,t){const n=this._editor.text(new P.TextRange(0,0,e,t)),i=await ObjectUI.javaScriptAutocomplete.argumentsHint(n);if(!i)return null;const r=i.argumentIndex,o=createElement("div");for(const e of i.args){const t=createElement("span");for(let n=0;n<e.length;n++)n===r||n<r&&e[n].startsWith("...")?t.appendChild(l.html`<b>${e[n]}</b>`):s.createTextChild(t,e[n]),n<e.length-1&&s.createTextChild(t,", ");o.appendChild(l.html`<div class='source-code'>\u0192(${t})</div>`)}return o}}var ee=Object.freeze({__proto__:null,JavaScriptAutocomplete:Z,JavaScriptAutocompleteConfig:Y,CompletionGroup:void 0});class te{constructor(e,t){this._linkifier=e,this._resultHighlightedAsDOM=t}dispose(){this._resultHighlightedAsDOM&&C.OverlayModel.hideDOMNodeHighlight(),this._linkifier&&this._linkifier.dispose()}static async buildObjectPopover(e,t){const n=(e.description||"").trimEndWithMaxLength(ne);let i=null;if("object"===e.type){let s=null,r=!1;if("node"===e.subtype&&(C.OverlayModel.highlightObjectAsDOMNode(e),r=!0),e.customPreview()){const t=new Q(e);t.expandIfPossible(),i=t.element}else{i=document.createElement("div"),i.classList.add("object-popover-content"),a.appendStyle(i,"object_ui/objectPopover.css",{enableLegacyPatching:!0});i.createChild("div","monospace object-popover-title").createChild("span").textContent=n,s=new L.Linkifier;const t=new R(e,"",s,void 0,void 0,void 0,!0);t.element.classList.add("object-popover-tree"),t.titleLessMode(),i.appendChild(t.element)}return i.dataset.stableNameForTest="object-popover-content",t.setMaxContentSize(new u.Size(300,250)),t.setSizeBehavior(m.SizeBehavior.SetExactSize),t.contentElement.appendChild(i),new te(s,r)}i=document.createElement("span"),i.dataset.stableNameForTest="object-popover-content",a.appendStyle(i,"object_ui/objectValue.css",{enableLegacyPatching:!0}),a.appendStyle(i,"object_ui/objectPopover.css",{enableLegacyPatching:!0});const r=i.createChild("span","monospace object-value-"+e.type);if(r.style.whiteSpace="pre","string"===e.type?s.createTextChildren(r,`"${n}"`):"function"!==e.type&&(r.textContent=n),"function"!==e.type)return t.contentElement.appendChild(i),new te(null,!1);R.formatObjectAsFunction(e,r,!0);const o=await e.debuggerModel().functionDetailsPromise(e);if(!o)return null;const l=document.createElement("div");l.classList.add("object-popover-container");const c=l.createChild("div","function-popover-title source-code");c.createChild("span","function-name").textContent=s.beautifyFunctionName(o.functionName);const p=o.location,d=c.createChild("div","function-title-link-container"),h=p&&p.script(),b=h&&h.sourceURL;let _=null;return b&&(_=new L.Linkifier(void 0,void 0,t.positionContent.bind(t)),d.appendChild(_.linkifyRawLocation(p,b))),l.appendChild(i),t.contentElement.appendChild(l),new te(_,!1)}}const ne=1e4;var ie=Object.freeze({__proto__:null,ObjectPopoverHelper:te});const se=new Z;export{X as CustomPreviewComponent,ee as JavaScriptAutocomplete,D as JavaScriptREPL,ie as ObjectPopoverHelper,q as ObjectPropertiesSection,F as RemoteObjectPreviewFormatter,se as javaScriptAutocomplete};
