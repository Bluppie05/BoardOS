import{Settings as e,ParsedURL as t,ObjectWrapper as o,ResourceType as s,EventTarget as r,Console as i,Throttler as n,UIString as a,Revealer as c}from"../common/common.js";import{SDKModel as u,DebuggerModel as d,SourceMapManager as l,ResourceTreeModel as h,RemoteObject as p,SourceMap as _,CompilerSourceMappingContentProvider as g,CSSModel as m,CSSStyleDeclaration as f,RuntimeModel as b,Script as S,ConsoleModel as L}from"../sdk/sdk.js";import{Workspace as v,UISourceCode as M,FileManager as w}from"../workspace/workspace.js";import{StringUtilities as C,Multimap as y}from"../platform/platform.js";import{Runtime as I}from"../root/root.js";import{StaticContentProvider as k,TextRange as R,Text as F}from"../text_utils/text_utils.js";let U;class T{constructor(t){this._debuggerWorkspaceBinding=t,u.TargetManager.instance().addModelListener(d.DebuggerModel,d.Events.GlobalObjectCleared,this._clearCacheIfNeeded.bind(this),this),e.Settings.instance().moduleSetting("skipStackFramesPattern").addChangeListener(this._patternChanged.bind(this)),e.Settings.instance().moduleSetting("skipContentScripts").addChangeListener(this._patternChanged.bind(this)),this._listeners=new Set,this._isBlackboxedURLCache=new Map,u.TargetManager.instance().observeModels(d.DebuggerModel,this)}static instance(e={forceNew:null,debuggerWorkspaceBinding:null}){const{forceNew:t,debuggerWorkspaceBinding:o}=e;if(!U||t){if(!o)throw new Error("Unable to create settings: targetManager, workspace, and debuggerWorkspaceBinding must be provided: "+(new Error).stack);U=new T(o)}return U}addChangeListener(e){this._listeners.add(e)}removeChangeListener(e){this._listeners.delete(e)}modelAdded(e){this._setBlackboxPatterns(e);const t=e.sourceMapManager();t.addEventListener(l.Events.SourceMapAttached,this._sourceMapAttached,this),t.addEventListener(l.Events.SourceMapDetached,this._sourceMapDetached,this)}modelRemoved(e){this._clearCacheIfNeeded();const t=e.sourceMapManager();t.removeEventListener(l.Events.SourceMapAttached,this._sourceMapAttached,this),t.removeEventListener(l.Events.SourceMapDetached,this._sourceMapDetached,this)}_clearCacheIfNeeded(){this._isBlackboxedURLCache.size>1024&&this._isBlackboxedURLCache.clear()}_getSkipStackFramesPatternSetting(){return e.Settings.instance().moduleSetting("skipStackFramesPattern")}_setBlackboxPatterns(e){const t=this._getSkipStackFramesPatternSetting().getAsArray(),o=[];for(const e of t)!e.disabled&&e.pattern&&o.push(e.pattern);return e.setBlackboxPatterns(o)}isBlackboxedUISourceCode(t){if(t.project().type()===v.projectTypes.ContentScripts&&e.Settings.instance().moduleSetting("skipContentScripts").get())return!0;const o=this._uiSourceCodeURL(t);return!!o&&this.isBlackboxedURL(o)}isBlackboxedURL(t,o){if(this._isBlackboxedURLCache.has(t))return!!this._isBlackboxedURLCache.get(t);if(o&&e.Settings.instance().moduleSetting("skipContentScripts").get())return!0;const s=this._getSkipStackFramesPatternSetting().asRegExp(),r=s&&s.test(t)||!1;return this._isBlackboxedURLCache.set(t,r),r}_sourceMapAttached(e){const t=e.data.client,o=e.data.sourceMap;this._updateScriptRanges(t,o)}_sourceMapDetached(e){const t=e.data.client;this._updateScriptRanges(t,null)}async _updateScriptRanges(e,t){let o=!1;if(T.instance().isBlackboxedURL(e.sourceURL,e.isContentScript())||(o=!!t&&t.sourceURLs().some(e=>this.isBlackboxedURL(e))),!o)return E.get(e)&&await e.setBlackboxedRanges([])&&E.delete(e),void await this._debuggerWorkspaceBinding.updateLocations(e);if(!t)return;const s=t.mappings(),r=[];if(s.length>0){let e=!1;0===s[0].lineNumber&&0===s[0].columnNumber||(r.push({lineNumber:0,columnNumber:0}),e=!0);for(const t of s)t.sourceURL&&e!==this.isBlackboxedURL(t.sourceURL)&&(r.push({lineNumber:t.lineNumber,columnNumber:t.columnNumber}),e=!e)}!function(e,t){if(e.length!==t.length)return!1;for(let o=0;o<e.length;++o)if(e[o].lineNumber!==t[o].lineNumber||e[o].columnNumber!==t[o].columnNumber)return!1;return!0}(E.get(e)||[],r)&&await e.setBlackboxedRanges(r)&&E.set(e,r),this._debuggerWorkspaceBinding.updateLocations(e)}_uiSourceCodeURL(e){return e.project().type()===v.projectTypes.Debugger?null:e.url()}canBlackboxUISourceCode(e){const t=this._uiSourceCodeURL(e);return!!t&&!!this._urlToRegExpString(t)}blackboxUISourceCode(e){const t=this._uiSourceCodeURL(e);t&&this._blackboxURL(t)}unblackboxUISourceCode(e){const t=this._uiSourceCodeURL(e);t&&this._unblackboxURL(t)}blackboxContentScripts(){e.Settings.instance().moduleSetting("skipContentScripts").set(!0)}unblackboxContentScripts(){e.Settings.instance().moduleSetting("skipContentScripts").set(!1)}_blackboxURL(e){const t=this._getSkipStackFramesPatternSetting().getAsArray(),o=this._urlToRegExpString(e);if(!o)return;let s=!1;for(let e=0;e<t.length;++e){const r=t[e];if(r.pattern===o){r.disabled=!1,s=!0;break}}s||t.push({pattern:o,disabled:void 0}),this._getSkipStackFramesPatternSetting().setAsArray(t)}_unblackboxURL(e){let t=this._getSkipStackFramesPatternSetting().getAsArray();const o=T.instance()._urlToRegExpString(e);if(o){t=t.filter((function(e){return e.pattern!==o}));for(let o=0;o<t.length;++o){const s=t[o];if(!s.disabled)try{new RegExp(s.pattern).test(e)&&(s.disabled=!0)}catch(e){}}this._getSkipStackFramesPatternSetting().setAsArray(t)}}async _patternChanged(){this._isBlackboxedURLCache.clear();const e=[];for(const t of u.TargetManager.instance().models(d.DebuggerModel)){e.push(this._setBlackboxPatterns(t));const o=t.sourceMapManager();for(const s of t.scripts())e.push(this._updateScriptRanges(s,o.sourceMapForClient(s)))}await Promise.all(e);const t=Array.from(this._listeners);for(const e of t)e();this._patternChangeFinishedForTests()}_patternChangeFinishedForTests(){}_urlToRegExpString(e){const o=new t.ParsedURL(e);if(o.isAboutBlank()||o.isDataURL())return"";if(!o.isValid)return"^"+e.escapeForRegExp()+"$";let s=o.lastPathComponent;if(s?s="/"+s:o.folderPathComponents&&(s=o.folderPathComponents+"/"),s||(s=o.host),!s)return"";const r=o.scheme;let i="";return r&&"http"!==r&&"https"!==r&&(i="^"+r+"://","chrome-extension"===r&&(i+=o.host+"\\b"),i+=".*"),i+s.escapeForRegExp()+(e.endsWith(s)?"$":"\\b")}}const E=new WeakMap;var N=Object.freeze({__proto__:null,BlackboxManager:T,SourceRange:void 0});class P extends v.ProjectStore{constructor(e,t,o,s,r){super(e,t,o,s),this._contentProviders={},this._isServiceProject=r,e.addProject(this)}async requestFileContent(e){const t=this._contentProviders[e.url()];try{const[e,o]=await Promise.all([t.requestContent(),t.contentEncoded()]);return{content:e.content,isEncoded:o,error:"error"in e&&e.error||""}}catch(e){return{content:null,isEncoded:!1,error:e?String(e):ls`Unknown error loading file`}}}isServiceProject(){return this._isServiceProject}requestMetadata(e){return Promise.resolve(j.get(e)||null)}canSetFileContent(){return!1}async setFileContent(e,t,o){}fullDisplayName(e){let t=e.parentURL().replace(/^(?:https?|file)\:\/\//,"");try{t=decodeURI(t)}catch(e){}return t+"/"+e.displayName(!0)}mimeType(e){return B.get(e)}canRename(){return!1}rename(e,t,o){const s=e.url();this.performRename(s,t,function(t,r){if(t&&r){const t=s.split("/");t[t.length-1]=r;const o=t.join("/");this._contentProviders[o]=this._contentProviders[s],delete this._contentProviders[s],this.renameUISourceCode(e,r)}o(t,r)}.bind(this))}excludeFolder(e){}canExcludeFolder(e){return!1}async createFile(e,t,o,s){return null}canCreateFile(){return!1}deleteFile(e){}remove(){}performRename(e,t,o){o(!1)}searchInFileContent(e,t,o,s){return this._contentProviders[e.url()].searchInContent(t,o,s)}async findFilesMatchingSearchRequest(e,t,o){const s=[];return o.setTotalWork(t.length),await Promise.all(t.map(async function(t){const r=this._contentProviders[t];let i=!0;for(const t of e.queries().slice()){if(!(await r.searchInContent(t,!e.ignoreCase(),e.isRegex())).length){i=!1;break}}i&&s.push(t);o.worked(1)}.bind(this))),o.done(),s}indexContent(e){Promise.resolve().then(e.done.bind(e))}addUISourceCodeWithProvider(e,t,o,s){B.set(e,s),this._contentProviders[e.url()]=t,j.set(e,o),this.addUISourceCode(e)}addContentProvider(e,t,o){const s=this.createUISourceCode(e,t.contentType());return this.addUISourceCodeWithProvider(s,t,null,o),s}removeFile(e){delete this._contentProviders[e],this.removeUISourceCode(e)}reset(){this._contentProviders={},this.removeProject(),this.workspace().addProject(this)}dispose(){this._contentProviders={},this.removeProject()}}const j=new WeakMap,B=new WeakMap;var A=Object.freeze({__proto__:null,ContentProviderBasedProject:P});const x=new WeakMap,D=new WeakMap;let W;class O extends o.ObjectWrapper{constructor(){super()}static instance({forceNew:e}={forceNew:!1}){return W&&!e||(W=new O),W}}const z={FrameAttributionAdded:Symbol("FrameAttributionAdded"),FrameAttributionRemoved:Symbol("FrameAttributionRemoved")};class V{static _resolveFrame(e,t){const o=V.targetForUISourceCode(e),s=o&&o.model(h.ResourceTreeModel);return s?s.frameForId(t):null}static setInitialFrameAttribution(e,t){const o=V._resolveFrame(e,t);if(!o)return;const s=new Map;s.set(t,{frame:o,count:1}),x.set(e,s)}static cloneInitialFrameAttribution(e,t){const o=x.get(e);if(!o)return;const s=new Map;for(const e of o.keys()){const t=o.get(e);void 0!==t&&s.set(e,{frame:t.frame,count:t.count})}x.set(t,s)}static addFrameAttribution(e,t){const o=V._resolveFrame(e,t);if(!o)return;const s=x.get(e);if(!s)return;const r=s.get(t)||{frame:o,count:0};if(r.count+=1,s.set(t,r),1!==r.count)return;const i={uiSourceCode:e,frame:o};O.instance().dispatchEventToListeners(z.FrameAttributionAdded,i)}static removeFrameAttribution(e,t){const o=x.get(e);if(!o)return;const s=o.get(t);if(console.assert(!!s,"Failed to remove frame attribution for url: "+e.url()),!s)return;if(s.count-=1,s.count>0)return;o.delete(t);const r={uiSourceCode:e,frame:s.frame};O.instance().dispatchEventToListeners(z.FrameAttributionRemoved,r)}static targetForUISourceCode(e){return D.get(e.project())||null}static setTargetForProject(e,t){D.set(e,t)}static getTargetForProject(e){return D.get(e)||null}static framesForUISourceCode(e){const t=V.targetForUISourceCode(e),o=t&&t.model(h.ResourceTreeModel),s=x.get(e);if(!o||!s)return[];return Array.from(s.keys()).map(e=>o.frameForId(e)).filter(e=>!!e)}}var H=Object.freeze({__proto__:null,NetworkProjectManager:O,Events:z,NetworkProject:V});class q{constructor(e,t,o){this._debuggerModel=e,this._sourceMapManager=this._debuggerModel.sourceMapManager(),this._workspace=t,this._debuggerWorkspaceBinding=o;const s=e.target();this._regularProject=new P(t,"jsSourceMaps::"+s.id(),v.projectTypes.Network,"",!1),this._contentScriptsProject=new P(t,"jsSourceMaps:extensions:"+s.id(),v.projectTypes.ContentScripts,"",!1),V.setTargetForProject(this._regularProject,s),V.setTargetForProject(this._contentScriptsProject,s),this._regularBindings=new Map,this._contentScriptsBindings=new Map,this._stubUISourceCodes=new Map,this._stubProject=new P(t,"jsSourceMaps:stub:"+s.id(),v.projectTypes.Service,"",!0),this._eventListeners=[this._sourceMapManager.addEventListener(l.Events.SourceMapWillAttach,e=>{this._sourceMapWillAttach(e)},this),this._sourceMapManager.addEventListener(l.Events.SourceMapFailedToAttach,e=>{this._sourceMapFailedToAttach(e)},this),this._sourceMapManager.addEventListener(l.Events.SourceMapAttached,e=>{this._sourceMapAttached(e)},this),this._sourceMapManager.addEventListener(l.Events.SourceMapDetached,e=>{this._sourceMapDetached(e)},this)]}_addStubUISourceCode(e){const t=this._stubProject.addContentProvider(e.sourceURL+":sourcemap",k.StaticContentProvider.fromString(e.sourceURL,s.resourceTypes.Script,"\n\n\n\n\n// Please wait a bit.\n// Compiled script is not shown while source map is being loaded!"),"text/javascript");this._stubUISourceCodes.set(e,t)}async _removeStubUISourceCode(e){const t=this._stubUISourceCodes.get(e);this._stubUISourceCodes.delete(e),t&&this._stubProject.removeFile(t.url()),await this._debuggerWorkspaceBinding.updateLocations(e)}static uiSourceCodeOrigin(e){const t=G.get(e);return t?t.compiledURL():null}mapsToSourceCode(e){const t=e.script(),o=t?this._sourceMapManager.sourceMapForClient(t):null;if(!o)return!0;const s=o.findEntry(e.lineNumber,e.columnNumber);return!!s&&s.lineNumber===e.lineNumber&&s.columnNumber===e.columnNumber}uiSourceCodeForURL(e,t){return t?this._contentScriptsProject.uiSourceCodeForURL(e):this._regularProject.uiSourceCodeForURL(e)}rawLocationToUILocation(e){const t=e.script();if(!t)return null;const o=e.lineNumber-t.lineOffset;let s=e.columnNumber;o||(s-=t.columnOffset);const r=this._stubUISourceCodes.get(t);if(r)return new M.UILocation(r,o,s);const i=this._sourceMapManager.sourceMapForClient(t);if(!i)return null;const n=i.findEntry(o,s);if(!n||!n.sourceURL)return null;const a=t.isContentScript()?this._contentScriptsProject.uiSourceCodeForURL(n.sourceURL):this._regularProject.uiSourceCodeForURL(n.sourceURL);return a?a.uiLocation(n.sourceLineNumber,n.sourceColumnNumber):null}uiLocationToRawLocations(e,t,o){const s=G.get(e);if(!s)return[];const r=this._sourceMapManager.clientsForSourceMap(s);if(!r.length)return[];const i=s.sourceLineMapping(e.url(),t,o);return i?r.map(e=>this._debuggerModel.createRawLocation(e,i.lineNumber+e.lineOffset,i.lineNumber?i.columnNumber:i.columnNumber+e.columnOffset)):[]}async _sourceMapWillAttach(e){const t=e.data;this._addStubUISourceCode(t),await this._debuggerWorkspaceBinding.updateLocations(t)}async _sourceMapFailedToAttach(e){const t=e.data;await this._removeStubUISourceCode(t)}async _sourceMapAttached(e){const t=e.data.client,o=e.data.sourceMap;await this._removeStubUISourceCode(t),T.instance().isBlackboxedURL(t.sourceURL,t.isContentScript())||await this._populateSourceMapSources(t,o),this._sourceMapAttachedForTest(o)}async _sourceMapDetached(e){const t=e.data.client,o=e.data.sourceMap,s=t.isContentScript()?this._contentScriptsBindings:this._regularBindings;for(const e of o.sourceURLs()){const r=s.get(e);r&&(r.removeSourceMap(o,t.frameId),r._uiSourceCode||s.delete(e))}await this._debuggerWorkspaceBinding.updateLocations(t)}sourceMapForScript(e){return this._sourceMapManager.sourceMapForClient(e)}scriptsForUISourceCode(e){const t=G.get(e);return t?this._sourceMapManager.clientsForSourceMap(t):[]}_sourceMapAttachedForTest(e){}async _populateSourceMapSources(e,t){const o=e.isContentScript()?this._contentScriptsProject:this._regularProject,s=e.isContentScript()?this._contentScriptsBindings:this._regularBindings;for(const r of t.sourceURLs()){let i=s.get(r);i||(i=new $(o,r),s.set(r,i)),i.addSourceMap(t,e.frameId)}await this._debuggerWorkspaceBinding.updateLocations(e)}static uiLineHasMapping(e,t){const o=G.get(e);return!o||!!o.sourceLineMapping(e.url(),t,0)}dispose(){r.EventTarget.removeEventListeners(this._eventListeners),this._regularProject.dispose(),this._contentScriptsProject.dispose(),this._stubProject.dispose()}}const G=new WeakMap;class ${constructor(e,t){this._project=e,this._url=t,this._referringSourceMaps=[],this._activeSourceMap=null,this._uiSourceCode=null}_recreateUISourceCodeIfNeeded(e){const t=this._referringSourceMaps.peekLast();if(!t||this._activeSourceMap===t)return;this._activeSourceMap=t;const o=this._project.createUISourceCode(this._url,s.resourceTypes.SourceMapScript);G.set(o,t);const r=t.sourceContentProvider(this._url,s.resourceTypes.SourceMapScript),i=s.ResourceType.mimeFromURL(this._url)||"text/javascript",n=t.embeddedContentByURL(this._url),a="string"==typeof n?new M.UISourceCodeMetadata(null,n.length):null;this._uiSourceCode?(V.cloneInitialFrameAttribution(this._uiSourceCode,o),this._project.removeFile(this._uiSourceCode.url())):V.setInitialFrameAttribution(o,e),this._uiSourceCode=o,this._project.addUISourceCodeWithProvider(this._uiSourceCode,r,a,i)}addSourceMap(e,t){this._uiSourceCode&&V.addFrameAttribution(this._uiSourceCode,t),this._referringSourceMaps.push(e),this._recreateUISourceCodeIfNeeded(t)}removeSourceMap(e,t){const o=this._uiSourceCode;V.removeFrameAttribution(o,t);const s=this._referringSourceMaps.lastIndexOf(e);-1!==s&&this._referringSourceMaps.splice(s,1),this._referringSourceMaps.length?this._recreateUISourceCodeIfNeeded(t):(this._project.removeFile(o.url()),this._uiSourceCode=null)}}var J=Object.freeze({__proto__:null,CompilerScriptMapping:q});const K=new WeakMap;class Q{constructor(e,t,o){this.typeInfo=e,this.members=t,this.typeMap=o}static create(e){if(0===e.length)return null;const t=new Map;for(const o of e)t.set(o.typeId,new Q(o,[],t));for(const o of t.values())o.members=o.typeInfo.members.map(({typeId:o})=>{const s=t.get(o);if(!s)throw new Error("Incomplete type information for type "+(e[0].typeNames[0]||"<anonymous>"));return s});return t.get(e[0].typeId)||null}}function X(e){const t=e.script;return{rawModuleId:t.sourceURL,codeOffset:e.location().columnNumber-(t.codeOffset()||0),inlineFrameIndex:e.inlineFrameIndex}}class Y extends p.RemoteObjectImpl{constructor(e,t,o,s,r){super(e.debuggerModel.runtimeModel(),s.objectId,s.type,s.subtype,s.value,s.unserializableValue,s.description,s.preview,s.customPreview,s.className),this._plugin=o,this._sourceType=t,this._callFrame=e,this.formatterTag=r}async findProperties(...e){const t={};for(const o of(await this.getOwnProperties(!1)).properties||[])e.indexOf(o.name)>=0&&o.value&&(t[o.name]=o.value);return t}async _createRemoteObject(e){const t=await this._getEvalBaseFromObject(e);if(!t)return new Y(this._callFrame,this._sourceType,this._plugin,e,this.formatterTag);const o=this._sourceType.typeMap.get(t.rootType.typeId);if(!o)throw new Error("Unknown typeId in eval base");return t.rootType.hasValue&&!t.rootType.canExpand&&t?Z.evaluate(this._callFrame,this._plugin,o,t,[]):new Z(this._callFrame,this._plugin,o,t,[])}async _getEvalBaseFromObject(e){const{objectId:t}=e;if(!e||!this.formatterTag)return null;const{className:o,symbol:s}=this.formatterTag;if(o!==e.className)return null;const r=await this.debuggerModel().target().runtimeAgent().invoke_callFunctionOn({functionDeclaration:"function(sym) { return this[sym]; }",objectId:t,arguments:[{objectId:s}]}),{result:i}=r;if(!i||"undefined"===i.type)return null;const n=new Y(this._callFrame,this._sourceType,this._plugin,i,null),{payload:a,rootType:c}=await n.findProperties("payload","rootType");if(void 0===a||void 0===c)return null;const u=await async function(e,t){if(void 0!==t.value)return t.value;const o=await e.debuggerModel.target().runtimeAgent().invoke_callFunctionOn({functionDeclaration:"function() { return this; }",objectId:t.objectId,returnByValue:!0}),{result:s}=o;return s?s.value:void 0}(this._callFrame,a),{typeId:d}=await c.findProperties("typeId","rootType");if(void 0===u||void 0===d)return null;const l=this._sourceType.typeMap.get(d.value);return l?{payload:u,rootType:l.typeInfo}:null}}class Z extends p.RemoteObjectImpl{static async evaluate(e,t,o,s,r){const i=X(e);let n=await t.getFormatter({base:s,field:r},i);n||(n={js:""});const a=await e.debuggerModel.target().debuggerAgent().invoke_evaluateOnCallFrame({callFrameId:e.id,expression:n.js,generatePreview:!1,includeCommandLineAPI:!0,objectGroup:"console",returnByValue:!1,silent:!1}),{result:c}=a,u=new Y(e,o,t,c,null),d=await async function(e){const{tag:t,value:o}=await e.findProperties("tag","value");if(!t||!o)return null;const{className:s,symbol:r}=await t.findProperties("className","symbol");if(!s||!r)return null;const i=s.value;if("string"!=typeof i||void 0===r.objectId)return null;return o.formatterTag={symbol:r.objectId,className:i},o}(u)||u;return void 0===d.value&&(d.description=o.typeInfo.typeNames[0]),d}static async get(e,t,o){const s=X(e),r=await t.getTypeInfo(o,s);if(!r)return new p.LocalJSONObject(void 0);const{base:i,typeInfos:n}=r,a=Q.create(n);return a?a.typeInfo.hasValue&&!a.typeInfo.canExpand&&i?Z.evaluate(e,t,a,i,[]):new Z(e,t,a,i,[]):new p.LocalJSONObject(void 0)}constructor(e,t,o,s,r){const i=o.typeInfo.typeNames[0]||"<anonymous>";super(e.debuggerModel.runtimeModel(),void 0,"object",void 0,null,void 0,i,void 0,void 0,i),this._variableType="object",this._callFrame=e,this._plugin=t,this._sourceType=o,this._base=s,this._fieldChain=r,this._hasChildren=!0}get type(){return this._variableType}async _expandMember(e,t){return e.typeInfo.hasValue&&!e.typeInfo.canExpand&&this._base?Z.evaluate(this._callFrame,this._plugin,e,this._base,this._fieldChain.concat(t)):new Z(this._callFrame,this._plugin,e,this._base,this._fieldChain.concat(t))}async doGetProperties(e,t,o){const{typeInfo:s}=this._sourceType;if(t||!s.canExpand)return{properties:[],internalProperties:[]};if(s.members.length>0){if(s.arraySize>0){const{typeId:e}=this._sourceType.typeInfo.members[0],t=[],o=this._sourceType.members[0];for(let r=0;r<s.arraySize;++r){const s=""+r,i={name:s,typeId:e,offset:o.typeInfo.size*r};t.push(new p.RemoteObjectProperty(s,await this._expandMember(o,i),!1,!1,!0,!1))}return{properties:t,internalProperties:[]}}const e=Promise.all(this._sourceType.members.map(async(e,t)=>{const o=this._sourceType.typeInfo.members[t],s=await this._expandMember(e,o),r=o.name||"";return new p.RemoteObjectProperty(r,s,!1,!1,!0,!1)}));return{properties:await e,internalProperties:[]}}return{properties:[],internalProperties:[]}}}class ee extends p.LocalJSONObject{constructor(e){super(e)}get description(){return this.type}get type(){return"namespace"}}class te extends p.RemoteObjectImpl{constructor(e,t,o){super(e.debuggerModel.runtimeModel(),void 0,"object",void 0,null),this.variables=[],this._callFrame=e,this._plugin=t,this._location=o}async doGetProperties(e,t,o){if(t)return{properties:[],internalProperties:[]};const s=[],r={};function i(e,t){return new p.RemoteObjectProperty(e,t,!1,!1,!0,!1)}for(const e of this.variables){const t=await Z.get(this._callFrame,this._plugin,e.name);if(e.nestedName&&e.nestedName.length>1){let o=r;for(let t=0;t<e.nestedName.length-1;t++){const s=e.nestedName[t];let r=o[s];r||(r=new ee({}),o[s]=r),o=r.value}o[e.nestedName[e.nestedName.length-1]]=t}else s.push(i(e.name,t))}for(const e in r)s.push(i(e,r[e]));return{properties:s,internalProperties:[]}}}class oe{constructor(e,t,o,s,r,i){this._callFrame=e,this._type=t,this._typeName=o,this._icon=s,this._object=new te(e,r,i),this._name=t,this._startLocation=null,this._endLocation=null}async getVariableValue(e){for(let t=0;t<this._object.variables.length;++t){if(this._object.variables[t].name!==e)continue;const o=await this._object.getAllProperties(!1,!1);if(!o.properties)continue;const{value:s}=o.properties[t];if(s)return s}return null}callFrame(){return this._callFrame}type(){return this._type}typeName(){return this._typeName}name(){}startLocation(){return this._startLocation}endLocation(){return this._endLocation}object(){return this._object}description(){return""}icon(){return this._icon}}class se{constructor(e,t,o){this._sourceMapManager=e.sourceMapManager(),this._debuggerModel=e,this._debuggerWorkspaceBinding=o,this._plugins=[];for(const e of self.Extensions.extensionServer.languageExtensionEndpoints)this._plugins.push(e);this._uiSourceCodes=new Map,this._pluginForScriptId=new Map,this._unhandledScripts=new Set;const s=this._debuggerModel.target();this._project=new P(t,"language_plugins::"+s.id(),v.projectTypes.Network,"",!1),V.setTargetForProject(this._project,s),this._eventHandlers=[this._debuggerModel.addEventListener(d.Events.ParsedScriptSource,this._newScriptSourceListener,this),self.Extensions.extensionServer.addEventListener(Extensions.ExtensionServer.Events.LanguageExtensionEndpointAdded,this._languageExtensionPluginAdded,this)]}clearPlugins(){this._plugins=[]}addPlugin(e){this._plugins.push(e);const t=[];for(const o of this._unhandledScripts)e.handleScript(o)&&(t.push(o),this._unhandledScripts.delete(o));t.forEach(t=>this._pluginForScriptId.set(t.scriptId,this._loadScript(e,t)))}_languageExtensionPluginAdded(e){this.addPlugin(e.data)}hasPluginForScript(e){return this._pluginForScriptId.has(e.scriptId)}_getPluginForScript(e){return Promise.resolve(this._pluginForScriptId.get(e.scriptId)||null)}async rawLocationToUILocation(e){const t=e.script();if(!t)return null;const o=await this._getPluginForScript(t);if(!o)return null;const s={rawModuleId:t.sourceURL,codeOffset:e.columnNumber-(t.codeOffset()||0),inlineFrameIndex:e.inlineFrameIndex};let r;try{r=await o.rawLocationToSourceLocation(s)}catch(e){return i.Console.instance().error(ls`Error in debugger language plugin: ${e.message}`),null}if(!r||0===r.length)return null;const n=r[0],a=this._project.uiSourceCodeForURL(n.sourceFileURL);return a?a.uiLocation(n.lineNumber,n.columnNumber>=0?n.columnNumber:void 0):null}async uiLocationToRawLocationRanges(e,t,o){const s=this._uiSourceCodes.get(e);if(!s)return null;const r=[];for(const{sourceFileURL:e,script:t}of s){const o=await this._getPluginForScript(t);o&&r.push(n(this._debuggerModel,o,e,t))}if(0===r.length)return null;try{return(await Promise.all(r)).flat()}catch(e){return i.Console.instance().error(ls`Error in debugger language plugin: ${e.message}`),null}async function n(e,s,r,i){const n={rawModuleId:i.sourceURL,sourceFileURL:r,lineNumber:t,columnNumber:o},a=await s.sourceLocationToRawLocation(n);return a&&0!==a.length?a.map(t=>({start:new d.Location(e,i.scriptId,0,Number(t.startOffset)+(i.codeOffset()||0)),end:new d.Location(e,i.scriptId,0,Number(t.endOffset)+(i.codeOffset()||0))})):[]}}async uiLocationToRawLocations(e,t,o){const s=await this.uiLocationToRawLocationRanges(e,t,o);return s?s.map(({start:e})=>e):null}async _getRawModule(e){return e.sourceURL.startsWith("wasm://")?e.sourceMapURL===_.WasmSourceMap.FAKE_URL?{code:await e.getWasmBytecode(),url:e.sourceURL}:null:{url:e.sourceURL,code:void 0}}_getOrCreateUISourceCode(e,t){let o=this._project.uiSourceCodeForURL(e);if(o)return o;o=this._project.createUISourceCode(e,s.resourceTypes.SourceMapScript),V.setInitialFrameAttribution(o,t.frameId);const r=new g.CompilerSourceMappingContentProvider(e,s.resourceTypes.SourceMapScript,t.createPageResourceLoadInitiator());this._bindUISourceCode(o,t,e);const i=s.ResourceType.mimeFromURL(e)||"text/javascript";return this._project.addUISourceCodeWithProvider(o,r,null,i),o}_bindUISourceCode(e,t,o){const s=this._uiSourceCodes.get(e);s?s.push({sourceFileURL:o,script:t}):this._uiSourceCodes.set(e,[{sourceFileURL:o,script:t}]),K.set(e,t)}_unbindUISourceCode(e,t){K.delete(e);const o=this._uiSourceCodes.get(e);if(!o)return;const s=o.filter(({script:e})=>e!==t);this._uiSourceCodes.set(e,s),0===s.length&&(this._project.removeFile(e.url()),this._uiSourceCodes.delete(e))}scriptsForUISourceCode(e){const t=new Set;for(const{script:o}of this._uiSourceCodes.get(e)||[])t.add(o);return[...t]}static uiSourceCodeOriginScript(e){return K.get(e)||null}async _loadScript(e,t){const o=await this._getRawModule(t);if(!o)return null;const s=(t.debugSymbols?t.debugSymbols.externalURL:t.sourceMapURL)||"";try{const r=await e.addRawModule(t.sourceURL,s,o);for(const e of r)this._getOrCreateUISourceCode(e,t);return this._debuggerWorkspaceBinding.updateLocations(t),e}catch(e){return i.Console.instance().error(ls`Error in debugger language plugin: ${e.message}`),null}}_newScriptSourceListener(e){const t=e.data;if(t.isWasm()&&t.sourceURL){for(const e of this._plugins)if(e.handleScript(t))return void this._pluginForScriptId.set(t.scriptId,this._loadScript(e,t));this._unhandledScripts.add(t)}}dispose(){this._project.dispose();for(const e of this._plugins)e.dispose&&e.dispose();this._pluginForScriptId.clear(),this._uiSourceCodes.clear()}async resolveScopeChain(e){if(!e)return null;const t=e.script,o=await this._getPluginForScript(t);if(!o)return null;const s=new Map,r=X(e);try{const t=await o.listVariablesInScope(r);for(const i of t||[]){let t=s.get(i.scope);if(!t){const{type:n,typeName:a,icon:c}=await o.getScopeInfo(i.scope);t=new oe(e,n,a,c,o,r),s.set(i.scope,t)}t.object().variables.push(i)}return Array.from(s.values())}catch(e){return i.Console.instance().error(ls`Error in debugger language plugin: ${e.message}`),null}}async getFunctionInfo(e){const t={frames:[]};if(!e)return t;const o=e.script,s=await this._getPluginForScript(o);if(!s)return t;const r={rawModuleId:o.sourceURL,codeOffset:e.location().columnNumber-(o.codeOffset()||0),inlineFrameIndex:void 0};try{return await s.getFunctionInfo(r)}catch(e){return i.Console.instance().warn(ls`Error in debugger language plugin: ${e.message}`),t}}async evaluateExpression(e,t){const o=t.script,s=await this._getPluginForScript(o);if(!s)return null;try{return{object:await Z.get(t,s,e),exceptionDetails:void 0}}catch(e){return{error:e.message}}}async getInlinedFunctionRanges(e){const t=e.script();if(!t)return[];const o=await this._getPluginForScript(t);if(!o)return[];const s={rawModuleId:t.sourceURL,codeOffset:e.columnNumber-(t.codeOffset()||0),inlineFrameIndex:void 0};try{return(await o.getInlinedFunctionRanges(s)).map(e=>({start:new d.Location(this._debuggerModel,t.scriptId,0,Number(e.startOffset)+(t.codeOffset()||0)),end:new d.Location(this._debuggerModel,t.scriptId,0,Number(e.endOffset)+(t.codeOffset()||0))}))}catch(e){return i.Console.instance().warn(ls`Error in debugger language plugin: ${e.message}`),[]}}async getInlinedCalleesRanges(e){const t=e.script();if(!t)return[];const o=await this._getPluginForScript(t);if(!o)return[];const s={rawModuleId:t.sourceURL,codeOffset:e.columnNumber-(t.codeOffset()||0),inlineFrameIndex:void 0};try{return(await o.getInlinedCalleesRanges(s)).map(e=>({start:new d.Location(this._debuggerModel,t.scriptId,0,Number(e.startOffset)+(t.codeOffset()||0)),end:new d.Location(this._debuggerModel,t.scriptId,0,Number(e.endOffset)+(t.codeOffset()||0))}))}catch(e){return i.Console.instance().warn(ls`Error in debugger language plugin: ${e.message}`),[]}}async removeScript(e){const t=this._pluginForScriptId.get(e.scriptId);if(!t)return;this._pluginForScriptId.delete(e.scriptId);const o=await t;if(o){try{await o.removeRawModule(e.sourceURL)}catch(e){i.Console.instance().error(ls`Error in debugger language plugin: ${e.message}`)}for(const t of this._uiSourceCodes.keys())this._unbindUISourceCode(t,e)}}}var re=Object.freeze({__proto__:null,SourceScope:oe,DebuggerLanguagePluginManager:se,RawModule:void 0,RawLocationRange:void 0,RawLocation:void 0,SourceLocation:void 0,Variable:void 0,VariableValue:void 0,EvaluatorModule:void 0,ScopeInfo:void 0,FunctionInfo:void 0,FieldInfo:void 0,TypeInfo:void 0,EvalBase:void 0,DebuggerLanguagePlugin:class{handleScript(e){throw new Error("Not implemented yet")}dispose(){}async addRawModule(e,t,o){throw new Error("Not implemented yet")}async sourceLocationToRawLocation(e){throw new Error("Not implemented yet")}async rawLocationToSourceLocation(e){throw new Error("Not implemented yet")}async getScopeInfo(e){throw new Error("Not implemented yet")}async listVariablesInScope(e){throw new Error("Not implemented yet")}async evaluateVariable(e,t){throw new Error("Not implemented yet")}removeRawModule(e){throw new Error("Not implemented yet")}getTypeInfo(e,t){throw new Error("Not implemented yet")}getFormatter(e,t){throw new Error("Not implemented yet")}async getFunctionInfo(e){throw new Error("Not implemented yet")}async getInlinedFunctionRanges(e){throw new Error("Not implemented yet")}async getInlinedCalleesRanges(e){throw new Error("Not implemented yet")}}});const ie=new WeakMap,ne=new WeakMap;class ae{constructor(e,t,o){this._debuggerModel=e,this._debuggerWorkspaceBinding=o,this._project=new P(t,"debugger:"+e.target().id(),v.projectTypes.Debugger,"",!0),this._eventListeners=[e.addEventListener(d.Events.GlobalObjectCleared,this._debuggerReset,this),e.addEventListener(d.Events.ParsedScriptSource,this._parsedScriptSource,this),e.addEventListener(d.Events.DiscardedAnonymousScriptSource,this._discardedScriptSource,this)],this._uiSourceCodeToScriptsMap=new WeakMap}static scriptForUISourceCode(e){const t=ie.get(e);return t?t.values().next().value:null}rawLocationToUILocation(e){const t=e.script();if(!t)return null;const o=ne.get(t);if(!o)return null;const s=e.lineNumber-(t.isInlineScriptWithSourceURL()?t.lineOffset:0);let r=e.columnNumber||0;return t.isInlineScriptWithSourceURL()&&!s&&r&&(r-=t.columnOffset),o.uiLocation(s,r)}uiLocationToRawLocations(e,t,o){const s=this._uiSourceCodeToScriptsMap.get(e);return s?s.isInlineScriptWithSourceURL()?[this._debuggerModel.createRawLocation(s,t+s.lineOffset,t?o:o+s.columnOffset)]:[this._debuggerModel.createRawLocation(s,t,o)]:[]}_parsedScriptSource(e){const o=e.data,r=t.ParsedURL.extractName(o.sourceURL),i="debugger:///VM"+o.scriptId+(r?" "+r:""),n=this._project.createUISourceCode(i,s.resourceTypes.Script);this._uiSourceCodeToScriptsMap.set(n,o);const a=ie.get(n);a?a.add(o):ie.set(n,new Set([o])),ne.set(o,n),this._project.addUISourceCodeWithProvider(n,o,null,"text/javascript"),this._debuggerWorkspaceBinding.updateLocations(o)}_discardedScriptSource(e){const t=e.data,o=ne.get(t);if(!o)return;ne.delete(t),this._uiSourceCodeToScriptsMap.delete(o);const s=ie.get(o);s&&(s.delete(t),s.size||ie.delete(o)),this._project.removeUISourceCode(o.url())}_debuggerReset(){this._project.reset()}dispose(){r.EventTarget.removeEventListeners(this._eventListeners),this._debuggerReset(),this._project.dispose()}}var ce=Object.freeze({__proto__:null,DefaultScriptMapping:ae});class ue{constructor(e,t){this._updateDelegate=e,this._locationPool=t,this._locationPool._add(this),this._updatePromise=null}async update(){this._updateDelegate&&(this._updatePromise?await this._updatePromise.then(()=>this.update()):(this._updatePromise=this._updateDelegate(this),await this._updatePromise,this._updatePromise=null))}async uiLocation(){throw"Not implemented"}dispose(){this._locationPool._delete(this),this._updateDelegate=null}async isBlackboxed(){throw"Not implemented"}}class de{constructor(){this._locations=new Set}_add(e){this._locations.add(e)}_delete(e){this._locations.delete(e)}disposeAll(){for(const e of this._locations)e.dispose()}}var le=Object.freeze({__proto__:null,LiveLocation:class{update(){throw new Error("not implemented")}uiLocation(){throw new Error("not implemented")}dispose(){}isBlackboxed(){throw new Error("not implemented")}},LiveLocationWithPool:ue,LiveLocationPool:de});const he=new WeakMap;class pe{constructor(e,t,o){this._sourceMapManager=t,this._project=new P(o,"cssSourceMaps:"+e.id(),v.projectTypes.Network,"",!1),V.setTargetForProject(this._project,e),this._eventListeners=[this._sourceMapManager.addEventListener(l.Events.SourceMapAttached,e=>{this._sourceMapAttached(e)},this),this._sourceMapManager.addEventListener(l.Events.SourceMapDetached,e=>{this._sourceMapDetached(e)},this),this._sourceMapManager.addEventListener(l.Events.SourceMapChanged,e=>{this._sourceMapChanged(e)},this)]}_sourceMapAttachedForTest(e){}async _sourceMapAttached(e){const t=e.data.client,o=e.data.sourceMap;for(const e of o.sourceURLs()){let r=this._project.uiSourceCodeForURL(e);if(r){V.addFrameAttribution(r,t.frameId);continue}const i=o.sourceContentProvider(e,s.resourceTypes.SourceMapStyleSheet),n=s.ResourceType.mimeFromURL(e)||i.contentType().canonicalMimeType(),a=o.embeddedContentByURL(e),c="string"==typeof a?new M.UISourceCodeMetadata(null,a.length):null;r=this._project.createUISourceCode(e,i.contentType()),V.setInitialFrameAttribution(r,t.frameId),he.set(r,o),this._project.addUISourceCodeWithProvider(r,i,c,n)}await Ce.instance().updateLocations(t),this._sourceMapAttachedForTest(o)}async _sourceMapDetached(e){const t=e.data.client,o=e.data.sourceMap,s=this._sourceMapManager.clientsForSourceMap(o);for(const e of o.sourceURLs())if(s.length){const o=this._project.uiSourceCodeForURL(e);if(!o)continue;V.removeFrameAttribution(o,t.frameId)}else this._project.removeFile(e);await Ce.instance().updateLocations(t)}async _sourceMapChanged(e){const t=e.data.sourceMap,o=e.data.newSources,s=this._sourceMapManager.clientsForSourceMap(t);for(const e of o.keys()){const t=this._project.uiSourceCodeForURL(e);if(!t){console.error("Failed to update source for "+e);continue}const s=o.get(e);t.setWorkingCopy(s)}const r=s.map(e=>Ce.instance().updateLocations(e));await Promise.all(r)}rawLocationToUILocation(e){const t=e.header();if(!t)return null;const o=this._sourceMapManager.sourceMapForClient(t);if(!o)return null;const s=o.findEntry(e.lineNumber,e.columnNumber);if(!s||!s.sourceURL)return null;const r=this._project.uiSourceCodeForURL(s.sourceURL);return r?r.uiLocation(s.sourceLineNumber||0,s.sourceColumnNumber):null}uiLocationToRawLocations(e){const t=he.get(e.uiSourceCode);if(!t)return[];const o=t.findReverseEntries(e.uiSourceCode.url(),e.lineNumber,e.columnNumber),s=[];for(const e of this._sourceMapManager.clientsForSourceMap(t))s.push(...o.map(t=>new m.CSSLocation(e,t.lineNumber,t.columnNumber)));return s}dispose(){this._project.dispose(),r.EventTarget.removeEventListeners(this._eventListeners)}}var _e=Object.freeze({__proto__:null,SASSSourceMapping:pe});function ge(e){for(const t of u.TargetManager.instance().models(h.ResourceTreeModel)){const o=t.resourceForURL(e);if(o)return o}return null}function me(e,t,o){const s=e.model(h.ResourceTreeModel);if(!s)return null;const r=s.frameForId(t);return r?fe(r.resourceForURL(o)):null}function fe(e){return!e||"number"!=typeof e.contentSize()&&!e.lastModified()?null:new M.UISourceCodeMetadata(e.lastModified(),e.contentSize())}var be=Object.freeze({__proto__:null,resourceForURL:ge,displayNameForURL:function(e){if(!e)return"";const o=ge(e);if(o)return o.displayName;const s=v.WorkspaceImpl.instance().uiSourceCodeForURL(e);if(s)return s.displayName();const r=u.TargetManager.instance().mainTarget(),i=r&&r.inspectedURL();if(!i)return C.trimURL(e,"");const n=t.ParsedURL.fromString(i);if(!n)return e;const a=n.lastPathComponent,c=i.indexOf(a);if(-1!==c&&c+a.length===i.length){const t=i.substring(0,c);if(e.startsWith(t))return e.substring(c)}const d=C.trimURL(e,n.host);return"/"===d?n.host+"/":d},metadataForURL:me,resourceMetadata:fe});const Se=new WeakMap;class Le{constructor(e,t){this._cssModel=e;const o=this._cssModel.target();this._project=new P(t,"css:"+o.id(),v.projectTypes.Network,"",!1),V.setTargetForProject(this._project,o),this._styleFiles=new Map,this._eventListeners=[this._cssModel.addEventListener(m.Events.StyleSheetAdded,this._styleSheetAdded,this),this._cssModel.addEventListener(m.Events.StyleSheetRemoved,this._styleSheetRemoved,this),this._cssModel.addEventListener(m.Events.StyleSheetChanged,this._styleSheetChanged,this)]}rawLocationToUILocation(e){const t=e.header();if(!t||!this._acceptsHeader(t))return null;const o=this._styleFiles.get(t.resourceURL());if(!o)return null;let s=e.lineNumber,r=e.columnNumber;if(t.isInline&&t.hasSourceURL){s-=t.lineNumberInSource(0);const e=t.columnNumberInSource(s,0);void 0===e?r=e:r-=e}return o._uiSourceCode.uiLocation(s,r)}uiLocationToRawLocations(e){const t=Se.get(e.uiSourceCode);if(!t)return[];const o=[];for(const s of t._headers){let t=e.lineNumber,r=e.columnNumber;s.isInline&&s.hasSourceURL&&(r=s.columnNumberInSource(t,e.columnNumber),t=s.lineNumberInSource(t)),o.push(new m.CSSLocation(s,t,r))}return o}_acceptsHeader(e){return!e.isConstructed&&(!(e.isInline&&!e.hasSourceURL&&"inspector"!==e.origin)&&!!e.resourceURL())}_styleSheetAdded(e){const t=e.data;if(!this._acceptsHeader(t))return;const o=t.resourceURL();let s=this._styleFiles.get(o);s?s.addHeader(t):(s=new ve(this._cssModel,this._project,t),this._styleFiles.set(o,s))}_styleSheetRemoved(e){const t=e.data;if(!this._acceptsHeader(t))return;const o=t.resourceURL(),s=this._styleFiles.get(o);s&&(1===s._headers.size?(s.dispose(),this._styleFiles.delete(o)):s.removeHeader(t))}_styleSheetChanged(e){const t=this._cssModel.styleSheetHeaderForId(e.data.styleSheetId);if(!t||!this._acceptsHeader(t))return;const o=this._styleFiles.get(t.resourceURL());o&&o._styleSheetChanged(t)}dispose(){for(const e of this._styleFiles.values())e.dispose();this._styleFiles.clear(),r.EventTarget.removeEventListeners(this._eventListeners),this._project.removeProject()}}class ve{constructor(e,t,o){this._cssModel=e,this._project=t,this._headers=new Set([o]);const s=e.target(),r=o.resourceURL(),i=me(s,o.frameId,r);this._uiSourceCode=this._project.createUISourceCode(r,o.contentType()),Se.set(this._uiSourceCode,this),V.setInitialFrameAttribution(this._uiSourceCode,o.frameId),this._project.addUISourceCodeWithProvider(this._uiSourceCode,this,i,"text/css"),this._eventListeners=[this._uiSourceCode.addEventListener(M.Events.WorkingCopyChanged,this._workingCopyChanged,this),this._uiSourceCode.addEventListener(M.Events.WorkingCopyCommitted,this._workingCopyCommitted,this)],this._throttler=new n.Throttler(ve.updateTimeout),this._terminated=!1}addHeader(e){this._headers.add(e),V.addFrameAttribution(this._uiSourceCode,e.frameId)}removeHeader(e){this._headers.delete(e),V.removeFrameAttribution(this._uiSourceCode,e.frameId)}_styleSheetChanged(e){if(console.assert(this._headers.has(e)),this._isUpdatingHeaders||!this._headers.has(e))return;const t=this._mirrorContent.bind(this,e,!0);this._throttler.schedule(t,!1)}_workingCopyCommitted(e){if(this._isAddingRevision)return;const t=this._mirrorContent.bind(this,this._uiSourceCode,!0);this._throttler.schedule(t,!0)}_workingCopyChanged(e){if(this._isAddingRevision)return;const t=this._mirrorContent.bind(this,this._uiSourceCode,!1);this._throttler.schedule(t,!1)}async _mirrorContent(e,t){if(this._terminated)return void this._styleFileSyncedForTest();let o=null;if(e===this._uiSourceCode)o=this._uiSourceCode.workingCopy();else{o=(await e.requestContent()).content}if(null===o||this._terminated)return void this._styleFileSyncedForTest();e!==this._uiSourceCode&&(this._isAddingRevision=!0,this._uiSourceCode.addRevision(o),this._isAddingRevision=!1),this._isUpdatingHeaders=!0;const s=[];for(const r of this._headers)r!==e&&s.push(this._cssModel.setStyleSheetText(r.id,o,t));await Promise.all(s),this._isUpdatingHeaders=!1,this._styleFileSyncedForTest()}_styleFileSyncedForTest(){}dispose(){this._terminated||(this._terminated=!0,this._project.removeFile(this._uiSourceCode.url()),r.EventTarget.removeEventListeners(this._eventListeners))}contentURL(){return console.assert(this._headers.size>0),this._headers.values().next().value.originalContentProvider().contentURL()}contentType(){return console.assert(this._headers.size>0),this._headers.values().next().value.originalContentProvider().contentType()}contentEncoded(){return console.assert(this._headers.size>0),this._headers.values().next().value.originalContentProvider().contentEncoded()}requestContent(){return console.assert(this._headers.size>0),this._headers.values().next().value.originalContentProvider().requestContent()}searchInContent(e,t,o){return console.assert(this._headers.size>0),this._headers.values().next().value.originalContentProvider().searchInContent(e,t,o)}}ve.updateTimeout=200;var Me=Object.freeze({__proto__:null,StylesSourceMapping:Le,StyleFile:ve});let we;class Ce{constructor(e,t){this._workspace=t,this._modelToInfo=new Map,this._sourceMappings=[],e.observeModels(m.CSSModel,this),this._liveLocationPromises=new Set}static instance(e={forceNew:null,targetManager:null,workspace:null}){const{forceNew:t,targetManager:o,workspace:s}=e;if(!we||t){if(!o||!s)throw new Error("Unable to create settings: targetManager and workspace must be provided: "+(new Error).stack);we=new Ce(o,s)}return we}_getCSSModelInfo(e){return this._modelToInfo.get(e)}modelAdded(e){this._modelToInfo.set(e,new ye(e,this._workspace))}modelRemoved(e){this._getCSSModelInfo(e)._dispose(),this._modelToInfo.delete(e)}async pendingLiveLocationChangesPromise(){await Promise.all(this._liveLocationPromises)}_recordLiveLocationChange(e){e.then(()=>{this._liveLocationPromises.delete(e)}),this._liveLocationPromises.add(e)}async updateLocations(e){const t=this._getCSSModelInfo(e.cssModel())._updateLocations(e);this._recordLiveLocationChange(t),await t}createLiveLocation(e,t,o){const s=this._getCSSModelInfo(e.cssModel())._createLiveLocation(e,t,o);return this._recordLiveLocationChange(s),s}propertyUILocation(e,t){const o=e.ownerStyle;if(!o||o.type!==f.Type.Regular||!o.styleSheetId)return null;const s=o.cssModel().styleSheetHeaderForId(o.styleSheetId);if(!s)return null;const r=t?e.nameRange():e.valueRange();if(!r)return null;const i=r.startLine,n=r.startColumn,a=new m.CSSLocation(s,s.lineNumberInSource(i),s.columnNumberInSource(i,n));return this.rawLocationToUILocation(a)}rawLocationToUILocation(e){for(let t=this._sourceMappings.length-1;t>=0;--t){const o=this._sourceMappings[t].rawLocationToUILocation(e);if(o)return o}return this._getCSSModelInfo(e.cssModel())._rawLocationToUILocation(e)}uiLocationToRawLocations(e){for(let t=this._sourceMappings.length-1;t>=0;--t){const o=this._sourceMappings[t].uiLocationToRawLocations(e);if(o.length)return o}const t=[];for(const o of this._modelToInfo.values())t.push(...o._uiLocationToRawLocations(e));return t}addSourceMapping(e){this._sourceMappings.push(e)}}class ye{constructor(e,t){this._eventListeners=[e.addEventListener(m.Events.StyleSheetAdded,e=>{this._styleSheetAdded(e)},this),e.addEventListener(m.Events.StyleSheetRemoved,e=>{this._styleSheetRemoved(e)},this)],this._stylesSourceMapping=new Le(e,t);const o=e.sourceMapManager();this._sassSourceMapping=new pe(e.target(),o,t),this._locations=new y,this._unboundLocations=new y}async _createLiveLocation(e,t,o){const s=new Ie(e,this,t,o),r=e.header();return r?(s._header=r,this._locations.set(r,s),await s.update()):this._unboundLocations.set(e.url,s),s}_disposeLocation(e){e._header?this._locations.delete(e._header,e):this._unboundLocations.delete(e._url,e)}_updateLocations(e){const t=[];for(const o of this._locations.get(e))t.push(o.update());return Promise.all(t)}async _styleSheetAdded(e){const t=e.data;if(!t.sourceURL)return;const o=[];for(const e of this._unboundLocations.get(t.sourceURL))e._header=t,this._locations.set(t,e),o.push(e.update());await Promise.all(o),this._unboundLocations.deleteAll(t.sourceURL)}async _styleSheetRemoved(e){const t=e.data,o=[];for(const e of this._locations.get(t))e._header=null,this._unboundLocations.set(e._url,e),o.push(e.update());await Promise.all(o),this._locations.deleteAll(t)}_rawLocationToUILocation(e){let t=null;return t=t||this._sassSourceMapping.rawLocationToUILocation(e),t=t||this._stylesSourceMapping.rawLocationToUILocation(e),t=t||Ee.instance().cssLocationToUILocation(e),t}_uiLocationToRawLocations(e){let t=this._sassSourceMapping.uiLocationToRawLocations(e);return t.length?t:(t=this._stylesSourceMapping.uiLocationToRawLocations(e),t.length?t:Ee.instance().uiLocationToCSSLocations(e))}_dispose(){r.EventTarget.removeEventListeners(this._eventListeners),this._stylesSourceMapping.dispose(),this._sassSourceMapping.dispose()}}class Ie extends ue{constructor(e,t,o,s){super(o,s),this._url=e.url,this._lineNumber=e.lineNumber,this._columnNumber=e.columnNumber,this._info=t,this._header=null}header(){return this._header}async uiLocation(){if(!this._header)return null;const e=new m.CSSLocation(this._header,this._lineNumber,this._columnNumber);return Ce.instance().rawLocationToUILocation(e)}dispose(){super.dispose(),this._info._disposeLocation(this)}async isBlackboxed(){return!1}}var ke=Object.freeze({__proto__:null,CSSWorkspaceBinding:Ce,SourceMapping:class{rawLocationToUILocation(e){throw new Error("Not implemented yet")}uiLocationToRawLocations(e){throw new Error("Not implemented yet")}},ModelInfo:ye,LiveLocation:Ie});let Re;const Fe=new WeakMap,Ue=new WeakMap,Te=new WeakSet;class Ee{constructor(e,t){this._workspace=t,this._modelToInfo=new Map,e.observeModels(h.ResourceTreeModel,this)}static instance(e={forceNew:null,targetManager:null,workspace:null}){const{forceNew:t,targetManager:o,workspace:s}=e;if(!Re||t){if(!o||!s)throw new Error("Unable to create settings: targetManager and workspace must be provided: "+(new Error).stack);Re=new Ee(o,s)}return Re}modelAdded(e){const t=new Ne(this._workspace,e);this._modelToInfo.set(e,t)}modelRemoved(e){const t=this._modelToInfo.get(e);t&&(t.dispose(),this._modelToInfo.delete(e))}_infoForTarget(e){const t=e.model(h.ResourceTreeModel);return t&&this._modelToInfo.get(t)||null}cssLocationToUILocation(e){const t=e.header();if(!t)return null;const o=this._infoForTarget(e.cssModel().target());if(!o)return null;const s=o._project.uiSourceCodeForURL(e.url);if(!s)return null;const r=Fe.get(t)||R.TextRange.createFromLocation(t.startLine,t.startColumn),i=e.lineNumber+r.startLine-t.startLine;let n=e.columnNumber;return e.lineNumber===t.startLine&&(n+=r.startColumn-t.startColumn),s.uiLocation(i,n)}jsLocationToUILocation(e){const t=e.script();if(!t)return null;const o=this._infoForTarget(e.debuggerModel.target());if(!o)return null;const s=o._project.uiSourceCodeForURL(t.sourceURL);if(!s)return null;const r=Ue.get(t)||R.TextRange.createFromLocation(t.lineOffset,t.columnOffset),i=e.lineNumber+r.startLine-t.lineOffset;let n=e.columnNumber;return e.lineNumber===t.lineOffset&&(n+=r.startColumn-t.columnOffset),s.uiLocation(i,n)}uiLocationToJSLocations(e,t,o){if(!Te.has(e))return[];const s=V.targetForUISourceCode(e);if(!s)return[];const r=s.model(d.DebuggerModel);if(!r)return[];const i=r.createRawLocationByURL(e.url(),t,o);if(i){const e=i.script();if(e&&e.containsLocation(t,o))return[i]}return[]}uiLocationToCSSLocations(e){if(!Te.has(e.uiSourceCode))return[];const t=V.targetForUISourceCode(e.uiSourceCode);if(!t)return[];const o=t.model(m.CSSModel);return o?o.createRawLocationsByURL(e.uiSourceCode.url(),e.lineNumber,e.columnNumber):[]}_resetForTest(e){const t=e.model(h.ResourceTreeModel),o=t?this._modelToInfo.get(t):null;o&&o._resetForTest()}}class Ne{constructor(e,t){const o=t.target();this._project=new P(e,"resources:"+o.id(),v.projectTypes.Network,"",!1),V.setTargetForProject(this._project,o),this._bindings=new Map;const s=o.model(m.CSSModel);console.assert(!!s),this._cssModel=s,this._eventListeners=[t.addEventListener(h.Events.ResourceAdded,this._resourceAdded,this),t.addEventListener(h.Events.FrameWillNavigate,this._frameWillNavigate,this),t.addEventListener(h.Events.FrameDetached,this._frameDetached,this),this._cssModel.addEventListener(m.Events.StyleSheetChanged,e=>{this._styleSheetChanged(e)},this)]}async _styleSheetChanged(e){const t=this._cssModel.styleSheetHeaderForId(e.data.styleSheetId);if(!t||!t.isInline||t.isInline&&t.isMutable)return;const o=this._bindings.get(t.resourceURL());o&&await o._styleSheetChanged(t,e.data.edit)}_acceptsResource(e){const t=e.resourceType();return(t===s.resourceTypes.Image||t===s.resourceTypes.Font||t===s.resourceTypes.Document||t===s.resourceTypes.Manifest)&&(!(t===s.resourceTypes.Image&&e.mimeType&&!e.mimeType.startsWith("image"))&&(!(t===s.resourceTypes.Font&&e.mimeType&&!e.mimeType.includes("font"))&&(t!==s.resourceTypes.Image&&t!==s.resourceTypes.Font||!e.contentURL().startsWith("data:"))))}_resourceAdded(e){const t=e.data;if(!this._acceptsResource(t))return;let o=this._bindings.get(t.url);o?o.addResource(t):(o=new Pe(this._project,t),this._bindings.set(t.url,o))}_removeFrameResources(e){for(const t of e.resources()){if(!this._acceptsResource(t))continue;const e=this._bindings.get(t.url);e&&(1===e._resources.size?(e.dispose(),this._bindings.delete(t.url)):e.removeResource(t))}}_frameWillNavigate(e){const t=e.data;this._removeFrameResources(t)}_frameDetached(e){const t=e.data;this._removeFrameResources(t)}_resetForTest(){for(const e of this._bindings.values())e.dispose();this._bindings.clear()}dispose(){r.EventTarget.removeEventListeners(this._eventListeners);for(const e of this._bindings.values())e.dispose();this._bindings.clear(),this._project.removeProject()}}class Pe{constructor(e,t){this._resources=new Set([t]),this._project=e,this._uiSourceCode=this._project.createUISourceCode(t.url,t.contentType()),Te.add(this._uiSourceCode),V.setInitialFrameAttribution(this._uiSourceCode,t.frameId),this._project.addUISourceCodeWithProvider(this._uiSourceCode,this,fe(t),t.mimeType),this._edits=[]}_inlineStyles(){const e=V.targetForUISourceCode(this._uiSourceCode),t=[];if(!e)return t;const o=e.model(m.CSSModel);if(o)for(const e of o.styleSheetIdsForURL(this._uiSourceCode.url())){const s=o.styleSheetHeaderForId(e);s&&t.push(s)}return t}_inlineScripts(){const e=V.targetForUISourceCode(this._uiSourceCode);if(!e)return[];const t=e.model(d.DebuggerModel);return t?t.scriptsForSourceURL(this._uiSourceCode.url()):[]}async _styleSheetChanged(e,t){if(this._edits.push({stylesheet:e,edit:t}),this._edits.length>1)return;const{content:o}=await this._uiSourceCode.requestContent();null!==o&&await this._innerStyleSheetChanged(o),this._edits=[]}async _innerStyleSheetChanged(e){const t=this._inlineScripts(),o=this._inlineStyles();let s=new F.Text(e);for(const e of this._edits){const r=e.edit;if(!r)continue;const i=e.stylesheet,n=Fe.get(i)||R.TextRange.createFromLocation(i.startLine,i.startColumn),a=r.oldRange.relativeFrom(n.startLine,n.startColumn),c=r.newRange.relativeFrom(n.startLine,n.startColumn);s=new F.Text(s.replaceRange(a,r.newText));const u=[];for(const e of t){const t=Ue.get(e)||R.TextRange.createFromLocation(e.lineOffset,e.columnOffset);t.follows(a)&&(Ue.set(e,t.rebaseAfterTextEdit(a,c)),u.push(We.instance().updateLocations(e)))}for(const e of o){const t=Fe.get(e)||R.TextRange.createFromLocation(e.startLine,e.startColumn);t.follows(a)&&(Fe.set(e,t.rebaseAfterTextEdit(a,c)),u.push(Ce.instance().updateLocations(e)))}await Promise.all(u)}this._uiSourceCode.addRevision(s.value())}addResource(e){this._resources.add(e),V.addFrameAttribution(this._uiSourceCode,e.frameId)}removeResource(e){this._resources.delete(e),V.removeFrameAttribution(this._uiSourceCode,e.frameId)}dispose(){this._project.removeFile(this._uiSourceCode.url())}_firstResource(){return console.assert(this._resources.size>0),this._resources.values().next().value}contentURL(){return this._firstResource().contentURL()}contentType(){return this._firstResource().contentType()}contentEncoded(){return this._firstResource().contentEncoded()}requestContent(){return this._firstResource().requestContent()}searchInContent(e,t,o){return this._firstResource().searchInContent(e,t,o)}}var je=Object.freeze({__proto__:null,ResourceMapping:Ee});class Be{constructor(e,t,o){this._debuggerModel=e,this._workspace=t,this._debuggerWorkspaceBinding=o,this._uiSourceCodeToScriptFile=new Map,this._projects=new Map,this._acceptedScripts=new Set;const s=e.runtimeModel();this._eventListeners=[this._debuggerModel.addEventListener(d.Events.ParsedScriptSource,e=>{this._parsedScriptSource(e)},this),this._debuggerModel.addEventListener(d.Events.GlobalObjectCleared,this._globalObjectCleared,this),s.addEventListener(b.Events.ExecutionContextDestroyed,this._executionContextDestroyed,this)]}_project(e){const t=(e.isContentScript()?"js:extensions:":"js::")+this._debuggerModel.target().id()+":"+e.frameId;let o=this._projects.get(t);if(!o){const s=e.isContentScript()?v.projectTypes.ContentScripts:v.projectTypes.Network;o=new P(this._workspace,t,s,"",!1),V.setTargetForProject(o,this._debuggerModel.target()),this._projects.set(t,o)}return o}rawLocationToUILocation(e){const t=e.script();if(!t)return null;const o=this._project(t).uiSourceCodeForURL(t.sourceURL);if(!o)return null;const s=this._uiSourceCodeToScriptFile.get(o);if(!s)return null;if(s.hasDivergedFromVM()&&!s.isMergingToVM()||s.isDivergingFromVM())return null;if(!s._hasScripts([t]))return null;const r=e.lineNumber-(t.isInlineScriptWithSourceURL()?t.lineOffset:0);let i=e.columnNumber||0;return t.isInlineScriptWithSourceURL()&&!r&&i&&(i-=t.columnOffset),o.uiLocation(r,i)}uiLocationToRawLocations(e,t,o){const s=this._uiSourceCodeToScriptFile.get(e);if(!s||void 0===s._script)return[];const r=s._script;return r.isInlineScriptWithSourceURL()?[this._debuggerModel.createRawLocation(r,t+r.lineOffset,t?o:o+r.columnOffset)]:[this._debuggerModel.createRawLocation(r,t,o)]}_acceptsScript(e){if(!e.sourceURL||e.isLiveEdit()||e.isInlineScript()&&!e.hasSourceURL)return!1;if(e.isContentScript()&&!e.hasSourceURL){if(!new t.ParsedURL(e.sourceURL).isValid)return!1}return!0}async _parsedScriptSource(e){const t=e.data;if(!this._acceptsScript(t))return;this._acceptedScripts.add(t);const o=t.originalContentProvider(),s=t.sourceURL,r=this._project(t),i=r.uiSourceCodeForURL(s);if(i){const e=this._uiSourceCodeToScriptFile.get(i);e&&void 0!==e._script&&await this._removeScript(e._script)}const n=r.createUISourceCode(s,o.contentType());V.setInitialFrameAttribution(n,t.frameId);const a=me(this._debuggerModel.target(),t.frameId,s),c=new Ae(this,n,[t]);this._uiSourceCodeToScriptFile.set(n,c);const u=t.isWasm()?"application/wasm":"text/javascript";r.addUISourceCodeWithProvider(n,o,a,u),await this._debuggerWorkspaceBinding.updateLocations(t)}scriptFile(e){return this._uiSourceCodeToScriptFile.get(e)||null}async _removeScript(e){if(!this._acceptedScripts.has(e))return;this._acceptedScripts.delete(e);const t=this._project(e),o=t.uiSourceCodeForURL(e.sourceURL),s=this._uiSourceCodeToScriptFile.get(o);s&&s.dispose(),this._uiSourceCodeToScriptFile.delete(o),t.removeFile(e.sourceURL),await this._debuggerWorkspaceBinding.updateLocations(e)}_executionContextDestroyed(e){const t=e.data,o=this._debuggerModel.scriptsForExecutionContext(t);for(const e of o)this._removeScript(e)}_globalObjectCleared(e){const t=Array.from(this._acceptedScripts);for(const e of t)this._removeScript(e)}resetForTest(){const e=Array.from(this._acceptedScripts);for(const t of e)this._removeScript(t)}dispose(){r.EventTarget.removeEventListeners(this._eventListeners);const e=Array.from(this._acceptedScripts);for(const t of e)this._removeScript(t);for(const e of this._projects.values())e.removeProject();this._projects.clear()}}class Ae extends o.ObjectWrapper{constructor(e,t,o){super(),console.assert(o.length>0),this._resourceScriptMapping=e,this._uiSourceCode=t,this._uiSourceCode.contentType().isScript()&&(this._script=o[o.length-1]),this._uiSourceCode.addEventListener(M.Events.WorkingCopyChanged,this._workingCopyChanged,this),this._uiSourceCode.addEventListener(M.Events.WorkingCopyCommitted,this._workingCopyCommitted,this)}_hasScripts(e){return!!this._script&&this._script===e[0]}_isDiverged(){if(this._uiSourceCode.isDirty())return!0;if(!this._script)return!1;if(void 0===this._scriptSource||null===this._scriptSource)return!1;const e=this._uiSourceCode.workingCopy();if(!e)return!1;if(!e.startsWith(this._scriptSource.trimRight()))return!0;const t=this._uiSourceCode.workingCopy().substr(this._scriptSource.length);return!!t.length&&!t.match(S.sourceURLRegex)}_workingCopyChanged(e){this._update()}_workingCopyCommitted(e){if(this._uiSourceCode.project().canSetFileContent())return;if(!this._script)return;const t=this._resourceScriptMapping._debuggerModel,o=Ge.instance().breakpointLocationsForUISourceCode(this._uiSourceCode).map(e=>e.breakpoint),s=this._uiSourceCode.workingCopy();t.setScriptSource(this._script.scriptId,s,(e,t)=>{this.scriptSourceWasSet(s,o,e,t)})}async scriptSourceWasSet(e,t,o,s){if(o||s||(this._scriptSource=e),await this._update(),!o&&!s)return void await Promise.all(t.map(e=>e.refreshInDebugger()));if(!s)return void i.Console.instance().addMessage(a.UIString("LiveEdit failed: %s",o),i.MessageLevel.Warning);const r=a.UIString("LiveEdit compile failed: %s",s.text);this._uiSourceCode.addLineMessage(M.Message.Level.Error,r,s.lineNumber,s.columnNumber)}async _update(){this._isDiverged()&&!this._hasDivergedFromVM?await this._divergeFromVM():!this._isDiverged()&&this._hasDivergedFromVM&&await this._mergeToVM()}async _divergeFromVM(){this._script&&(this._isDivergingFromVM=!0,await this._resourceScriptMapping._debuggerWorkspaceBinding.updateLocations(this._script),delete this._isDivergingFromVM,this._hasDivergedFromVM=!0,this.dispatchEventToListeners(Ae.Events.DidDivergeFromVM,this._uiSourceCode))}async _mergeToVM(){this._script&&(delete this._hasDivergedFromVM,this._isMergingToVM=!0,await this._resourceScriptMapping._debuggerWorkspaceBinding.updateLocations(this._script),delete this._isMergingToVM,this.dispatchEventToListeners(Ae.Events.DidMergeToVM,this._uiSourceCode))}hasDivergedFromVM(){return!!this._hasDivergedFromVM}isDivergingFromVM(){return!!this._isDivergingFromVM}isMergingToVM(){return!!this._isMergingToVM}checkMapping(){this._script&&void 0===this._scriptSource?this._script.requestContent().then(e=>{this._scriptSource=e.content,this._update().then(()=>this._mappingCheckedForTest())}):this._mappingCheckedForTest()}_mappingCheckedForTest(){}dispose(){this._uiSourceCode.removeEventListener(M.Events.WorkingCopyChanged,this._workingCopyChanged,this),this._uiSourceCode.removeEventListener(M.Events.WorkingCopyCommitted,this._workingCopyCommitted,this)}addSourceMapURL(e){this._script&&this._script.debuggerModel.setSourceMapURL(this._script,e)}hasSourceMapURL(){return!!this._script&&!!this._script.sourceMapURL}get script(){return this._script||null}get uiSourceCode(){return this._uiSourceCode}}Ae.Events={DidMergeToVM:Symbol("DidMergeToVM"),DidDivergeFromVM:Symbol("DidDivergeFromVM")};var xe=Object.freeze({__proto__:null,ResourceScriptMapping:Be,ResourceScriptFile:Ae});let De;class We{constructor(e,t){this._workspace=t,this._sourceMappings=[],this._debuggerModelToData=new Map,e.addModelListener(d.DebuggerModel,d.Events.GlobalObjectCleared,this._globalObjectCleared,this),e.addModelListener(d.DebuggerModel,d.Events.DebuggerResumed,this._debuggerResumed,this),e.observeModels(d.DebuggerModel,this),this._liveLocationPromises=new Set}static instance(e={forceNew:null,targetManager:null,workspace:null}){const{forceNew:t,targetManager:o,workspace:s}=e;if(!De||t){if(!o||!s)throw new Error("Unable to create settings: targetManager and workspace must be provided: "+(new Error).stack);De=new We(o,s)}return De}addSourceMapping(e){this._sourceMappings.push(e)}modelAdded(e){this._debuggerModelToData.set(e,new Oe(e,this))}modelRemoved(e){const t=this._debuggerModelToData.get(e);t&&(t._dispose(),this._debuggerModelToData.delete(e))}getLanguagePluginManager(e){const t=this._debuggerModelToData.get(e);return t?t.pluginManager:null}async pendingLiveLocationChangesPromise(){await Promise.all(this._liveLocationPromises)}_recordLiveLocationChange(e){e.then(()=>{this._liveLocationPromises.delete(e)}),this._liveLocationPromises.add(e)}async updateLocations(e){const t=this._debuggerModelToData.get(e.debuggerModel);if(t){const o=t._updateLocations(e);this._recordLiveLocationChange(o),await o}}createLiveLocation(e,t,o){const s=e.script();if(!s)return Promise.resolve(null);const r=this._debuggerModelToData.get(s.debuggerModel);if(!r)return Promise.resolve(null);const i=r._createLiveLocation(e,t,o);return this._recordLiveLocationChange(i),i}async createStackTraceTopFrameLiveLocation(e,t,o){console.assert(e.length>0);const s=Ve.createStackTraceTopFrameLocation(e,this,t,o);return this._recordLiveLocationChange(s),s}async createCallFrameLiveLocation(e,t,o){if(!e.script())return null;const s=e.debuggerModel,r=this.createLiveLocation(e,t,o);this._recordLiveLocationChange(r);const i=await r;return i?(this._registerCallFrameLiveLocation(s,i),i):null}async rawLocationToUILocation(e){for(const t of this._sourceMappings){const o=t.rawLocationToUILocation(e);if(o)return o}const t=this._debuggerModelToData.get(e.debuggerModel);return t?t._rawLocationToUILocation(e):null}uiSourceCodeForSourceMapSourceURL(e,t,o){const s=this._debuggerModelToData.get(e);return s?s._compilerMapping.uiSourceCodeForURL(t,o):null}async uiLocationToRawLocations(e,t,o){for(const s of this._sourceMappings){const r=s.uiLocationToRawLocations(e,t,o);if(r.length)return r}const s=[];for(const r of this._debuggerModelToData.values())s.push(r._uiLocationToRawLocations(e,t,o));return(await Promise.all(s)).flat()}uiLocationToRawLocationsForUnformattedJavaScript(e,t,o){console.assert(e.contentType().isScript());const s=[];for(const r of this._debuggerModelToData.values())s.push(...r._uiLocationToRawLocationsExcludeAsync(e,t,o));return s}async normalizeUILocation(e){const t=await this.uiLocationToRawLocations(e.uiSourceCode,e.lineNumber,e.columnNumber);for(const e of t){const t=await this.rawLocationToUILocation(e);if(t)return t}return e}scriptFile(e,t){const o=this._debuggerModelToData.get(t);return o?o._resourceMapping.scriptFile(e):null}scriptsForUISourceCode(e){const t=new Set;for(const o of this._debuggerModelToData.values()){o._pluginManager&&o._pluginManager.scriptsForUISourceCode(e).forEach(e=>t.add(e));const s=o._resourceMapping.scriptFile(e);s&&s._script&&t.add(s._script),o._compilerMapping.scriptsForUISourceCode(e).forEach(e=>t.add(e))}return[...t]}sourceMapForScript(e){const t=this._debuggerModelToData.get(e.debuggerModel);return t?t._compilerMapping.sourceMapForScript(e):null}_globalObjectCleared(e){const t=e.data;this._reset(t)}_reset(e){const t=this._debuggerModelToData.get(e);if(t){for(const e of t.callFrameLocations.values())this._removeLiveLocation(e);t.callFrameLocations.clear()}}_resetForTest(e){const t=e.model(d.DebuggerModel),o=this._debuggerModelToData.get(t);o&&o._resourceMapping.resetForTest()}_registerCallFrameLiveLocation(e,t){const o=this._debuggerModelToData.get(e);if(o){o.callFrameLocations.add(t)}}_removeLiveLocation(e){const t=this._debuggerModelToData.get(e._script.debuggerModel);t&&t._disposeLocation(e)}_debuggerResumed(e){const t=e.data;this._reset(t)}}class Oe{constructor(e,t){this._debuggerModel=e,this._debuggerWorkspaceBinding=t,this.callFrameLocations=new Set;const o=t._workspace;I.experiments.isEnabled("wasmDWARFDebugging")&&(this._pluginManager=new se(e,o,t)),this._defaultMapping=new ae(e,o,t),this._resourceMapping=new Be(e,o,t),this._compilerMapping=new q(e,o,t),this._locations=new y,e.setBeforePausedCallback(this._beforePaused.bind(this))}get pluginManager(){return this._pluginManager||null}async _createLiveLocation(e,t,o){console.assert(null!==e.script());const s=e.script(),r=new ze(s,e,this._debuggerWorkspaceBinding,t,o);return this._locations.set(s,r),await r.update(),r}_disposeLocation(e){this._locations.delete(e._script,e)}async _updateLocations(e){const t=[];for(const o of this._locations.get(e))t.push(o.update());await Promise.all(t)}async _rawLocationToUILocation(e){let t=null;return this._pluginManager&&(t=await this._pluginManager.rawLocationToUILocation(e)),t=t||this._compilerMapping.rawLocationToUILocation(e),t=t||this._resourceMapping.rawLocationToUILocation(e),t=t||Ee.instance().jsLocationToUILocation(e),t=t||this._defaultMapping.rawLocationToUILocation(e),t}async _uiLocationToRawLocations(e,t,o){let s=null;return this._pluginManager&&(s=await this._pluginManager.uiLocationToRawLocations(e,t,o)),s=s||this._uiLocationToRawLocationsExcludeAsync(e,t,o),s}_uiLocationToRawLocationsExcludeAsync(e,t,o){let s=this._compilerMapping.uiLocationToRawLocations(e,t,o);return s=s.length?s:this._resourceMapping.uiLocationToRawLocations(e,t,o),s=s.length?s:Ee.instance().uiLocationToJSLocations(e,t,o),s=s.length?s:this._defaultMapping.uiLocationToRawLocations(e,t,o),s}_beforePaused(e){const t=e.callFrames[0];return!!t&&(t.script.sourceMapURL!==_.WasmSourceMap.FAKE_URL&&!I.experiments.isEnabled("emptySourceMapAutoStepping")||!!this._compilerMapping.mapsToSourceCode(t.location()))}_dispose(){this._debuggerModel.setBeforePausedCallback(null),this._compilerMapping.dispose(),this._resourceMapping.dispose(),this._defaultMapping.dispose()}}class ze extends ue{constructor(e,t,o,s,r){super(s,r),this._script=e,this._rawLocation=t,this._binding=o}async uiLocation(){const e=this._rawLocation;return this._binding.rawLocationToUILocation(e)}dispose(){super.dispose(),this._binding._removeLiveLocation(this)}async isBlackboxed(){const e=await this.uiLocation();return!!e&&T.instance().isBlackboxedUISourceCode(e.uiSourceCode)}}class Ve extends ue{constructor(e,t){super(e,t),this._updateScheduled=!0,this._current=null,this._locations=null}static async createStackTraceTopFrameLocation(e,t,o,s){const r=new Ve(o,s),i=e.map(e=>t.createLiveLocation(e,r._scheduleUpdate.bind(r),s));return r._locations=(await Promise.all(i)).filter(e=>!!e),await r._updateLocation(),r}async uiLocation(){return this._current?this._current.uiLocation():null}async isBlackboxed(){return!!this._current&&this._current.isBlackboxed()}dispose(){if(super.dispose(),this._locations)for(const e of this._locations)e.dispose();this._locations=null,this._current=null}async _scheduleUpdate(){this._updateScheduled||(this._updateScheduled=!0,setImmediate(this._updateLocation.bind(this)))}async _updateLocation(){if(this._updateScheduled=!1,this._locations&&0!==this._locations.length){this._current=this._locations[0];for(const e of this._locations)if(!await e.isBlackboxed()){this._current=e;break}this.update()}}}var He=Object.freeze({__proto__:null,DebuggerWorkspaceBinding:We,Location:ze,DebuggerSourceMapping:class{rawLocationToUILocation(e){throw new Error("Not yet implemented")}uiLocationToRawLocations(e,t,o){throw new Error("Not yet implemented")}}});let qe;class Ge extends o.ObjectWrapper{constructor(e,t,o){super(),this._storage=new Qe,this._workspace=t,this._targetManager=e,this._debuggerWorkspaceBinding=o,this._breakpointsForUISourceCode=new Map,this._breakpointByStorageId=new Map,this._workspace.addEventListener(v.Events.UISourceCodeAdded,this._uiSourceCodeAdded,this),this._workspace.addEventListener(v.Events.UISourceCodeRemoved,this._uiSourceCodeRemoved,this)}static instance(e={forceNew:null,targetManager:null,workspace:null,debuggerWorkspaceBinding:null}){const{forceNew:t,targetManager:o,workspace:s,debuggerWorkspaceBinding:r}=e;if(!qe||t){if(!o||!s||!r)throw new Error("Unable to create settings: targetManager, workspace, and debuggerWorkspaceBinding must be provided: "+(new Error).stack);qe=new Ge(o,s,r)}return qe}static _breakpointStorageId(e,t,o){return e?e+":"+t+":"+o:""}async copyBreakpoints(e,t){const o=this._storage.breakpointItems(e);for(const e of o)await this.setBreakpoint(t,e.lineNumber,e.columnNumber,e.condition,e.enabled)}_restoreBreakpoints(e){const t=e.url();if(!t)return;this._storage.mute();const o=this._storage.breakpointItems(t);for(const t of o)this._innerSetBreakpoint(e,t.lineNumber,t.columnNumber,t.condition,t.enabled);this._storage.unmute()}_uiSourceCodeAdded(e){const t=e.data;this._restoreBreakpoints(t)}_uiSourceCodeRemoved(e){const t=e.data;this.breakpointLocationsForUISourceCode(t).forEach(e=>e.breakpoint.removeUISourceCode(t))}async setBreakpoint(e,t,o,s,r){let i=new M.UILocation(e,t,o);const n=await this._debuggerWorkspaceBinding.normalizeUILocation(i);return n.id()!==i.id()&&(c.reveal(n),i=n),this._innerSetBreakpoint(i.uiSourceCode,i.lineNumber,i.columnNumber,s,r)}_innerSetBreakpoint(e,t,o,s,r){const i=Ge._breakpointStorageId(e.url(),t,o);let n=this._breakpointByStorageId.get(i);return n?(n._updateState(s,r),n.addUISourceCode(e),n._updateBreakpoint(),n):(n=new Je(this,e,e.url(),t,o,s,r),this._breakpointByStorageId.set(i,n),n)}findBreakpoint(e){const t=this._breakpointsForUISourceCode.get(e.uiSourceCode);return t&&t.get(e.id())||null}async possibleBreakpoints(e,t){const o=We.instance().uiLocationToRawLocations(e,t.startLine,t.startColumn),s=We.instance().uiLocationToRawLocations(e,t.endLine,t.endColumn),[r,i]=await Promise.all([o,s]),n=new Map;for(const e of i)n.set(e.debuggerModel,e);let a=null,c=null;for(const e of r){const t=n.get(e.debuggerModel);if(t){a=e,c=t;break}}return a&&c?a.debuggerModel.getPossibleBreakpoints(a,c,!1).then(async function(t){const o=t.map(e=>this._debuggerWorkspaceBinding.rawLocationToUILocation(e)),s=(await Promise.all(o)).filter(t=>t&&t.uiSourceCode===e);if(!s.length)return[];s.sort(M.UILocation.comparator);let r=s[0];const i=[r];for(const e of s)e.id()!==r.id()&&(i.push(e),r=e);return i}.bind(this)):[]}breakpointLocationsForUISourceCode(e){const t=this._breakpointsForUISourceCode.get(e);return t?Array.from(t.values()):[]}allBreakpointLocations(){const e=[];for(const t of this._breakpointsForUISourceCode.values())e.push(...t.values());return e}_removeBreakpoint(e,t){t&&this._storage._removeBreakpoint(e),this._breakpointByStorageId.delete(e._breakpointStorageId())}_uiLocationAdded(e,t){let o=this._breakpointsForUISourceCode.get(t.uiSourceCode);o||(o=new Map,this._breakpointsForUISourceCode.set(t.uiSourceCode,o));const s={breakpoint:e,uiLocation:t};o.set(t.id(),s),this.dispatchEventToListeners($e.BreakpointAdded,s)}_uiLocationRemoved(e,t){const o=this._breakpointsForUISourceCode.get(t.uiSourceCode);if(!o)return;o.get(t.id())&&(o.delete(t.id()),0===o.size&&this._breakpointsForUISourceCode.delete(t.uiSourceCode),this.dispatchEventToListeners($e.BreakpointRemoved,{breakpoint:e,uiLocation:t}))}}const $e={BreakpointAdded:Symbol("breakpoint-added"),BreakpointRemoved:Symbol("breakpoint-removed")};class Je{constructor(e,t,o,s,r,i,n){this._breakpointManager=e,this._url=o,this._lineNumber=s,this._columnNumber=r,this._uiLocations=new Set,this._uiSourceCodes=new Set,this._condition,this._enabled,this._isRemoved,this._currentState=null,this._modelBreakpoints=new Map,this._updateState(i,n),this.addUISourceCode(t),this._breakpointManager._targetManager.observeModels(d.DebuggerModel,this)}async refreshInDebugger(){if(!this._isRemoved){const e=Array.from(this._modelBreakpoints.values());await Promise.all(e.map(e=>e._refreshBreakpoint()))}}modelAdded(e){const t=this._breakpointManager._debuggerWorkspaceBinding;this._modelBreakpoints.set(e,new Ke(e,this,t))}modelRemoved(e){const t=this._modelBreakpoints.get(e);this._modelBreakpoints.delete(e),t&&(t._cleanUpAfterDebuggerIsGone(),t._removeEventListeners())}addUISourceCode(e){this._uiSourceCodes.has(e)||(this._uiSourceCodes.add(e),this.bound()||this._breakpointManager._uiLocationAdded(this,this._defaultUILocation(e)))}clearUISourceCodes(){this.bound()||this._removeAllUnboundLocations(),this._uiSourceCodes.clear()}removeUISourceCode(e){if(this._uiSourceCodes.has(e)&&(this._uiSourceCodes.delete(e),this.bound()||this._breakpointManager._uiLocationRemoved(this,this._defaultUILocation(e))),this.bound()){for(const t of this._uiLocations)t.uiSourceCode===e&&(this._uiLocations.delete(t),this._breakpointManager._uiLocationRemoved(this,t));this.bound()||this._isRemoved||this._addAllUnboundLocations()}}url(){return this._url}lineNumber(){return this._lineNumber}columnNumber(){return this._columnNumber}_uiLocationAdded(e){this._isRemoved||(this.bound()||this._removeAllUnboundLocations(),this._uiLocations.add(e),this._breakpointManager._uiLocationAdded(this,e))}_uiLocationRemoved(e){this._uiLocations.has(e)&&(this._uiLocations.delete(e),this._breakpointManager._uiLocationRemoved(this,e),this.bound()||this._isRemoved||this._addAllUnboundLocations())}enabled(){return this._enabled}bound(){return 0!==this._uiLocations.size}hasBoundScript(){for(const e of this._uiSourceCodes)if(e.project().type()===v.projectTypes.Network)return!0;return!1}setEnabled(e){this._updateState(this._condition,e)}condition(){return this._condition}setCondition(e){this._updateState(e,this._enabled)}_updateState(e,t){this._enabled===t&&this._condition===e||(this._enabled=t,this._condition=e,this._breakpointManager._storage._updateBreakpoint(this),this._updateBreakpoint())}_updateBreakpoint(){this.bound()||(this._removeAllUnboundLocations(),this._isRemoved||this._addAllUnboundLocations());for(const e of this._modelBreakpoints.values())e._scheduleUpdateInDebugger()}remove(e){this._isRemoved=!0;const t=!e;for(const e of this._modelBreakpoints.values())e._scheduleUpdateInDebugger(),e._removeEventListeners();this._breakpointManager._removeBreakpoint(this,t),this._breakpointManager._targetManager.unobserveModels(d.DebuggerModel,this),this.clearUISourceCodes()}_breakpointStorageId(){return Ge._breakpointStorageId(this._url,this._lineNumber,this._columnNumber)}_resetLocations(){this.clearUISourceCodes();for(const e of this._modelBreakpoints.values())e._resetLocations()}_defaultUILocation(e){return e.uiLocation(this._lineNumber,this._columnNumber)}_removeAllUnboundLocations(){for(const e of this._uiSourceCodes)this._breakpointManager._uiLocationRemoved(this,this._defaultUILocation(e))}_addAllUnboundLocations(){for(const e of this._uiSourceCodes)this._breakpointManager._uiLocationAdded(this,this._defaultUILocation(e))}}class Ke{constructor(e,t,o){this._debuggerModel=e,this._breakpoint=t,this._debuggerWorkspaceBinding=o,this._liveLocations=new de,this._uiLocations=new Map,this._debuggerModel.addEventListener(d.Events.DebuggerWasDisabled,this._cleanUpAfterDebuggerIsGone,this),this._debuggerModel.addEventListener(d.Events.DebuggerWasEnabled,this._scheduleUpdateInDebugger,this),this._hasPendingUpdate=!1,this._isUpdating=!1,this._cancelCallback=!1,this._currentState=null,this._debuggerId,this._debuggerModel.debuggerEnabled()&&this._scheduleUpdateInDebugger()}_resetLocations(){for(const e of this._uiLocations.values())this._breakpoint._uiLocationRemoved(e);this._uiLocations.clear(),this._liveLocations.disposeAll()}_scheduleUpdateInDebugger(){this._isUpdating?this._hasPendingUpdate=!0:(this._isUpdating=!0,this._updateInDebugger(this._didUpdateInDebugger.bind(this)))}_didUpdateInDebugger(){this._isUpdating=!1,this._hasPendingUpdate&&(this._hasPendingUpdate=!1,this._scheduleUpdateInDebugger())}_scriptDiverged(){for(const e of this._breakpoint._uiSourceCodes){const t=this._debuggerWorkspaceBinding.scriptFile(e,this._debuggerModel);if(t&&t.hasDivergedFromVM())return!0}return!1}async _updateInDebugger(e){if(this._debuggerModel.target().isDisposed())return this._cleanUpAfterDebuggerIsGone(),void e();const t=this._breakpoint._lineNumber,o=this._breakpoint._columnNumber,s=this._breakpoint.condition();let r=null;for(const e of this._breakpoint._uiSourceCodes){if(r=(await We.instance().uiLocationToRawLocations(e,t,o)).find(e=>e.debuggerModel===this._debuggerModel),r)break}let i,n=null;if(this._breakpoint._isRemoved||!this._breakpoint.enabled()||this._scriptDiverged())n=null;else if(r&&r.script()){const e=r.script();if(!e)return;n=e.sourceURL?new Je.State(e.sourceURL,null,null,r.lineNumber,r.columnNumber,s):new Je.State(null,e.scriptId,e.hash,r.lineNumber,r.columnNumber,s)}else if(this._breakpoint._currentState&&this._breakpoint._currentState.url){const e=this._breakpoint._currentState;n=new Je.State(e.url,null,null,e.lineNumber,e.columnNumber,s)}else this._breakpoint._uiSourceCodes.size>0&&(n=new Je.State(this._breakpoint.url(),null,null,t,o,s));if(!this._debuggerId||!Je.State.equals(n,this._currentState))return this._breakpoint._currentState=n,this._debuggerId?(await this._refreshBreakpoint(),void e()):void(n?(this._currentState=n,n.url?i=await this._debuggerModel.setBreakpointByURL(n.url,n.lineNumber,n.columnNumber,n.condition):n.scriptId&&n.scriptHash&&(i=await this._debuggerModel.setBreakpointInAnonymousScript(n.scriptId,n.scriptHash,n.lineNumber,n.columnNumber,n.condition)),i&&i.breakpointId?await this._didSetBreakpointInDebugger(e,i.breakpointId,i.locations):await this._didSetBreakpointInDebugger(e,null,[])):e());e()}async _refreshBreakpoint(){this._debuggerId&&(this._resetLocations(),await this._debuggerModel.removeBreakpoint(this._debuggerId),this._didRemoveFromDebugger(),this._currentState=null,this._scheduleUpdateInDebugger())}async _didSetBreakpointInDebugger(e,t,o){if(this._cancelCallback)return this._cancelCallback=!1,void e();if(!t)return this._breakpoint.remove(!0),void e();this._debuggerId=t,this._debuggerModel.addBreakpointListener(this._debuggerId,e=>this._breakpointResolved(e),this);for(const e of o)if(!await this._addResolvedLocation(e))break;e()}_didRemoveFromDebugger(){this._cancelCallback?this._cancelCallback=!1:(this._resetLocations(),this._debuggerId&&this._debuggerModel.removeBreakpointListener(this._debuggerId,e=>this._breakpointResolved(e),this),this._debuggerId=null)}async _breakpointResolved(e){await this._addResolvedLocation(e.data)}async _locationUpdated(e){const t=this._uiLocations.get(e),o=await e.uiLocation();t&&this._breakpoint._uiLocationRemoved(t),o?(this._uiLocations.set(e,o),this._breakpoint._uiLocationAdded(o)):this._uiLocations.delete(e)}async _addResolvedLocation(e){const t=await this._debuggerWorkspaceBinding.rawLocationToUILocation(e);if(!t)return!1;const o=this._breakpoint._breakpointManager.findBreakpoint(t);return o&&o.breakpoint!==this._breakpoint?(this._breakpoint.remove(!1),!1):(await this._debuggerWorkspaceBinding.createLiveLocation(e,this._locationUpdated.bind(this),this._liveLocations),!0)}_cleanUpAfterDebuggerIsGone(){this._isUpdating&&(this._cancelCallback=!0),this._resetLocations(),this._currentState=null,this._debuggerId&&this._didRemoveFromDebugger()}_removeEventListeners(){this._debuggerModel.removeEventListener(d.Events.DebuggerWasDisabled,this._cleanUpAfterDebuggerIsGone,this),this._debuggerModel.removeEventListener(d.Events.DebuggerWasEnabled,this._scheduleUpdateInDebugger,this)}}Je.State=class{constructor(e,t,o,s,r,i){this.url=e,this.scriptId=t,this.scriptHash=o,this.lineNumber=s,this.columnNumber=r,this.condition=i}static equals(e,t){return!(!e||!t)&&(e.url===t.url&&e.scriptId===t.scriptId&&e.scriptHash===t.scriptHash&&e.lineNumber===t.lineNumber&&e.columnNumber===t.columnNumber&&e.condition===t.condition)}};class Qe{constructor(){this._setting=e.Settings.instance().createLocalSetting("breakpoints",[]),this._breakpoints=new Map;const t=this._setting.get();for(const e of t)e.columnNumber=e.columnNumber||0,this._breakpoints.set(Ge._breakpointStorageId(e.url,e.lineNumber,e.columnNumber),e);this._muted}mute(){this._muted=!0}unmute(){delete this._muted}breakpointItems(e){return Array.from(this._breakpoints.values()).filter(t=>t.url===e)}_updateBreakpoint(e){!this._muted&&e._breakpointStorageId()&&(this._breakpoints.set(e._breakpointStorageId(),new Qe.Item(e)),this._save())}_removeBreakpoint(e){this._muted||(this._breakpoints.delete(e._breakpointStorageId()),this._save())}_save(){this._setting.set(Array.from(this._breakpoints.values()))}}Qe.Item=class{constructor(e){this.url=e._url,this.lineNumber=e.lineNumber(),this.columnNumber=e.columnNumber(),this.condition=e.condition(),this.enabled=e.enabled()}};var Xe=Object.freeze({__proto__:null,BreakpointManager:Ge,Events:$e,Breakpoint:Je,ModelBreakpoint:Ke,BreakpointLocation:void 0});class Ye{constructor(e,t,o){this._file=e,this._fileSize=e.size,this._loadedSize=0,this._chunkSize=t,this._chunkTransferredCallback=o,this._decoder=new TextDecoder,this._isCanceled=!1,this._error=null,this._transferFinished}read(e){return this._chunkTransferredCallback&&this._chunkTransferredCallback(this),this._output=e,this._reader=new FileReader,this._reader.onload=this._onChunkLoaded.bind(this),this._reader.onerror=this._onError.bind(this),this._loadChunk(),new Promise(e=>{this._transferFinished=e})}cancel(){this._isCanceled=!0}loadedSize(){return this._loadedSize}fileSize(){return this._fileSize}fileName(){return this._file?this._file.name:""}error(){return this._error}_onChunkLoaded(e){if(this._isCanceled)return;if(e.target.readyState!==FileReader.DONE)return;if(!this._output||!this._reader)return;const t=this._reader.result;this._loadedSize+=t.byteLength;const o=this._loadedSize===this._fileSize,s=this._decoder.decode(t,{stream:!o});if(this._output.write(s),!this._isCanceled){if(this._chunkTransferredCallback&&this._chunkTransferredCallback(this),o)return this._file=null,this._reader=null,this._output.close(),void this._transferFinished(!this._error);this._loadChunk()}}_loadChunk(){if(!this._output||!this._reader||!this._file)return;const e=this._loadedSize,t=Math.min(this._fileSize,e+this._chunkSize),o=this._file.slice(e,t);this._reader.readAsArrayBuffer(o)}_onError(e){const t=e.target;this._error=t.error,this._transferFinished(!1)}}var Ze=Object.freeze({__proto__:null,ChunkedReader:class{fileSize(){throw new Error("Not implemented yet")}loadedSize(){throw new Error("Not implemented yet")}fileName(){throw new Error("Not implemented yet")}cancel(){}error(){throw new Error("Not implemented yet")}},ChunkedFileReader:Ye,FileOutputStream:class{constructor(){this._writeCallbacks=[],this._fileName}async open(e){this._closed=!1,this._writeCallbacks=[],this._fileName=e;const t=await w.FileManager.instance().save(this._fileName,"",!0);return t&&w.FileManager.instance().addEventListener(w.Events.AppendedToURL,this._onAppendDone,this),!!t}write(e){return new Promise(t=>{this._writeCallbacks.push(t),w.FileManager.instance().append(this._fileName,e)})}async close(){this._closed=!0,this._writeCallbacks.length||(w.FileManager.instance().removeEventListener(w.Events.AppendedToURL,this._onAppendDone,this),w.FileManager.instance().close(this._fileName))}_onAppendDone(e){if(e.data!==this._fileName)return;const t=this._writeCallbacks.shift();t&&t(),this._writeCallbacks.length||this._closed&&(w.FileManager.instance().removeEventListener(w.Events.AppendedToURL,this._onAppendDone,this),w.FileManager.instance().close(this._fileName))}}});const et=new WeakMap;class tt{constructor(e){this._debuggerModel=e,this._pendingConsoleMessages={},this._presentationConsoleMessages=[],e.addEventListener(d.Events.ParsedScriptSource,e=>{setImmediate(this._parsedScriptSource.bind(this,e))}),e.addEventListener(d.Events.GlobalObjectCleared,this._debuggerReset,this),this._locationPool=new de}_consoleMessageAdded(e){const t=this._rawLocation(e);t?this._addConsoleMessageToScript(e,t):this._addPendingConsoleMessage(e)}_rawLocation(e){if(e.scriptId)return this._debuggerModel.createRawLocationByScriptId(e.scriptId,e.line,e.column);const t=e.stackTrace&&e.stackTrace.callFrames?e.stackTrace.callFrames[0]:null;return t?this._debuggerModel.createRawLocationByScriptId(t.scriptId,t.lineNumber,t.columnNumber):e.url?this._debuggerModel.createRawLocationByURL(e.url,e.line,e.column):null}_addConsoleMessageToScript(e,t){this._presentationConsoleMessages.push(new ot(e,t,this._locationPool))}_addPendingConsoleMessage(e){e.url&&(this._pendingConsoleMessages[e.url]||(this._pendingConsoleMessages[e.url]=[]),this._pendingConsoleMessages[e.url].push(e))}_parsedScriptSource(e){const t=e.data,o=this._pendingConsoleMessages[t.sourceURL];if(!o)return;const s=[];for(let e=0;e<o.length;e++){const r=o[e],i=this._rawLocation(r);i&&(t.scriptId===i.scriptId?this._addConsoleMessageToScript(r,i):s.push(r))}s.length?this._pendingConsoleMessages[t.sourceURL]=s:delete this._pendingConsoleMessages[t.sourceURL]}_consoleCleared(){this._pendingConsoleMessages={},this._debuggerReset()}_debuggerReset(){for(const e of this._presentationConsoleMessages)e.dispose();this._presentationConsoleMessages=[],this._locationPool.disposeAll()}}class ot{constructor(e,t,o){this._text=e.messageText,this._level=e.level===L.MessageLevel.Error?M.Message.Level.Error:M.Message.Level.Warning,We.instance().createLiveLocation(t,this._updateLocation.bind(this),o)}async _updateLocation(e){this._uiMessage&&this._uiMessage.remove();const t=await e.uiLocation();t&&(this._uiMessage=t.uiSourceCode.addLineMessage(this._level,this._text,t.lineNumber,t.columnNumber))}dispose(){this._uiMessage&&this._uiMessage.remove()}}var st=Object.freeze({__proto__:null,PresentationConsoleMessageManager:class{constructor(){u.TargetManager.instance().observeModels(d.DebuggerModel,this),L.ConsoleModel.instance().addEventListener(L.Events.ConsoleCleared,this._consoleCleared,this),L.ConsoleModel.instance().addEventListener(L.Events.MessageAdded,e=>this._consoleMessageAdded(e.data)),L.ConsoleModel.instance().messages().forEach(this._consoleMessageAdded,this)}modelAdded(e){et.set(e,new tt(e))}modelRemoved(e){const t=et.get(e);t&&t._consoleCleared()}_consoleMessageAdded(e){const t=e.runtimeModel();if(!e.isErrorOrWarning()||!e.runtimeModel()||e.source===L.MessageSource.Violation||!t)return;const o=et.get(t.debuggerModel());o&&o._consoleMessageAdded(e)}_consoleCleared(){for(const e of u.TargetManager.instance().models(d.DebuggerModel)){const t=et.get(e);t&&t._consoleCleared()}}},PresentationConsoleMessageHelper:tt,PresentationConsoleMessage:ot});class rt{constructor(){this._lastBlob=null}write(e){this._lastBlob&&e.unshift(this._lastBlob),this._lastBlob=new Blob(e,{type:"text/plain"})}read(){return this.readRange()}size(){return this._lastBlob?this._lastBlob.size:0}async readRange(e,t){if(!this._lastBlob)return i.Console.instance().error("Attempt to read a temp file that was never written"),"";const o="number"==typeof e||"number"==typeof t?this._lastBlob.slice(e,t):this._lastBlob,s=new FileReader;try{await new Promise((e,t)=>{s.onloadend=e,s.onerror=t,s.readAsText(o)})}catch(e){i.Console.instance().error("Failed to read from temp file: "+e.message)}return s.result}copyToOutputStream(e,t){if(!this._lastBlob)return e.close(),Promise.resolve(null);const o=new Ye(this._lastBlob,1e7,t);return o.read(e).then(e=>e?null:o.error())}remove(){this._lastBlob=null}}var it=Object.freeze({__proto__:null,TempFile:rt,TempFileBackingStorage:class{constructor(){this._file=null,this._strings,this._stringsLength,this.reset()}appendString(e){this._strings.push(e),this._stringsLength+=e.length;this._stringsLength>10485760&&this._flush()}appendAccessibleString(e){if(this._flush(),!this._file)return async()=>null;const t=this._file.size();return this._strings.push(e),this._flush(),this._file.readRange.bind(this._file,t,this._file.size())}_flush(){this._strings.length&&(this._file||(this._file=new rt),this._stringsLength=0,this._file.write(this._strings.splice(0)))}finishWriting(){this._flush()}reset(){this._file&&this._file.remove(),this._file=null,this._strings=[],this._stringsLength=0}writeToStream(e){return this._file?this._file.copyToOutputStream(e):Promise.resolve(null)}}});export{N as BlackboxManager,Xe as BreakpointManager,ke as CSSWorkspaceBinding,J as CompilerScriptMapping,A as ContentProviderBasedProject,re as DebuggerLanguagePlugins,He as DebuggerWorkspaceBinding,ce as DefaultScriptMapping,Ze as FileUtils,le as LiveLocation,H as NetworkProject,st as PresentationConsoleMessageHelper,je as ResourceMapping,xe as ResourceScriptMapping,be as ResourceUtils,_e as SASSSourceMapping,Me as StylesSourceMapping,it as TempFile};
