import{OverlayModel as e,TracingModel as t,TracingManager as i,SDKModel as s,CPUProfilerModel as n,RuntimeModel as a,PaintProfiler as r,DOMModel as o,ResourceTreeModel as l,NetworkManager as h,DebuggerModel as c,FilmStripModel as d}from"../sdk/sdk.js";import{UIString as m,Console as u,Settings as p,ParsedURL as _,ObjectWrapper as g,Color as f,EventTarget as v,Linkifier as T}from"../common/common.js";import{TimelineOverviewPane as w,FlameChart as S,NetworkPriorities as y,ChartViewport as b,LineLevelProfile as C,PieChart as x,FilmStripView as k,TimelineGrid as M}from"../perf_ui/perf_ui.js";import{NumberUtilities as E,DateUtilities as P,SetUtilities as R,StringUtilities as L}from"../platform/platform.js";import{TimelineJSProfile as I,TimelineModel as F,TimelineModelFilter as D,TimelineProfileTree as B,TimelineIRModel as W,TimelineFrameModel as N}from"../timeline_model/timeline_model.js";import{UIUtils as U,Widget as V,SplitWidget as A,Toolbar as H,ARIAUtils as G,Geometry as O,TabbedPane as z,Fragment as j,Utils as q,ActionRegistry as X,GlassPane as $,ListModel as J,ListControl as K,Icon as Y,Action as Q,Panel as Z,DropTarget as ee,SearchableView as te,Context as ie,ContextMenu as se,ViewManager as ne,XLink as ae,ShortcutRegistry as re,TreeOutline as oe}from"../ui/ui.js";import{TempFile as le,FileUtils as he,BlackboxManager as ce,ResourceUtils as de,DebuggerWorkspaceBinding as me}from"../bindings/bindings.js";import{Linkifier as ue,ImagePreview as pe,JSPresentationUtils as _e}from"../components/components.js";import{ExtensionServer as ge}from"../extensions/extensions.js";import{ResourceLoader as fe,Platform as ve,userMetrics as Te,UserMetrics as we}from"../host/host.js";import{ThrottlingManager as Se}from"../mobile_throttling/mobile_throttling.js";import{InspectorBackend as ye}from"../protocol_client/protocol_client.js";import{Runtime as be}from"../root/root.js";import{TextUtils as Ce}from"../text_utils/text_utils.js";import{CoverageModel as xe}from"../coverage/coverage.js";import{SortableDataGrid as ke,DataGrid as Me,ViewportDataGrid as Ee}from"../data_grid/data_grid.js";import{LayerViewHost as Pe,LayerTreeOutline as Re,Layers3DView as Le,LayerDetailsView as Ie,PaintProfilerView as Fe,TransformController as De}from"../layer_viewer/layer_viewer.js";import{ThemeSupport as Be}from"../theme_support/theme_support.js";class We{constructor([e,t,i,s]){this.x=e,this.y=t,this.width=i,this.height=s,this.color={r:238,g:111,b:99,a:.4},this.outlineColor={r:238,g:111,b:99,a:.7}}}var Ne=Object.freeze({__proto__:null,CLSRect:We,Linkifier:class{linkify(t,i){const s=document.createElement("span"),n=t,{x:a,y:r,width:o,height:l}=n;return s.textContent=`Location: [${a},${r}], Size: [${o}x${l}]`,s.addEventListener("mouseover",()=>e.OverlayModel.highlightRect(n)),s.addEventListener("mouseleave",()=>e.OverlayModel.clearHighlight()),s}}});class Ue{constructor(e){this._client=e,this._backingStorage=new le.TempFileBackingStorage,this._tracingModel=new t.TracingModel(this._backingStorage),this._canceledCallback=null,this._state=Ae.Initial,this._buffer="",this._firstRawChunk=!0,this._firstChunk=!0,this._loadedBytes=0,this._totalSize,this._jsonTokenizer=new Ce.BalancedJSONTokenizer(this._writeBalancedJSON.bind(this),!0)}static loadFromFile(e,t){const i=new Ue(t),s=new he.ChunkedFileReader(e,Ve);return i._canceledCallback=s.cancel.bind(s),i._totalSize=e.size,s.read(i).then(e=>{!e&&s.error()&&i._reportErrorAndCancelLoading(s.error().message)}),i}static loadFromEvents(e,t){const i=new Ue(t);return setTimeout(async()=>{t.loadingStarted();for(let s=0;s<e.length;s+=5e3){const n=e.slice(s,s+5e3);i._tracingModel.addEvents(n),t.loadingProgress((s+n.length)/e.length),await new Promise(e=>setTimeout(e))}i.close()}),i}static loadFromURL(e,t){const i=new Ue(t);return fe.loadAsStream(e,null,i),i}cancel(){this._tracingModel=null,this._backingStorage.reset(),this._client&&(this._client.loadingComplete(null),this._client=null),this._canceledCallback&&this._canceledCallback()}write(e){if(!this._client)return Promise.resolve();if(this._loadedBytes+=e.length,this._firstRawChunk?this._client.loadingStarted():this._client.loadingProgress(this._totalSize?this._loadedBytes/this._totalSize:void 0),this._firstRawChunk=!1,this._state===Ae.Initial)if(e.startsWith('{"nodes":['))this._state=Ae.LoadingCPUProfileFormat;else if("{"===e[0])this._state=Ae.LookingForEvents;else{if("["!==e[0])return this._reportErrorAndCancelLoading(m.UIString("Malformed timeline data: Unknown JSON format")),Promise.resolve();this._state=Ae.ReadingEvents}if(this._state===Ae.LoadingCPUProfileFormat)return this._buffer+=e,Promise.resolve();if(this._state===Ae.LookingForEvents){const t='"traceEvents":',i=this._buffer.length-t.length;this._buffer+=e;const s=this._buffer.indexOf(t,i);if(-1===s)return Promise.resolve();e=this._buffer.slice(s+t.length),this._state=Ae.ReadingEvents}return this._state!==Ae.ReadingEvents||this._jsonTokenizer.write(e)||(this._state=Ae.SkippingTail,this._firstChunk&&this._reportErrorAndCancelLoading(m.UIString("Malformed timeline input, wrong JSON brackets balance"))),Promise.resolve()}_writeBalancedJSON(e){let t,i=e+"]";if(!this._firstChunk){const e=i.indexOf(",");-1!==e&&(i=i.slice(e+1)),i="["+i}try{t=JSON.parse(i)}catch(e){return void this._reportErrorAndCancelLoading(m.UIString("Malformed timeline data: %s",e.toString()))}if(this._firstChunk&&(this._firstChunk=!1,this._looksLikeAppVersion(t[0])))this._reportErrorAndCancelLoading(m.UIString("Legacy Timeline format is not supported."));else try{this._tracingModel.addEvents(t)}catch(e){this._reportErrorAndCancelLoading(m.UIString("Malformed timeline data: %s",e.toString()))}}_reportErrorAndCancelLoading(e){e&&u.Console.instance().error(e),this.cancel()}_looksLikeAppVersion(e){return"string"==typeof e&&-1!==e.indexOf("Chrome")}async close(){this._client&&(this._client.processingStarted(),setTimeout(()=>this._finalizeTrace(),0))}_finalizeTrace(){this._state===Ae.LoadingCPUProfileFormat&&(this._parseCPUProfileFormat(this._buffer),this._buffer=""),this._tracingModel.tracingComplete(),this._client.loadingComplete(this._tracingModel)}_parseCPUProfileFormat(e){let t;try{const i=JSON.parse(e);t=I.TimelineJSProfileProcessor.buildTraceProfileFromCpuProfile(i,1,!0)}catch(e){return void this._reportErrorAndCancelLoading(m.UIString("Malformed CPU profile format"))}this._tracingModel.addEvents(t)}}const Ve=5e6;const Ae={Initial:Symbol("Initial"),LookingForEvents:Symbol("LookingForEvents"),ReadingEvents:Symbol("ReadingEvents"),SkippingTail:Symbol("SkippingTail"),LoadingCPUProfileFormat:Symbol("LoadingCPUProfileFormat")};var He=Object.freeze({__proto__:null,TimelineLoader:Ue,TransferChunkLengthBytes:Ve,Client:class{loadingStarted(){}loadingProgress(e){}processingStarted(){}loadingComplete(e){}},State:Ae});class Ge{constructor(e,t){this._provider=e,this._performanceModel=t,this._completionCallback,this._completionPromise=new Promise(e=>{this._completionCallback=e}),this._timeOffset=0}loadingStarted(){}processingStarted(){}loadingProgress(e){}loadingComplete(e){e&&(this._performanceModel.addExtensionEvents(this._provider.longDisplayName(),e,this._timeOffset),this._completionCallback())}complete(e,t){e?(this._timeOffset=t,Ue.loadFromURL(e,this)):this._completionCallback()}start(){this._provider.start(this)}stop(){return this._provider.stop(),this._completionPromise}}var Oe=Object.freeze({__proto__:null,ExtensionTracingSession:Ge});class ze{constructor(e,a){this._target=e,this._tracingManager=e.model(i.TracingManager),this._performanceModel=new Mi,this._performanceModel.setMainTarget(e),this._client=a;const r=new le.TempFileBackingStorage;this._tracingModel=new t.TracingModel(r),this._extensionSessions=[],s.TargetManager.instance().observeModels(n.CPUProfilerModel,this)}dispose(){s.TargetManager.instance().unobserveModels(n.CPUProfilerModel,this)}mainTarget(){return this._target}async startRecording(e,t){function i(e){return"disabled-by-default-"+e}this._extensionTraceProviders=ge.ExtensionServer.instance().traceProviders().slice();const n=["-*","devtools.timeline",i("devtools.timeline"),i("devtools.timeline.frame"),"v8.execute",F.TimelineModelImpl.Category.Console,F.TimelineModelImpl.Category.UserTiming,F.TimelineModelImpl.Category.Loading];n.push(F.TimelineModelImpl.Category.LatencyInfo),Root.Runtime.experiments.isEnabled("timelineFlowEvents")&&n.push("devtools.timeline.async"),Root.Runtime.experiments.isEnabled("timelineV8RuntimeCallStats")&&e.enableJSSampling&&n.push(i("v8.runtime_stats_sampling")),!Root.Runtime.queryParam("timelineTracingJSProfileDisabled")&&e.enableJSSampling&&n.push(i("v8.cpu_profiler")),n.push(i("devtools.timeline.stack")),Root.Runtime.experiments.isEnabled("timelineInvalidationTracking")&&n.push(i("devtools.timeline.invalidationTracking")),e.capturePictures&&n.push(i("devtools.timeline.layers"),i("devtools.timeline.picture"),i("blink.graphics_context_annotations")),e.captureFilmStrip&&n.push(i("devtools.screenshot")),this._extensionSessions=t.map(e=>new Ge(e,this._performanceModel)),this._extensionSessions.forEach(e=>e.start()),this._performanceModel.setRecordStartTime(Date.now());const a=await this._startRecordingWithCategories(n.join(","),e.enableJSSampling);return a[ye.ProtocolError]&&(await this._waitForTracingToStop(!1),await s.TargetManager.instance().resumeAllTargets()),a}async stopRecording(){return this._tracingManager&&this._tracingManager.stop(),this._client.loadingStarted(),await this._waitForTracingToStop(!0),this._allSourcesFinished(),this._performanceModel}_waitForTracingToStop(e){const t=[];this._tracingManager&&e&&t.push(new Promise(e=>{this._tracingCompleteCallback=e})),t.push(this._stopProfilingOnAllModels());const i=this._extensionSessions.map(e=>e.stop());return i.length&&t.push(Promise.race([Promise.all(i),new Promise(e=>setTimeout(e,5e3))])),Promise.all(t)}modelAdded(e){this._profiling&&e.startRecording()}modelRemoved(e){}_startProfilingOnAllModels(){this._profiling=!0;const e=s.TargetManager.instance().models(n.CPUProfilerModel);return Promise.all(e.map(e=>e.startRecording()))}_addCpuProfile(e,t){t?(this._cpuProfiles||(this._cpuProfiles=new Map),this._cpuProfiles.set(e,t)):u.Console.instance().warn(m.UIString("CPU profile for a target is not available."))}_stopProfilingOnAllModels(){const e=this._profiling?s.TargetManager.instance().models(n.CPUProfilerModel):[];this._profiling=!1;const t=[];for(const i of e){const e=i.target().id(),s=i.stopRecording().then(this._addCpuProfile.bind(this,e));t.push(s)}return Promise.all(t)}async _startRecordingWithCategories(e,t){if(await s.TargetManager.instance().suspendAllTargets("performance-timeline"),t&&Root.Runtime.queryParam("timelineTracingJSProfileDisabled")&&await this._startProfilingOnAllModels(),this._tracingManager)return this._tracingManager.start(this,e,"")}traceEventsCollected(e){this._tracingModel.addEvents(e)}tracingComplete(){this._tracingCompleteCallback(),this._tracingCompleteCallback=null}_allSourcesFinished(){this._client.processingStarted(),setTimeout(()=>this._finalizeTrace(),0)}async _finalizeTrace(){this._injectCpuProfileEvents(),await s.TargetManager.instance().resumeAllTargets(),this._tracingModel.tracingComplete(),this._client.loadingComplete(this._tracingModel)}_injectCpuProfileEvent(e,i,s){if(!s)return;const n={cat:t.DevToolsMetadataEventCategory,ph:t.Phase.Instant,ts:1e3*this._tracingModel.maximumRecordTime(),pid:e,tid:i,name:F.RecordType.CpuProfile,args:{data:{cpuProfile:s}}};this._tracingModel.addEvents([n])}_buildTargetToProcessIdMap(){const e=F.TimelineModelImpl.DevToolsMetadataEvent,t=this._tracingModel.devToolsMetadataEvents(),i=t.find(t=>t.name===e.TracingStartedInBrowser);if(!i)return null;const n=new Platform.Multimap,a=new Map,r=i.args.data.frames;for(const e of r)a.set(e.frame,e.processId);for(const i of t){const t=i.args.data;switch(i.name){case e.FrameCommittedInBrowser:t.processId?a.set(t.frame,t.processId):n.set(t.processPseudoId,t.frame);break;case e.ProcessReadyInBrowser:for(const e of n.get(t.processPseudoId)||[])a.set(e,t.processId)}}const o=r.find(e=>!e.parent).processId,l=this._tracingModel.processById(o);return l&&a.set(s.TargetManager.instance().mainTarget().id(),l.id()),a}_injectCpuProfileEvents(){if(!this._cpuProfiles)return;const e=F.TimelineModelImpl.DevToolsMetadataEvent,t=this._tracingModel.devToolsMetadataEvents(),i=this._buildTargetToProcessIdMap();if(i)for(const[e,t]of this._cpuProfiles){const s=i.get(e);if(!s)continue;const n=this._tracingModel.processById(s),a=n&&n.threadByName(F.TimelineModelImpl.RendererMainThreadName);a&&this._injectCpuProfileEvent(s,a.id(),t)}else{const i=t.filter(t=>t.name===e.TracingStartedInPage).peekLast();if(i){const e=i.thread.process().id(),t=this._cpuProfiles.get(this._tracingManager.target().id());this._injectCpuProfileEvent(e,i.thread.id(),t)}else{let e=0;for(const t of this._cpuProfiles){const i=s.TargetManager.instance().targetById(t[0]),n=i&&i.name();this._tracingModel.addEvents(I.TimelineJSProfileProcessor.buildTraceProfileFromCpuProfile(t[1],++e,1===e,n))}}}const n=t.filter(t=>t.name===e.TracingSessionIdForWorker);for(const e of n){const t=e.args.data.workerId,i=this._cpuProfiles.get(t);this._injectCpuProfileEvent(e.thread.process().id(),e.args.data.workerThreadId,i)}this._cpuProfiles=null}tracingBufferUsage(e){this._client.recordingProgress(e)}eventsRetrievalProgress(e){this._client.loadingProgress(e)}}var je=Object.freeze({__proto__:null,TimelineController:ze,Client:class{recordingProgress(e){}},RecordingOptions:void 0});class qe extends w.TimelineOverviewBase{constructor(e,t){super(),this.element.id="timeline-overview-"+e,this.element.classList.add("overview-strip"),this._model=null,t&&(this.element.createChild("div","timeline-overview-strip-title").textContent=t)}setModel(e){this._model=e}_renderBar(e,t,i,s,n){const a=e,r=t-e,o=this.context();o.fillStyle=n,o.fillRect(a,i,r,s)}}class Xe extends qe{constructor(){super("input",null)}update(){if(super.update(),!this._model)return;const e=this.height(),t=gi.eventDispatchDesciptors(),i=new Map;let s=-1;for(const e of t){for(const t of e.eventTypes)i.set(t,e);s=Math.max(s,e.priority)}const n=2*window.devicePixelRatio,a=this._model.timelineModel().minimumRecordTime(),r=this._model.timelineModel().maximumRecordTime()-a,o=this.width(),l=o/r;for(let t=0;t<=s;++t)for(const s of this._model.timelineModel().tracks())for(let r=0;r<s.events.length;++r){const h=s.events[r];if(h.name!==F.RecordType.EventDispatch)continue;const c=i.get(h.args.data.type);if(!c||c.priority!==t)continue;if(void 0===h.endTime)continue;const d=E.clamp(Math.floor((h.startTime-a)*l),0,o),m=E.clamp(Math.ceil((h.endTime-a)*l),0,o),u=Math.max(m-d,n);this._renderBar(d,d+u,0,e,c.color)}}}class $e extends qe{constructor(){super("network",m.UIString("NET"))}update(){if(super.update(),!this._model)return;const e=this._model.timelineModel(),t=this.height()/2,i=e.minimumRecordTime(),s=e.maximumRecordTime()-i,n=this.width(),a=n/s,r=new Path2D,o=new Path2D,l=Protocol.Network.ResourcePriority,h=new Set([l.VeryHigh,l.High,l.Medium]);for(const s of e.networkRequests()){const e=h.has(s.priority)?r:o,l=Math.max(Math.floor((s.startTime-i)*a),0),c=Math.min(Math.ceil((s.endTime-i)*a+1),n);e.rect(l,0,c-l,t-1)}const c=this.context();c.save(),c.fillStyle="hsl(214, 60%, 60%)",c.fill(r),c.translate(0,t),c.fillStyle="hsl(214, 80%, 80%)",c.fill(o),c.restore()}}const Je=new WeakMap;class Ke extends qe{constructor(){super("cpu-activity",m.UIString("CPU")),this._backgroundCanvas=this.element.createChild("canvas","fill background")}resetCanvas(){super.resetCanvas(),this._backgroundCanvas.width=this.element.clientWidth*window.devicePixelRatio,this._backgroundCanvas.height=this.element.clientHeight*window.devicePixelRatio}update(){if(super.update(),!this._model)return;const e=this._model.timelineModel(),t=4*window.devicePixelRatio,i=this.width(),s=this.height(),n=s,a=e.minimumRecordTime(),r=e.maximumRecordTime()-a,o=t/(i/r),l=gi.categories(),h=gi.getTimelineMainEventCategories(),c=h.indexOf("other");console.assert(0===h.indexOf("idle"));for(let e=1;e<h.length;++e)Je.set(l[h[e]],e);const d=this._backgroundCanvas.getContext("2d");if(!d)throw new Error("Could not find 2d canvas");for(const t of e.tracks())t.type===F.TrackType.MainThread&&t.forMainFrame?m(this.context(),t.events):m(d,t.events);function m(e,d){const m=new tt(a,o,(function(e){let i=n;for(let n=1;n<h.length;++n){const a=(e[n]||0)/o*s;i-=a,_[n].bezierCurveTo(u,g[n],u,i,u+t/2,i),g[n]=i}u+=t}));let u=0;const p=[],_=[],g=[];for(let e=0;e<h.length;++e)_[e]=new Path2D,_[e].moveTo(0,s),g[e]=s;F.TimelineModelImpl.forEachEvent(d,(function(e){const t=p.length?p.peekLast():0;m.appendInterval(e.startTime,t),p.push(Je.get(gi.eventStyle(e).category)||c)}),(function(e){const t=p.pop();void 0!==e.endTime&&t&&m.appendInterval(e.endTime,t)})),m.appendInterval(a+r+o,0);for(let t=h.length-1;t>0;--t)_[t].lineTo(i,s),e.fillStyle=l[h[t]].color,e.fill(_[t])}!function(e){const t=4*window.devicePixelRatio;e.save(),e.lineWidth=t/Math.sqrt(8);for(let n=.5;n<i+s;n+=t)e.moveTo(n,0),e.lineTo(n-s,s);e.globalCompositeOperation="destination-out",e.stroke(),e.restore()}(d)}}class Ye extends qe{constructor(){super("responsiveness",null)}update(){if(super.update(),!this._model)return;const e=this.height(),t=this._model.timelineModel().minimumRecordTime(),i=this._model.timelineModel().maximumRecordTime()-t,s=this.width()/i,n=this._model.frames(),a=this.context(),r=new Path2D,o=new Path2D;for(let e=0;e<n.length;++e){const t=n[e];t.hasWarnings()&&l(t.startTime,t.duration)}for(const e of this._model.timelineModel().tracks()){const t=e.events;for(let e=0;e<t.length;++e){if(!F.TimelineData.forEvent(t[e]).warning)continue;const i=t[e].duration;void 0!==i&&l(t[e].startTime,i)}}function l(i,n){const a=Math.round(s*(i-t)),l=Math.round(s*n);r.rect(a,0,l,e),o.moveTo(a+l,0),o.lineTo(a+l,e)}a.fillStyle="hsl(0, 80%, 90%)",a.strokeStyle="red",a.lineWidth=2*window.devicePixelRatio,a.fill(r),a.stroke(o)}}class Qe extends qe{constructor(){super("filmstrip",null),this._frameToImagePromise=new Map,this._lastFrame=null,this._lastElement=null,this.reset()}update(){super.update();const e=this._model?this._model.filmStripModel().frames():[];if(!e.length)return;const t=Symbol("drawGeneration");this._drawGeneration=t,this._imageByFrame(e[0]).then(e=>{if(this._drawGeneration!==t)return;if(!e||!e.naturalWidth||!e.naturalHeight)return;const i=this.height()-2*Qe.Padding,s=Math.ceil(i*e.naturalWidth/e.naturalHeight),n=Math.min(200/e.naturalWidth,1);this._emptyImage=new Image(e.naturalWidth*n,e.naturalHeight*n),this._drawFrames(s,i)})}async _imageByFrame(e){let t=this._frameToImagePromise.get(e);if(!t){const i=await e.imageDataPromise();t=U.loadImageFromData(i),this._frameToImagePromise.set(e,t)}return t}_drawFrames(e,t){if(!e||!this._model)return;const i=this._model.filmStripModel();if(!i.frames().length)return;const s=Qe.Padding,n=this.width(),a=i.zeroTime(),r=i.spanTime()/n,o=this.context(),l=this._drawGeneration;o.beginPath();for(let l=s;l<n;l+=e+2*s){const s=a+(l+e/2)*r,n=i.frameByTimestamp(s);n&&(o.rect(l-.5,.5,e+1,t+1),this._imageByFrame(n).then(h.bind(this,l)))}function h(i,s){this._drawGeneration===l&&s&&o.drawImage(s,i,1,e,t)}o.strokeStyle="#ddd",o.stroke()}async overviewInfoPromise(e){if(!this._model||!this._model.filmStripModel().frames().length)return null;const t=this.calculator();if(!t)return null;const i=t.positionToTime(e),s=this._model.filmStripModel().frameByTimestamp(i);if(s===this._lastFrame)return this._lastElement;const n=s?this._imageByFrame(s):Promise.resolve(this._emptyImage),a=await n,r=document.createElement("div");return r.classList.add("frame"),a&&r.createChild("div","thumbnail").appendChild(a),this._lastFrame=s,this._lastElement=r,r}reset(){this._lastFrame=null,this._lastElement=null,this._frameToImagePromise=new Map,this._imageWidth=0}}Qe.Padding=2;class Ze extends qe{constructor(){super("framerate",m.UIString("FPS"))}update(){if(super.update(),!this._model)return;const e=this._model.frames();if(!e.length)return;const t=this.height(),i=1*window.devicePixelRatio,s=t-2*i,n=this._model.timelineModel().minimumRecordTime(),a=this._model.timelineModel().maximumRecordTime()-n,r=this.width()/a,o=t-i,l=this.context(),h=o+10*window.devicePixelRatio;let c=0,d=h;const m=window.devicePixelRatio,u=1&m?.5:0,p=1.5*window.devicePixelRatio;l.beginPath(),l.moveTo(0,d);for(let t=0;t<e.length;++t){const i=e[t];c=Math.round((i.startTime-n)*r)+u,l.lineTo(c,d),l.lineTo(c,d+p),d=i.idle?h:Math.round(o-s*Math.min(1e3/60/i.duration,1))-u,l.lineTo(c,d+p),l.lineTo(c,d)}const _=e.peekLast();_&&(c=Math.round((_.startTime+_.duration-n)*r)+u),l.lineTo(c,d),l.lineTo(c,h),l.fillStyle="hsl(110, 50%, 88%)",l.strokeStyle="hsl(110, 50%, 60%)",l.lineWidth=m,l.fill(),l.stroke()}}class et extends qe{constructor(){super("memory",m.UIString("HEAP")),this._heapSizeLabel=this.element.createChild("div","memory-graph-label")}resetHeapSizeLabels(){this._heapSizeLabel.textContent=""}update(){super.update();const e=window.devicePixelRatio;if(!this._model)return void this.resetHeapSizeLabels();const t=this._model.timelineModel().tracks().filter(e=>e.type===F.TrackType.MainThread&&e.forMainFrame).map(e=>e.events),i=3*e;let s=0,n=1e11;const a=this._model.timelineModel().minimumRecordTime(),r=this._model.timelineModel().maximumRecordTime();function o(e){return e.name===F.RecordType.UpdateCounters}for(let e=0;e<t.length;e++)t[e]=t[e].filter(o);function l(e){const t=e.args.data;t&&t.jsHeapSizeUsed&&(s=Math.max(s,t.jsHeapSizeUsed),n=Math.min(n,t.jsHeapSizeUsed))}for(let e=0;e<t.length;e++)t[e].forEach(l);n=Math.min(n,s);const h=this.width(),c=this.height()-i,d=h/(r-a),u=(c-1)/Math.max(s-n,1),p=new Array(h);function _(e){const t=e.args.data;if(!t||!t.jsHeapSizeUsed)return;const i=Math.round((e.startTime-a)*d),s=Math.round((t.jsHeapSizeUsed-n)*u);p[i]=Math.max(p[i]||0,s)}for(let e=0;e<t.length;e++)t[e].forEach(_);const g=this.context(),f=c+i+1;g.translate(.5,.5),g.beginPath(),g.moveTo(-1,f);let v=0,T=!0,w=0;for(let e=0;e<p.length;e++){if(void 0===p[e])continue;T&&(T=!1,v=p[e],g.lineTo(-1,c-v));const t=p[e];Math.abs(t-v)>2&&Math.abs(e-w)>1&&g.lineTo(e,c-v),v=t,g.lineTo(e,c-v),w=e}g.lineTo(h+1,c-v),g.lineTo(h+1,f),g.closePath(),g.fillStyle="hsla(220, 90%, 70%, 0.2)",g.fill(),g.lineWidth=1,g.strokeStyle="hsl(220, 90%, 70%)",g.stroke(),this._heapSizeLabel.textContent=m.UIString("%s – %s",E.bytesToString(n),E.bytesToString(s))}}class tt{constructor(e,t,i){this._lastTime=e,this._quantDuration=t,this._callback=i,this._counters=[],this._remainder=t}appendInterval(e,t){let i=e-this._lastTime;if(i<=this._remainder)return this._counters[t]=(this._counters[t]||0)+i,this._remainder-=i,void(this._lastTime=e);for(this._counters[t]=(this._counters[t]||0)+this._remainder,this._callback(this._counters),i-=this._remainder;i>=this._quantDuration;){const e=[];e[t]=this._quantDuration,this._callback(e),i-=this._quantDuration}this._counters=[],this._counters[t]=i,this._lastTime=e,this._remainder=this._quantDuration-i}}class it extends qe{constructor(){super("coverage",m.UIString("COVERAGE")),this._heapSizeLabel=this.element.createChild("div","timeline-overview-coverage-label")}resetHeapSizeLabels(){this._heapSizeLabel.textContent=""}setModel(e){if(super.setModel(e),e){const t=e.mainTarget();t&&(this._coverageModel=t.model(xe.CoverageModel))}}update(){super.update();const e=window.devicePixelRatio;if(!this._coverageModel)return;let t=0,i=0;const s=new Map,n=new Map;for(const e of this._coverageModel.entries())for(const a of e.entries()){t+=a.size();for(const[e,t]of a.usedByTimestamp()){i+=t;let r=n.get(e);void 0===r&&(r=new Set,n.set(e,r)),r.add(a);const o=s.get(e);void 0===o?s.set(e,t):s.set(e,o+t)}}const a=new Set,r=new Map;let o=0,l=0;const h=Array.from(n.entries()).sort((e,t)=>e[0]-t[0]);for(const[e,t]of h){for(const e of t.values())a.has(e)||(a.add(e),o+=e.size());l+=s.get(e)||0,r.set(e,l/o)}const c=t?Math.round(100*i/t):0,d=3*e;if(!this._model)return;const m=this._model.timelineModel().minimumRecordTime()/1e3,u=this._model.timelineModel().maximumRecordTime()/1e3,p=this.width(),_=this.height()-d,g=p/(u-m),f=_-1;let v=0;const T=this.context(),w=_+d+1;T.translate(.5,.5),T.beginPath(),T.moveTo(-1,w),T.lineTo(-1,_-v);let S=null;for(const e of this._coverageModel.coverageUpdateTimes()){const t=r.get(e)||S;if(S=t,!t)continue;if(e>u)break;const i=(e-m)*g;v=t*f,T.lineTo(i,_-v)}const y="hsl(220, 90%, 70%)";T.lineTo(p+1,_-v),T.lineTo(p+1,w),T.closePath(),T.fillStyle="hsla(220, 90%, 70%, 0.2)",T.fill(),T.lineWidth=1,T.strokeStyle=y,T.stroke(),S=null;for(const e of this._coverageModel.coverageUpdateTimes()){const t=r.get(e)||S;if(S=t,!t)continue;T.beginPath();const i=(e-m)*g,s=_-t*f;T.arc(i,s,2,0,2*Math.PI,!1),T.closePath(),T.stroke(),T.fillStyle=r.has(e)?y:"hsl(0, 100%, 100%)",T.fill()}this._heapSizeLabel.textContent=c+"% used"}}var st=Object.freeze({__proto__:null,TimelineEventOverview:qe,TimelineEventOverviewInput:Xe,TimelineEventOverviewNetwork:$e,TimelineEventOverviewCPUActivity:Ke,TimelineEventOverviewResponsiveness:Ye,TimelineFilmStripOverview:Qe,TimelineEventOverviewFrames:Ze,TimelineEventOverviewMemory:et,Quantizer:tt,TimelineEventOverviewCoverage:it});class nt extends D.TimelineModelFilter{constructor(){super(),this._minimumRecordDuration=0}setMinimumRecordDuration(e){this._minimumRecordDuration=e}accept(e){return(e.endTime?e.endTime-e.startTime:0)>=this._minimumRecordDuration}}class at extends D.TimelineModelFilter{constructor(){super()}accept(e){return!gi.eventStyle(e).category.hidden}}class rt extends D.TimelineModelFilter{constructor(e){super(),this._regExp,this.setRegExp(e||null)}setRegExp(e){this._regExp=e}regExp(){return this._regExp}accept(e){return!this._regExp||gi.testContentMatching(e,this._regExp)}}var ot=Object.freeze({__proto__:null,IsLong:nt,Category:at,TimelineRegExp:rt});class lt extends V.VBox{constructor(){super(),this._model=null,this._track=null,this._tree=null,this.element.classList.add("timeline-tree-view"),this._searchResults=[],this.linkifier,this.dataGrid,this._lastHoveredProfileNode,this._textFilter,this._taskFilter,this._startTime,this._endTime,this.splitWidget,this.detailsView,this._searchableView}static eventNameForSorting(e){if(e.name===F.RecordType.JSFrame){const t=e.args.data;return t.functionName+"@"+(t.scriptId||t.url||"")}return e.name+":@"+B.eventURL(e)}setSearchableView(e){this._searchableView=e}setModel(e,t){this._model=e,this._track=t,this.refreshTree()}getToolbarInputAccessiblePlaceHolder(){return""}model(){return this._model}init(){this.linkifier=new ue.Linkifier,this._taskFilter=new D.ExclusiveNameFilter([F.RecordType.Task]),this._textFilter=new rt,this._currentThreadSetting=p.Settings.instance().createSetting("timelineTreeCurrentThread",0),this._currentThreadSetting.addChangeListener(this.refreshTree,this);const e=[];this.populateColumns(e),this.splitWidget=new A.SplitWidget(!0,!0,"timelineTreeViewDetailsSplitWidget");const t=new V.VBox,i=new H.Toolbar("",t.element);this.populateToolbar(i),this.dataGrid=new ke.SortableDataGrid({displayName:ls`Performance`,columns:e,refreshCallback:void 0,editCallback:void 0,deleteCallback:void 0}),this.dataGrid.addEventListener(Me.Events.SortingChanged,this._sortingChanged,this),this.dataGrid.element.addEventListener("mousemove",this._onMouseMove.bind(this),!0),this.dataGrid.setResizeMethod(Me.ResizeMethod.Last),this.dataGrid.setRowContextMenuCallback(this._onContextMenu.bind(this)),this.dataGrid.asWidget().show(t.element),this.dataGrid.addEventListener(Me.Events.SelectedNode,this._updateDetailsForSelection,this),this.detailsView=new V.VBox,this.detailsView.element.classList.add("timeline-details-view","timeline-details-view-body"),this.splitWidget.setMainWidget(t),this.splitWidget.setSidebarWidget(this.detailsView),this.splitWidget.hideSidebar(),this.splitWidget.show(this.element),this.splitWidget.addEventListener(A.Events.ShowModeChanged,this._onShowModeChanged,this),this._lastSelectedNode}lastSelectedNode(){return this._lastSelectedNode}updateContents(e){this.setRange(e.startTime(),e.endTime())}setRange(e,t){this._startTime=e,this._endTime=t,this.refreshTree()}filters(){return[this._taskFilter,this._textFilter,...this._model?this._model.filters():[]]}filtersWithoutTextFilter(){return[this._taskFilter,...this._model?this._model.filters():[]]}textFilter(){return this._textFilter}_exposePercentages(){return!1}populateToolbar(e){const t=new H.ToolbarInput(m.UIString("Filter"),this.getToolbarInputAccessiblePlaceHolder());t.addEventListener(H.ToolbarInput.Event.TextChanged,()=>{const e=t.value();this._textFilter.setRegExp(e?createPlainTextSearchRegex(e,"i"):null),this.refreshTree()},this),this._textFilterUI=t,e.appendToolbarItem(t)}_modelEvents(){return this._track?this._track.syncEvents():[]}_onHover(e){}_appendContextMenuItems(e,t){}_linkifyLocation(e){if(!this._model)return null;const t=this._model.timelineModel().targetByEvent(e);if(!t)return null;const i=B.eventStackFrame(e);return i?this.linkifier.maybeLinkifyConsoleCallFrame(t,i):null}selectProfileNode(e,t){const i=[];let s=e;for(;s;s=s.parent)i.push(s);for(let e=i.length-1;e>0;--e){const t=this.dataGridNodeForTreeNode(i[e]);t&&t.dataGrid&&t.expand()}const n=this.dataGridNodeForTreeNode(e);n&&n.dataGrid&&(n.reveal(),n.select(t))}refreshTree(){if(this.linkifier.reset(),this.dataGrid.rootNode().removeChildren(),!this._model)return void this._updateDetailsForSelection();this._root=this._buildTree();const e=this._root.children();let t=0,i=0;const s=this._root.totalTime-this._root.selfTime;for(const s of e.values())t=Math.max(t,s.selfTime),i=Math.max(i,s.totalTime);for(const n of e.values()){const e=new ct(n,s,t,i,this);this.dataGrid.insertChild(e)}this._sortingChanged(),this._updateDetailsForSelection(),this._searchableView&&this._searchableView.refreshSearch();const n=this.dataGrid.rootNode();n.children.length>0&&n.children[0].select(!0)}_buildTree(){throw new Error("Not Implemented")}buildTopDownTree(e,t){return new B.TopDownRootNode(this._modelEvents(),this.filters(),this._startTime,this._endTime,e,t)}populateColumns(e){e.push({id:"self",title:m.UIString("Self Time"),width:"120px",fixedWidth:!0,sortable:!0}),e.push({id:"total",title:m.UIString("Total Time"),width:"120px",fixedWidth:!0,sortable:!0}),e.push({id:"activity",title:m.UIString("Activity"),disclosure:!0,sortable:!0})}_sortingChanged(){const e=this.dataGrid.sortColumnId();if(!e)return;let t;switch(e){case"startTime":t=function(e,t){const i=t,s=e._profileNode.event,n=i._profileNode.event;return s.startTime-n.startTime};break;case"self":t=i.bind(null,"selfTime");break;case"total":t=i.bind(null,"totalTime");break;case"activity":t=function(e,t){const i=t,s=e._profileNode.event,n=i._profileNode.event,a=lt.eventNameForSorting(s),r=lt.eventNameForSorting(n);return a.localeCompare(r)};break;default:return void console.assert(!1,"Unknown sort field: "+e)}function i(e,t,i){const s=i;return t._profileNode[e]-s._profileNode[e]}this.dataGrid.sortNodes(t,!this.dataGrid.isSortOrderAscending())}_onShowModeChanged(){this.splitWidget.showMode()!==A.ShowMode.OnlyMain&&(this._lastSelectedNode=void 0,this._updateDetailsForSelection())}_updateDetailsForSelection(){const e=this.dataGrid.selectedNode?this.dataGrid.selectedNode._profileNode:null;if(e===this._lastSelectedNode)return;if(this._lastSelectedNode=e,this.splitWidget.showMode()===A.ShowMode.OnlyMain)return;if(this.detailsView.detachChildWidgets(),this.detailsView.element.removeChildren(),e&&this._showDetailsForNode(e))return;const t=this.detailsView.element.createChild("div","full-widget-dimmed-banner");U.createTextChild(t,m.UIString("Select item for details."))}_showDetailsForNode(e){return!1}_onMouseMove(e){const t=e.target&&e.target instanceof Node?this.dataGrid.dataGridNodeFromNode(e.target):null,i=t&&t._profileNode;i!==this._lastHoveredProfileNode&&(this._lastHoveredProfileNode=i,this._onHover(i))}_onContextMenu(e,t){const i=t;i._linkElement&&!e.containsTarget(i._linkElement)&&e.appendApplicableItems(i._linkElement);const s=i._profileNode;s&&this._appendContextMenuItems(e,s)}dataGridNodeForTreeNode(e){return dt.get(e)||null}searchCanceled(){this._searchResults=[],this._currentResult=0}performSearch(e,t,i){if(this._searchResults=[],this._currentResult=0,!this._root)return;const s=e.toSearchRegex();this._searchResults=this._root.searchTree(e=>gi.testContentMatching(e,s)),this._searchableView.updateSearchMatchesCount(this._searchResults.length)}jumpToNextSearchResult(){this._searchResults.length&&(this.selectProfileNode(this._searchResults[this._currentResult],!1),this._currentResult=E.mod(this._currentResult+1,this._searchResults.length))}jumpToPreviousSearchResult(){this._searchResults.length&&(this.selectProfileNode(this._searchResults[this._currentResult],!1),this._currentResult=E.mod(this._currentResult-1,this._searchResults.length))}supportsCaseSensitiveSearch(){return!0}supportsRegexSearch(){return!0}}class ht extends ke.SortableDataGridNode{constructor(e,t,i,s,n){super(null,!1),this._populated=!1,this._profileNode=e,this._treeView=n,this._grandTotalTime=t,this._maxSelfTime=i,this._maxTotalTime=s,this._linkElement=null}createCell(e){return"activity"===e?this._createNameCell(e):this._createValueCell(e)||super.createCell(e)}_createNameCell(e){const t=this.createTD(e),i=t.createChild("div","name-container"),s=i.createChild("div","activity-icon-container"),n=s.createChild("div","activity-icon"),a=i.createChild("div","activity-name"),r=this._profileNode.event;if(this._profileNode.isGroupNode()){const e=this._treeView._displayInfoForGroupNode(this._profileNode);a.textContent=e.name,n.style.backgroundColor=e.color,e.icon&&s.insertBefore(e.icon,n)}else if(r){const e=r.args.data,t=e&&e.deoptReason;t&&(i.createChild("div","activity-warning").title=m.UIString("Not optimized: %s",t)),a.textContent=gi.eventTitle(r),this._linkElement=this._treeView._linkifyLocation(r),this._linkElement&&i.createChild("div","activity-link").appendChild(this._linkElement);const s=gi.eventStyle(r).category;G.setAccessibleName(n,s.title),n.style.backgroundColor=s.color}return t}_createValueCell(e){if("self"!==e&&"total"!==e&&"startTime"!==e)return null;let t,i,s,n=!1;switch(e){case"startTime":if(s=this._profileNode.event,!this._treeView._model)throw new Error("Unable to find model for tree view");t=(s?s.startTime:0)-this._treeView._model.timelineModel().minimumRecordTime();break;case"self":t=this._profileNode.selfTime,i=this._maxSelfTime,n=!0;break;case"total":t=this._profileNode.totalTime,i=this._maxTotalTime,n=!0;break;default:return null}const a=this.createTD(e);a.className="numeric-column";const r=a.createChild("div");return r.createChild("span").textContent=m.UIString("%.1f ms",t),n&&this._treeView._exposePercentages()&&(r.createChild("span","percent-column").textContent=m.UIString("%.1f %%",t/this._grandTotalTime*100)),i&&(r.classList.add("background-percent-bar"),a.createChild("div","background-bar-container").createChild("div","background-bar").style.width=(100*t/i).toFixed(1)+"%"),a}}class ct extends ht{constructor(e,t,i,s,n){super(e,t,i,s,n),this.setHasChildren(this._profileNode.hasChildren()),dt.set(e,this)}populate(){if(!this._populated&&(this._populated=!0,this._profileNode.children))for(const e of this._profileNode.children().values()){const t=new ct(e,this._grandTotalTime,this._maxSelfTime,this._maxTotalTime,this._treeView);this.insertChildOrdered(t)}}}ct._gridNodeSymbol=Symbol("treeGridNode");const dt=new WeakMap;class mt extends lt{constructor(){super(),this._groupBySetting=p.Settings.instance().createSetting("timelineTreeGroupBy",mt.GroupBy.None),this._groupBySetting.addChangeListener(this.refreshTree.bind(this)),this.init(),this._stackView=new _t(this),this._stackView.addEventListener(_t.Events.SelectionChanged,this._onStackViewSelectionChanged,this),this._productByURLCache=new Map,this._colorByURLCache=new Map,this._executionContextNamesByOrigin=new Map}setModel(e,t){super.setModel(e,t)}updateContents(e){this._updateExtensionResolver(),super.updateContents(e);const t=this.dataGrid.rootNode();t.children.length&&t.children[0].select(!0)}_updateExtensionResolver(){this._executionContextNamesByOrigin=new Map;for(const e of s.TargetManager.instance().models(a.RuntimeModel))for(const t of e.executionContexts())this._executionContextNamesByOrigin.set(t.origin,t.name)}_beautifyDomainName(e){return mt._isExtensionInternalURL(e)?e=m.UIString("[Chrome extensions overhead]"):mt._isV8NativeURL(e)?e=m.UIString("[V8 Runtime]"):e.startsWith("chrome-extension")&&(e=this._executionContextNamesByOrigin.get(e)||e),e}_displayInfoForGroupNode(e){const t=gi.categories(),i=e.id?gi.eventColor(e.event):t.other.color,s=m.UIString("[unattributed]"),n="symbol"==typeof e.id?void 0:e.id;switch(this._groupBySetting.get()){case mt.GroupBy.Category:{const e=n?t[n]||t.other:{title:s,color:s};return{name:e.title,color:e.color,icon:void 0}}case mt.GroupBy.Domain:case mt.GroupBy.Subdomain:return{name:(n?this._beautifyDomainName(n):void 0)||s,color:i,icon:void 0};case mt.GroupBy.EventName:if(!e.event)throw new Error("Unable to find event for group by operation");return{name:e.event.name===F.RecordType.JSFrame?m.UIString("JavaScript"):gi.eventTitle(e.event),color:e.event.name===F.RecordType.JSFrame?gi.eventStyle(e.event).category.color:i,icon:void 0};case mt.GroupBy.URL:break;case mt.GroupBy.Frame:{if(!this._model)throw new Error("Unable to find model for group by frame operation");const e=n?this._model.timelineModel().pageFrameById(n):void 0;return{name:e?gi.displayNameForFrame(e,80):m.UIString("Page"),color:i,icon:void 0}}default:console.assert(!1,"Unexpected grouping type")}return{name:n||s,color:i,icon:void 0}}populateToolbar(e){super.populateToolbar(e);const t=mt.GroupBy,i=[{label:m.UIString("No Grouping"),value:t.None},{label:m.UIString("Group by Activity"),value:t.EventName},{label:m.UIString("Group by Category"),value:t.Category},{label:m.UIString("Group by Domain"),value:t.Domain},{label:m.UIString("Group by Frame"),value:t.Frame},{label:m.UIString("Group by Subdomain"),value:t.Subdomain},{label:m.UIString("Group by URL"),value:t.URL}];e.appendToolbarItem(new H.ToolbarSettingComboBox(i,this._groupBySetting,ls`Group by`)),e.appendSpacer(),e.appendToolbarItem(this.splitWidget.createShowHideSidebarButton(m.UIString("heaviest stack")))}_buildHeaviestStack(e){console.assert(!!e.parent,"Attempt to build stack for tree root");let t=[];for(let i=e;i&&i.parent;i=i.parent)t.push(i);t=t.reverse();for(let i=e;i&&i.children()&&i.children().size;){const e=Array.from(i.children().values());i=e.reduce((e,t)=>e.totalTime>t.totalTime?e:t),t.push(i)}return t}_exposePercentages(){return!0}_onStackViewSelectionChanged(){const e=this._stackView.selectedTreeNode();e&&this.selectProfileNode(e,!0)}_showDetailsForNode(e){const t=this._buildHeaviestStack(e);return this._stackView.setStack(t,e),this._stackView.show(this.detailsView.element),!0}_groupingFunction(e){const t=mt.GroupBy;switch(e){case t.None:return null;case t.EventName:return e=>gi.eventStyle(e).title;case t.Category:return e=>gi.eventStyle(e).category.name;case t.Subdomain:return this._domainByEvent.bind(this,!1);case t.Domain:return this._domainByEvent.bind(this,!0);case t.URL:return e=>B.eventURL(e)||"";case t.Frame:return e=>F.TimelineData.forEvent(e).frameId;default:return console.assert(!1,"Unexpected aggregation setting: "+e),null}}_domainByEvent(e,t){const i=B.eventURL(t);if(!i)return"";if(mt._isExtensionInternalURL(i))return mt._extensionInternalPrefix;if(mt._isV8NativeURL(i))return mt._v8NativePrefix;const s=_.ParsedURL.fromString(i);if(!s)return"";if("chrome-extension"===s.scheme)return s.scheme+"://"+s.host;if(!e)return s.host;if(/^[.0-9]+$/.test(s.host))return s.host;const n=/([^.]*\.)?[^.]*$/.exec(s.host);return n&&n[0]||""}_appendContextMenuItems(e,t){if(this._groupBySetting.get()!==mt.GroupBy.Frame)return;if(!t.isGroupNode())return;if(!this._model)return;const i=this._model.timelineModel().pageFrameById(t.id);i&&i.ownerNode&&e.appendApplicableItems(i.ownerNode)}static _isExtensionInternalURL(e){return e.startsWith(mt._extensionInternalPrefix)}static _isV8NativeURL(e){return e.startsWith(mt._v8NativePrefix)}}mt._extensionInternalPrefix="extensions::",mt._v8NativePrefix="native ",mt.GroupBy={None:"None",EventName:"EventName",Category:"Category",Domain:"Domain",Subdomain:"Subdomain",URL:"URL",Frame:"Frame"};class ut extends mt{constructor(){super(),this.dataGrid.markColumnAsSortedBy("total",Me.Order.Descending)}getToolbarInputAccessiblePlaceHolder(){return ls`Filter call tree`}_buildTree(){const e=this._groupBySetting.get();return this.buildTopDownTree(!1,this._groupingFunction(e))}}class pt extends mt{constructor(){super(),this.dataGrid.markColumnAsSortedBy("self",Me.Order.Descending)}getToolbarInputAccessiblePlaceHolder(){return ls`Filter bottom-up`}_buildTree(){return new B.BottomUpRootNode(this._modelEvents(),this.textFilter(),this.filtersWithoutTextFilter(),this._startTime,this._endTime,this._groupingFunction(this._groupBySetting.get()))}}class _t extends V.VBox{constructor(e){super();this.element.createChild("div","timeline-stack-view-header").textContent=m.UIString("Heaviest stack"),this._treeView=e;const t=[{id:"total",title:m.UIString("Total Time"),fixedWidth:!0,width:"110px"},{id:"activity",title:m.UIString("Activity")}];this._dataGrid=new Ee.ViewportDataGrid({displayName:ls`Timeline Stack`,columns:t,deleteCallback:void 0,editCallback:void 0,refreshCallback:void 0}),this._dataGrid.setResizeMethod(Me.ResizeMethod.Last),this._dataGrid.addEventListener(Me.Events.SelectedNode,this._onSelectionChanged,this),this._dataGrid.asWidget().show(this.element)}setStack(e,t){const i=this._dataGrid.rootNode();i.removeChildren();let s=null;const n=Math.max.apply(Math,e.map(e=>e.totalTime));for(const a of e){const e=new ht(a,n,n,n,this._treeView);i.appendChild(e),a===t&&(s=e)}s&&s.revealAndSelect()}selectedTreeNode(){const e=this._dataGrid.selectedNode;return e&&e._profileNode}_onSelectionChanged(){this.dispatchEventToListeners(_t.Events.SelectionChanged)}}_t.Events={SelectionChanged:Symbol("SelectionChanged")};var gt=Object.freeze({__proto__:null,TimelineTreeView:lt,GridNode:ht,TreeGridNode:ct,AggregatedTimelineTreeView:mt,CallTreeTimelineTreeView:ut,BottomUpTimelineTreeView:pt,TimelineStackView:_t});class ft extends lt{constructor(e){super(),this._filtersControl=new vt,this._filtersControl.addEventListener(vt.Events.FilterChanged,this._onFilterChanged,this),this.init(),this._delegate=e,this.dataGrid.markColumnAsSortedBy("startTime",Me.Order.Ascending),this.splitWidget.showBoth()}filters(){return[...super.filters(),...this._filtersControl.filters()]}updateContents(e){if(super.updateContents(e),e.type()===mi.Type.TraceEvent){const t=e.object();this._selectEvent(t,!0)}}getToolbarInputAccessiblePlaceHolder(){return ls`Filter event log`}_buildTree(){return this._currentTree=this.buildTopDownTree(!0,null),this._currentTree}_onFilterChanged(){const e=this.lastSelectedNode()&&this.lastSelectedNode().event;this.refreshTree(),e&&this._selectEvent(e,!1)}_findNodeWithEvent(e){const t=[this._currentTree.children().values()];for(;t.length;){const i=t.peekLast().next();if(i.done){t.pop();continue}const s=i.value;if(s.event===e)return s;t.push(s.children().values())}return null}_selectEvent(e,t){const i=this._findNodeWithEvent(e);i&&(this.selectProfileNode(i,!1),t&&this.dataGridNodeForTreeNode(i).expand())}populateColumns(e){e.push({id:"startTime",title:m.UIString("Start Time"),width:"80px",fixedWidth:!0,sortable:!0}),super.populateColumns(e),e.filter(e=>e.fixedWidth).forEach(e=>{e.width="80px"})}populateToolbar(e){super.populateToolbar(e),this._filtersControl.populateToolbar(e)}_showDetailsForNode(e){const t=e.event;return!!t&&(gi.buildTraceEventDetails(t,this.model().timelineModel(),this.linkifier,!1).then(e=>this.detailsView.element.appendChild(e)),!0)}_onHover(e){this._delegate.highlightEvent(e&&e.event)}}class vt extends g.ObjectWrapper{constructor(){super(),this._categoryFilter=new at,this._durationFilter=new nt,this._filters=[this._categoryFilter,this._durationFilter]}filters(){return this._filters}populateToolbar(e){const t=new H.ToolbarComboBox(function(){const e=t.selectedOption().value,i=parseInt(e,10);this._durationFilter.setMinimumRecordDuration(i),this._notifyFiltersChanged()}.bind(this),ls`Duration filter`);for(const e of vt._durationFilterPresetsMs)t.addOption(t.createOption(e?m.UIString("≥ %d ms",e):m.UIString("All"),String(e)));e.appendToolbarItem(t);const i={},s=gi.categories();for(const t in s){const a=s[t];if(!a.visible)continue;const r=new H.ToolbarCheckbox(a.title,void 0,n.bind(this,t));r.setChecked(!0),r.inputElement.style.backgroundColor=a.color,i[a.name]=r,e.appendToolbarItem(r)}function n(e){gi.categories()[e].hidden=!i[e].checked(),this._notifyFiltersChanged()}}_notifyFiltersChanged(){this.dispatchEventToListeners(vt.Events.FilterChanged)}}vt._durationFilterPresetsMs=[0,1,15],vt.Events={FilterChanged:Symbol("FilterChanged")};var Tt=Object.freeze({__proto__:null,EventsTimelineTreeView:ft,Filters:vt});class wt extends A.SplitWidget{constructor(e,t){super(!0,!1,"timelineLayersView"),this._model=e,this._showPaintProfilerCallback=t,this.element.classList.add("timeline-layers-view"),this._rightSplitWidget=new A.SplitWidget(!0,!0,"timelineLayersViewDetails"),this._rightSplitWidget.element.classList.add("timeline-layers-view-properties"),this.setMainWidget(this._rightSplitWidget);const i=new V.VBox;this.setSidebarWidget(i),this._layerViewHost=new Pe.LayerViewHost;const s=new Re.LayerTreeOutline(this._layerViewHost);i.element.appendChild(s.element),this._layers3DView=new Le.Layers3DView(this._layerViewHost),this._layers3DView.addEventListener(Le.Events.PaintProfilerRequested,this._onPaintProfilerRequested,this),this._rightSplitWidget.setMainWidget(this._layers3DView);const n=new Ie.LayerDetailsView(this._layerViewHost);this._rightSplitWidget.setSidebarWidget(n),n.addEventListener(Ie.Events.PaintProfilerRequested,this._onPaintProfilerRequested,this)}showLayerTree(e){this._frameLayerTree=e,this.isShowing()?this._update():this._updateWhenVisible=!0}wasShown(){this._updateWhenVisible&&(this._updateWhenVisible=!1,this._update())}_onPaintProfilerRequested(e){const t=e.data;this._layers3DView.snapshotForSelection(t).then(e=>{e&&this._showPaintProfilerCallback(e.snapshot)})}_update(){this._frameLayerTree&&this._frameLayerTree.layerTreePromise().then(e=>this._layerViewHost.setLayerTree(e))}}var St=Object.freeze({__proto__:null,TimelineLayersView:wt});class yt extends A.SplitWidget{constructor(e){super(!1,!1),this.element.classList.add("timeline-paint-profiler-view"),this.setSidebarSize(60),this.setResizable(!1),this._frameModel=e,this._logAndImageSplitWidget=new A.SplitWidget(!0,!1),this._logAndImageSplitWidget.element.classList.add("timeline-paint-profiler-log-split"),this.setMainWidget(this._logAndImageSplitWidget),this._imageView=new bt,this._logAndImageSplitWidget.setMainWidget(this._imageView),this._paintProfilerView=new Fe.PaintProfilerView(this._imageView.showImage.bind(this._imageView)),this._paintProfilerView.addEventListener(Fe.Events.WindowChanged,this._onWindowChanged,this),this.setSidebarWidget(this._paintProfilerView),this._logTreeView=new Fe.PaintProfilerCommandLogView,this._logAndImageSplitWidget.setSidebarWidget(this._logTreeView),this._needsUpdateWhenVisible=!1,this._pendingSnapshot=null,this._event=null,this._paintProfilerModel=null,this._lastLoadedSnapshot=null}wasShown(){this._needsUpdateWhenVisible&&(this._needsUpdateWhenVisible=!1,this._update())}setSnapshot(e){this._releaseSnapshot(),this._pendingSnapshot=e,this._event=null,this._updateWhenVisible()}setEvent(e,t){return this._releaseSnapshot(),this._paintProfilerModel=e,this._pendingSnapshot=null,this._event=t,this._updateWhenVisible(),this._event.name===F.RecordType.Paint?!!F.TimelineData.forEvent(t).picture:this._event.name===F.RecordType.RasterTask&&this._frameModel.hasRasterTile(this._event)}_updateWhenVisible(){this.isShowing()?this._update():this._needsUpdateWhenVisible=!0}_update(){let e;if(this._logTreeView.setCommandLog([]),this._paintProfilerView.setSnapshotAndLog(null,[],null),this._pendingSnapshot)e=Promise.resolve({rect:null,snapshot:this._pendingSnapshot});else if(this._event&&this._event.name===F.RecordType.Paint){e=F.TimelineData.forEvent(this._event).picture.objectPromise().then(e=>this._paintProfilerModel.loadSnapshot(e.skp64)).then(e=>e&&{rect:null,snapshot:e})}else{if(!this._event||this._event.name!==F.RecordType.RasterTask)return void console.assert(!1,"Unexpected event type or no snapshot");e=this._frameModel.rasterTilePromise(this._event)}function t(e,t,i){this._logTreeView.setCommandLog(i||[]),this._paintProfilerView.setSnapshotAndLog(e,i||[],t)}e.then(e=>{if(this._releaseSnapshot(),!e)return void this._imageView.showImage();const i=e.snapshot;this._lastLoadedSnapshot=i,this._imageView.setMask(e.rect),i.commandLog().then(s=>t.call(this,i,e.rect,s||[]))})}_releaseSnapshot(){this._lastLoadedSnapshot&&(this._lastLoadedSnapshot.release(),this._lastLoadedSnapshot=null)}_onWindowChanged(){this._logTreeView.updateWindow(this._paintProfilerView.selectionWindow())}}class bt extends V.Widget{constructor(){super(!0),this.registerRequiredCSS("timeline/timelinePaintProfiler.css",{enableLegacyPatching:!0}),this.contentElement.classList.add("fill","paint-profiler-image-view"),this._imageContainer=this.contentElement.createChild("div","paint-profiler-image-container"),this._imageElement=this._imageContainer.createChild("img"),this._maskElement=this._imageContainer.createChild("div"),this._imageElement.addEventListener("load",this._updateImagePosition.bind(this),!1),this._transformController=new De.TransformController(this.contentElement,!0),this._transformController.addEventListener(De.Events.TransformChanged,this._updateImagePosition,this)}onResize(){this._imageElement.src&&this._updateImagePosition()}_updateImagePosition(){const e=this._imageElement.naturalWidth,t=this._imageElement.naturalHeight,i=this.contentElement.clientWidth,s=this.contentElement.clientHeight,n=.1*i,a=.1*s,r=(i-n)/e,o=(s-a)/t,l=Math.min(r,o);if(this._maskRectangle){const i=this._maskElement.style;i.width=e+"px",i.height=t+"px",i.borderLeftWidth=this._maskRectangle.x+"px",i.borderTopWidth=this._maskRectangle.y+"px",i.borderRightWidth=e-this._maskRectangle.x-this._maskRectangle.width+"px",i.borderBottomWidth=t-this._maskRectangle.y-this._maskRectangle.height+"px"}this._transformController.setScaleConstraints(.5,10/l);let h=(new WebKitCSSMatrix).scale(this._transformController.scale(),this._transformController.scale()).translate(i/2,s/2).scale(l,l).translate(-e/2,-t/2);const c=O.boundsForTransformedPoints(h,[0,0,0,e,t,0]);this._transformController.clampOffsets(n-c.maxX,i-n-c.minX,a-c.maxY,s-a-c.minY),h=(new WebKitCSSMatrix).translate(this._transformController.offsetX(),this._transformController.offsetY()).multiply(h),this._imageContainer.style.webkitTransform=h.toString()}showImage(e){this._imageContainer.classList.toggle("hidden",!e),e&&(this._imageElement.src=e)}setMask(e){this._maskRectangle=e,this._maskElement.classList.toggle("hidden",!e)}}var Ct=Object.freeze({__proto__:null,TimelinePaintProfilerView:yt,TimelinePaintImageView:bt});class xt extends V.VBox{constructor(e){super(),this.element.classList.add("timeline-details"),this._detailsLinkifier=new ue.Linkifier,this._tabbedPane=new z.TabbedPane,this._tabbedPane.show(this.element);const t=kt;this._defaultDetailsWidget=new V.VBox,this._defaultDetailsWidget.element.classList.add("timeline-details-view"),this._defaultDetailsContentElement=this._defaultDetailsWidget.element.createChild("div","timeline-details-view-body vbox"),this._appendTab(t.Details,m.UIString("Summary"),this._defaultDetailsWidget),this.setPreferredTab(t.Details),this._rangeDetailViews=new Map;const i=new pt;this._appendTab(t.BottomUp,m.UIString("Bottom-Up"),i),this._rangeDetailViews.set(t.BottomUp,i);const s=new ut;this._appendTab(t.CallTree,m.UIString("Call Tree"),s),this._rangeDetailViews.set(t.CallTree,s);const n=new ft(e);this._appendTab(t.EventLog,m.UIString("Event Log"),n),this._rangeDetailViews.set(t.EventLog,n),this._additionalMetricsToolbar=new H.Toolbar("timeline-additional-metrics"),this.element.appendChild(this._additionalMetricsToolbar.element),this._tabbedPane.addEventListener(z.Events.TabSelected,this._tabSelected,this),this._model}setModel(e,t){this._model!==e&&(this._model&&this._model.removeEventListener(Ei.WindowChanged,this._onWindowChanged,this),this._model=e,this._model&&this._model.addEventListener(Ei.WindowChanged,this._onWindowChanged,this)),this._track=t,this._tabbedPane.closeTabs([kt.PaintProfiler,kt.LayerViewer],!1);for(const i of this._rangeDetailViews.values())i.setModel(e,t);if(this._lazyPaintProfilerView=null,this._lazyLayersView=null,this.setSelection(null),this._additionalMetricsToolbar.removeToolbarItems(),e&&e.timelineModel()){const{estimated:t,time:i}=e.timelineModel().totalBlockingTime(),s=t?` (${ls`estimated`})`:"",n=ls`Total blocking time: ${i.toFixed(2)}ms${s}`,a=document.createElement("span"),r=U.createWebDevLink("tbt/",ls`Learn more`);r.style.marginRight="2px",a.appendChild(U.formatLocalized("%s",[r])),this._additionalMetricsToolbar.appendText(n),this._additionalMetricsToolbar.appendToolbarItem(new H.ToolbarItem(a))}}_setContent(e){const t=this._tabbedPane.otherTabs(kt.Details);for(let e=0;e<t.length;++e)this._rangeDetailViews.has(t[e])||this._tabbedPane.closeTab(t[e]);this._defaultDetailsContentElement.removeChildren(),this._defaultDetailsContentElement.appendChild(e)}_updateContents(){const e=this._rangeDetailViews.get(this._tabbedPane.selectedTabId||"");if(e){const t=this._model.window();e.updateContents(this._selection||mi.fromRange(t.left,t.right))}}_appendTab(e,t,i,s){this._tabbedPane.appendTab(e,t,i,void 0,void 0,s),this._preferredTabId!==this._tabbedPane.selectedTabId&&this._tabbedPane.selectTab(e)}headerElement(){return this._tabbedPane.headerElement()}setPreferredTab(e){this._preferredTabId=e}_onWindowChanged(e){this._selection||this._updateContentsFromWindow()}_updateContentsFromWindow(){if(!this._model)return void this._setContent(j.html`<div/>`);const e=this._model.window();this._updateSelectedRangeStats(e.left,e.right),this._updateContents()}setSelection(e){if(this._detailsLinkifier.reset(),this._selection=e,this._selection){switch(this._selection.type()){case mi.Type.TraceEvent:{const e=this._selection.object();gi.buildTraceEventDetails(e,this._model.timelineModel(),this._detailsLinkifier,!0).then(t=>this._appendDetailsTabsForTraceEventAndShowDetails(e,t));break}case mi.Type.Frame:{const e=this._selection.object(),t=this._model.filmStripModelFrame(e);if(this._setContent(gi.generateDetailsContentForFrame(e,t)),e.layerTree){const t=this._layersView();t.showLayerTree(e.layerTree),this._tabbedPane.hasTab(kt.LayerViewer)||this._appendTab(kt.LayerViewer,m.UIString("Layers"),t)}break}case mi.Type.NetworkRequest:{const e=this._selection.object();gi.buildNetworkRequestDetails(e,this._model.timelineModel(),this._detailsLinkifier).then(this._setContent.bind(this));break}case mi.Type.Range:this._updateSelectedRangeStats(this._selection.startTime(),this._selection.endTime())}this._updateContents()}else this._updateContentsFromWindow()}_tabSelected(e){e.data.isUserGesture&&(this.setPreferredTab(e.data.tabId),this._updateContents())}_layersView(){return this._lazyLayersView||(this._lazyLayersView=new wt(this._model.timelineModel(),this._showSnapshotInPaintProfiler.bind(this))),this._lazyLayersView}_paintProfilerView(){return this._lazyPaintProfilerView||(this._lazyPaintProfilerView=new yt(this._model.frameModel())),this._lazyPaintProfilerView}_showSnapshotInPaintProfiler(e){const t=this._paintProfilerView();t.setSnapshot(e),this._tabbedPane.hasTab(kt.PaintProfiler)||this._appendTab(kt.PaintProfiler,m.UIString("Paint Profiler"),t,!0),this._tabbedPane.selectTab(kt.PaintProfiler,!0)}_appendDetailsTabsForTraceEventAndShowDetails(e,t){this._setContent(t),e.name!==F.RecordType.Paint&&e.name!==F.RecordType.RasterTask||this._showEventInPaintProfiler(e)}_showEventInPaintProfiler(e){const t=s.TargetManager.instance().models(r.PaintProfilerModel)[0];if(!t)return;const i=this._paintProfilerView();i.setEvent(t,e)&&(this._tabbedPane.hasTab(kt.PaintProfiler)||this._appendTab(kt.PaintProfiler,m.UIString("Paint Profiler"),i))}_updateSelectedRangeStats(e,t){if(!this._model||!this._track)return;const i=gi.statsForTimeRange(this._track.syncEvents(),e,t),s=e-this._model.timelineModel().minimumRecordTime(),n=t-this._model.timelineModel().minimumRecordTime(),a=new Ci(null,null);a.addSection(ls`Range:  ${Number.millisToString(s)} \u2013 ${Number.millisToString(n)}`);const r=gi.generatePieChart(i);a.appendElementRow("",r),this._setContent(a.fragment)}}const kt={Details:"Details",EventLog:"EventLog",CallTree:"CallTree",BottomUp:"BottomUp",PaintProfiler:"PaintProfiler",LayerViewer:"LayerViewer"};var Mt=Object.freeze({__proto__:null,TimelineDetailsView:xt,Tab:kt});class Et extends g.ObjectWrapper{constructor(){super(),this.reset(),this._font="11px "+ve.fontFamily(),this._timelineData=null,this._currentLevel=0,this._performanceModel=null,this._model=null,this._minimumBoundary=0,this._maximumBoundary=0,this._timeSpan=0,this._consoleColorGenerator=new f.Generator({min:30,max:55},{min:70,max:100,count:6},50,.7),this._extensionColorGenerator=new f.Generator({min:210,max:300},{min:70,max:100,count:6},70,.7),this._headerLevel1=this._buildGroupStyle({shareHeaderLine:!1}),this._headerLevel2=this._buildGroupStyle({padding:2,nestingLevel:1,collapsible:!1}),this._staticHeader=this._buildGroupStyle({collapsible:!1}),this._framesHeader=this._buildGroupStyle({useFirstLineForOverview:!0}),this._collapsibleTimingsHeader=this._buildGroupStyle({shareHeaderLine:!0,useFirstLineForOverview:!0,collapsible:!0}),this._timingsHeader=this._buildGroupStyle({shareHeaderLine:!0,useFirstLineForOverview:!0,collapsible:!1}),this._screenshotsHeader=this._buildGroupStyle({useFirstLineForOverview:!0,nestingLevel:1,collapsible:!1,itemsHeight:150}),this._interactionsHeaderLevel1=this._buildGroupStyle({useFirstLineForOverview:!0}),this._interactionsHeaderLevel2=this._buildGroupStyle({padding:2,nestingLevel:1}),this._experienceHeader=this._buildGroupStyle({collapsible:!1}),this._flowEventIndexById=new Map}_buildGroupStyle(e){const t={padding:4,height:17,collapsible:!0,color:Be.instance().patchColorText("#222",Be.ColorUsage.Foreground),backgroundColor:Be.instance().patchColorText("white",Be.ColorUsage.Background),font:this._font,nestingLevel:0,shareHeaderLine:!0};return Object.assign(t,e)}setModel(e){this.reset(),this._performanceModel=e,this._model=e&&e.timelineModel()}groupTrack(e){return e._track||null}navStartTimes(){return this._model?this._model.navStartTimes():new Map}entryTitle(e){const i=It,s=this._entryType(e);if(s===i.Event){const i=this._entryData[e];return i.phase===t.Phase.AsyncStepInto||i.phase===t.Phase.AsyncStepPast?i.name+":"+i.args.step:i._blackboxRoot?m.UIString("Blackboxed"):this._performanceModel.timelineModel().isMarkerEvent(i)?gi.markerShortTitle(i):gi.eventTitle(i)}if(s===i.ExtensionEvent){return this._entryData[e].name}if(s===i.Screenshot)return"";let n=this._entryIndexToTitle[e];return n||(n=m.UIString("Unexpected entryIndex %d",e),console.error(n)),n}textColor(e){const t=this._entryData[e];return t&&t._blackboxRoot?"#888":jt.textColor}entryFont(e){return this._font}reset(){this._currentLevel=0,this._timelineData=null,this._entryData=[],this._entryParent=[],this._entryTypeByLevel=[],this._entryIndexToTitle=[],this._markers=[],this._asyncColorByCategory=new Map,this._asyncColorByInteractionPhase=new Map,this._extensionInfo=[],this._screenshotImageCache=new Map}maxStackDepth(){return this._currentLevel}timelineData(){return this._timelineData?this._timelineData:(this._timelineData=new S.TimelineData([],[],[],[]),this._model?(this._flowEventIndexById.clear(),this._minimumBoundary=this._model.minimumRecordTime(),this._timeSpan=this._model.isEmpty()?1e3:this._model.maximumRecordTime()-this._minimumBoundary,this._currentLevel=0,this._model.isGenericTrace()?this._processGenericTrace():this._processInspectorTrace(),this._timelineData):this._timelineData)}_processGenericTrace(){const e=this._buildGroupStyle({shareHeaderLine:!1}),t=this._buildGroupStyle({padding:2,nestingLevel:1,shareHeaderLine:!1}),i=It.Event,s=new Platform.Multimap;for(const e of this._model.tracks())null!==e.thread?s.set(e.thread.process(),e):console.error("Failed to process track");for(const n of s.keysArray()){if(s.size>1){const t=`${n.name()} ${n.id()}`;this._appendHeader(t,e,!1)}for(const e of s.get(n)){const s=this._appendSyncEvents(e,e.events,e.name,t,i,!0);this._timelineData.selectedGroup&&e.name!==F.TimelineModelImpl.BrowserMainThreadName||(this._timelineData.selectedGroup=s)}}}_processInspectorTrace(){this._appendFrames(),this._appendInteractionRecords();const e=It.Event,t=e=>{switch(e.type){case F.TrackType.Input:return 0;case F.TrackType.Animation:return 1;case F.TrackType.Timings:return 2;case F.TrackType.Console:return 3;case F.TrackType.Experience:return 4;case F.TrackType.MainThread:return e.forMainFrame?5:6;case F.TrackType.Worker:return 7;case F.TrackType.Raster:return 8;case F.TrackType.GPU:return 9;case F.TrackType.Other:return 10}},i=this._model.tracks().slice();i.sort((e,i)=>t(e)-t(i));let s=0;for(const t of i)switch(t.type){case F.TrackType.Input:this._appendAsyncEventsGroup(t,ls`Input`,t.asyncEvents,this._interactionsHeaderLevel2,e,!1);break;case F.TrackType.Animation:this._appendAsyncEventsGroup(t,ls`Animation`,t.asyncEvents,this._interactionsHeaderLevel2,e,!1);break;case F.TrackType.Timings:{const i=t.asyncEvents.length>0?this._collapsibleTimingsHeader:this._timingsHeader;this._appendHeader(ls`Timings`,i,!0)._track=t,this._appendPageMetrics(),this._copyPerfMarkEvents(t),this._appendSyncEvents(t,t.events,null,null,e,!0),this._appendAsyncEventsGroup(t,null,t.asyncEvents,null,e,!0);break}case F.TrackType.Console:this._appendAsyncEventsGroup(t,ls`Console`,t.asyncEvents,this._headerLevel1,e,!0);break;case F.TrackType.MainThread:if(t.forMainFrame){const i=this._appendSyncEvents(t,t.events,t.url?ls`Main \u2014 ${t.url}`:ls`Main`,this._headerLevel1,e,!0);i&&(this._timelineData.selectedGroup=i)}else this._appendSyncEvents(t,t.events,t.url?ls`Frame \u2014 ${t.url}`:ls`Subframe`,this._headerLevel1,e,!0);break;case F.TrackType.Worker:this._appendSyncEvents(t,t.events,t.name,this._headerLevel1,e,!0);break;case F.TrackType.Raster:s||this._appendHeader(ls`Raster`,this._headerLevel1,!1),++s,this._appendSyncEvents(t,t.events,ls`Rasterizer Thread ${s}`,this._headerLevel2,e,!0);break;case F.TrackType.GPU:this._appendSyncEvents(t,t.events,ls`GPU`,this._headerLevel1,e,!0);break;case F.TrackType.Other:this._appendSyncEvents(t,t.events,t.name||ls`Thread`,this._headerLevel1,e,!0),this._appendAsyncEventsGroup(t,t.name,t.asyncEvents,this._headerLevel1,e,!0);break;case F.TrackType.Experience:this._appendSyncEvents(t,t.events,ls`Experience`,this._experienceHeader,e,!0)}this._timelineData.selectedGroup&&(this._timelineData.selectedGroup.expanded=!0);for(let e=0;e<this._extensionInfo.length;e++)this._innerAppendExtensionEvents(e);this._markers.sort((e,t)=>e.startTime()-t.startTime()),this._timelineData.markers=this._markers,this._flowEventIndexById.clear()}minimumBoundary(){return this._minimumBoundary}totalTime(){return this._timeSpan}search(e,i,s){const n=[],a=It;this.timelineData();for(let t=0;t<this._entryData.length;++t){if(this._entryType(t)!==a.Event)continue;const r=this._entryData[t];r.startTime>i||((r.endTime||r.startTime)<e||s.accept(r)&&n.push(t))}return n.sort((e,i)=>t.Event.compareStartTime(this._entryData[e],this._entryData[i])),n}_appendSyncEvents(e,i,s,n,a,r){if(!i.length)return null;const o=a===It.ExtensionEvent,l=[],h=Root.Runtime.experiments.isEnabled("timelineFlowEvents"),c=!o&&Root.Runtime.experiments.isEnabled("blackboxJSFramesOnTimeline");let d=0,m=null;e&&e.type===F.TrackType.MainThread&&(m=this._appendHeader(s,n,r),m._track=e);for(let a=0;a<i.length;++a){const u=i[a];if(this._performanceModel){const t=this._performanceModel.timelineModel().isInteractiveTimeEvent(u),i=this._performanceModel.timelineModel().isLayoutShiftEvent(u),s=t||i;if(e&&e.type===F.TrackType.MainThread&&s)continue}if(this._performanceModel&&this._performanceModel.timelineModel().isLayoutShiftEvent(u))for(const e of this._performanceModel.frames()){void 0===u.endTime&&u.setEndTime(u.startTime);const t=u.startTime>=e.startTime,i=u.endTime&&u.endTime<=e.endTime;t&&i&&(u.startTime=e.startTime,u.setEndTime(e.endTime))}if(!o&&this._performanceModel.timelineModel().isMarkerEvent(u)&&this._markers.push(new qt(u.startTime,u.startTime-this._model.minimumRecordTime(),gi.markerStyleForEvent(u))),!t.TracingModel.isFlowPhase(u.phase)){if(!u.endTime&&u.phase!==t.Phase.Instant)continue;if(t.TracingModel.isAsyncPhase(u.phase))continue;if(!o&&!this._performanceModel.isVisible(u))continue}for(;l.length&&l.peekLast().endTime<=u.startTime;)l.pop();if(u._blackboxRoot=!1,c&&this._isBlackboxedEvent(u)){const e=l.peekLast();if(e&&e._blackboxRoot)continue;u._blackboxRoot=!0}!m&&s&&(m=this._appendHeader(s,n,r),r&&(m._track=e));const p=this._currentLevel+l.length;h&&this._appendFlowEvent(u,p);const _=this._appendEvent(u,p);l.length&&(this._entryParent[_]=l.peekLast()),!o&&this._performanceModel.timelineModel().isMarkerEvent(u)&&(this._timelineData.entryTotalTimes[this._entryData.length]=void 0),d=Math.max(d,l.length+1),u.endTime&&l.push(u)}return this._entryTypeByLevel.length=this._currentLevel+d,this._entryTypeByLevel.fill(a,this._currentLevel),this._currentLevel+=d,m}_isBlackboxedEvent(e){if(e.name!==F.RecordType.JSFrame)return!1;const t=e.args.data.url;return t&&this._isBlackboxedURL(t)}_isBlackboxedURL(e){return ce.BlackboxManager.instance().isBlackboxedURL(e)}_appendAsyncEventsGroup(e,t,i,s,n,a){if(!i.length)return null;const r=[];let o=null;for(let n=0;n<i.length;++n){const l=i[n];if(!this._performanceModel.isVisible(l))continue;!o&&t&&(o=this._appendHeader(t,s,a),a&&(o._track=e));const h=l.startTime;let c;for(c=0;c<r.length&&r[c]>h;++c);this._appendAsyncEvent(l,this._currentLevel+c),r[c]=l.endTime}return this._entryTypeByLevel.length=this._currentLevel+r.length,this._entryTypeByLevel.fill(n,this._currentLevel),this._currentLevel+=r.length,o}_appendInteractionRecords(){const e=this._performanceModel.interactionRecords();if(e.length){this._appendHeader(ls`Interactions`,this._interactionsHeaderLevel1,!1);for(const t of e){const e=this._entryData.length;this._entryData.push(t.data),this._entryIndexToTitle[e]=t.data,this._timelineData.entryLevels[e]=this._currentLevel,this._timelineData.entryTotalTimes[e]=t.end-t.begin,this._timelineData.entryStartTimes[e]=t.begin}this._entryTypeByLevel[this._currentLevel++]=It.InteractionRecord}}_appendPageMetrics(){this._entryTypeByLevel[this._currentLevel]=It.Event;const e=[],i=[],s=this._performanceModel.timelineModel();for(const t of this._model.tracks())for(const n of t.events)s.isMarkerEvent(n)&&(s.isLCPCandidateEvent(n)||s.isLCPInvalidateEvent(n)?i.push(n):e.push(n));if(i.length>0){const t=new Map;for(const e of i){const i=e.args.data.navigationId,s=t.get(i);(!s||s.args.data.candidateIndex<e.args.data.candidateIndex)&&t.set(i,e)}const n=Array.from(t.values()).filter(e=>s.isLCPCandidateEvent(e));e.push(...n)}e.sort(t.Event.compareStartTime);const n=this._timelineData.entryTotalTimes;for(const t of e)this._appendEvent(t,this._currentLevel),n[n.length-1]=Number.NaN;++this._currentLevel}_copyPerfMarkEvents(e){this._entryTypeByLevel[this._currentLevel]=It.Event;const i=this._performanceModel.timelineModel(),s=["workerStart","redirectStart","redirectEnd","fetchStart","domainLookupStart","domainLookupEnd","connectStart","connectEnd","secureConnectionStart","requestStart","responseStart","responseEnd","navigationStart","unloadEventStart","unloadEventEnd","redirectStart","redirectEnd","fetchStart","domainLookupStart","domainLookupEnd","connectStart","connectEnd","secureConnectionStart","requestStart","responseStart","responseEnd","domLoading","domInteractive","domContentLoadedEventStart","domContentLoadedEventEnd","domComplete","loadEventStart","loadEventEnd"];for(const n of this._model.tracks())if(n.type===F.TrackType.MainThread)for(const a of n.events)if(i.isUserTimingEvent(a)){if(s.includes(a.name))continue;if(t.TracingModel.isAsyncPhase(a.phase))continue;a.setEndTime(a.startTime),e.events.push(a)}++this._currentLevel}_appendFrames(){const e=this._performanceModel.filmStripModel().frames(),t=!!e.length;this._framesHeader.collapsible=t,this._appendHeader(m.UIString("Frames"),this._framesHeader,!1),this._frameGroup=this._timelineData.groups.peekLast();const i=gi.markerStyleForFrame();this._entryTypeByLevel[this._currentLevel]=It.Frame;for(const e of this._performanceModel.frames())this._markers.push(new qt(e.startTime,e.startTime-this._model.minimumRecordTime(),i)),this._appendFrame(e);if(++this._currentLevel,!t)return;let s;this._appendHeader("",this._screenshotsHeader,!1),this._entryTypeByLevel[this._currentLevel]=It.Screenshot;for(const t of e)this._entryData.push(t),this._timelineData.entryLevels.push(this._currentLevel),this._timelineData.entryStartTimes.push(t.timestamp),s&&this._timelineData.entryTotalTimes.push(t.timestamp-s),s=t.timestamp;e.length&&this._timelineData.entryTotalTimes.push(this._model.maximumRecordTime()-s),++this._currentLevel}_entryType(e){return this._entryTypeByLevel[this._timelineData.entryLevels[e]]}prepareHighlightedEntryInfo(e){let t,i,s="";const n=this._entryType(e);if(n===It.Event){const n=this._entryData[e],a=n.duration,r=n.selfTime,o=1e-6;if("number"==typeof a&&(s=Math.abs(a-r)>o&&r>o?m.UIString("%s (self %s)",Number.millisToString(a,!0),Number.millisToString(r,!0)):Number.millisToString(a,!0)),t=this._performanceModel.timelineModel().isMarkerEvent(n)?gi.eventTitle(n):this.entryTitle(e),i=gi.eventWarning(n),this._model&&this._model.isLayoutShiftEvent(n)){s=ls`Occurrences: ${1}`}if(this._model&&this._model.isParseHTMLEvent(n)){const e=n.args.beginData.startLine,i=n.args.endData&&n.args.endData.endLine;t+=` - ${de.displayNameForURL(n.args.beginData.url)} [${-1!==i||i===e?`${e}...${i}`:e}]`}}else{if(n!==It.Frame)return null;{const n=this._entryData[e];s=m.UIString("%s ~ %.0f fps",Number.preciseMillisToString(n.duration,1),1e3/n.duration),t=n.idle?m.UIString("Idle Frame"):m.UIString("Frame"),n.hasWarnings()&&(i=createElement("span"),i.textContent=m.UIString("Long frame"))}}const a=createElement("div"),r=q.createShadowRootWithCoreStyles(a,{cssFile:"timeline/timelineFlamechartPopover.css",enableLegacyPatching:!0,delegatesFocus:void 0}).createChild("div","timeline-flamechart-popover");return r.createChild("span","timeline-info-time").textContent=s,r.createChild("span","timeline-info-title").textContent=t,i&&(i.classList.add("timeline-info-warning"),r.appendChild(i)),a}entryColor(e){function i(e,t,i){let s=e.get(t);if(s)return s;return s=f.Color.parse(i(t)).setAlpha(.7).asString(f.Format.RGBA)||"",e.set(t,s),s}const s=It,n=this._entryType(e);if(n===s.Event){const s=this._entryData[e];if(this._model.isGenericTrace())return this._genericTraceEventColor(s);if(this._performanceModel.timelineModel().isMarkerEvent(s))return gi.markerStyleForEvent(s).color;if(!t.TracingModel.isAsyncPhase(s.phase))return this._colorForEvent(s);if(s.hasCategory(F.TimelineModelImpl.Category.Console)||s.hasCategory(F.TimelineModelImpl.Category.UserTiming))return this._consoleColorGenerator.colorForID(s.name);if(s.hasCategory(F.TimelineModelImpl.Category.LatencyInfo)){const e=W.TimelineIRModel.phaseForEvent(s)||W.Phases.Uncategorized;return i(this._asyncColorByInteractionPhase,e,gi.interactionPhaseColor)}const n=gi.eventStyle(s).category;return i(this._asyncColorByCategory,n,()=>n.color)}if(n===s.Frame)return"white";if(n===s.InteractionRecord)return"transparent";if(n===s.ExtensionEvent){const t=this._entryData[e];return this._extensionColorGenerator.colorForID(t.name)}return""}_genericTraceEventColor(e){const t=e.categoriesString||e.name;return t?`hsl(${String.hashCode(t)%300+30}, 40%, 70%)`:"#ccc"}_drawFrame(e,t,i,s,n,a,r){const o=this._entryData[e];s+=1,a-=2,t.fillStyle=o.idle?"white":o.hasWarnings()?"#fad1d1":"#d7f0d1",t.fillRect(s,n,a,r);const l=Number.preciseMillisToString(o.duration,1),h=t.measureText(l).width;h<=a&&(t.fillStyle=this.textColor(e),t.fillText(l,s+(a-h)/2,n+r-4))}async _drawScreenshot(e,t,i,s,n,a){const r=this._entryData[e];if(!this._screenshotImageCache.has(r)){this._screenshotImageCache.set(r,null);const e=await r.imageDataPromise(),t=await U.loadImageFromData(e);return this._screenshotImageCache.set(r,t),void this.dispatchEventToListeners(Lt.DataChanged)}const o=this._screenshotImageCache.get(r);if(!o)return;const l=i+1,h=s+1,c=a-2,d=c/o.naturalHeight,m=Math.floor(o.naturalWidth*d);t.save(),t.beginPath(),t.rect(i,s,n,a),t.clip(),t.drawImage(o,l,h,m,c),t.strokeStyle="#ccc",t.strokeRect(l-.5,h-.5,Math.min(n-1,m+1),c),t.restore()}decorateEntry(e,t,i,s,n,a,r,o,l){const h=this._entryData[e],c=this._entryType(e),d=It;if(c===d.Frame)return this._drawFrame(e,t,i,s,n,a,r),!0;if(c===d.Screenshot)return this._drawScreenshot(e,t,s,n,a,r),!0;if(c===d.InteractionRecord){const e=gi.interactionPhaseColor(h);return t.fillStyle=e,t.fillRect(s,n,a-1,2),t.fillRect(s,n-3,2,3),t.fillRect(s+a-3,n-3,2,3),!1}if(c===d.Event){const e=h;if(e.hasCategory(F.TimelineModelImpl.Category.LatencyInfo)){const i=F.TimelineData.forEvent(e).timeWaitingForMainThread;if(i){t.fillStyle="hsla(0, 70%, 60%, 1)";const e=Math.floor(o-s+i*l);t.fillRect(s,n+r-3,e,2)}}F.TimelineData.forEvent(e).warning&&(m=s,u=a-1.5,t.save(),t.beginPath(),t.rect(m,n,u,r),t.clip(),t.beginPath(),t.fillStyle="red",t.moveTo(m+u-8,n),t.lineTo(m+u,n),t.lineTo(m+u,n+8),t.fill(),t.restore())}var m,u;return!1}forceDecoration(e){const t=It,i=this._entryType(e);if(i===t.Frame)return!0;if(i===t.Screenshot)return!0;if(i===t.Event){const t=this._entryData[e];return!!F.TimelineData.forEvent(t).warning}return!1}appendExtensionEvents(e){this._extensionInfo.push(e),this._timelineData&&this._innerAppendExtensionEvents(this._extensionInfo.length-1)}_innerAppendExtensionEvents(e){const t=this._extensionInfo[e],i=It.ExtensionEvent,s=[].concat(...t.model.sortedProcesses().map(e=>e.sortedThreads()));if(!s.length)return;const n=!(1!==s.length||s[0].events().length&&s[0].asyncEvents().length);n||this._appendHeader(t.title,this._headerLevel1,!1);const a=n?this._headerLevel2:this._headerLevel1;let r=0;for(const e of s){const s=n?t.title:e.name()||ls`Thread ${++r}`;this._appendAsyncEventsGroup(null,s,e.asyncEvents(),a,i,!1),this._appendSyncEvents(null,e.events(),s,a,i,!1)}}_appendHeader(e,t,i){const s={startLevel:this._currentLevel,name:e,style:t,selectable:i};return this._timelineData.groups.push(s),s}_appendEvent(e,t){const i=this._entryData.length;return this._entryData.push(e),this._timelineData.entryLevels[i]=t,this._timelineData.entryTotalTimes[i]=e.duration||Pt,this._timelineData.entryStartTimes[i]=e.startTime,e[Rt]=i,i}_appendAsyncEvent(e,i){if(t.TracingModel.isNestableAsyncPhase(e.phase))return void this._appendEvent(e,i);const s=e.steps,n=s.length>1&&s[1].phase===t.Phase.AsyncStepPast?1:0;for(let e=0;e<s.length-1;++e){const t=this._entryData.length;this._entryData.push(s[e+n]);const a=s[e].startTime;this._timelineData.entryLevels[t]=i,this._timelineData.entryTotalTimes[t]=s[e+1].startTime-a,this._timelineData.entryStartTimes[t]=a}}_appendFlowEvent(e,i){const s=this._timelineData;function n(e){const t=s.flowStartTimes.length;return s.flowStartTimes.push(e.startTime),s.flowStartLevels.push(i),t}function a(e,t){s.flowEndTimes[t]=e.startTime,s.flowEndLevels[t]=i}const r=e.id;if(r)switch(e.phase){case t.Phase.FlowBegin:this._flowEventIndexById.set(r,n(e));break;case t.Phase.FlowStep:a(e,this._flowEventIndexById.get(r)),this._flowEventIndexById.set(r,n(e));break;case t.Phase.FlowEnd:a(e,this._flowEventIndexById.get(r)),this._flowEventIndexById.delete(r)}}_appendFrame(e){const t=this._entryData.length;this._entryData.push(e),this._entryIndexToTitle[t]=Number.millisToString(e.duration,!0),this._timelineData.entryLevels[t]=this._currentLevel,this._timelineData.entryTotalTimes[t]=e.duration,this._timelineData.entryStartTimes[t]=e.startTime}createSelection(e){const t=this._entryType(e);let i=null;return t===It.Event?i=mi.fromTraceEvent(this._entryData[e]):t===It.Frame&&(i=mi.fromFrame(this._entryData[e])),i&&(this._lastSelection=new zt(i,e)),i}formatValue(e,t){return Number.preciseMillisToString(e,t)}canJumpToEntry(e){return!1}entryIndexForSelection(e){if(!e||e.type()===mi.Type.Range)return-1;if(this._lastSelection&&this._lastSelection.timelineSelection.object()===e.object())return this._lastSelection.entryIndex;const t=this._entryData.indexOf(e.object());return-1!==t&&(this._lastSelection=new zt(e,t)),t}buildFlowForInitiator(e){if(this._lastInitiatorEntry===e)return!1;this._lastInitiatorEntry=e;let t=this.eventByIndex(e);const i=this._timelineData;for(i.flowStartTimes=[],i.flowStartLevels=[],i.flowEndTimes=[],i.flowEndLevels=[];t;){let e;for(;t&&(e=F.TimelineData.forEvent(t).initiator(),!e);t=this._eventParent(t));if(!e)break;const s=t[Rt],n=e[Rt];i.flowStartTimes.push(e.endTime||e.startTime),i.flowStartLevels.push(i.entryLevels[n]),i.flowEndTimes.push(t.startTime),i.flowEndLevels.push(i.entryLevels[s]),t=e}return!0}_eventParent(e){return this._entryParent[e[Rt]]||null}eventByIndex(e){return e>=0&&this._entryType(e)===It.Event?this._entryData[e]:null}setEventColorMapping(e){this._colorForEvent=e}}const Pt=.001,Rt=Symbol("index"),Lt={DataChanged:Symbol("DataChanged")},It={Frame:Symbol("Frame"),Event:Symbol("Event"),InteractionRecord:Symbol("InteractionRecord"),ExtensionEvent:Symbol("ExtensionEvent"),Screenshot:Symbol("Screenshot")};var Ft=Object.freeze({__proto__:null,TimelineFlameChartDataProvider:Et,InstantEventVisibleDurationMs:Pt,indexSymbol:Rt,Events:Lt,EntryType:It});class Dt{constructor(){this._font="11px "+ve.fontFamily(),this.setModel(null),this._style={padding:4,height:17,collapsible:!0,color:Be.instance().patchColorText("#222",Be.ColorUsage.Foreground),font:this._font,backgroundColor:Be.instance().patchColorText("white",Be.ColorUsage.Background),nestingLevel:0,useFirstLineForOverview:!1,useDecoratorsForOverview:!0,shareHeaderLine:!1},this._group={startLevel:0,name:m.UIString("Network"),expanded:!1,style:this._style},this._minimumBoundary=0,this._maximumBoundary=0,this._timeSpan=0,this._requests=[],this._maxLevel=0}setModel(e){this._model=e&&e.timelineModel(),this._timelineData=null}isEmpty(){return this.timelineData(),!this._requests.length}maxStackDepth(){return this._maxLevel}timelineData(){return this._timelineData||(this._requests=[],this._timelineData=new S.TimelineData([],[],[],[]),this._model&&this._appendTimelineData()),this._timelineData}minimumBoundary(){return this._minimumBoundary}totalTime(){return this._timeSpan}setWindowTimes(e,t){this._startTime=e,this._endTime=t,this._updateTimelineData()}createSelection(e){if(-1===e)return null;const t=this._requests[e];return this._lastSelection=new zt(mi.fromNetworkRequest(t),e),this._lastSelection.timelineSelection}entryIndexForSelection(e){if(!e)return-1;if(this._lastSelection&&this._lastSelection.timelineSelection.object()===e.object())return this._lastSelection.entryIndex;if(e.type()!==mi.Type.NetworkRequest)return-1;const t=e.object(),i=this._requests.indexOf(t);return-1!==i&&(this._lastSelection=new zt(mi.fromNetworkRequest(t),i)),i}entryColor(e){const t=this._requests[e],i=gi.networkRequestCategory(t);return gi.networkCategoryColor(i)}textColor(e){return jt.textColor}entryTitle(e){const t=this._requests[e],i=new _.ParsedURL(t.url||"");return i.isValid?`${i.displayName} (${i.host})`:t.url||null}entryFont(e){return this._font}decorateEntry(e,t,i,s,n,a,r,o,l){const h=this._requests[e];if(!h.timing)return!1;const c=h.timing,d=h.beginTime(),m=e=>Math.floor(o+(e-d)*l),u=h.getStartTime(),p=h.endTime,{sendStartTime:_,headersEndTime:g}=h.getSendReceiveTiming(),f=Math.max(m(_),o),v=Math.max(m(g),f),T=Math.max(m(h.finishTime||p),v+2),w=m(u),S=Math.max(m(p),T);if(t.fillStyle="hsla(0, 100%, 100%, 0.8)",t.fillRect(f+.5,n+.5,v-f-.5,r-2),t.fillStyle=Be.instance().patchColorText("white",Be.ColorUsage.Background),t.fillRect(s,n-.5,f-s,r),t.fillRect(T,n-.5,s+a-T,r),!h.cached()&&c.pushStart){const i=m(1e3*c.pushStart),s=c.pushEnd?m(1e3*c.pushEnd):w,a=E.clamp(s-i-2,0,4),o=1;if(t.save(),t.beginPath(),t.moveTo(i+a,n+r/2),t.lineTo(i,n+o),t.lineTo(s-a,n+o),t.lineTo(s,n+r/2),t.lineTo(s-a,n+r-o),t.lineTo(i,n+r-o),t.closePath(),c.pushEnd)t.fillStyle=this.entryColor(e);else{const n=t.createLinearGradient(i,0,s,0);n.addColorStop(0,this.entryColor(e)),n.addColorStop(1,"white"),t.fillStyle=n}t.globalAlpha=.3,t.fill(),t.restore()}function y(e,i,s){t.moveTo(e,s-3),t.lineTo(e,s+3),t.moveTo(e,s),t.lineTo(i,s)}t.beginPath(),t.lineWidth=1,t.strokeStyle="#ccc";const b=Math.floor(n+r/2)+.5,C=S-.5;if(y(w+.5,f,b),y(C,T,b),t.stroke(),"string"==typeof h.priority){const e=this._colorForPriority(h.priority);e&&(t.fillStyle=e,t.fillRect(f+.5,n+.5,3.5,3.5))}const x=Math.max(f,0),k=T-x;if(k>=20&&(i=this.entryTitle(e)||"",h.fromServiceWorker&&(i="⚙ "+i),i)){const e=4,s=r-5,a=U.trimTextEnd(t,i,k-2*e);t.fillStyle="#333",t.fillText(a,x+e,n+s)}return!0}forceDecoration(e){return!0}prepareHighlightedEntryInfo(e){const t=this._requests[e];if(!t.url)return null;const i=document.createElement("div"),s=q.createShadowRootWithCoreStyles(i,{cssFile:"timeline/timelineFlamechartPopover.css",enableLegacyPatching:!0,delegatesFocus:void 0}).createChild("div","timeline-flamechart-popover"),n=t.getStartTime(),a=t.endTime-n;if(n&&isFinite(a)&&(s.createChild("span","timeline-info-network-time").textContent=Number.millisToString(a,!0)),"string"==typeof t.priority){const e=s.createChild("span");e.textContent=y.uiLabelForNetworkPriority(t.priority),e.style.color=this._colorForPriority(t.priority)||"black"}return s.createChild("span").textContent=t.url.trimMiddle(80),i}_colorForPriority(e){if(!this._priorityToValue){const e=Protocol.Network.ResourcePriority;this._priorityToValue=new Map([[e.VeryLow,1],[e.Low,2],[e.Medium,3],[e.High,4],[e.VeryHigh,5]])}const t=this._priorityToValue.get(e);return t?`hsla(214, 80%, 50%, ${t/5})`:null}_appendTimelineData(){this._model&&(this._minimumBoundary=this._model.minimumRecordTime(),this._maximumBoundary=this._model.maximumRecordTime(),this._timeSpan=this._model.isEmpty()?1e3:this._maximumBoundary-this._minimumBoundary,this._model.networkRequests().forEach(this._appendEntry.bind(this)),this._updateTimelineData())}_updateTimelineData(){if(!this._timelineData)return;const e=[];let t=0;for(let i=0;i<this._requests.length;++i){const s=this._requests[i],n=s.beginTime(),a=this._startTime;if(n<this._endTime&&s.endTime>a){for(;e.length&&e[e.length-1]<=n;)e.pop();this._timelineData.entryLevels[i]=e.length,e.push(s.endTime),t=Math.max(t,e.length)}else this._timelineData.entryLevels[i]=-1}for(let e=0;e<this._requests.length;++e)-1===this._timelineData.entryLevels[e]&&(this._timelineData.entryLevels[e]=t);this._timelineData=new S.TimelineData(this._timelineData.entryLevels,this._timelineData.entryTotalTimes,this._timelineData.entryStartTimes,[this._group]),this._maxLevel=t}_appendEntry(e){this._requests.push(e),this._timelineData.entryStartTimes.push(e.beginTime()),this._timelineData.entryTotalTimes.push(e.endTime-e.beginTime()),this._timelineData.entryLevels.push(this._requests.length-1)}preferredHeight(){return this._style.height*(this._group.expanded?E.clamp(this._maxLevel+1,4,8.5):1)}isExpanded(){return this._group&&!!this._group.expanded}formatValue(e,t){return Number.preciseMillisToString(e,t)}canJumpToEntry(e){return!1}navStartTimes(){return this._model?this._model.navStartTimes():new Map}}var Bt=Object.freeze({__proto__:null,TimelineFlameChartNetworkDataProvider:Dt});class Wt{constructor(e){this.timeline=e,this.context=e.getContext()}tX(e){return this.timeline.tX(e)}tD(e){return this.timeline.tD(e)}renderLaneLabel(e){const t=e.toLocaleUpperCase();this.context.save(),this.context.font="9px "+ve.fontFamily();const i=this.context.measureText(t),s=i.actualBoundingBoxAscent-i.actualBoundingBoxDescent;this.context.fillStyle="rgba(255, 255, 255, 0.8)",this.context.fillRect(0,1,i.width+12,s+6),this.context.fillStyle="#80868b",this.context.fillText(t,6,s+4),this.context.restore()}render(){}}class Nt extends Wt{constructor(e,t,i){super(e),this.markers=[],this.selectedMarker=null,this.hoverMarker=null,this.context=e.getContext(),this.label=t,this.getMarkerType=i,this.labelMetrics=this.measureLabel(this.label)}handlePointerMove(e){this.hoverMarker=null===e?null:this.markers.find(t=>{const i=this.tX(t.timestamp);return i-5<=e&&e<=i+t.widthIncludingLabel})||null}handleClick(e){this.selectedMarker=this.hoverMarker}setEvents(e){this.hoverMarker=null,this.selectedMarker=null,this.markers=e.map(e=>this.getMarker(e))}measureLabel(e){this.context.save(),this.context.font="11px "+ve.fontFamily();const t=this.context.measureText(e);return this.context.restore(),t}measureTimestamp(e){this.context.save(),this.context.font="11px "+ve.fontFamily();const t=this.context.measureText(e);return this.context.restore(),t}getMarker(e){const t=this.getMarkerType(e),i=this.timeline.getTimeSinceLastMainFrameNavigation(e.timestamp),s=Number.preciseMillisToString(i,1),n=this.measureTimestamp(s),a=15+this.labelMetrics.width+5,r=a+5+n.width;return{timestamp:e.timestamp,timestampLabel:s,type:t,timestampMetrics:n,widthIncludingLabel:a,widthIncludingTimestamp:r}}renderLabel(e,t,i){this.context.save(),this.context.font="11px "+ve.fontFamily();const s=i.actualBoundingBoxAscent-i.actualBoundingBoxDescent;this.context.fillStyle="#202124",this.context.fillText(t,this.tX(e)+.5*this.timeline.getLineHeight(),.5*this.timeline.getLineHeight()+.5*s),this.context.restore()}renderTimestamp(e,t,i,s){this.context.save(),this.context.font="11px "+ve.fontFamily();const n=s.actualBoundingBoxAscent-s.actualBoundingBoxDescent;this.context.fillStyle="rgba(0, 0, 0, 0.5)",this.context.fillText(i,this.tX(e)+.5*this.timeline.getLineHeight()+t+5,.5*this.timeline.getLineHeight()+.5*n),this.context.restore()}renderGoodMarkerSymbol(e){this.context.save(),this.context.beginPath(),this.context.strokeStyle="#0cce6b",this.context.moveTo(this.tX(e),2),this.context.lineTo(this.tX(e),5),this.context.moveTo(this.tX(e),19),this.context.lineTo(this.tX(e),22),this.context.stroke(),this.context.beginPath(),this.context.fillStyle="#0cce6b",this.context.arc(this.tX(e),.5*this.timeline.getLineHeight(),5,0,2*Math.PI),this.context.fill(),this.context.restore()}renderMediumMarkerSymbol(e){this.context.save(),this.context.beginPath(),this.context.strokeStyle="#ffa400",this.context.moveTo(this.tX(e),2),this.context.lineTo(this.tX(e),5),this.context.moveTo(this.tX(e),19),this.context.lineTo(this.tX(e),22),this.context.stroke(),this.context.beginPath(),this.context.fillStyle="#ffa400",this.context.rect(this.tX(e)-5,.5*this.timeline.getLineHeight()-5,10,10),this.context.fill(),this.context.restore()}renderBadMarkerSymbol(e){this.context.save(),this.context.beginPath(),this.context.strokeStyle="#ff4e42",this.context.moveTo(this.tX(e),2),this.context.lineTo(this.tX(e),5),this.context.moveTo(this.tX(e),19),this.context.lineTo(this.tX(e),22),this.context.stroke(),this.context.beginPath(),this.context.fillStyle="#ff4e42",this.context.translate(this.tX(e),.5*this.timeline.getLineHeight()),this.context.rotate(45*Math.PI/180),this.context.rect(-4,-4,8,8),this.context.rotate(-45*Math.PI/180),this.context.translate(-this.tX(e),-.5*this.timeline.getLineHeight()),this.context.fill(),this.context.restore()}renderMarker(e,t,i,s){const n=e.timestampLabel,a=this.labelMetrics,r=e.timestampMetrics,o=t,l=i||t,h=e.widthIncludingLabel,c=l?e.widthIncludingTimestamp:h,d=s?this.tD(s.timestamp-e.timestamp):null,m=l||null!==d&&d>h+5;if(l){this.context.save();const t=this.tX(e.timestamp)-5-5,i=1,s=c+10,n=this.timeline.getLineHeight()-2;this.context.fillStyle="rgba(255, 255, 255, 0.8)",this.context.fillRect(t,i,s,n),o&&(this.context.strokeStyle="#1b73e7",this.context.lineWidth=2,this.context.strokeRect(t,i,s,n),this.context.lineWidth=1),this.context.restore()}m&&(a&&this.renderLabel(e.timestamp,this.label,a),l&&this.renderTimestamp(e.timestamp,a?a.width:0,n,r)),"Good"===e.type?this.renderGoodMarkerSymbol(e.timestamp):"Medium"===e.type?this.renderMediumMarkerSymbol(e.timestamp):this.renderBadMarkerSymbol(e.timestamp)}render(){for(let e=0;e<this.markers.length;e++){const t=this.markers[e];t!==this.selectedMarker&&t!==this.hoverMarker&&this.renderMarker(t,!1,!1,e<this.markers.length-1?this.markers[e+1]:null)}this.hoverMarker&&this.hoverMarker!==this.selectedMarker&&this.renderMarker(this.hoverMarker,!1,!0,null),this.selectedMarker&&this.renderMarker(this.selectedMarker,!0,!1,null)}}class Ut extends Wt{constructor(e,t){super(e),this.boxes=[],this.hoverBox=-1,this.selectedBox=-1,this.label=t;const i=document.createElement("canvas"),s=i.getContext("2d");Vt(s,CanvasRenderingContext2D);i.width=17,i.height=17,s.translate(8.5,8.5),s.rotate(.25*Math.PI),s.translate(-8.5,-8.5),s.fillStyle="#000";for(let e=-17;e<34;e+=3)s.fillRect(e,-17,1,51);const n=this.context.createPattern(i,"repeat");Vt(n,CanvasPattern),this.longTaskPattern=n}handlePointerMove(e){this.hoverBox=null===e?-1:this.boxes.findIndex(t=>{const i=this.tX(t.start),s=this.tX(t.start+t.duration);return i<=e&&e<=s})}handleClick(e){this.selectedBox=this.hoverBox}setTimeboxes(e){this.selectedBox=-1,this.hoverBox=-1,this.boxes=e}renderTimebox(e,t){this.context.save(),this.context.beginPath(),this.context.fillStyle="#669df6",this.context.moveTo(this.tX(e.start)+2,2),this.context.lineTo(this.tX(e.start+e.duration)-2,2),this.context.quadraticCurveTo(this.tX(e.start+e.duration),2,this.tX(e.start+e.duration),4),this.context.lineTo(this.tX(e.start+e.duration),20),this.context.quadraticCurveTo(this.tX(e.start+e.duration),20,this.tX(e.start+e.duration)-2,22),this.context.lineTo(this.tX(e.start)+2,22),this.context.quadraticCurveTo(this.tX(e.start)+2,22,this.tX(e.start),20),this.context.lineTo(this.tX(e.start),4),this.context.quadraticCurveTo(this.tX(e.start),4,this.tX(e.start)+2,2),this.context.closePath(),this.context.fill(),this.context.beginPath(),this.context.fillStyle=this.longTaskPattern,this.context.moveTo(this.tX(e.start+50)+2,2),this.context.lineTo(this.tX(e.start+e.duration)-2,2),this.context.quadraticCurveTo(this.tX(e.start+e.duration),2,this.tX(e.start+e.duration),4),this.context.lineTo(this.tX(e.start+e.duration),20),this.context.quadraticCurveTo(this.tX(e.start+e.duration),20,this.tX(e.start+e.duration)-2,22),this.context.lineTo(this.tX(e.start+50),22),this.context.lineTo(this.tX(e.start+50),2),this.context.closePath(),this.context.fill(),t&&(this.context.beginPath(),this.context.strokeStyle="#ff4e42",this.context.rect(this.tX(e.start)-2,0,this.tD(e.duration)+4,24),this.context.lineWidth=2,this.context.stroke(),this.context.lineWidth=1),this.context.restore()}render(){for(let e=0;e<this.boxes.length;e++)e!==this.hoverBox&&e!==this.selectedBox&&this.renderTimebox(this.boxes[e],!1);-1!==this.hoverBox&&this.renderTimebox(this.boxes[this.hoverBox],!0),-1!==this.selectedBox&&this.renderTimebox(this.boxes[this.selectedBox],!0),this.renderLaneLabel(this.label)}}function Vt(e,t){if(!(e instanceof t))throw new TypeError(`Instance expected to be of type ${t.name} but got ${e.constructor.name}`)}class At extends HTMLElement{constructor(){super(),this.shadow=this.attachShadow({mode:"open"}),this.mainFrameNavigations=[],this.startTime=0,this.duration=1e3,this.maxDuration=1e3,this.width=0,this.height=0,this.hoverLane=null,this.animationFrame=null,this.canvas=document.createElement("canvas"),this.canvas.style.width="100%",this.canvas.style.height="120px",this.shadow.appendChild(this.canvas),this.canvas.addEventListener("pointermove",this.handlePointerMove.bind(this)),this.canvas.addEventListener("pointerout",this.handlePointerOut.bind(this)),this.canvas.addEventListener("click",this.handleClick.bind(this));const e=this.canvas.getContext("2d");Vt(e,CanvasRenderingContext2D),this.context=e,this.fcpLane=new Nt(this,"FCP",e=>this.getMarkerTypeForFCPEvent(e)),this.lcpLane=new Nt(this,"LCP",e=>this.getMarkerTypeForLCPEvent(e)),this.layoutShiftsLane=new Nt(this,"LS",e=>"Bad"),this.longTasksLane=new Ut(this,"Long Tasks")}set data(e){this.startTime=e.startTime||this.startTime,this.duration=e.duration||this.duration,this.maxDuration=e.maxDuration||this.maxDuration,this.mainFrameNavigations=e.mainFrameNavigations||this.mainFrameNavigations,e.fcps&&this.fcpLane.setEvents(e.fcps),e.lcps&&this.lcpLane.setEvents(e.lcps),e.layoutShifts&&this.layoutShiftsLane.setEvents(e.layoutShifts),e.longTasks&&this.longTasksLane.setTimeboxes(e.longTasks),this.scheduleRender()}getContext(){return this.context}getLineHeight(){return 24}handlePointerMove(e){const t=e.offsetX,i=e.offsetY,s=Math.floor(i/24);this.hoverLane=s,this.fcpLane.handlePointerMove(1===this.hoverLane?t:null),this.lcpLane.handlePointerMove(2===this.hoverLane?t:null),this.layoutShiftsLane.handlePointerMove(3===this.hoverLane?t:null),this.longTasksLane.handlePointerMove(4===this.hoverLane?t:null),this.scheduleRender()}handlePointerOut(e){this.fcpLane.handlePointerMove(null),this.lcpLane.handlePointerMove(null),this.layoutShiftsLane.handlePointerMove(null),this.longTasksLane.handlePointerMove(null),this.scheduleRender()}handleClick(e){const t=e.offsetX;this.focus(),this.fcpLane.handleClick(1===this.hoverLane?t:null),this.lcpLane.handleClick(2===this.hoverLane?t:null),this.layoutShiftsLane.handleClick(3===this.hoverLane?t:null),this.longTasksLane.handleClick(4===this.hoverLane?t:null),this.scheduleRender()}tX(e){return(e-this.startTime)/this.duration*this.width}tD(e){return e/this.duration*this.width}setSize(e,t){const i=window.devicePixelRatio;this.width=e,this.height=t,this.canvas.width=Math.floor(this.width*i),this.canvas.height=Math.floor(this.height*i),this.context.scale(i,i),this.style.width=this.width+"px",this.style.height=this.height+"px",this.render()}connectedCallback(){this.style.display="block",this.tabIndex=0;const e=this.canvas.getBoundingClientRect(),t=e.width,i=e.height;this.setSize(t,i),this.render()}getMarkerTypeForFCPEvent(e){const t=this.getTimeSinceLastMainFrameNavigation(e.timestamp);return t<=2e3?"Good":t<=4e3?"Medium":"Bad"}getMarkerTypeForLCPEvent(e){const t=this.getTimeSinceLastMainFrameNavigation(e.timestamp);return t<=2500?"Good":t<=4e3?"Medium":"Bad"}renderMainFrameNavigations(e){this.context.save(),this.context.strokeStyle="blue",this.context.beginPath();for(const t of e)this.context.moveTo(this.tX(t),0),this.context.lineTo(this.tX(t),this.height);this.context.stroke(),this.context.restore()}getTimeSinceLastMainFrameNavigation(e){let t=0,i=0;for(;t<this.mainFrameNavigations.length&&this.mainFrameNavigations[t]<=e;)i=this.mainFrameNavigations[t],t++;return e-i}render(){this.context.save(),this.context.clearRect(0,0,this.width,this.height),this.context.strokeStyle="#dadce0",this.context.beginPath();for(let e=0;e<5;e++)this.context.moveTo(0,24*e+.5),this.context.lineTo(this.width,24*e+.5);this.context.moveTo(0,119.5),this.context.lineTo(this.width,119.5),this.context.stroke(),this.context.restore(),this.context.save(),this.context.font="11px "+ve.fontFamily();const e=this.context.measureText("Web Vitals"),t=e.actualBoundingBoxAscent-e.actualBoundingBoxDescent;this.context.fillStyle="#202124",this.context.fillText("Web Vitals",6,4+t),this.context.restore(),this.context.save(),this.context.translate(0,24),this.fcpLane.render(),this.context.translate(0,24),this.lcpLane.render(),this.context.translate(0,24),this.layoutShiftsLane.render(),this.context.translate(0,24),this.longTasksLane.render(),this.context.restore(),this.renderMainFrameNavigations(this.mainFrameNavigations)}scheduleRender(){this.animationFrame||(this.animationFrame=window.requestAnimationFrame(()=>{this.animationFrame=null,this.render()}))}}customElements.define("devtools-timeline-webvitals",At);HTMLElement;class Ht extends V.VBox{constructor(e){super(!0,!0),this.delegate=e,this.element.style.height="120px",this.element.style.flex="0 auto",this.webVitalsTimeline=document.createElement("devtools-timeline-webvitals"),this.chartViewport=new b.ChartViewport(this),this.chartViewport.show(this.contentElement),this.chartViewport.alwaysShowVerticalScroll(),this.chartViewport.setContentHeight(114),this.chartViewport.viewportElement.appendChild(this.webVitalsTimeline)}windowChanged(e,t,i){this.delegate.windowChanged(e,t,i)}updateRangeSelection(e,t){this.delegate.updateRangeSelection(e,t)}setSize(e,t){this.webVitalsTimeline.setSize(e,t)}update(){this.webVitalsTimeline.render()}}class Gt extends A.SplitWidget{constructor(e,t,i,s,n,a){super(e,t,i,s,n,a),this._webVitals,this._model}setWebVitals(e){this._webVitals=e}setWindowTimes(e,t,i){this._webVitals&&(this._webVitals.chartViewport.setWindowTimes(e,t,i),this._webVitals.webVitalsTimeline.data={startTime:e-this._model.timelineModel().minimumRecordTime(),duration:t-e})}setModelAndUpdateBoundaries(e){if(this._model=e,!this._webVitals)return;const i=e.window().left,s=e.window().right,n=e.timelineModel(),a=n.tracks().reduce((e,t)=>e.concat(t.events),[]),r=e.timelineModel().minimumRecordTime(),o=e=>a.filter(e).map(e=>e.startTime-r),l=a.filter(e=>n.isLCPCandidateEvent(e)||n.isLCPInvalidateEvent(e)),h=new Map;for(const e of l){const t=e.args.data.navigationId,i=h.get(t);(!i||i.args.data.candidateIndex<e.args.data.candidateIndex)&&h.set(t,e)}const c=Array.from(h.values()).filter(e=>n.isLCPCandidateEvent(e)),d=a.filter(e=>t.TracingModel.isCompletePhase(e.phase)&&n.isLongRunningTask(e)).map(e=>({start:e.startTime-r,duration:e.duration}));this._webVitals.chartViewport.setBoundaries(i,s-i),this._webVitals.chartViewport.setWindowTimes(i,s),this._webVitals.webVitalsTimeline.data={startTime:i-this._model.timelineModel().minimumRecordTime(),duration:s-i,maxDuration:n.maximumRecordTime(),fcps:a.filter(e=>n.isFCPEvent(e)).map(e=>({timestamp:e.startTime-r,e:e})),lcps:c.map(e=>e.startTime).map(e=>({timestamp:e-r})),layoutShifts:o(e=>n.isLayoutShiftEvent(e)).map(e=>({timestamp:e})),longTasks:d,mainFrameNavigations:o(e=>n.isMainFrameNavigationStartEvent(e))}}}class Ot extends V.VBox{constructor(e){super(),this.element.classList.add("timeline-flamechart"),this._delegate=e,this._model=null,this._searchResults,this._eventListeners=[],this._showMemoryGraphSetting=p.Settings.instance().createSetting("timelineShowMemory",!1),this._showWebVitalsSetting=p.Settings.instance().createSetting("timelineWebVitals",!1),this._networkSplitWidget=new A.SplitWidget(!1,!1,"timelineFlamechartMainView",150);const t=p.Settings.instance().createSetting("timelineFlamechartMainViewGroupExpansion",{});this._mainDataProvider=new Et,this._mainDataProvider.addEventListener(Lt.DataChanged,()=>this._mainFlameChart.scheduleUpdate()),this._mainFlameChart=new S.FlameChart(this._mainDataProvider,this,t),this._mainFlameChart.alwaysShowVerticalScroll(),this._mainFlameChart.enableRuler(!1),this._networkFlameChartGroupExpansionSetting=p.Settings.instance().createSetting("timelineFlamechartNetworkViewGroupExpansion",{}),this._networkDataProvider=new Dt,this._networkFlameChart=new S.FlameChart(this._networkDataProvider,this,this._networkFlameChartGroupExpansionSetting),this._networkFlameChart.alwaysShowVerticalScroll(),this._networkFlameChart.disableRangeSelection(),this._networkPane=new V.VBox,this._networkPane.setMinimumSize(23,23),this._networkFlameChart.show(this._networkPane.element),this._splitResizer=this._networkPane.element.createChild("div","timeline-flamechart-resizer"),this._networkSplitWidget.hideDefaultResizer(!0),this._networkSplitWidget.installResizer(this._splitResizer),this._webVitals=new Ht(this),this._mainSplitWidget=new Gt(!1,!1,"timelineFlamechartMainAndVitalsView",void 0,120),this._mainSplitWidget.setWebVitals(this._webVitals),this._mainSplitWidget.setMainWidget(this._mainFlameChart),this._mainSplitWidget.setSidebarWidget(this._webVitals),this._showWebVitalsSetting.get()?this._mainSplitWidget.showBoth():this._mainSplitWidget.hideSidebar(),this._networkSplitWidget.setMainWidget(this._mainSplitWidget),this._networkSplitWidget.setSidebarWidget(this._networkPane),this._chartSplitWidget=new A.SplitWidget(!1,!0,"timelineCountersSplitViewState"),this._countersView=new Ri(this._delegate),this._chartSplitWidget.setMainWidget(this._networkSplitWidget),this._chartSplitWidget.setSidebarWidget(this._countersView),this._chartSplitWidget.hideDefaultResizer(),this._chartSplitWidget.installResizer(this._countersView.resizerElement()),this._updateCountersGraphToggle(),this._detailsSplitWidget=new A.SplitWidget(!1,!0,"timelinePanelDetailsSplitViewState"),this._detailsSplitWidget.element.classList.add("timeline-details-split"),this._detailsView=new xt(e),this._detailsSplitWidget.installResizer(this._detailsView.headerElement()),this._detailsSplitWidget.setMainWidget(this._chartSplitWidget),this._detailsSplitWidget.setSidebarWidget(this._detailsView),this._detailsSplitWidget.show(this.element),this._onMainEntrySelected=this._onEntrySelected.bind(this,this._mainDataProvider),this._onNetworkEntrySelected=this._onEntrySelected.bind(this,this._networkDataProvider),this._mainFlameChart.addEventListener(S.Events.EntrySelected,this._onMainEntrySelected,this),this._mainFlameChart.addEventListener(S.Events.EntryInvoked,this._onMainEntrySelected,this),this._networkFlameChart.addEventListener(S.Events.EntrySelected,this._onNetworkEntrySelected,this),this._networkFlameChart.addEventListener(S.Events.EntryInvoked,this._onNetworkEntrySelected,this),this._mainFlameChart.addEventListener(S.Events.EntryHighlighted,this._onEntryHighlighted,this),this._nextExtensionIndex=0,this._boundRefresh=this._refresh.bind(this),this._selectedTrack=null,this._mainDataProvider.setEventColorMapping(gi.eventColor),this._groupBySetting=p.Settings.instance().createSetting("timelineTreeGroupBy",mt.GroupBy.None),this._groupBySetting.addChangeListener(this._updateColorMapper,this),this._updateColorMapper()}toggleWebVitalsLane(){this._showWebVitalsSetting.get()?this._mainSplitWidget.showBoth():this._mainSplitWidget.hideSidebar()}_updateColorMapper(){this._urlToColorCache=new Map,this._model&&(this._mainDataProvider.setEventColorMapping(gi.eventColor),this._mainFlameChart.update())}_onWindowChanged(e){const t=e.data.window,i=!!e.data.animate;this._mainFlameChart.setWindowTimes(t.left,t.right,i),this._networkFlameChart.setWindowTimes(t.left,t.right,i),this._networkDataProvider.setWindowTimes(t.left,t.right),this._mainSplitWidget.setWindowTimes(t.left,t.right,i),this._updateSearchResults(!1,!1)}windowChanged(e,t,i){this._model.setWindow({left:e,right:t},i)}updateRangeSelection(e,t){this._delegate.select(mi.fromRange(e,t))}updateSelectedGroup(e,t){if(e!==this._mainFlameChart)return;const i=t?this._mainDataProvider.groupTrack(t):null;this._selectedTrack=i,this._updateTrack()}setModel(e){if(e!==this._model){if(v.EventTarget.removeEventListeners(this._eventListeners),this._model=e,this._selectedTrack=null,this._mainDataProvider.setModel(this._model),this._networkDataProvider.setModel(this._model),this._model){this._eventListeners=[this._model.addEventListener(Ei.WindowChanged,this._onWindowChanged,this),this._model.addEventListener(Ei.ExtensionDataAdded,this._appendExtensionData,this)];const t=e.window();this._mainFlameChart.setWindowTimes(t.left,t.right),this._networkFlameChart.setWindowTimes(t.left,t.right),this._networkDataProvider.setWindowTimes(t.left,t.right),this._mainSplitWidget.setModelAndUpdateBoundaries(e),this._updateSearchResults(!1,!1)}this._updateColorMapper(),this._updateTrack(),this._nextExtensionIndex=0,this._appendExtensionData(),this._refresh()}}_updateTrack(){this._countersView.setModel(this._model,this._selectedTrack),this._detailsView.setModel(this._model,this._selectedTrack)}_refresh(){this._networkDataProvider.isEmpty()?(this._mainFlameChart.enableRuler(!0),this._networkSplitWidget.hideSidebar()):(this._mainFlameChart.enableRuler(!1),this._networkSplitWidget.showBoth(),this.resizeToPreferredHeights()),this._mainFlameChart.reset(),this._networkFlameChart.reset(),this._updateSearchResults(!1,!1)}_appendExtensionData(){if(!this._model)return;const e=this._model.extensionInfo();for(;this._nextExtensionIndex<e.length;)this._mainDataProvider.appendExtensionEvents(e[this._nextExtensionIndex++]);this._mainFlameChart.scheduleUpdate()}_onEntryHighlighted(t){e.OverlayModel.hideDOMNodeHighlight();const i=t.data,s=this._mainDataProvider.eventByIndex(i);if(!s)return;const n=this._model&&this._model.timelineModel().targetByEvent(s);if(!n)return;const a=F.TimelineData.forEvent(s).backendNodeId;a&&new o.DeferredDOMNode(n,a).highlight()}highlightEvent(e){const t=e?this._mainDataProvider.entryIndexForSelection(mi.fromTraceEvent(e)):-1;t>=0?this._mainFlameChart.highlightEntry(t):this._mainFlameChart.hideHighlight()}willHide(){this._networkFlameChartGroupExpansionSetting.removeChangeListener(this.resizeToPreferredHeights,this),this._showMemoryGraphSetting.removeChangeListener(this._updateCountersGraphToggle,this),ce.BlackboxManager.instance().removeChangeListener(this._boundRefresh)}wasShown(){this._networkFlameChartGroupExpansionSetting.addChangeListener(this.resizeToPreferredHeights,this),this._showMemoryGraphSetting.addChangeListener(this._updateCountersGraphToggle,this),ce.BlackboxManager.instance().addChangeListener(this._boundRefresh),this._needsResizeToPreferredHeights&&this.resizeToPreferredHeights(),this._mainFlameChart.scheduleUpdate(),this._networkFlameChart.scheduleUpdate()}_updateCountersGraphToggle(){this._showMemoryGraphSetting.get()?this._chartSplitWidget.showBoth():this._chartSplitWidget.hideSidebar()}setSelection(e){let t=this._mainDataProvider.entryIndexForSelection(e);this._mainFlameChart.setSelectedEntry(t),t=this._networkDataProvider.entryIndexForSelection(e),this._networkFlameChart.setSelectedEntry(t),this._detailsView&&this._detailsView.setSelection(e)}_onEntrySelected(e,t){const i=t.data;Root.Runtime.experiments.isEnabled("timelineEventInitiators")&&e===this._mainDataProvider&&this._mainDataProvider.buildFlowForInitiator(i)&&this._mainFlameChart.scheduleUpdate(),this._delegate.select(e.createSelection(i))}resizeToPreferredHeights(){this.isShowing()?(this._needsResizeToPreferredHeights=!1,this._networkPane.element.classList.toggle("timeline-network-resizer-disabled",!this._networkDataProvider.isExpanded()),this._networkSplitWidget.setSidebarSize(this._networkDataProvider.preferredHeight()+this._splitResizer.clientHeight+S.HeaderHeight+2)):this._needsResizeToPreferredHeights=!0}setSearchableView(e){this._searchableView=e}jumpToNextSearchResult(){if(!this._searchResults||!this._searchResults.length)return;const e=void 0!==this._selectedSearchResult?this._searchResults.indexOf(this._selectedSearchResult):-1;this._selectSearchResult(E.mod(e+1,this._searchResults.length))}jumpToPreviousSearchResult(){if(!this._searchResults||!this._searchResults.length)return;const e=void 0!==this._selectedSearchResult?this._searchResults.indexOf(this._selectedSearchResult):0;this._selectSearchResult(E.mod(e-1,this._searchResults.length))}supportsCaseSensitiveSearch(){return!0}supportsRegexSearch(){return!0}_selectSearchResult(e){this._searchableView.updateCurrentMatchIndex(e),this._selectedSearchResult=this._searchResults[e],this._delegate.select(this._mainDataProvider.createSelection(this._selectedSearchResult))}_updateSearchResults(e,t){const i=this._selectedSearchResult;if(delete this._selectedSearchResult,this._searchResults=[],!this._searchRegex||!this._model)return;const s=new rt(this._searchRegex),n=this._model.window();if(this._searchResults=this._mainDataProvider.search(n.left,n.right,s),this._searchableView.updateSearchMatchesCount(this._searchResults.length),!e||!this._searchResults.length)return;let a=this._searchResults.indexOf(i);-1===a&&(a=t?this._searchResults.length-1:0),this._selectSearchResult(a)}searchCanceled(){void 0!==this._selectedSearchResult&&this._delegate.select(null),delete this._searchResults,delete this._selectedSearchResult,delete this._searchRegex}performSearch(e,t,i){this._searchRegex=e.toSearchRegex(),this._updateSearchResults(t,i)}}class zt{constructor(e,t){this.timelineSelection=e,this.entryIndex=t}}const jt={textColor:"#333"};class qt{constructor(e,t,i){this._startTime=e,this._startOffset=t,this._style=i}startTime(){return this._startTime}color(){return this._style.color}title(){if(this._style.lowPriority)return null;const e=Number.millisToString(this._startOffset);return ls`${this._style.title} at ${e}`}draw(e,t,i,s){this._style.lowPriority&&s<4||(e.save(),this._style.tall&&(e.strokeStyle=this._style.color,e.lineWidth=this._style.lineWidth,e.translate(this._style.lineWidth<1||1&this._style.lineWidth?.5:0,.5),e.beginPath(),e.moveTo(t,0),e.setLineDash(this._style.dashStyle),e.lineTo(t,e.canvas.height),e.stroke()),e.restore())}}var Xt=Object.freeze({__proto__:null,TimelineFlameChartView:Ot,Selection:zt,FlameChartStyle:jt,TimelineFlameChartMarker:qt,ColorBy:{URL:"URL"}});class $t{constructor(){this._recordings=[],this._action=X.ActionRegistry.instance().action("timeline.show-history"),this._nextNumberByDomain=new Map,this._button=new Zt(this._action),G.markAsMenuButton(this._button.element),this.clear(),this._allOverviews=[{constructor:Ye,height:3},{constructor:Ze,height:16},{constructor:Ke,height:20},{constructor:$e,height:8}],this._totalHeight=this._allOverviews.reduce((e,t)=>e+t.height,0),this._enabled=!0,this._lastActiveModel=null}addRecording(e){this._lastActiveModel=e,this._recordings.unshift(e),this._buildPreview(e);const t=this._title(e);this._button.setText(t);const i=this._action.title();if(G.setAccessibleName(this._button.element,ls`Current Session: ${t}. ${i}`),this._updateState(),this._recordings.length<=Jt)return;const s=this._recordings.reduce((e,t)=>n(e)<n(t)?e:t);function n(e){const t=$t._dataForModel(e);if(!t)throw new Error("Unable to find data for model");return t.lastUsed}this._recordings.splice(this._recordings.indexOf(s),1),s.dispose()}setEnabled(e){this._enabled=e,this._updateState()}button(){return this._button}clear(){this._recordings.forEach(e=>e.dispose()),this._recordings=[],this._lastActiveModel=null,this._updateState(),this._button.setText(m.UIString("(no recordings)")),this._nextNumberByDomain.clear()}async showHistoryDropDown(){if(this._recordings.length<2||!this._enabled)return null;const e=await Qt.show(this._recordings,this._lastActiveModel,this._button.element);if(!e)return null;return this._recordings.indexOf(e)<0?(console.assert(!1,"selected recording not found"),null):(this._setCurrentModel(e),e)}cancelIfShowing(){Qt.cancelIfShowing()}navigate(e){if(!this._enabled||!this._lastActiveModel)return null;const t=this._recordings.indexOf(this._lastActiveModel);if(t<0)return null;const i=E.clamp(t+e,0,this._recordings.length-1),s=this._recordings[i];return this._setCurrentModel(s),s}_setCurrentModel(e){const t=$t._dataForModel(e);if(!t)throw new Error("Unable to find data for model");t.lastUsed=Date.now(),this._lastActiveModel=e;const i=this._title(e),s=this._action.title();this._button.setText(i),G.setAccessibleName(this._button.element,ls`Current Session: ${i}. ${s}`)}_updateState(){this._action.setEnabled(this._recordings.length>1&&this._enabled)}static _previewElement(e){const t=$t._dataForModel(e);if(!t)throw new Error("Unable to find data for model");const i=e.recordStartTime();return t.time.textContent=i?m.UIString("(%s ago)",$t._coarseAge(i)):"",t.preview}static _coarseAge(e){const t=Math.round((Date.now()-e)/1e3);if(t<50)return m.UIString("moments");const i=Math.round(t/60);if(i<50)return m.UIString("%s m",i);const s=Math.round(i/60);return m.UIString("%s h",s)}_title(e){const t=$t._dataForModel(e);if(!t)throw new Error("Unable to find data for model");return t.title}_buildPreview(e){const t=_.ParsedURL.fromString(e.timelineModel().pageURL()),i=t?t.host:"",s=this._nextNumberByDomain.get(i)||1,n=m.UIString("%s #%d",i,s);this._nextNumberByDomain.set(i,s+1);const a=document.createElement("span"),r=document.createElement("div");r.classList.add("preview-item"),r.classList.add("vbox");const o={preview:r,title:n,time:a,lastUsed:Date.now()};Yt.set(e,o),r.appendChild(this._buildTextDetails(e,n,a));const l=r.createChild("div","hbox");return l.appendChild(this._buildScreenshotThumbnail(e)),l.appendChild(this._buildOverview(e)),o.preview}_buildTextDetails(e,t,i){const s=document.createElement("div");s.classList.add("text-details"),s.classList.add("hbox");const n=s.createChild("span","name");n.textContent=t,G.setAccessibleName(n,t);const a=e.tracingModel(),r=Number.millisToString(a.maximumRecordTime()-a.minimumRecordTime(),!1),o=s.createChild("span","time");return o.appendChild(document.createTextNode(r)),o.appendChild(i),s}_buildScreenshotThumbnail(e){const t=document.createElement("div");t.classList.add("screenshot-thumb");t.style.width=1.5*this._totalHeight+"px",t.style.height=this._totalHeight+"px";const i=e.filmStripModel().frames().peekLast();return i?(i.imageDataPromise().then(e=>U.loadImageFromData(e)).then(e=>e&&t.appendChild(e)),t):t}_buildOverview(e){const t=document.createElement("div");t.style.width=Kt+"px",t.style.height=this._totalHeight+"px";const i=t.createChild("canvas");i.width=window.devicePixelRatio*Kt,i.height=window.devicePixelRatio*this._totalHeight;const s=i.getContext("2d");let n=0;for(const t of this._allOverviews){const i=new t.constructor;i.setCanvasSize(Kt,t.height),i.setModel(e),i.update();const a=i.context(),r=a.getImageData(0,0,a.canvas.width,a.canvas.height);s&&s.putImageData(r,0,n),n+=t.height*window.devicePixelRatio}return t}static _dataForModel(e){return Yt.get(e)||null}}const Jt=5,Kt=450,Yt=new WeakMap;class Qt{constructor(e){this._glassPane=new $.GlassPane,this._glassPane.setSizeBehavior($.SizeBehavior.MeasureContent),this._glassPane.setOutsideClickCallback(()=>this._close(null)),this._glassPane.setPointerEventsBehavior($.PointerEventsBehavior.BlockedByGlassPane),this._glassPane.setAnchorBehavior($.AnchorBehavior.PreferBottom),this._glassPane.element.addEventListener("blur",()=>this._close(null));const t=q.createShadowRootWithCoreStyles(this._glassPane.contentElement,{cssFile:"timeline/timelineHistoryManager.css",enableLegacyPatching:!0,delegatesFocus:void 0}).createChild("div","drop-down"),i=new J.ListModel;this._listControl=new K.ListControl(i,this,K.ListMode.NonViewport),this._listControl.element.addEventListener("mousemove",this._onMouseMove.bind(this),!1),i.replaceAll(e),G.markAsMenu(this._listControl.element),G.setAccessibleName(this._listControl.element,ls`Select Timeline Session`),t.appendChild(this._listControl.element),t.addEventListener("keydown",this._onKeyDown.bind(this),!1),t.addEventListener("click",this._onClick.bind(this),!1),this._focusRestorer=new U.ElementFocusRestorer(this._listControl.element),this._selectionDone=null}static show(e,t,i){if(Qt._instance)return Promise.resolve(null);return new Qt(e)._show(i,t)}static cancelIfShowing(){Qt._instance&&Qt._instance._close(null)}_show(e,t){return Qt._instance=this,this._glassPane.setContentAnchorBox(e.boxInWindow()),this._glassPane.show(this._glassPane.contentElement.ownerDocument),this._listControl.element.focus(),this._listControl.selectItem(t),new Promise(e=>{this._selectionDone=e})}_onMouseMove(e){const t=e.target.enclosingNodeOrSelfWithClass("preview-item"),i=t&&this._listControl.itemForNode(t);i&&this._listControl.selectItem(i)}_onClick(e){e.target.enclosingNodeOrSelfWithClass("preview-item")&&this._close(this._listControl.selectedItem())}_onKeyDown(e){switch(e.key){case"Tab":case"Escape":this._close(null);break;case"Enter":this._close(this._listControl.selectedItem());break;default:return}e.consume(!0)}_close(e){this._selectionDone&&this._selectionDone(e),this._focusRestorer.restore(),this._glassPane.hide(),Qt._instance=null}createElementForItem(e){const t=$t._previewElement(e);return G.markAsMenuItem(t),t.classList.remove("selected"),t}heightForItem(e){return console.assert(!1,"Should not be called"),0}isItemSelectable(e){return!0}selectedItemChanged(e,t,i,s){i&&i.classList.remove("selected"),s&&s.classList.add("selected")}updateSelectedItemARIA(e,t){return!1}}Qt._instance=null;class Zt extends H.ToolbarItem{constructor(e){const t=document.createElement("button");t.classList.add("history-dropdown-button"),super(t),q.appendStyle(this.element,"timeline/historyToolbarButton.css",{enableLegacyPatching:!0}),this._contentElement=this.element.createChild("span","content");const i=Y.Icon.create("smallicon-triangle-down");this.element.appendChild(i),this.element.addEventListener("click",()=>{e.execute()},!1),this.setEnabled(e.enabled()),e.addEventListener(Q.Events.Enabled,e=>this.setEnabled(e.data)),this.setTitle(e.title())}setText(e){this._contentElement.textContent=e}}var ei=Object.freeze({__proto__:null,TimelineHistoryManager:$t,maxRecordings:Jt,previewWidth:Kt,DropDown:Qt,ToolbarButton:Zt,PreviewData:void 0});let ti=null,ii=null;class si{static isUiDevTools(){return"true"===be.Runtime.queryParam("uiDevTools")}static categorizeEvents(){if(ti)return ti;const e=ni,t=si.categories(),i=t.drawing,s=t.rasterizing,n=t.layout,a=t.painting,r=t.other,o={};return o[e.ViewPaint]=new fi(ls`View::Paint`,a),o[e.ViewOnPaint]=new fi(ls`View::OnPaint`,a),o[e.ViewPaintChildren]=new fi(ls`View::PaintChildren`,a),o[e.ViewOnPaintBackground]=new fi(ls`View::OnPaintBackground`,a),o[e.ViewOnPaintBorder]=new fi(ls`View::OnPaintBorder`,a),o[e.LayerPaintContentsToDisplayList]=new fi(ls`Layer::PaintContentsToDisplayList`,a),o[e.ViewLayout]=new fi(ls`View::Layout`,n),o[e.ViewLayoutBoundsChanged]=new fi(ls`View::Layout(bounds_changed)`,n),o[e.RasterTask]=new fi(ls`RasterTask`,s),o[e.RasterizerTaskImplRunOnWorkerThread]=new fi(ls`RasterizerTaskImpl::RunOnWorkerThread`,s),o[e.DirectRendererDrawFrame]=new fi(ls`DirectRenderer::DrawFrame`,i),o[e.BeginFrame]=new fi(ls`Frame Start`,i,!0),o[e.DrawFrame]=new fi(ls`Draw Frame`,i,!0),o[e.NeedsBeginFrameChanged]=new fi(ls`NeedsBeginFrameChanged`,i,!0),o[e.ThreadControllerImplRunTask]=new fi(ls`ThreadControllerImpl::RunTask`,r),ti=o,o}static categories(){return ii||(ii={layout:new bi("layout",ls`Layout`,!0,"hsl(214, 67%, 74%)","hsl(214, 67%, 66%)"),rasterizing:new bi("rasterizing",ls`Rasterizing`,!0,"hsl(43, 83%, 72%)","hsl(43, 83%, 64%) "),drawing:new bi("drawing",ls`Drawing`,!0,"hsl(256, 67%, 76%)","hsl(256, 67%, 70%)"),painting:new bi("painting",ls`Painting`,!0,"hsl(109, 33%, 64%)","hsl(109, 33%, 55%)"),other:new bi("other",ls`System`,!1,"hsl(0, 0%, 87%)","hsl(0, 0%, 79%)"),idle:new bi("idle",ls`Idle`,!1,"hsl(0, 0%, 98%)","hsl(0, 0%, 98%)")},ii)}static getMainCategoriesList(){return["idle","drawing","painting","rasterizing","layout","other"]}}const ni={ViewPaint:"View::Paint",ViewOnPaint:"View::OnPaint",ViewPaintChildren:"View::PaintChildren",ViewOnPaintBackground:"View::OnPaintBackground",ViewOnPaintBorder:"View::OnPaintBorder",ViewLayout:"View::Layout",ViewLayoutBoundsChanged:"View::Layout(bounds_changed)",LayerPaintContentsToDisplayList:"Layer::PaintContentsToDisplayList",DirectRendererDrawFrame:"DirectRenderer::DrawFrame",RasterTask:"RasterTask",RasterizerTaskImplRunOnWorkerThread:"RasterizerTaskImpl::RunOnWorkerThread",BeginFrame:"BeginFrame",DrawFrame:"DrawFrame",NeedsBeginFrameChanged:"NeedsBeginFrameChanged",ThreadControllerImplRunTask:"ThreadControllerImpl::RunTask"};var ai=Object.freeze({__proto__:null,UIDevtoolsUtils:si,RecordType:ni});class ri extends ze{constructor(e,t){super(e,t),gi.setEventStylesMap(si.categorizeEvents()),gi.setCategories(si.categories()),gi.setTimelineMainEventCategories(si.getMainCategoriesList())}}var oi=Object.freeze({__proto__:null,UIDevtoolsController:ri});let li;class hi extends Z.Panel{constructor(){super("timeline"),this.registerRequiredCSS("timeline/timelinePanel.css",{enableLegacyPatching:!0}),this.element.addEventListener("contextmenu",this._contextMenu.bind(this),!1),this._dropTarget=new ee.DropTarget(this.element,[ee.Type.File,ee.Type.URI],m.UIString("Drop timeline file or URL here"),this._handleDrop.bind(this)),this._recordingOptionUIControls=[],this._state=ci.Idle,this._recordingPageReload=!1,this._millisecondsToRecordAfterLoadEvent=5e3,this._toggleRecordAction=X.ActionRegistry.instance().action("timeline.toggle-recording"),this._recordReloadAction=X.ActionRegistry.instance().action("timeline.record-reload"),this._historyManager=new $t,this._performanceModel=null,this._viewModeSetting=p.Settings.instance().createSetting("timelineViewMode",di.FlameChart),this._disableCaptureJSProfileSetting=p.Settings.instance().createSetting("timelineDisableJSSampling",!1),this._disableCaptureJSProfileSetting.setTitle(m.UIString("Disable JavaScript samples")),this._captureLayersAndPicturesSetting=p.Settings.instance().createSetting("timelineCaptureLayersAndPictures",!1),this._captureLayersAndPicturesSetting.setTitle(m.UIString("Enable advanced paint instrumentation (slow)")),this._showScreenshotsSetting=p.Settings.instance().createSetting("timelineShowScreenshots",!0),this._showScreenshotsSetting.setTitle(m.UIString("Screenshots")),this._showScreenshotsSetting.addChangeListener(this._updateOverviewControls,this),this._startCoverage=p.Settings.instance().createSetting("timelineStartCoverage",!1),this._startCoverage.setTitle(ls`Coverage`),be.experiments.isEnabled("recordCoverageWithPerformanceTracing")||this._startCoverage.set(!1),this._showMemorySetting=p.Settings.instance().createSetting("timelineShowMemory",!1),this._showMemorySetting.setTitle(m.UIString("Memory")),this._showMemorySetting.addChangeListener(this._onModeChanged,this),this._showWebVitalsSetting=p.Settings.instance().createSetting("timelineWebVitals",!1),this._showWebVitalsSetting.setTitle(ls`Web Vitals`),this._showWebVitalsSetting.addChangeListener(this._onWebVitalsChanged,this);const e=this.element.createChild("div","timeline-toolbar-container");this._panelToolbar=new H.Toolbar("timeline-main-toolbar",e),this._panelRightToolbar=new H.Toolbar("",e),this._createSettingsPane(),this._updateShowSettingsToolbarButton(),this._timelinePane=new V.VBox,this._timelinePane.show(this.element);const t=this._timelinePane.element.createChild("div","hbox");t.id="timeline-overview-panel",this._overviewPane=new w.TimelineOverviewPane("timeline"),this._overviewPane.addEventListener(w.Events.WindowChanged,this._onOverviewWindowChanged.bind(this)),this._overviewPane.show(t),this._overviewControls=[],this._statusPaneContainer=this._timelinePane.element.createChild("div","status-pane-container fill"),this._createFileSelector(),s.TargetManager.instance().addModelListener(l.ResourceTreeModel,l.Events.Load,this._loadEventFired,this),this._flameChart=new Ot(this),this._searchableView=new te.SearchableView(this._flameChart),this._searchableView.setMinimumSize(0,100),this._searchableView.element.classList.add("searchable-view"),this._searchableView.show(this._timelinePane.element),this._flameChart.show(this._searchableView.element),this._flameChart.setSearchableView(this._searchableView),this._searchableView.hideWidget(),this._onModeChanged(),this._onWebVitalsChanged(),this._populateToolbar(),this._showLandingPage(),this._updateTimelineControls(),ge.ExtensionServer.instance().addEventListener(ge.Events.TraceProviderAdded,this._appendExtensionsToToolbar,this),s.TargetManager.instance().addEventListener(s.Events.SuspendStateChanged,this._onSuspendStateChanged,this),this._showSettingsPaneButton,this._showSettingsPaneSetting,this._settingsPane,this._controller,this._clearButton,this._loadButton,this._saveButton,this._statusPane,this._landingPage}static instance(e={forceNew:null}){const{forceNew:t}=e;return li&&!t||(li=new hi),li}searchableView(){return this._searchableView}wasShown(){ie.Context.instance().setFlavor(hi,this),Te.panelLoaded("timeline","DevTools.Launch.Timeline")}willHide(){ie.Context.instance().setFlavor(hi,null),this._historyManager.cancelIfShowing()}loadFromEvents(e){this._state===ci.Idle&&(this._prepareToLoadTimeline(),this._loader=Ue.loadFromEvents(e,this))}_onOverviewWindowChanged(e){if(!this._performanceModel)return;const t=e.data.startTime,i=e.data.endTime;this._performanceModel.setWindow({left:t,right:i},!0)}_onModelWindowChanged(e){const t=e.data.window;this._overviewPane.setWindowTimes(t.left,t.right)}_setState(e){this._state=e,this._updateTimelineControls()}_createSettingCheckbox(e,t){const i=new H.ToolbarSettingCheckbox(e,t);return this._recordingOptionUIControls.push(i),i}_populateToolbar(){this._panelToolbar.appendToolbarItem(H.Toolbar.createActionButton(this._toggleRecordAction)),this._panelToolbar.appendToolbarItem(H.Toolbar.createActionButton(this._recordReloadAction)),this._clearButton=new H.ToolbarButton(m.UIString("Clear"),"largeicon-clear"),this._clearButton.addEventListener(H.ToolbarButton.Events.Click,()=>this._onClearButton()),this._panelToolbar.appendToolbarItem(this._clearButton),this._loadButton=new H.ToolbarButton(m.UIString("Load profile…"),"largeicon-load"),this._loadButton.addEventListener(H.ToolbarButton.Events.Click,()=>this._selectFileToLoad()),this._saveButton=new H.ToolbarButton(m.UIString("Save profile…"),"largeicon-download"),this._saveButton.addEventListener(H.ToolbarButton.Events.Click,e=>{this._saveToFile()}),this._panelToolbar.appendSeparator(),this._panelToolbar.appendToolbarItem(this._loadButton),this._panelToolbar.appendToolbarItem(this._saveButton),this._panelToolbar.appendSeparator(),this._panelToolbar.appendToolbarItem(this._historyManager.button()),this._panelToolbar.appendSeparator(),this._panelToolbar.appendSeparator(),this._showScreenshotsToolbarCheckbox=this._createSettingCheckbox(this._showScreenshotsSetting,m.UIString("Capture screenshots")),this._panelToolbar.appendToolbarItem(this._showScreenshotsToolbarCheckbox),this._showMemoryToolbarCheckbox=this._createSettingCheckbox(this._showMemorySetting,m.UIString("Show memory timeline")),this._panelToolbar.appendToolbarItem(this._showMemoryToolbarCheckbox),this._showWebVitalsToolbarCheckbox=this._createSettingCheckbox(this._showWebVitalsSetting,ls`Show Web Vitals`),this._panelToolbar.appendToolbarItem(this._showWebVitalsToolbarCheckbox),be.experiments.isEnabled("recordCoverageWithPerformanceTracing")&&(this._startCoverageCheckbox=this._createSettingCheckbox(this._startCoverage,ls`Record coverage with performance trace`),this._panelToolbar.appendToolbarItem(this._startCoverageCheckbox)),this._panelToolbar.appendToolbarItem(H.Toolbar.createActionButtonForId("components.collect-garbage")),this._panelRightToolbar.appendSeparator(),this._panelRightToolbar.appendToolbarItem(this._showSettingsPaneButton)}_createSettingsPane(){this._showSettingsPaneSetting=p.Settings.instance().createSetting("timelineShowSettingsToolbar",!1),this._showSettingsPaneButton=new H.ToolbarSettingToggle(this._showSettingsPaneSetting,"largeicon-settings-gear",m.UIString("Capture settings")),h.MultitargetNetworkManager.instance().addEventListener(h.MultitargetNetworkManager.Events.ConditionsChanged,this._updateShowSettingsToolbarButton,this),Se.throttlingManager().addEventListener(Se.Events.RateChanged,this._updateShowSettingsToolbarButton,this),this._disableCaptureJSProfileSetting.addChangeListener(this._updateShowSettingsToolbarButton,this),this._captureLayersAndPicturesSetting.addChangeListener(this._updateShowSettingsToolbarButton,this),this._settingsPane=new V.HBox,this._settingsPane.element.classList.add("timeline-settings-pane"),this._settingsPane.show(this.element);const e=new H.Toolbar("",this._settingsPane.element);e.element.classList.add("flex-auto"),e.makeVertical(),e.appendToolbarItem(this._createSettingCheckbox(this._disableCaptureJSProfileSetting,m.UIString("Disables JavaScript sampling, reduces overhead when running against mobile devices"))),e.appendToolbarItem(this._createSettingCheckbox(this._captureLayersAndPicturesSetting,m.UIString("Captures advanced paint instrumentation, introduces significant performance overhead")));const t=new V.VBox;t.element.classList.add("flex-auto"),t.show(this._settingsPane.element);const i=new H.Toolbar("",t.element);i.appendText(m.UIString("Network:")),this._networkThrottlingSelect=this._createNetworkConditionsSelect(),i.appendToolbarItem(this._networkThrottlingSelect);const s=new H.Toolbar("",t.element);s.appendText(m.UIString("CPU:")),this._cpuThrottlingSelect=Se.throttlingManager().createCPUThrottlingSelector(),s.appendToolbarItem(this._cpuThrottlingSelect),this._showSettingsPaneSetting.addChangeListener(this._updateSettingsPaneVisibility.bind(this)),this._updateSettingsPaneVisibility()}_appendExtensionsToToolbar(e){const t=e.data,i=hi._settingForTraceProvider(t),s=this._createSettingCheckbox(i,t.longDisplayName());this._panelToolbar.appendToolbarItem(s)}static _settingForTraceProvider(e){let t=pi.get(e);if(!t){const i=e.persistentIdentifier();t=p.Settings.instance().createSetting(i,!1),t.setTitle(e.shortDisplayName()),pi.set(e,t)}return t}_createNetworkConditionsSelect(){const e=new H.ToolbarComboBox(null,ls`Network conditions`);return e.setMaxWidth(140),Se.throttlingManager().decorateSelectWithNetworkThrottling(e.selectElement()),e}_prepareToLoadTimeline(){console.assert(this._state===ci.Idle),this._setState(ci.Loading),this._performanceModel&&(this._performanceModel.dispose(),this._performanceModel=null)}_createFileSelector(){this._fileSelectorElement&&this._fileSelectorElement.remove(),this._fileSelectorElement=U.createFileSelectorElement(this._loadFromFile.bind(this)),this._timelinePane.element.appendChild(this._fileSelectorElement)}_contextMenu(e){const t=new se.ContextMenu(e);t.appendItemsAtLocation("timelineMenu"),t.show()}async _saveToFile(){if(this._state!==ci.Idle)return;const e=this._performanceModel;if(!e)return;const t=new Date,i="Profile-"+P.toISO8601Compact(t)+".json",s=new he.FileOutputStream;if(!await s.open(i))return;const n=await e.save(s);n&&u.Console.instance().error(m.UIString("Failed to save timeline: %s (%s, %s)",n.message,n.name,n.code))}async _showHistory(){const e=await this._historyManager.showHistoryDropDown();e&&e!==this._performanceModel&&this._setModel(e)}_navigateHistory(e){const t=this._historyManager.navigate(e);return t&&t!==this._performanceModel&&this._setModel(t),!0}_selectFileToLoad(){this._fileSelectorElement&&this._fileSelectorElement.click()}_loadFromFile(e){this._state===ci.Idle&&(this._prepareToLoadTimeline(),this._loader=Ue.loadFromFile(e,this),this._createFileSelector())}_loadFromURL(e){this._state===ci.Idle&&(this._prepareToLoadTimeline(),this._loader=Ue.loadFromURL(e,this))}_updateOverviewControls(){this._overviewControls=[],this._overviewControls.push(new Ye),be.experiments.isEnabled("inputEventsOnTimelineOverview")&&this._overviewControls.push(new Xe),this._overviewControls.push(new Ze),this._overviewControls.push(new Ke),this._overviewControls.push(new $e),this._showScreenshotsSetting.get()&&this._performanceModel&&this._performanceModel.filmStripModel().frames().length&&this._overviewControls.push(new Qe),this._showMemorySetting.get()&&this._overviewControls.push(new et),this._startCoverage.get()&&this._overviewControls.push(new it);for(const e of this._overviewControls)e.setModel(this._performanceModel);this._overviewPane.setOverviewControls(this._overviewControls)}_onModeChanged(){this._updateOverviewControls(),this.doResize(),this.select(null)}_onWebVitalsChanged(){this._flameChart.toggleWebVitalsLane()}_updateSettingsPaneVisibility(){this._showSettingsPaneSetting.get()?this._settingsPane.showWidget():this._settingsPane.hideWidget()}_updateShowSettingsToolbarButton(){const e=[];if(1!==Se.throttlingManager().cpuThrottlingRate()&&e.push(m.UIString("- CPU throttling is enabled")),h.MultitargetNetworkManager.instance().isThrottling()&&e.push(m.UIString("- Network throttling is enabled")),this._captureLayersAndPicturesSetting.get()&&e.push(m.UIString("- Significant overhead due to paint instrumentation")),this._disableCaptureJSProfileSetting.get()&&e.push(m.UIString("- JavaScript sampling is disabled")),this._showSettingsPaneButton.setDefaultWithRedColor(e.length>0),this._showSettingsPaneButton.setToggleWithRedColor(e.length>0),e.length){const t=document.createElement("div");e.forEach(e=>{t.createChild("div").textContent=e}),this._showSettingsPaneButton.setTitle(t.textContent||"")}else this._showSettingsPaneButton.setTitle(m.UIString("Capture settings"))}_setUIControlsEnabled(e){this._recordingOptionUIControls.forEach(t=>t.setEnabled(e))}async _getCoverageViewWidget(){const e=ne.ViewManager.instance().view("coverage");return await e.widget()}async _startRecording(){console.assert(!this._statusPane,"Status pane is already opened."),this._setState(ci.StartPending);const e={enableJSSampling:!this._disableCaptureJSProfileSetting.get(),capturePictures:this._captureLayersAndPicturesSetting.get(),captureFilmStrip:this._showScreenshotsSetting.get(),startCoverage:this._startCoverage.get()};e.startCoverage&&await ne.ViewManager.instance().showView("coverage").then(()=>this._getCoverageViewWidget()).then(e=>e.ensureRecordingStarted()),this._showRecordingStarted();const t=ge.ExtensionServer.instance().traceProviders().filter(e=>hi._settingForTraceProvider(e).get()),i=s.TargetManager.instance().mainTarget();si.isUiDevTools()?this._controller=new ri(i,this):this._controller=new ze(i,this),this._setUIControlsEnabled(!1),this._hideLandingPage();const n=await this._controller.startRecording(e,t);n[ye.ProtocolError]?this._recordingFailed(n[ye.ProtocolError]):this._recordingStarted()}async _stopRecording(){if(this._statusPane&&(this._statusPane.finish(),this._statusPane.updateStatus(m.UIString("Stopping timeline…")),this._statusPane.updateProgressBar(m.UIString("Received"),0)),this._setState(ci.StopPending),this._startCoverage.get()&&await ne.ViewManager.instance().showView("coverage").then(()=>this._getCoverageViewWidget()).then(e=>e.stopRecording()),this._controller){const e=await this._controller.stopRecording();this._performanceModel=e,this._setUIControlsEnabled(!0),this._controller.dispose(),this._controller=null}}_recordingFailed(e){this._statusPane&&this._statusPane.hide(),this._statusPane=new ui({description:e,buttonText:ls`Close`,buttonDisabled:!1,showProgress:void 0,showTimer:void 0},()=>this.loadingComplete(null)),this._statusPane.showPane(this._statusPaneContainer),this._statusPane.updateStatus(ls`Recording failed`),this._setState(ci.RecordingFailed),this._performanceModel=null,this._setUIControlsEnabled(!0),this._controller&&(this._controller.dispose(),this._controller=null)}_onSuspendStateChanged(){this._updateTimelineControls()}_updateTimelineControls(){const e=ci;this._toggleRecordAction.setToggled(this._state===e.Recording),this._toggleRecordAction.setEnabled(this._state===e.Recording||this._state===e.Idle),this._recordReloadAction.setEnabled(this._state===e.Idle),this._historyManager.setEnabled(this._state===e.Idle),this._clearButton.setEnabled(this._state===e.Idle),this._panelToolbar.setEnabled(this._state!==e.Loading),this._panelRightToolbar.setEnabled(this._state!==e.Loading),this._dropTarget.setEnabled(this._state===e.Idle),this._loadButton.setEnabled(this._state===e.Idle),this._saveButton.setEnabled(this._state===e.Idle&&!!this._performanceModel)}_toggleRecording(){this._state===ci.Idle?(this._recordingPageReload=!1,this._startRecording(),Te.actionTaken(we.Action.TimelineStarted)):this._state===ci.Recording&&this._stopRecording()}_recordReload(){this._state===ci.Idle&&(this._recordingPageReload=!0,this._startRecording(),Te.actionTaken(we.Action.TimelinePageReloadStarted))}_onClearButton(){this._historyManager.clear(),this._clear()}_clear(){this._showLandingPage(),this._reset()}_reset(){C.Performance.instance().reset(),this._setModel(null)}_applyFilters(e){e.timelineModel().isGenericTrace()||be.experiments.isEnabled("timelineShowAllEvents")||e.setFilters([gi.visibleEventsFilter()])}_setModel(e){if(this._performanceModel&&this._performanceModel.removeEventListener(Ei.WindowChanged,this._onModelWindowChanged,this),this._performanceModel=e,e?(this._searchableView.showWidget(),this._applyFilters(e)):this._searchableView.hideWidget(),this._flameChart.setModel(e),this._updateOverviewControls(),this._overviewPane.reset(),e&&this._performanceModel){this._performanceModel.addEventListener(Ei.WindowChanged,this._onModelWindowChanged,this),this._overviewPane.setNavStartTimes(e.timelineModel().navStartTimes()),this._overviewPane.setBounds(e.timelineModel().minimumRecordTime(),e.timelineModel().maximumRecordTime()),C.Performance.instance().reset();for(const t of e.timelineModel().cpuProfiles())C.Performance.instance().appendCPUProfile(t);this._setMarkers(e.timelineModel()),this._flameChart.setSelection(null),this._overviewPane.setWindowTimes(e.window().left,e.window().right)}for(const t of this._overviewControls)t.setModel(e);this._flameChart&&this._flameChart.resizeToPreferredHeights(),this._updateTimelineControls()}_recordingStarted(){if(this._recordingPageReload&&this._controller){const e=this._controller.mainTarget().model(l.ResourceTreeModel);e&&e.reloadPage()}this._reset(),this._setState(ci.Recording),this._showRecordingStarted(),this._statusPane&&(this._statusPane.enableAndFocusButton(),this._statusPane.updateStatus(m.UIString("Profiling…")),this._statusPane.updateProgressBar(m.UIString("Buffer usage"),0),this._statusPane.startTimer()),this._hideLandingPage()}recordingProgress(e){this._statusPane&&this._statusPane.updateProgressBar(m.UIString("Buffer usage"),100*e)}_showLandingPage(){if(this._landingPage)return void this._landingPage.show(this._statusPaneContainer);function e(e,t){const i=document.createElement(e);return i.textContent=t,i}const t=ae.XLink.create("https://developers.google.com/web/tools/chrome-devtools/evaluate-performance/",m.UIString("Learn more")),i=e("b",re.ShortcutRegistry.instance().shortcutsForAction("timeline.toggle-recording")[0].title()),s=e("b",re.ShortcutRegistry.instance().shortcutsForAction("timeline.record-reload")[0].title()),n=e("b",m.UIString("WASD"));this._landingPage=new V.VBox,this._landingPage.contentElement.classList.add("timeline-landing-page","fill");const a=this._landingPage.contentElement.createChild("div"),r=U.createInlineButton(H.Toolbar.createActionButton(this._toggleRecordAction)),o=U.createInlineButton(H.Toolbar.createActionButtonForId("timeline.record-reload"));a.createChild("p").appendChild(U.formatLocalized("Click the record button %s or hit %s to start a new recording.\nClick the reload button %s or hit %s to record the page load.",[r,i,o,s])),a.createChild("p").appendChild(U.formatLocalized("After recording, select an area of interest in the overview by dragging.\nThen, zoom and pan the timeline with the mousewheel or %s keys.\n%s",[n,t])),this._landingPage.show(this._statusPaneContainer)}_hideLandingPage(){this._landingPage.detach()}loadingStarted(){this._hideLandingPage(),this._statusPane&&this._statusPane.hide(),this._statusPane=new ui({showProgress:!0,showTimer:void 0,buttonDisabled:void 0,buttonText:void 0,description:void 0},()=>this._cancelLoading()),this._statusPane.showPane(this._statusPaneContainer),this._statusPane.updateStatus(m.UIString("Loading profile…")),this._loader||this._statusPane.finish(),this.loadingProgress(0)}loadingProgress(e){"number"==typeof e&&this._statusPane&&this._statusPane.updateProgressBar(m.UIString("Received"),100*e)}processingStarted(){this._statusPane&&this._statusPane.updateStatus(m.UIString("Processing profile…"))}loadingComplete(e){delete this._loader,this._setState(ci.Idle),this._statusPane&&this._statusPane.hide(),this._statusPane=null,e?(this._performanceModel||(this._performanceModel=new Mi),this._performanceModel.setTracingModel(e),this._setModel(this._performanceModel),this._historyManager.addRecording(this._performanceModel),this._startCoverage.get()&&ne.ViewManager.instance().showView("coverage").then(()=>this._getCoverageViewWidget()).then(e=>e.processBacklog()).then(()=>this._updateOverviewControls())):this._clear()}_showRecordingStarted(){this._statusPane||(this._statusPane=new ui({showTimer:!0,showProgress:!0,buttonDisabled:!0,description:void 0,buttonText:void 0},()=>this._stopRecording()),this._statusPane.showPane(this._statusPaneContainer),this._statusPane.updateStatus(m.UIString("Initializing profiler…")))}_cancelLoading(){this._loader&&this._loader.cancel()}_setMarkers(e){const t=new Map,i=F.RecordType,s=e.minimumRecordTime();for(const n of e.timeMarkerEvents())n.name!==i.TimeStamp&&n.name!==i.ConsoleTime&&t.set(n.startTime,gi.createEventDivider(n,s));for(const i of e.navStartTimes().values())t.set(i.startTime,gi.createEventDivider(i,s));this._overviewPane.setMarkers(t)}async _loadEventFired(e){if(this._state!==ci.Recording||!this._recordingPageReload||!this._controller||this._controller.mainTarget()!==e.data.resourceTreeModel.target())return;const t=this._controller;await new Promise(e=>setTimeout(e,this._millisecondsToRecordAfterLoadEvent)),t===this._controller&&this._state===ci.Recording&&this._stopRecording()}_frameForSelection(e){switch(e.type()){case mi.Type.Frame:return e.object();case mi.Type.Range:return null;case mi.Type.TraceEvent:return this._performanceModel?this._performanceModel.frameModel().frames(e._endTime,e._endTime)[0]:null;default:return console.assert(!1,"Should never be reached"),null}}_jumpToFrame(e){const t=this._selection&&this._frameForSelection(this._selection);if(!t||!this._performanceModel)return;const i=this._performanceModel.frames();let s=i.indexOf(t);console.assert(s>=0,"Can't find current frame in the frame list"),s=E.clamp(s+e,0,i.length-1);const n=i[s];return this._revealTimeRange(n.startTime,n.endTime),this.select(mi.fromFrame(n)),!0}select(e){this._selection=e,this._flameChart.setSelection(e)}selectEntryAtTime(e,i){if(e){for(let s=e.upperBound(i,(e,t)=>e-t.startTime)-1;s>=0;--s){const n=e[s],a=n.endTime||n.startTime;if(t.TracingModel.isTopLevelEvent(n)&&a<i)break;if(this._performanceModel&&this._performanceModel.isVisible(n)&&a>=i)return void this.select(mi.fromTraceEvent(n))}this.select(null)}}highlightEvent(e){this._flameChart.highlightEvent(e)}_revealTimeRange(e,t){if(!this._performanceModel)return;const i=this._performanceModel.window();let s=0;i.right<t?s=t-i.right:i.left>e&&(s=e-i.left),this._performanceModel.setWindow({left:i.left+s,right:i.right+s},!0)}_handleDrop(e){const t=e.items;if(!t.length)return;const i=t[0];if("string"===i.kind){const t=e.getData("text/uri-list");new _.ParsedURL(t).isValid&&this._loadFromURL(t)}else if("file"===i.kind){const e=t[0].webkitGetAsEntry();if(!e.isFile)return;e.file(this._loadFromFile.bind(this))}}}const ci={Idle:Symbol("Idle"),StartPending:Symbol("StartPending"),Recording:Symbol("Recording"),StopPending:Symbol("StopPending"),Loading:Symbol("Loading"),RecordingFailed:Symbol("RecordingFailed")},di={FlameChart:"FlameChart",BottomUp:"BottomUp",CallTree:"CallTree",EventLog:"EventLog"};class mi{constructor(e,t,i,s){this._type=e,this._startTime=t,this._endTime=i,this._object=s||null}static fromFrame(e){return new mi(mi.Type.Frame,e.startTime,e.endTime,e)}static fromNetworkRequest(e){return new mi(mi.Type.NetworkRequest,e.startTime,e.endTime||e.startTime,e)}static fromTraceEvent(e){return new mi(mi.Type.TraceEvent,e.startTime,e.endTime||e.startTime+1,e)}static fromRange(e,t){return new mi(mi.Type.Range,e,t)}type(){return this._type}object(){return this._object}startTime(){return this._startTime}endTime(){return this._endTime}}mi.Type={Frame:"Frame",NetworkRequest:"NetworkRequest",TraceEvent:"TraceEvent",Range:"Range"};class ui extends V.VBox{constructor(e,t){super(!0),this.registerRequiredCSS("timeline/timelineStatusDialog.css",{enableLegacyPatching:!0}),this.contentElement.classList.add("timeline-status-dialog");const i=this.contentElement.createChild("div","status-dialog-line status");if(i.createChild("div","label").textContent=m.UIString("Status"),this._status=i.createChild("div","content"),G.markAsStatus(this._status),e.showTimer){const e=this.contentElement.createChild("div","status-dialog-line time");e.createChild("div","label").textContent=m.UIString("Time"),this._time=e.createChild("div","content")}if(e.showProgress){const e=this.contentElement.createChild("div","status-dialog-line progress");this._progressLabel=e.createChild("div","label"),this._progressBar=e.createChild("div","indicator-container").createChild("div","indicator"),G.markAsProgressBar(this._progressBar)}if("string"==typeof e.description){const t=this.contentElement.createChild("div","status-dialog-line description");t.createChild("div","label").textContent=ls`Description`,this._description=t.createChild("div","content"),this._description.innerText=e.description}const s=e.buttonText||ls`Stop`;this._button=U.createTextButton(s,t,"",!0),this._button.disabled=!1==!e.buttonDisabled,this.contentElement.createChild("div","stop-button").appendChild(this._button),this._progressLabel,this._progressBar,this._startTime,this._time}finish(){this._stopTimer(),this._button.disabled=!0}hide(){this.element.parentNode.classList.remove("tinted"),this.element.remove()}showPane(e){this.show(e),e.classList.add("tinted")}enableAndFocusButton(){this._button.disabled=!1,this._button.focus()}updateStatus(e){this._status.textContent=e}updateProgressBar(e,t){this._progressLabel.textContent=e,this._progressBar.style.width=t.toFixed(1)+"%",G.setValueNow(this._progressBar,t),this._updateTimer()}startTimer(){this._startTime=Date.now(),this._timeUpdateTimer=setInterval(this._updateTimer.bind(this,!1),1e3),this._updateTimer()}_stopTimer(){this._timeUpdateTimer&&(clearInterval(this._timeUpdateTimer),this._updateTimer(!0),delete this._timeUpdateTimer)}_updateTimer(e){if(!this._timeUpdateTimer)return;const t=(Date.now()-this._startTime)/1e3;this._time.textContent=m.UIString("%s sec",t.toFixed(e?1:0))}}const pi=new WeakMap;var _i=Object.freeze({__proto__:null,TimelinePanel:hi,State:ci,ViewMode:di,rowHeight:18,headerHeight:20,TimelineSelection:mi,TimelineModeViewDelegate:class{select(e){}selectEntryAtTime(e,t){}highlightEvent(e){}},StatusPane:ui,LoadTimelineHandler:class{handleQueryParam(e){ne.ViewManager.instance().showView("timeline").then(()=>{hi.instance()._loadFromURL(window.decodeURIComponent(e))})}},ActionDelegate:class{handleAction(e,t){const i=ie.Context.instance().flavor(hi);switch(console.assert(i&&i instanceof hi),t){case"timeline.toggle-recording":return i._toggleRecording(),!0;case"timeline.record-reload":return i._recordReload(),!0;case"timeline.save-to-file":return i._saveToFile(),!0;case"timeline.load-from-file":return i._selectFileToLoad(),!0;case"timeline.jump-to-previous-frame":return i._jumpToFrame(-1),!0;case"timeline.jump-to-next-frame":return i._jumpToFrame(1),!0;case"timeline.show-history":return i._showHistory(),!0;case"timeline.previous-recording":return i._navigateHistory(1),!0;case"timeline.next-recording":return i._navigateHistory(-1),!0}return!1}}});class gi{static _initEventStyles(){if(gi._eventStylesMap)return gi._eventStylesMap;const e=F.RecordType,t=gi.categories(),i=t.rendering,s=t.scripting,n=t.loading,a=t.experience,r=t.painting,o=t.other,l=t.idle,h={};return h[e.Task]=new fi(ls`Task`,o),h[e.Program]=new fi(ls`Other`,o),h[e.Animation]=new fi(ls`Animation`,i),h[e.EventDispatch]=new fi(ls`Event`,s),h[e.RequestMainThreadFrame]=new fi(ls`Request Main Thread Frame`,i,!0),h[e.BeginFrame]=new fi(ls`Frame Start`,i,!0),h[e.BeginMainThreadFrame]=new fi(ls`Frame Start (main thread)`,i,!0),h[e.DrawFrame]=new fi(ls`Draw Frame`,i,!0),h[e.HitTest]=new fi(ls`Hit Test`,i),h[e.ScheduleStyleRecalculation]=new fi(ls`Schedule Style Recalculation`,i),h[e.RecalculateStyles]=new fi(ls`Recalculate Style`,i),h[e.UpdateLayoutTree]=new fi(ls`Recalculate Style`,i),h[e.InvalidateLayout]=new fi(ls`Invalidate Layout`,i,!0),h[e.Layout]=new fi(ls`Layout`,i),h[e.PaintSetup]=new fi(ls`Paint Setup`,r),h[e.PaintImage]=new fi(ls`Paint Image`,r,!0),h[e.UpdateLayer]=new fi(ls`Update Layer`,r,!0),h[e.UpdateLayerTree]=new fi(ls`Update Layer Tree`,i),h[e.Paint]=new fi(ls`Paint`,r),h[e.RasterTask]=new fi(ls`Rasterize Paint`,r),h[e.ScrollLayer]=new fi(ls`Scroll`,i),h[e.CompositeLayers]=new fi(ls`Composite Layers`,r),h[e.ParseHTML]=new fi(ls`Parse HTML`,n),h[e.ParseAuthorStyleSheet]=new fi(ls`Parse Stylesheet`,n),h[e.TimerInstall]=new fi(ls`Install Timer`,s),h[e.TimerRemove]=new fi(ls`Remove Timer`,s),h[e.TimerFire]=new fi(ls`Timer Fired`,s),h[e.XHRReadyStateChange]=new fi(ls`XHR Ready State Change`,s),h[e.XHRLoad]=new fi(ls`XHR Load`,s),h[e.CompileScript]=new fi(ls`Compile Script`,s),h[e.EvaluateScript]=new fi(ls`Evaluate Script`,s),h[e.CompileModule]=new fi(ls`Compile Module`,s),h[e.EvaluateModule]=new fi(ls`Evaluate Module`,s),h[e.StreamingCompileScript]=new fi(ls`Streaming Compile Task`,o),h[e.StreamingCompileScriptWaiting]=new fi(ls`Waiting for Network`,l),h[e.StreamingCompileScriptParsing]=new fi(ls`Parse and Compile`,s),h[e.WasmStreamFromResponseCallback]=new fi(ls`Streaming Wasm Response`,s),h[e.WasmCompiledModule]=new fi(ls`Compiled Wasm Module`,s),h[e.WasmCachedModule]=new fi(ls`Cached Wasm Module`,s),h[e.WasmModuleCacheHit]=new fi(ls`Wasm Module Cache Hit`,s),h[e.WasmModuleCacheInvalid]=new fi(ls`Wasm Module Cache Invalid`,s),h[e.FrameStartedLoading]=new fi(ls`Frame Started Loading`,n,!0),h[e.MarkLoad]=new fi(ls`Onload Event`,s,!0),h[e.MarkDOMContent]=new fi(ls`DOMContentLoaded Event`,s,!0),h[e.MarkFirstPaint]=new fi(ls`First Paint`,r,!0),h[e.MarkFCP]=new fi(ls`First Contentful Paint`,i,!0),h[e.MarkLCPCandidate]=new fi(ls`Largest Contentful Paint`,i,!0),h[e.TimeStamp]=new fi(ls`Timestamp`,s),h[e.ConsoleTime]=new fi(ls`Console Time`,s),h[e.UserTiming]=new fi(ls`User Timing`,s),h[e.ResourceWillSendRequest]=new fi(ls`Will Send Request`,n),h[e.ResourceSendRequest]=new fi(ls`Send Request`,n),h[e.ResourceReceiveResponse]=new fi(ls`Receive Response`,n),h[e.ResourceFinish]=new fi(ls`Finish Loading`,n),h[e.ResourceReceivedData]=new fi(ls`Receive Data`,n),h[e.RunMicrotasks]=new fi(ls`Run Microtasks`,s),h[e.FunctionCall]=new fi(ls`Function Call`,s),h[e.GCEvent]=new fi(ls`GC Event`,s),h[e.MajorGC]=new fi(ls`Major GC`,s),h[e.MinorGC]=new fi(ls`Minor GC`,s),h[e.JSFrame]=new fi(ls`JS Frame`,s),h[e.RequestAnimationFrame]=new fi(ls`Request Animation Frame`,s),h[e.CancelAnimationFrame]=new fi(ls`Cancel Animation Frame`,s),h[e.FireAnimationFrame]=new fi(ls`Animation Frame Fired`,s),h[e.RequestIdleCallback]=new fi(ls`Request Idle Callback`,s),h[e.CancelIdleCallback]=new fi(ls`Cancel Idle Callback`,s),h[e.FireIdleCallback]=new fi(ls`Fire Idle Callback`,s),h[e.WebSocketCreate]=new fi(ls`Create WebSocket`,s),h[e.WebSocketSendHandshakeRequest]=new fi(ls`Send WebSocket Handshake`,s),h[e.WebSocketReceiveHandshakeResponse]=new fi(ls`Receive WebSocket Handshake`,s),h[e.WebSocketDestroy]=new fi(ls`Destroy WebSocket`,s),h[e.EmbedderCallback]=new fi(ls`Embedder Callback`,s),h[e.DecodeImage]=new fi(ls`Image Decode`,r),h[e.ResizeImage]=new fi(ls`Image Resize`,r),h[e.GPUTask]=new fi(ls`GPU`,t.gpu),h[e.LatencyInfo]=new fi(ls`Input Latency`,s),h[e.GCCollectGarbage]=new fi(ls`DOM GC`,s),h[e.CryptoDoEncrypt]=new fi(ls`Encrypt`,s),h[e.CryptoDoEncryptReply]=new fi(ls`Encrypt Reply`,s),h[e.CryptoDoDecrypt]=new fi(ls`Decrypt`,s),h[e.CryptoDoDecryptReply]=new fi(ls`Decrypt Reply`,s),h[e.CryptoDoDigest]=new fi(ls`Digest`,s),h[e.CryptoDoDigestReply]=new fi(ls`Digest Reply`,s),h[e.CryptoDoSign]=new fi(ls`Sign`,s),h[e.CryptoDoSignReply]=new fi(ls`Sign Reply`,s),h[e.CryptoDoVerify]=new fi(ls`Verify`,s),h[e.CryptoDoVerifyReply]=new fi(ls`Verify Reply`,s),h[e.AsyncTask]=new fi(ls`Async Task`,t.async),h[e.LayoutShift]=new fi(ls`Layout Shift`,a),gi._eventStylesMap=h,h}static setEventStylesMap(e){gi._eventStylesMap=e}static inputEventDisplayName(e){if(!gi._inputEventToDisplayName){const e=W.InputEvents;gi._inputEventToDisplayName=new Map([[e.Char,ls`Key Character`],[e.KeyDown,ls`Key Down`],[e.KeyDownRaw,ls`Key Down`],[e.KeyUp,ls`Key Up`],[e.Click,ls`Click`],[e.ContextMenu,ls`Context Menu`],[e.MouseDown,ls`Mouse Down`],[e.MouseMove,ls`Mouse Move`],[e.MouseUp,ls`Mouse Up`],[e.MouseWheel,ls`Mouse Wheel`],[e.ScrollBegin,ls`Scroll Begin`],[e.ScrollEnd,ls`Scroll End`],[e.ScrollUpdate,ls`Scroll Update`],[e.FlingStart,ls`Fling Start`],[e.FlingCancel,ls`Fling Halt`],[e.Tap,ls`Tap`],[e.TapCancel,ls`Tap Halt`],[e.ShowPress,ls`Tap Begin`],[e.TapDown,ls`Tap Down`],[e.TouchCancel,ls`Touch Cancel`],[e.TouchEnd,ls`Touch End`],[e.TouchMove,ls`Touch Move`],[e.TouchStart,ls`Touch Start`],[e.PinchBegin,ls`Pinch Begin`],[e.PinchEnd,ls`Pinch End`],[e.PinchUpdate,ls`Pinch Update`]])}return gi._inputEventToDisplayName.get(e)||null}static frameDisplayName(e){if(!I.TimelineJSProfileProcessor.isNativeRuntimeFrame(e))return U.beautifyFunctionName(e.functionName);const t=I.TimelineJSProfileProcessor.nativeGroup(e.functionName),i=I.TimelineJSProfileProcessor.NativeGroups;switch(t){case i.Compile:return ls`Compile`;case i.Parse:return ls`Parse`}return e.functionName}static testContentMatching(e,t){const i=[gi.eventStyle(e).title],s=F.TimelineData.forEvent(e).url;return s&&i.push(s),function e(t,s){if(!s)return;for(const n in t){const a=t[n],r=typeof a;"string"===r?i.push(a):"number"===r?i.push(String(a)):"object"===r&&e(a,s-1)}}(e.args,2),t.test(i.join("|"))}static eventURL(e){const t=e.args.data||e.args.beginData,i=t&&t.url;if(i)return i;const s=t&&t.stackTrace,n=s&&s.length&&s[0]||F.TimelineData.forEvent(e).topFrame();return n&&n.url||null}static eventStyle(e){const t=gi._initEventStyles();if(e.hasCategory(F.TimelineModelImpl.Category.Console)||e.hasCategory(F.TimelineModelImpl.Category.UserTiming))return new fi(e.name,gi.categories().scripting);if(e.hasCategory(F.TimelineModelImpl.Category.LatencyInfo)){const t="InputLatency::",i=e.name.startsWith(t)?e.name.substr(t.length):e.name,s=gi.inputEventDisplayName(i);return new fi(s||i,gi.categories().scripting)}let i=t[e.name];return i||(i=new fi(e.name,gi.categories().other,!0),t[e.name]=i),i}static eventColor(e){if(e.name===F.RecordType.JSFrame){const t=e.args.data;if(gi.isUserFrame(t))return gi.colorForId(t.url)}const t=gi.eventStyle(e).category.color;return e.name===F.RecordType.StreamingCompileScriptWaiting?f.Color.parse(gi.categories().scripting.color).setAlpha(.3).asString(null):t}static eventColorByProduct(e,t,i){const s=gi.eventURL(i)||"";let n=t.get(s);if(n)return n;const a=_.ParsedURL.fromString(s);if(!a)return"#f2ecdc";const r=a.host;return e.rootFrames().some(e=>new _.ParsedURL(e.url).host===r)&&(n="#f2ecdc"),n||(n="#f2ecdc"),t.set(s,n),n}static eventTitle(e){const t=F.RecordType,i=e.args.data;if(e.name===t.JSFrame)return gi.frameDisplayName(i);const s=gi.eventStyle(e).title;return e.hasCategory(F.TimelineModelImpl.Category.Console)?s:e.name===t.TimeStamp?ls`${s}: ${i.message}`:e.name===t.Animation&&i&&i.name?ls`${s}: ${i.name}`:e.name===t.EventDispatch&&i&&i.type?ls`${s}: ${i.type}`:s}static _interactionPhaseStyles(){let e=gi._interactionPhaseStylesMap;return e||(e=new Map([[W.Phases.Idle,{color:"white",label:"Idle"}],[W.Phases.Response,{color:"hsl(43, 83%, 64%)",label:ls`Response`}],[W.Phases.Scroll,{color:"hsl(256, 67%, 70%)",label:ls`Scroll`}],[W.Phases.Fling,{color:"hsl(256, 67%, 70%)",label:ls`Fling`}],[W.Phases.Drag,{color:"hsl(256, 67%, 70%)",label:ls`Drag`}],[W.Phases.Animation,{color:"hsl(256, 67%, 70%)",label:ls`Animation`}],[W.Phases.Uncategorized,{color:"hsl(0, 0%, 87%)",label:ls`Uncategorized`}]]),gi._interactionPhaseStylesMap=e),e}static interactionPhaseColor(e){return gi._interactionPhaseStyles().get(e).color}static interactionPhaseLabel(e){return gi._interactionPhaseStyles().get(e).label}static isUserFrame(e){return"0"!==e.scriptId&&!(e.url&&e.url.startsWith("native "))}static networkRequestCategory(e){const t=vi;switch(e.mimeType){case"text/html":return t.HTML;case"application/javascript":case"application/x-javascript":case"text/javascript":return t.Script;case"text/css":return t.Style;case"audio/ogg":case"image/gif":case"image/jpeg":case"image/png":case"image/svg+xml":case"image/webp":case"image/x-icon":case"font/opentype":case"font/woff2":case"application/font-woff":return t.Media;default:return t.Other}}static networkCategoryColor(e){const t=vi;switch(e){case t.HTML:return"hsl(214, 67%, 66%)";case t.Script:return"hsl(43, 83%, 64%)";case t.Style:return"hsl(256, 67%, 70%)";case t.Media:return"hsl(109, 33%, 55%)";default:return"hsl(0, 0%, 70%)"}}static async buildDetailsTextForTraceEvent(e,t){const i=F.RecordType;let s;const n=e.args.data;switch(e.name){case i.GCEvent:case i.MajorGC:case i.MinorGC:{const t=e.args.usedHeapSizeBefore-e.args.usedHeapSizeAfter;s=m.UIString("%s collected",E.bytesToString(t));break}case i.FunctionCall:n&&(s=await a(n.scriptId,n.lineNumber,n.columnNumber));break;case i.JSFrame:s=gi.frameDisplayName(n);break;case i.EventDispatch:s=n?n.type:null;break;case i.Paint:{const e=gi.quadWidth(n.clip),t=gi.quadHeight(n.clip);e&&t&&(s=m.UIString("%d × %d",e,t));break}case i.ParseHTML:{const t=e.args.beginData.startLine,i=e.args.endData&&e.args.endData.endLine,n=de.displayNameForURL(e.args.beginData.url);s=i>=0?m.UIString("%s [%s…%s]",n,t+1,i+1):m.UIString("%s [%s…]",n,t+1);break}case i.CompileModule:s=de.displayNameForURL(e.args.fileName);break;case i.CompileScript:case i.EvaluateScript:{const e=n&&n.url;e&&(s=de.displayNameForURL(e)+":"+(n.lineNumber+1));break}case i.WasmCompiledModule:case i.WasmModuleCacheHit:{const t=e.args.url;t&&(s=de.displayNameForURL(t));break}case i.StreamingCompileScript:case i.XHRReadyStateChange:case i.XHRLoad:{const e=n.url;e&&(s=de.displayNameForURL(e));break}case i.TimeStamp:s=n.message;break;case i.WebSocketCreate:case i.WebSocketSendHandshakeRequest:case i.WebSocketReceiveHandshakeResponse:case i.WebSocketDestroy:case i.ResourceWillSendRequest:case i.ResourceSendRequest:case i.ResourceReceivedData:case i.ResourceReceiveResponse:case i.ResourceFinish:case i.PaintImage:case i.DecodeImage:case i.ResizeImage:case i.DecodeLazyPixelRef:{const t=F.TimelineData.forEvent(e).url;t&&(s=de.displayNameForURL(t));break}case i.EmbedderCallback:s=n.callbackName;break;case i.Animation:s=n&&n.name;break;case i.AsyncTask:s=n?n.name:null;break;default:s=e.hasCategory(F.TimelineModelImpl.Category.Console)?null:await async function(){const t=F.TimelineData.forEvent(e).topFrame();if(!t)return null;let i=await a(t.scriptId,t.lineNumber,t.columnNumber);i||(i=t.url,"number"==typeof t.lineNumber&&(i+=":"+(t.lineNumber+1)));return i}()}return s;async function a(e,i,s){const n=t?t.model(c.DebuggerModel):null;if(!t||t.isDisposed()||!e||!n)return null;const a=n.createRawLocationByScriptId(e,i,s);if(!a)return null;const r=await me.DebuggerWorkspaceBinding.instance().rawLocationToUILocation(a);return r?r.linkText():null}}static async buildDetailsNodeForTraceEvent(e,t,i){const s=F.RecordType;let n,a=null;const r=e.args.data;switch(e.name){case s.GCEvent:case s.MajorGC:case s.MinorGC:case s.EventDispatch:case s.Paint:case s.Animation:case s.EmbedderCallback:case s.ParseHTML:case s.WasmStreamFromResponseCallback:case s.WasmCompiledModule:case s.WasmModuleCacheHit:case s.WasmCachedModule:case s.WasmModuleCacheInvalid:case s.WebSocketCreate:case s.WebSocketSendHandshakeRequest:case s.WebSocketReceiveHandshakeResponse:case s.WebSocketDestroy:n=await gi.buildDetailsTextForTraceEvent(e,t);break;case s.PaintImage:case s.DecodeImage:case s.ResizeImage:case s.DecodeLazyPixelRef:case s.XHRReadyStateChange:case s.XHRLoad:case s.ResourceWillSendRequest:case s.ResourceSendRequest:case s.ResourceReceivedData:case s.ResourceReceiveResponse:case s.ResourceFinish:{const t=F.TimelineData.forEvent(e).url;t&&(a=ue.Linkifier.linkifyURL(t,{tabStop:!0}));break}case s.FunctionCall:case s.JSFrame:{a=createElement("span"),U.createTextChild(a,gi.frameDisplayName(r));const e=o(r.scriptId,r.url,r.lineNumber,r.columnNumber);e&&(U.createTextChild(a," @ "),a.appendChild(e));break}case s.CompileModule:a=o("",e.args.fileName,0,0);break;case s.CompileScript:case s.EvaluateScript:{const e=r.url;e&&(a=o("",e,r.lineNumber,0));break}case s.StreamingCompileScript:{const e=r.url;e&&(a=o("",e,0,0));break}default:e.hasCategory(F.TimelineModelImpl.Category.Console)?n=null:a=function(){const s=F.TimelineData.forEvent(e).topFrame();return s?i.maybeLinkifyConsoleCallFrame(t,s,{className:"timeline-details",tabStop:!0}):null}()}return!a&&n&&(a=createTextNode(n)),a;function o(e,s,n,a){const r={columnNumber:a,className:"timeline-details",tabStop:!0};return i.linkifyScriptLocation(t,e,s,n,r)}}static buildDetailsNodeForPerformanceEvent(e){let t="https://developers.google.com/web/fundamentals/performance/user-centric-performance-metrics#user-centric_performance_metrics",i="page performance metrics";const s=F.RecordType;switch(e.name){case s.MarkLCPCandidate:t="https://web.dev/largest-contentful-paint",i="largest contentful paint";break;case s.MarkFCP:t="https://web.dev/first-contentful-paint",i="first contentful paint"}return j.html`<div>${ae.XLink.create(t,ls`Learn more`)} about ${i}.</div>`}static buildCompilationCacheDetails(e,t){"producedCacheSize"in e?(t.appendTextRow(ls`Compilation cache status`,ls`script saved to cache`),t.appendTextRow(ls`Compilation cache size`,E.bytesToString(e.producedCacheSize))):"consumedCacheSize"in e?(t.appendTextRow(ls`Compilation cache status`,ls`script loaded from cache`),t.appendTextRow(ls`Compilation cache size`,E.bytesToString(e.consumedCacheSize))):e&&e.cacheRejected?t.appendTextRow(ls`Compilation cache status`,ls`failed to load script from cache`):t.appendTextRow(ls`Compilation cache status`,ls`script not eligible`)}static async buildTraceEventDetails(e,i,s,n){const a=i.targetByEvent(e);let r=null;if(a){const t=a;if(void 0===e[Si]){let i=null;const s=F.TimelineData.forEvent(e).url;s?i=await pe.ImagePreview.build(t,s,!1,{imageAltText:pe.ImagePreview.defaultAltTextForImageURL(s)}):F.TimelineData.forEvent(e).picture&&(i=await gi.buildPicturePreviewContent(e,t)),e[Si]=i}const i=new Set,s=F.TimelineData.forEvent(e);s.backendNodeId&&i.add(s.backendNodeId);const n=F.InvalidationTracker.invalidationEventsFor(e);if(n&&gi._collectInvalidationNodeIds(i,n),i.size){const e=t.model(o.DOMModel);e&&(r=await e.pushNodesByBackendIdsToFrontend(i))}}const l=F.RecordType;let h;e.name===l.LayoutShift&&(n=!1);const c=new Ci(i.targetByEvent(e),s),d=i.isMarkerEvent(e)?gi.markerStyleForEvent(e).color:gi.eventStyle(e).category.color;c.addSection(gi.eventTitle(e),d);const m=e.args.data,u=F.TimelineData.forEvent(e),p=u.initiator();let _=null;if(u.warning&&c.appendWarningRow(e),e.name===l.JSFrame&&m.deoptReason&&c.appendWarningRow(e,F.TimelineModelImpl.WarningType.V8Deopt),n&&!Number.isNaN(e.duration+0)&&(c.appendTextRow(ls`Total Time`,Number.millisToString(e.duration,!0)),c.appendTextRow(ls`Self Time`,Number.millisToString(e.selfTime,!0))),i.isGenericTrace()){for(const t in e.args)try{c.appendTextRow(t,JSON.stringify(e.args[t]))}catch(i){c.appendTextRow(t,`<${typeof e.args[t]}>`)}return c.fragment}switch(e.name){case l.GCEvent:case l.MajorGC:case l.MinorGC:{const t=e.args.usedHeapSizeBefore-e.args.usedHeapSizeAfter;c.appendTextRow(ls`Collected`,E.bytesToString(t));break}case l.JSFrame:case l.FunctionCall:{const t=await gi.buildDetailsNodeForTraceEvent(e,i.targetByEvent(e),s);t&&c.appendElementRow(ls`Function`,t);break}case l.TimerFire:case l.TimerInstall:case l.TimerRemove:c.appendTextRow(ls`Timer ID`,m.timerId),e.name===l.TimerInstall&&(c.appendTextRow(ls`Timeout`,Number.millisToString(m.timeout)),c.appendTextRow(ls`Repeats`,!m.singleShot));break;case l.FireAnimationFrame:c.appendTextRow(ls`Callback ID`,m.id);break;case l.ResourceWillSendRequest:case l.ResourceSendRequest:case l.ResourceReceiveResponse:case l.ResourceReceivedData:case l.ResourceFinish:if(_=u.url,_&&c.appendElementRow(ls`Resource`,ue.Linkifier.linkifyURL(_,{tabStop:!0})),m.requestMethod&&c.appendTextRow(ls`Request Method`,m.requestMethod),"number"==typeof m.statusCode&&c.appendTextRow(ls`Status Code`,m.statusCode),m.mimeType&&c.appendTextRow(ls`MIME Type`,m.mimeType),"priority"in m){const e=y.uiLabelForNetworkPriority(m.priority);c.appendTextRow(ls`Priority`,e)}m.encodedDataLength&&c.appendTextRow(ls`Encoded Data`,ls`${m.encodedDataLength} Bytes`),m.decodedBodyLength&&c.appendTextRow(ls`Decoded Body`,ls`${m.decodedBodyLength} Bytes`);break;case l.CompileModule:c.appendLocationRow(ls`Module`,e.args.fileName,0);break;case l.CompileScript:{_=m&&m.url,_&&c.appendLocationRow(ls`Script`,_,m.lineNumber,m.columnNumber);const e=m.streamed;c.appendTextRow(ls`Streamed`,e+(e?"":": "+m.notStreamedReason)),gi.buildCompilationCacheDetails(m,c);break}case l.EvaluateScript:_=m&&m.url,_&&c.appendLocationRow(ls`Script`,_,m.lineNumber,m.columnNumber);break;case l.WasmStreamFromResponseCallback:case l.WasmCompiledModule:case l.WasmCachedModule:case l.WasmModuleCacheHit:case l.WasmModuleCacheInvalid:if(m){_=e.args.url,_&&c.appendTextRow(ls`Url`,_);const t=e.args.producedCachedSize;t&&c.appendTextRow(ls`Produced Cache Size`,t);const i=e.args.consumedCachedSize;i&&c.appendTextRow(ls`Consumed Cache Size`,i)}break;case l.Paint:{const e=m.clip;c.appendTextRow(ls`Location`,ls`(${e[0]}, ${e[1]})`);const t=gi.quadWidth(e),i=gi.quadHeight(e);c.appendTextRow(ls`Dimensions`,ls`${t} × ${i}`)}case l.PaintSetup:case l.Rasterize:case l.ScrollLayer:h=ls`Layer Root`;break;case l.PaintImage:case l.DecodeLazyPixelRef:case l.DecodeImage:case l.ResizeImage:case l.DrawLazyPixelRef:h=ls`Owner Element`,_=u.url,_&&c.appendElementRow(ls`Image URL`,ue.Linkifier.linkifyURL(_,{tabStop:!0}));break;case l.ParseAuthorStyleSheet:_=m.styleSheetUrl,_&&c.appendElementRow(ls`Stylesheet URL`,ue.Linkifier.linkifyURL(_,{tabStop:!0}));break;case l.UpdateLayoutTree:case l.RecalculateStyles:c.appendTextRow(ls`Elements Affected`,e.args.elementCount);break;case l.Layout:{const t=e.args.beginData;c.appendTextRow(ls`Nodes That Need Layout`,ls`${t.dirtyObjects} of ${t.totalObjects}`),h=ls`Layout root`;break}case l.ConsoleTime:c.appendTextRow(ls`Message`,e.name);break;case l.WebSocketCreate:case l.WebSocketSendHandshakeRequest:case l.WebSocketReceiveHandshakeResponse:case l.WebSocketDestroy:{const e=p?p.args.data:m;void 0!==e.webSocketURL&&c.appendTextRow(ls`URL`,e.webSocketURL),void 0!==e.webSocketProtocol&&c.appendTextRow(ls`WebSocket Protocol`,e.webSocketProtocol),void 0!==m.message&&c.appendTextRow(ls`Message`,m.message);break}case l.EmbedderCallback:c.appendTextRow(ls`Callback Function`,m.callbackName);break;case l.Animation:e.phase===t.Phase.NestableAsyncInstant&&c.appendTextRow(ls`State`,m.state);break;case l.ParseHTML:{const t=e.args.beginData,i=t.startLine-1,s=e.args.endData?e.args.endData.endLine-1:void 0;_=t.url,_&&c.appendLocationRange(ls`Range`,_,i,s);break}case l.FireIdleCallback:c.appendTextRow(ls`Allotted Time`,Number.millisToString(m.allottedMilliseconds)),c.appendTextRow(ls`Invoked by Timeout`,m.timedOut);case l.RequestIdleCallback:case l.CancelIdleCallback:c.appendTextRow(ls`Callback ID`,m.id);break;case l.EventDispatch:c.appendTextRow(ls`Type`,m.type);break;case l.MarkLCPCandidate:c.appendTextRow(ls`Type`,String(m.type)),c.appendTextRow(ls`Size`,String(m.size));case l.MarkFirstPaint:case l.MarkFCP:case l.MarkLoad:case l.MarkDOMContent:{let t=e.startTime-i.minimumRecordTime();const{navigationId:s}=e.args.data;if(s){const n=i.navStartTimes().get(s);n&&(t=e.startTime-n.startTime)}c.appendTextRow(ls`Timestamp`,Number.preciseMillisToString(t,1)),c.appendElementRow(ls`Details`,gi.buildDetailsNodeForPerformanceEvent(e));break}case l.LayoutShift:{const e=createElement("span"),t=U.createWebDevLink("cls/",ls`Cumulative Layout Shifts`);e.appendChild(U.formatLocalized("%s can result in poor user experiences.",[t])),c.appendElementRow(ls`Warning`,e,!0),c.appendTextRow(ls`Score`,m.score.toPrecision(4)),c.appendTextRow(ls`Cumulative Score`,m.cumulative_score.toPrecision(4)),c.appendTextRow(ls`Had recent input`,m.had_recent_input?ls`Yes`:ls`No`);for(const e of m.impacted_nodes){const t=new We(e.old_rect),i=new We(e.new_rect),s=await T.Linkifier.linkify(t),n=await T.Linkifier.linkify(i);c.appendElementRow(ls`Moved from`,s),c.appendElementRow(ls`Moved to`,n)}break}default:{const t=await gi.buildDetailsNodeForTraceEvent(e,i.targetByEvent(e),s);t&&c.appendElementRow(ls`Details`,t);break}}u.timeWaitingForMainThread&&c.appendTextRow(ls`Time Waiting for Main Thread`,Number.millisToString(u.timeWaitingForMainThread,!0));const g=r&&r.get(u.backendNodeId);if(g){const e=await T.Linkifier.linkify(g);c.appendElementRow(h||ls`Related Node`,e)}e[Si]&&(c.addSection(ls`Preview`),c.appendElementRow("",e[Si])),(p||u.stackTraceForSelfOrInitiator()||F.InvalidationTracker.invalidationEventsFor(e))&&gi._generateCauses(e,i.targetByEvent(e),r,c);const f={};if(n&&gi._aggregatedStatsForTraceEvent(f,i,e)){c.addSection(ls`Aggregated Time`);const t=gi.generatePieChart(f,gi.eventStyle(e).category,e.selfTime);c.appendElementRow("",t)}return c.fragment}static statsForTimeRange(e,i,s){if(!e.length)return{idle:s-i};!function(e){if(e[xi])return;const i={},s=[];let n=0;function a(e,t){let s=i[e];if(s||(s={time:[],value:[]},i[e]=s),s.time.length&&s.time.peekLast()===t||n>t)return;const a=s.value.length?s.value.peekLast():0;s.value.push(a+t-n),s.time.push(t)}function r(e,t,i){e&&a(e,i),n=i,t&&a(t,i)}F.TimelineModelImpl.forEachEvent(e,(function(e){const t=gi.eventStyle(e).category.name,i=s.length?s.peekLast():null;t!==i&&r(i,t,e.startTime),s.push(t)}),(function(e){const t=s.pop(),i=s.length?s.peekLast():null;t!==i&&r(t,i,e.endTime)}),void 0,void 0,void 0,function(){const e=gi.visibleEventsFilter();return i=>e.accept(i)||t.TracingModel.isTopLevelEvent(i)}());e[xi]=i}(e);const n=function(e,t){const i=Object.assign({},e);for(const e in t)i[e]-=t[e];return i}(r(s),r(i)),a=Object.values(n).reduce((e,t)=>e+t,0);return n.idle=Math.max(0,s-i-a),n;function r(t){const i={},s=e[xi];for(const e in s){const n=s[e],a=n.time.upperBound(t);let r;if(0===a)r=0;else if(a===n.time.length)r=n.value.peekLast();else{const e=n.time[a-1],i=n.time[a],s=n.value[a-1];r=s+(n.value[a]-s)*(t-e)/(i-e)}i[e]=r}return i}}static async buildNetworkRequestDetails(e,t,i){const s=t.targetByEvent(e.children[0]),n=new Ci(s,i),a=gi.networkRequestCategory(e),r=gi.networkCategoryColor(a);n.addSection(ls`Network request`,r),e.url&&n.appendElementRow(ls`URL`,ue.Linkifier.linkifyURL(e.url,{tabStop:!0}));const o=e.endTime-(e.getStartTime()||-1/0);if(isFinite(o)){let t=Number.millisToString(o,!0);const i=e.finishTime-e.getStartTime(),s=e.endTime-e.finishTime;if(isFinite(i)&&isFinite(s)){const n=Number.millisToString(i,!0),a=Number.millisToString(s,!0),r=e.cached()?ls`load from cache`:ls`network transfer`;t+=ls` (${n} ${r} + ${a} resource loading)`}n.appendTextRow(ls`Duration`,t)}if(e.requestMethod&&n.appendTextRow(ls`Request Method`,e.requestMethod),"string"==typeof e.priority){const t=y.uiLabelForNetworkPriority(e.priority);n.appendTextRow(ls`Priority`,t)}e.mimeType&&n.appendTextRow(ls`Mime Type`,e.mimeType);let l="";e.memoryCached()?l+=ls` (from memory cache)`:e.cached()?l+=ls` (from cache)`:e.timing&&e.timing.pushStart&&(l+=ls` (from push)`),e.fromServiceWorker&&(l+=ls` (from service worker)`),!e.encodedDataLength&&l||(l=`${E.bytesToString(e.encodedDataLength)}${l}`),n.appendTextRow(ls`Encoded Data`,l),e.decodedBodyLength&&n.appendTextRow(ls`Decoded Body`,E.bytesToString(e.decodedBodyLength));const h=ls`Initiator`,c=e.children[0],d=F.TimelineData.forEvent(c).topFrame();if(d){const e=i.maybeLinkifyConsoleCallFrame(s,d,{tabStop:!0});e&&n.appendElementRow(h,e)}else{const e=F.TimelineData.forEvent(c).initiator();if(e){const t=F.TimelineData.forEvent(e).url;if(t){const e=i.maybeLinkifyScriptLocation(s,null,t,0,{tabStop:!0});e&&n.appendElementRow(h,e)}}}return!e.previewElement&&e.url&&s&&(e.previewElement=await pe.ImagePreview.build(s,e.url,!1,{imageAltText:pe.ImagePreview.defaultAltTextForImageURL(e.url)})),e.previewElement&&n.appendElementRow(ls`Preview`,e.previewElement),n.fragment}static _stackTraceFromCallFrames(e){return{callFrames:e}}static _generateCauses(e,t,i,s){const n=F.RecordType;let a,r;switch(e.name){case n.TimerFire:a=ls`Timer Installed`;break;case n.FireAnimationFrame:a=ls`Animation Frame Requested`;break;case n.FireIdleCallback:a=ls`Idle Callback Requested`;break;case n.UpdateLayoutTree:case n.RecalculateStyles:r=ls`Recalculation Forced`;break;case n.Layout:a=ls`First Layout Invalidation`,r=ls`Layout Forced`}const o=F.TimelineData.forEvent(e);o.stackTrace&&o.stackTrace.length&&(s.addSection(ls`Call Stacks`),s.appendStackTrace(r||ls`Stack Trace`,gi._stackTraceFromCallFrames(o.stackTrace)));const l=F.TimelineData.forEvent(e).initiator();if(F.InvalidationTracker.invalidationEventsFor(e)&&t)s.addSection(ls`Invalidations`),gi._generateInvalidations(e,t,i,s);else if(l){const t=e.startTime-l.startTime;s.appendTextRow(ls`Pending for`,Number.preciseMillisToString(t,1));const i=document.createElement("span");i.classList.add("devtools-link"),G.markAsLink(i),i.tabIndex=0,i.textContent=ls`Reveal`,i.addEventListener("click",()=>{hi.instance().select(mi.fromTraceEvent(l))}),i.addEventListener("keydown",e=>{isEnterKey(e)&&(hi.instance().select(mi.fromTraceEvent(l)),e.consume(!0))}),s.appendElementRow(ls`Initiator`,i);const n=F.TimelineData.forEvent(l).stackTrace;n&&s.appendStackTrace(a||ls`First Invalidated`,gi._stackTraceFromCallFrames(n))}}static _generateInvalidations(e,t,i,s){const n=F.InvalidationTracker.invalidationEventsFor(e),a={};n.forEach((function(e){a[e.type]?a[e.type].push(e):a[e.type]=[e]})),Object.keys(a).forEach((function(e){gi._generateInvalidationsForType(e,t,a[e],i,s)}))}static _generateInvalidationsForType(e,t,i,s,n){let a;switch(e){case F.RecordType.StyleRecalcInvalidationTracking:a=ls`Style Invalidations`;break;case F.RecordType.LayoutInvalidationTracking:a=ls`Layout Invalidations`;break;default:a=ls`Other Invalidations`}const r=new oe.TreeOutlineInShadow;r.registerRequiredCSS("timeline/invalidationsTree.css",{enableLegacyPatching:!0}),r.element.classList.add("invalidations-tree");(function(e){const t=new Map;for(let i=0;i<e.length;i++){const s=e[i];let n="";s.cause.reason&&(n+=s.cause.reason+"."),s.cause.stackTrace&&s.cause.stackTrace.forEach((function(e){n+=e.functionName+".",n+=e.scriptId+".",n+=e.url+".",n+=e.lineNumber+".",n+=e.columnNumber+"."})),t.has(n)?t.get(n).push(s):t.set(n,[s])}return[...t.values()]})(i).forEach((function(e){const i=new wi(t,s,n,e);r.appendChild(i)})),n.appendElementRow(a,r.element,!1,!0)}static _collectInvalidationNodeIds(e,t){R.addAll(e,t.map(e=>e.nodeId).filter(e=>e))}static _aggregatedStatsForTraceEvent(e,i,s){const n=i.inspectedTargetEvents();const a=n.binaryIndexOf(s.startTime,(function(e,t){return e-t.startTime}));if(a<0)return!1;let r=!1;const o=s.endTime;if(o)for(let t=a;t<n.length;t++){const i=n[t];if(i.startTime>=o)break;if(!i.selfTime)continue;if(i.thread!==s.thread)continue;t>a&&(r=!0);const l=gi.eventStyle(i).category.name;e[l]=(e[l]||0)+i.selfTime}if(t.TracingModel.isAsyncPhase(s.phase)){if(s.endTime){let t=0;for(const i in e)t+=e[i];e.idle=Math.max(0,s.endTime-s.startTime-t)}return!1}return r}static async buildPicturePreviewContent(e,t){const i=await new N.LayerPaintEvent(e,t).snapshotPromise();if(!i)return null;const s=i.snapshot.replay();i.snapshot.release();const n=await s;if(!n)return null;const a=createElement("div");q.appendStyle(a,"components/imagePreview.css",{enableLegacyPatching:!0}),a.classList.add("image-preview-container","vbox","link");const r=a.createChild("img");r.src=n,r.alt=pe.ImagePreview.defaultAltTextForImageURL(n);return a.createChild("a").textContent=ls`Paint Profiler`,G.markAsLink(a),a.tabIndex=0,a.addEventListener("click",()=>hi.instance().select(mi.fromTraceEvent(e)),!1),a.addEventListener("keydown",t=>{isEnterKey(t)&&(hi.instance().select(mi.fromTraceEvent(e)),t.consume(!0))}),a}static createEventDivider(e,t){const i=document.createElement("div");i.classList.add("resources-event-divider");const s=Number.millisToString(e.startTime-t);i.title=m.UIString("%s at %s",gi.eventTitle(e),s);const n=gi.markerStyleForEvent(e);return n.tall&&(i.style.backgroundColor=n.color),i}static _visibleTypes(){const e=gi._initEventStyles(),t=[];for(const i in e)e[i].hidden||t.push(i);return t}static visibleEventsFilter(){return new D.TimelineVisibleEventsFilter(gi._visibleTypes())}static categories(){return gi._categories||(gi._categories={loading:new bi("loading",ls`Loading`,!0,"hsl(214, 67%, 74%)","hsl(214, 67%, 66%)"),experience:new bi("experience",ls`Experience`,!1,"hsl(5, 80%, 74%)","hsl(5, 80%, 66%)"),scripting:new bi("scripting",ls`Scripting`,!0,"hsl(43, 83%, 72%)","hsl(43, 83%, 64%) "),rendering:new bi("rendering",ls`Rendering`,!0,"hsl(256, 67%, 76%)","hsl(256, 67%, 70%)"),painting:new bi("painting",ls`Painting`,!0,"hsl(109, 33%, 64%)","hsl(109, 33%, 55%)"),gpu:new bi("gpu",ls`GPU`,!1,"hsl(109, 33%, 64%)","hsl(109, 33%, 55%)"),async:new bi("async",ls`Async`,!1,"hsl(0, 100%, 50%)","hsl(0, 100%, 40%)"),other:new bi("other",ls`System`,!1,"hsl(0, 0%, 87%)","hsl(0, 0%, 79%)"),idle:new bi("idle",ls`Idle`,!1,"hsl(0, 0%, 98%)","hsl(0, 0%, 98%)")}),gi._categories}static setCategories(e){gi._categories=e}static getTimelineMainEventCategories(){return gi._eventCategories||(gi._eventCategories=["idle","loading","painting","rendering","scripting","other"]),gi._eventCategories}static setTimelineMainEventCategories(e){gi._eventCategories=e}static generatePieChart(e,t,i){let s=0;for(const t in e)s+=e[t];const n=document.createElement("div");n.classList.add("timeline-details-view-pie-chart-wrapper"),n.classList.add("hbox");const a=x.createPieChart(),r=[];function o(e,t,i,s){i&&r.push({value:i,color:s,title:t})}if(t){i&&o(t.name,m.UIString("%s (self)",t.title),i,t.color);const s=e[t.name]-i;s>0&&o(t.name,m.UIString("%s (children)",t.title),s,t.childColor)}for(const i in gi.categories()){const s=gi.categories()[i];s!==t&&o(s.name,s.title,e[s.name],s.childColor)}a.data={chartName:ls`Time spent in rendering`,size:110,formatter:e=>Number.preciseMillisToString(e),showLegend:!0,total:s,slices:r};return n.createChild("div","vbox").appendChild(a),n}static generateDetailsContentForFrame(e,t){const i=new Ci(null,null);i.addSection(ls`Frame`);const s=gi.frameDuration(e);i.appendElementRow(ls`Duration`,s,e.hasWarnings());const n=e.endTime-e.startTime;if(i.appendTextRow(ls`FPS`,Math.floor(1e3/n)),i.appendTextRow(ls`CPU time`,Number.millisToString(e.cpuTime,!0)),t){const e=document.createElement("div");e.classList.add("timeline-filmstrip-preview"),t.imageDataPromise().then(e=>U.loadImageFromData(e)).then(t=>t&&e.appendChild(t)),i.appendElementRow("",e),e.addEventListener("click",function(e){new k.Dialog(e,0)}.bind(null,t),!1)}return e.layerTree&&i.appendElementRow(ls`Layer tree`,ue.Linkifier.linkifyRevealable(e.layerTree,ls`Show`)),i.fragment}static frameDuration(e){const t=m.UIString("%s (at %s)",Number.millisToString(e.endTime-e.startTime,!0),Number.millisToString(e.startTimeOffset,!0));if(!e.hasWarnings())return U.formatLocalized("%s",[t]);const i=ae.XLink.create("https://developers.google.com/web/fundamentals/performance/rendering/",ls`jank`);return U.formatLocalized("%s. Long frame times are an indication of %s",[t,i])}static createFillStyle(e,t,i,s,n,a){const r=e.createLinearGradient(0,0,t,i);return r.addColorStop(0,s),r.addColorStop(.25,n),r.addColorStop(.75,n),r.addColorStop(1,a),r}static quadWidth(e){return Math.round(Math.sqrt(Math.pow(e[0]-e[2],2)+Math.pow(e[1]-e[3],2)))}static quadHeight(e){return Math.round(Math.sqrt(Math.pow(e[0]-e[6],2)+Math.pow(e[1]-e[7],2)))}static eventDispatchDesciptors(){if(gi._eventDispatchDesciptors)return gi._eventDispatchDesciptors;const e="hsl(40,100%,50%)";return gi._eventDispatchDesciptors=[new yi(1,"hsl(40,100%,80%)",["mousemove","mouseenter","mouseleave","mouseout","mouseover"]),new yi(1,"hsl(40,100%,80%)",["pointerover","pointerout","pointerenter","pointerleave","pointermove"]),new yi(2,"hsl(90,100%,40%)",["wheel"]),new yi(3,e,["click","mousedown","mouseup"]),new yi(3,e,["touchstart","touchend","touchmove","touchcancel"]),new yi(3,e,["pointerdown","pointerup","pointercancel","gotpointercapture","lostpointercapture"]),new yi(3,"hsl(256,100%,75%)",["keydown","keyup","keypress"])],gi._eventDispatchDesciptors}static markerShortTitle(e){const t=F.RecordType;switch(e.name){case t.MarkDOMContent:return ls`DCL`;case t.MarkLoad:return ls`L`;case t.MarkFirstPaint:return ls`FP`;case t.MarkFCP:return ls`FCP`;case t.MarkLCPCandidate:return ls`LCP`}return null}static markerStyleForEvent(e){const t=[6,4],i=gi.eventTitle(e),s=F.RecordType;if(e.name!==s.NavigationStart&&(e.hasCategory(F.TimelineModelImpl.Category.Console)||e.hasCategory(F.TimelineModelImpl.Category.UserTiming)))return{title:i,dashStyle:t,lineWidth:.5,color:e.hasCategory(F.TimelineModelImpl.Category.UserTiming)?"purple":"orange",tall:!1,lowPriority:!1};let n=!1,a="grey";switch(e.name){case s.NavigationStart:a="#FF9800",n=!0;break;case s.FrameStartedLoading:a="green",n=!0;break;case s.MarkDOMContent:a="#0867CB",n=!0;break;case s.MarkLoad:a="#B31412",n=!0;break;case s.MarkFirstPaint:a="#228847",n=!0;break;case s.MarkFCP:a="#1A6937",n=!0;break;case s.MarkLCPCandidate:a="#1A3422",n=!0;break;case s.TimeStamp:a="orange"}return{title:i,dashStyle:t,lineWidth:.5,color:a,tall:n,lowPriority:!1}}static markerStyleForFrame(){return{title:ls`Frame`,color:"rgba(100, 100, 100, 0.4)",lineWidth:3,dashStyle:[3],tall:!0,lowPriority:!0}}static colorForId(e){return gi.colorForId._colorGenerator||(gi.colorForId._colorGenerator=new f.Generator({min:30,max:330},{min:50,max:80,count:3},85),gi.colorForId._colorGenerator.setColorForID("","#f2ecdc")),gi.colorForId._colorGenerator.colorForID(e)}static eventWarning(e,t){const i=F.TimelineData.forEvent(e),s=t||i.warning;if(!s)return null;const n=F.TimelineModelImpl.WarningType,a=createElement("span"),r=e.args.data;switch(s){case n.ForcedStyle:case n.ForcedLayout:{const e=U.createDocumentationLink("../../fundamentals/performance/rendering/avoid-large-complex-layouts-and-layout-thrashing#avoid-forced-synchronous-layouts",ls`Forced reflow`);a.appendChild(U.formatLocalized("%s is a likely performance bottleneck.",[e]));break}case n.IdleDeadlineExceeded:{const t=Number.millisToString(e.duration-r.allottedMilliseconds,!0);a.textContent=ls`Idle callback execution extended beyond deadline by ${t}`;break}case n.LongHandler:a.textContent=m.UIString("Handler took %s",Number.millisToString(e.duration,!0));break;case n.LongRecurringHandler:a.textContent=m.UIString("Recurring handler took %s",Number.millisToString(e.duration,!0));break;case n.LongTask:{const t=U.createDocumentationLink("../../fundamentals/performance/rail#goals-and-guidelines",ls`Long task`);a.appendChild(U.formatLocalized("%s took %s.",[t,Number.millisToString(e.duration,!0)]));break}case n.V8Deopt:a.appendChild(ae.XLink.create("https://github.com/GoogleChrome/devtools-docs/issues/53",m.UIString("Not optimized"))),U.createTextChild(a,m.UIString(": %s",r.deoptReason));break;default:console.assert(!1,"Unhandled TimelineModel.WarningType")}return a}static displayNameForFrame(e,t){return t||(t=30),e.url.startsWith("about:")?`"${e.name.trimMiddle(t)}"`:e.url.trimEnd(t)}}class fi{constructor(e,t,i=!1){this.title=e,this.category=t,this.hidden=i}}const vi={HTML:Symbol("HTML"),Script:Symbol("Script"),Style:Symbol("Style"),Media:Symbol("Media"),Other:Symbol("Other")},Ti=Symbol("aggregatedStats");class wi extends oe.TreeElement{constructor(e,t,i,s){super("",!0),this.listItemElement.classList.add("header"),this.selectable=!1,this.toggleOnClick=!0,this._relatedNodesMap=t,this._contentHelper=i,this._invalidations=s,this.title=this._createTitle(e)}_createTitle(e){const t=this._invalidations[0],i=t.cause.reason||ls`Unknown cause`,s=t.cause.stackTrace&&t.cause.stackTrace[0],n=this._getTruncatedNodesElement(this._invalidations);if(null===n)return U.formatLocalized(i,[]);const a=U.formatLocalized("%s for %s",[i,n]);if(s&&this._contentHelper.linkifier()){const t=document.createElement("span");t.classList.add("monospace");const i=U.formatLocalized("%s. %s",[a,t]);t.createChild("span").textContent=gi.frameDisplayName(s);const n=this._contentHelper.linkifier().maybeLinkifyConsoleCallFrame(e,s);return n&&(t.createChild("span").textContent=" @ ",t.createChild("span").appendChild(n)),i}return a}async onpopulate(){const e=document.createElement("div");e.classList.add("content");const t=this._invalidations[0];if(t.cause.stackTrace){const i=e.createChild("div");U.createTextChild(i,ls`Stack trace:`),this._contentHelper.createChildStackTraceElement(i,gi._stackTraceFromCallFrames(t.cause.stackTrace))}U.createTextChild(e,1!==this._invalidations.length?ls`Nodes:`:ls`Node:`);const i=e.createChild("div","node-list");let s=!0;for(let e=0;e<this._invalidations.length;e++){const t=this._invalidations[e],n=this._createInvalidationNode(t,!0);if(n){s||U.createTextChild(i,ls`, `),s=!1,i.appendChild(n);const e=t.extraData?", "+t.extraData:"";t.changedId?U.createTextChild(i,m.UIString('(changed id to "%s"%s)',t.changedId,e)):t.changedClass?U.createTextChild(i,m.UIString('(changed class to "%s"%s)',t.changedClass,e)):t.changedAttribute?U.createTextChild(i,m.UIString('(changed attribute to "%s"%s)',t.changedAttribute,e)):t.changedPseudo?U.createTextChild(i,m.UIString('(changed pesudo to "%s"%s)',t.changedPseudo,e)):t.selectorPart&&U.createTextChild(i,m.UIString('(changed "%s"%s)',t.selectorPart,e))}}const n=new oe.TreeElement(e,!1);n.selectable=!1,this.appendChild(n)}_getTruncatedNodesElement(e){const t=[],i={};for(let s=0;s<e.length;s++){const n=e[s],a=this._createInvalidationNode(n,!1);a.addEventListener("click",e=>e.consume(),!1),a&&!i[n.nodeId]&&(t.push(a),i[n.nodeId]=!0)}return 1===t.length?t[0]:2===t.length?U.formatLocalized("%s and %s",t):3===t.length?U.formatLocalized("%s, %s, and 1 other",t.slice(0,2)):t.length>=4?U.formatLocalized("%s, %s, and %s others",[...t.slice(0,2),(t.length-2).toString()]):null}_createInvalidationNode(e,t){const i=e.nodeId&&this._relatedNodesMap?this._relatedNodesMap.get(e.nodeId):null;if(i){const e=createElement("span");return T.Linkifier.linkify(i).then(t=>e.appendChild(t)),e}if(e.nodeName){const t=createElement("span");return t.textContent=m.UIString("[ %s ]",e.nodeName),t}if(t){const e=createElement("span");return U.createTextChild(e,m.UIString("[ unknown node ]"))}}}const Si=Symbol("previewElement");class yi{constructor(e,t,i){this.priority=e,this.color=t,this.eventTypes=i}}class bi extends g.ObjectWrapper{constructor(e,t,i,s,n){super(),this.name=e,this.title=t,this.visible=i,this.childColor=s,this.color=n,this.hidden=!1}get hidden(){return this._hidden}set hidden(e){this._hidden=e,this.dispatchEventToListeners(bi.Events.VisibilityChanged,this)}}bi.Events={VisibilityChanged:Symbol("VisibilityChanged")};class Ci{constructor(e,t){this.fragment=createDocumentFragment(),this._linkifier=t,this._target=e,this.element=document.createElement("div"),this.element.classList.add("timeline-details-view-block"),this._tableElement=this.element.createChild("div","vbox timeline-details-chip-body"),this.fragment.appendChild(this.element)}addSection(e,t){if(this._tableElement.hasChildNodes()?(this.element=document.createElement("div"),this.element.classList.add("timeline-details-view-block"),this.fragment.appendChild(this.element)):this.element.removeChildren(),e){const i=this.element.createChild("div","timeline-details-chip-title");t&&(i.createChild("div").style.backgroundColor=t),U.createTextChild(i,e)}this._tableElement=this.element.createChild("div","vbox timeline-details-chip-body"),this.fragment.appendChild(this.element)}linkifier(){return this._linkifier}appendTextRow(e,t){const i=this._tableElement.createChild("div","timeline-details-view-row");i.createChild("div","timeline-details-view-row-title").textContent=e,i.createChild("div","timeline-details-view-row-value").textContent=t}appendElementRow(e,t,i,s){const n=this._tableElement.createChild("div","timeline-details-view-row");i&&n.classList.add("timeline-details-warning"),s&&n.classList.add("timeline-details-stack-values");n.createChild("div","timeline-details-view-row-title").textContent=e;const a=n.createChild("div","timeline-details-view-row-value");t instanceof Node?a.appendChild(t):U.createTextChild(a,t||"")}appendLocationRow(e,t,i,s){if(!this._linkifier||!this._target)return;const n=this._linkifier.maybeLinkifyScriptLocation(this._target,null,t,i,{columnNumber:s,tabStop:!0});n&&this.appendElementRow(e,n)}appendLocationRange(e,t,i,s){if(!this._linkifier||!this._target)return;const n=createElement("span"),a=this._linkifier.maybeLinkifyScriptLocation(this._target,null,t,i,{tabStop:!0});a&&(n.appendChild(a),U.createTextChild(n,L.sprintf(" [%s…%s]",i+1,s+1||"")),this.appendElementRow(e,n))}appendStackTrace(e,t){if(!this._linkifier||!this._target)return;const i=this._tableElement.createChild("div","timeline-details-view-row");i.createChild("div","timeline-details-view-row-title").textContent=e,this.createChildStackTraceElement(i,t)}createChildStackTraceElement(e,t){if(!this._linkifier||!this._target)return;e.classList.add("timeline-details-stack-values");const i=e.createChild("div","timeline-details-view-row-value timeline-details-view-row-stack-trace"),s=_e.buildStackTracePreviewContents(this._target,this._linkifier,{stackTrace:t,tabStops:!0});i.appendChild(s.element)}appendWarningRow(e,t){const i=gi.eventWarning(e,t);i&&this.appendElementRow(ls`Warning`,i,!0)}}const xi=Symbol("categoryBreakdownCache");var ki=Object.freeze({__proto__:null,TimelineUIUtils:gi,TimelineRecordStyle:fi,NetworkCategory:vi,aggregatedStatsKey:Ti,InvalidationsGroupElement:wi,previewElementSymbol:Si,EventDispatchTypeDescriptor:yi,TimelineCategory:bi,TimelinePopupContentHelper:class{constructor(e){this._contentTable=createElement("table");const t=this._createCell(m.UIString("%s - Details",e),"timeline-details-title");t.colSpan=2;const i=createElement("tr");i.appendChild(t),this._contentTable.appendChild(i)}contentTable(){return this._contentTable}_createCell(e,t){const i=createElement("label");U.createTextChild(i,String(e));const s=createElement("td");return s.className="timeline-details",t&&(s.className+=" "+t),s.textContent=e,s}appendTextRow(e,t){const i=createElement("tr");i.appendChild(this._createCell(e,"timeline-details-row-title")),i.appendChild(this._createCell(t,"timeline-details-row-data")),this._contentTable.appendChild(i)}appendElementRow(e,t){const i=createElement("tr"),s=this._createCell(e,"timeline-details-row-title");i.appendChild(s);const n=createElement("td");n.className="details",t instanceof Node?n.appendChild(t):U.createTextChild(n,t||""),i.appendChild(n),this._contentTable.appendChild(i)}},TimelineDetailsContentHelper:Ci,categoryBreakdownCacheSymbol:xi,TimelineMarkerStyle:void 0});class Mi extends g.ObjectWrapper{constructor(){super(),this._mainTarget=null,this._tracingModel=null,this._filters=[],this._timelineModel=new F.TimelineModelImpl,this._frameModel=new N.TimelineFrameModel(e=>gi.eventStyle(e).category.name),this._filmStripModel=null,this._irModel=new W.TimelineIRModel,this._window={left:0,right:1/0},this._extensionTracingModels=[],this._recordStartTime=void 0}setMainTarget(e){this._mainTarget=e}mainTarget(){return this._mainTarget}setRecordStartTime(e){this._recordStartTime=e}recordStartTime(){return this._recordStartTime}setFilters(e){this._filters=e}filters(){return this._filters}isVisible(e){return this._filters.every(t=>t.accept(e))}setTracingModel(e){this._tracingModel=e,this._timelineModel.setEvents(e);let t=null,i=null;for(const e of this._timelineModel.tracks())e.type===F.TrackType.Input&&(t=e.asyncEvents),e.type===F.TrackType.Animation&&(i=e.asyncEvents);(t||i)&&this._irModel.populate(t||[],i||[]);const s=this._timelineModel.tracks().filter(e=>e.type===F.TrackType.MainThread&&e.forMainFrame&&e.events.length).map(e=>{const t=e.events[0];return{thread:t.thread,time:t.startTime}});this._frameModel.addTraceEvents(this._mainTarget,this._timelineModel.inspectedTargetEvents(),s);for(const e of this._extensionTracingModels)e.model.adjustTime(this._tracingModel.minimumRecordTime()+e.timeOffset/1e3-this._recordStartTime);this._autoWindowTimes()}addExtensionEvents(e,t,i){this._extensionTracingModels.push({model:t,title:e,timeOffset:i}),this._tracingModel&&(t.adjustTime(this._tracingModel.minimumRecordTime()+i/1e3-this._recordStartTime),this.dispatchEventToListeners(Ei.ExtensionDataAdded))}tracingModel(){if(!this._tracingModel)throw"call setTracingModel before accessing PerformanceModel";return this._tracingModel}timelineModel(){return this._timelineModel}filmStripModel(){if(this._filmStripModel)return this._filmStripModel;if(!this._tracingModel)throw"call setTracingModel before accessing PerformanceModel";return this._filmStripModel=new d.FilmStripModel(this._tracingModel),this._filmStripModel}frames(){return this._frameModel.frames()}frameModel(){return this._frameModel}interactionRecords(){return this._irModel.interactionRecords()}extensionInfo(){return this._extensionTracingModels}dispose(){this._tracingModel&&this._tracingModel.dispose();for(const e of this._extensionTracingModels)e.model.dispose()}filmStripModelFrame(e){const t=e.idle?e.startTime:e.endTime,i=this._filmStripModel.frameByTimestamp(t);return i&&i.timestamp-e.endTime<10?i:null}save(e){if(!this._tracingModel)throw"call setTracingModel before accessing PerformanceModel";return this._tracingModel.backingStorage().writeToStream(e)}setWindow(e,t){this._window=e,this.dispatchEventToListeners(Ei.WindowChanged,{window:e,animate:t})}window(){return this._window}_autoWindowTimes(){const e=this._timelineModel;let t=[];for(const i of e.tracks())i.type===F.TrackType.MainThread&&i.forMainFrame&&(t=i.tasks);if(!t.length)return void this.setWindow({left:e.minimumRecordTime(),right:e.maximumRecordTime()});function i(e,i){let s=e,n=(t[s].startTime+t[s].endTime)/2,a=0;const r=Math.sign(i-e);for(let o=e;o!==i;o+=r){const e=t[o],i=(e.startTime+e.endTime)/2;a<.1*Math.abs(n-i)&&(s=o,n=i,a=0),a+=e.duration}return s}const s=i(t.length-1,0),n=i(0,s);let a=t[n].startTime,r=t[s].endTime;const o=r-a;o<.1*(e.maximumRecordTime()-e.minimumRecordTime())?(a=e.minimumRecordTime(),r=e.maximumRecordTime()):(a=Math.max(a-.05*o,e.minimumRecordTime()),r=Math.min(r+.05*o,e.maximumRecordTime())),this.setWindow({left:a,right:r})}}const Ei={ExtensionDataAdded:Symbol("ExtensionDataAdded"),WindowChanged:Symbol("WindowChanged")};var Pi=Object.freeze({__proto__:null,PerformanceModel:Mi,Events:Ei,Window:void 0});class Ri extends V.VBox{constructor(e){super(),this.element.id="memory-graphs-container",this._delegate=e,this._calculator=new Fi,this._model,this._header=new V.HBox,this._header.element.classList.add("timeline-memory-header"),this._header.show(this.element),this._toolbar=new H.Toolbar("timeline-memory-toolbar"),this._header.element.appendChild(this._toolbar.element),this._graphsContainer=new V.VBox,this._graphsContainer.show(this.element);const t=new V.VBoxWithResizeCallback(this._resize.bind(this));t.show(this._graphsContainer.element),this._createCurrentValuesBar(),this._canvasContainer=t.element,this._canvasContainer.id="memory-graphs-canvas-container",this._canvas=document.createElement("canvas"),this._canvasContainer.appendChild(this._canvas),this._canvas.id="memory-counters-graph",this._canvasContainer.addEventListener("mouseover",this._onMouseMove.bind(this),!0),this._canvasContainer.addEventListener("mousemove",this._onMouseMove.bind(this),!0),this._canvasContainer.addEventListener("mouseleave",this._onMouseLeave.bind(this),!0),this._canvasContainer.addEventListener("click",this._onClick.bind(this),!0),this._timelineGrid=new M.TimelineGrid,this._canvasContainer.appendChild(this._timelineGrid.dividersElement),this._counters=[],this._counterUI=[],this._countersByName=new Map,this._countersByName.set("jsHeapSizeUsed",this._createCounter(m.UIString("JS Heap"),m.UIString("JS Heap: %s"),"hsl(220, 90%, 43%)",E.bytesToString)),this._countersByName.set("documents",this._createCounter(m.UIString("Documents"),m.UIString("Documents: %s"),"hsl(0, 90%, 43%)")),this._countersByName.set("nodes",this._createCounter(m.UIString("Nodes"),m.UIString("Nodes: %s"),"hsl(120, 90%, 43%)")),this._countersByName.set("jsEventListeners",this._createCounter(m.UIString("Listeners"),m.UIString("Listeners: %s"),"hsl(38, 90%, 43%)")),this._gpuMemoryCounter=this._createCounter(m.UIString("GPU Memory"),m.UIString("GPU Memory: %s"),"hsl(300, 90%, 43%)",E.bytesToString),this._countersByName.set("gpuMemoryUsedKB",this._gpuMemoryCounter)}setModel(e,t){this._model!==e&&(this._model&&this._model.removeEventListener(Ei.WindowChanged,this._onWindowChanged,this),this._model=e,this._model&&this._model.addEventListener(Ei.WindowChanged,this._onWindowChanged,this)),this._calculator.setZeroTime(e?e.timelineModel().minimumRecordTime():0);for(let e=0;e<this._counters.length;++e)this._counters[e].reset(),this._counterUI[e].reset();if(this.scheduleRefresh(),this._track=t,!t)return;const i=t.syncEvents();for(let e=0;e<i.length;++e){const t=i[e];if(t.name!==F.RecordType.UpdateCounters)continue;const s=t.args.data;if(!s)return;for(const e in s){const i=this._countersByName.get(e);i&&i.appendSample(t.startTime,s[e])}const n="gpuMemoryLimitKB";n in s&&this._gpuMemoryCounter.setLimit(s[n])}}_createCurrentValuesBar(){this._currentValuesBar=this._graphsContainer.element.createChild("div"),this._currentValuesBar.id="counter-values-bar"}_createCounter(e,t,i,s){const n=new Li;return this._counters.push(n),this._counterUI.push(new Ii(this,e,t,i,n,s)),n}resizerElement(){return this._header.element}_resize(){const e=this._canvas.parentElement;this._canvas.width=e.clientWidth*window.devicePixelRatio,this._canvas.height=e.clientHeight*window.devicePixelRatio,this._calculator.setDisplayWidth(this._canvas.width),this.refresh()}_onWindowChanged(e){const t=e.data.window;this._calculator.setWindow(t.left,t.right),this.scheduleRefresh()}scheduleRefresh(){U.invokeOnceAfterBatchUpdate(this,this.refresh)}draw(){this._clear();for(const e of this._counters)e._calculateVisibleIndexes(this._calculator),e._calculateXValues(this._canvas.width);for(const e of this._counterUI)e._drawGraph(this._canvas)}_onClick(e){const t=e.x-this._canvasContainer.totalOffsetLeft();let i,s=1/0;for(const e of this._counterUI){if(!e.counter.times.length)continue;const n=e._recordIndexAt(t),a=Math.abs(t*window.devicePixelRatio-e.counter.x[n]);a<s&&(s=a,i=e.counter.times[n])}void 0!==i&&this._track&&this._delegate.selectEntryAtTime(this._track.events.length?this._track.events:this._track.asyncEvents,i)}_onMouseLeave(e){delete this._markerXPosition,this._clearCurrentValueAndMarker()}_clearCurrentValueAndMarker(){for(let e=0;e<this._counterUI.length;e++)this._counterUI[e]._clearCurrentValueAndMarker()}_onMouseMove(e){const t=e.x-this._canvasContainer.totalOffsetLeft();this._markerXPosition=t,this._refreshCurrentValues()}_refreshCurrentValues(){if(void 0!==this._markerXPosition)for(let e=0;e<this._counterUI.length;++e)this._counterUI[e].updateCurrentValue(this._markerXPosition)}refresh(){this._timelineGrid.updateDividers(this._calculator),this.draw(),this._refreshCurrentValues()}_clear(){const e=this._canvas.getContext("2d");if(!e)throw new Error("Unable to get canvas context");e.clearRect(0,0,e.canvas.width,e.canvas.height)}}class Li{constructor(){this.times=[],this.values=[],this.x=[],this._minimumIndex=0,this._maximumIndex=0,this._maxTime=0,this._minTime=0}appendSample(e,t){this.values.length&&this.values.peekLast()===t||(this.times.push(e),this.values.push(t))}reset(){this.times=[],this.values=[]}setLimit(e){this._limitValue=e}_calculateBounds(){let e,t;for(let i=this._minimumIndex;i<=this._maximumIndex;i++){const s=this.values[i];(void 0===t||s<t)&&(t=s),(void 0===e||s>e)&&(e=s)}return t=t||0,e=e||1,this._limitValue&&(e>.5*this._limitValue&&(e=Math.max(e,this._limitValue)),t=Math.min(t,this._limitValue)),{min:t,max:e}}_calculateVisibleIndexes(e){const t=e.minimumBoundary(),i=e.maximumBoundary();this._minimumIndex=E.clamp(this.times.upperBound(t)-1,0,this.times.length-1),this._maximumIndex=E.clamp(this.times.lowerBound(i),0,this.times.length-1),this._minTime=t,this._maxTime=i}_calculateXValues(e){if(!this.values.length)return;const t=e/(this._maxTime-this._minTime);this.x=new Array(this.values.length);for(let e=this._minimumIndex+1;e<=this._maximumIndex;e++)this.x[e]=t*(this.times[e]-this._minTime)}}class Ii{constructor(e,t,i,s,n,a){this._countersPane=e,this.counter=n,this._formatter=a||Number.withThousandsSeparator,this._setting=p.Settings.instance().createSetting("timelineCountersGraph-"+t,!0),this._setting.setTitle(t),this._filter=new H.ToolbarSettingCheckbox(this._setting,t),this._filter.inputElement.classList.add("-theme-preserve-input");const r=f.Color.parse(s);if(r){const e=r.setAlpha(.5).asString(f.Format.RGBA),t=this._filter.element;e&&(t.style.backgroundColor=e),t.style.borderColor="transparent"}this._filter.inputElement.addEventListener("click",this._toggleCounterGraph.bind(this)),e._toolbar.appendToolbarItem(this._filter),this._range=this._filter.element.createChild("span","range"),this._value=e._currentValuesBar.createChild("span","memory-counter-value"),this._value.style.color=s,this.graphColor=s,r&&(this.limitColor=r.setAlpha(.3).asString(f.Format.RGBA)),this.graphYValues=[],this._verticalPadding=10,this._currentValueLabel=i,this._marker=e._canvasContainer.createChild("div","memory-counter-marker"),this._marker.style.backgroundColor=s,this._clearCurrentValueAndMarker()}reset(){this._range.textContent=""}setRange(e,t){const i=this._formatter(e),s=this._formatter(t);this._range.textContent=m.UIString("[%s – %s]",i,s)}_toggleCounterGraph(e){this._value.classList.toggle("hidden",!this._filter.checked()),this._countersPane.refresh()}_recordIndexAt(e){return this.counter.x.upperBound(e*window.devicePixelRatio,void 0,this.counter._minimumIndex+1,this.counter._maximumIndex+1)-1}updateCurrentValue(e){if(!this.visible()||!this.counter.values.length||!this.counter.x)return;const t=this._recordIndexAt(e),i=Number.withThousandsSeparator(this.counter.values[t]);this._value.textContent=m.UIString(this._currentValueLabel,i);const s=this.graphYValues[t]/window.devicePixelRatio;this._marker.style.left=e+"px",this._marker.style.top=s+"px",this._marker.classList.remove("hidden")}_clearCurrentValueAndMarker(){this._value.textContent="",this._marker.classList.add("hidden")}_drawGraph(e){const t=e.getContext("2d");if(!t)throw new Error("Unable to get canvas context");const i=e.width,s=e.height-2*this._verticalPadding;if(s<=0)return void(this.graphYValues=[]);const n=this._verticalPadding,a=this.counter,r=a.values;if(!r.length)return;const o=a._calculateBounds(),l=o.min,h=o.max;if(this.setRange(l,h),!this.visible())return;const c=this.graphYValues,d=h-l,m=d?s/d:1;t.save(),t.lineWidth=window.devicePixelRatio,t.lineWidth%2&&t.translate(.5,.5),t.beginPath();let u=r[a._minimumIndex],p=Math.round(n+s-(u-l)*m);t.moveTo(0,p);let _=a._minimumIndex;for(;_<=a._maximumIndex;_++){const e=Math.round(a.x[_]);t.lineTo(e,p);const i=r[_];void 0!==i&&(u=i),p=Math.round(n+s-(u-l)*m),t.lineTo(e,p),c[_]=p}if(c.length=_,t.lineTo(i,p),t.strokeStyle=this.graphColor,t.stroke(),a._limitValue){const e=Math.round(n+s-(a._limitValue-l)*m);t.moveTo(0,e),t.lineTo(i,e),this.limitColor&&(t.strokeStyle=this.limitColor),t.stroke()}t.closePath(),t.restore()}visible(){return this._filter.checked()}}class Fi{constructor(){this._minimumBoundary=0,this._maximumBoundary=0,this._workingArea=0,this._zeroTime=0}setZeroTime(e){this._zeroTime=e}computePosition(e){return(e-this._minimumBoundary)/this.boundarySpan()*this._workingArea}setWindow(e,t){this._minimumBoundary=e,this._maximumBoundary=t}setDisplayWidth(e){this._workingArea=e}formatValue(e,t){return Number.preciseMillisToString(e-this.zeroTime(),t)}maximumBoundary(){return this._maximumBoundary}minimumBoundary(){return this._minimumBoundary}zeroTime(){return this._zeroTime}boundarySpan(){return this._maximumBoundary-this._minimumBoundary}}var Di=Object.freeze({__proto__:null,CountersGraph:Ri,Counter:Li,CounterUI:Ii,Calculator:Fi});export{Ne as CLSLinkifier,Di as CountersGraph,Tt as EventsTimelineTreeView,Oe as ExtensionTracingSession,Pi as PerformanceModel,je as TimelineController,Mt as TimelineDetailsView,st as TimelineEventOverview,ot as TimelineFilters,Ft as TimelineFlameChartDataProvider,Bt as TimelineFlameChartNetworkDataProvider,Xt as TimelineFlameChartView,ei as TimelineHistoryManager,St as TimelineLayersView,He as TimelineLoader,Ct as TimelinePaintProfilerView,_i as TimelinePanel,gt as TimelineTreeView,ki as TimelineUIUtils,oi as UIDevtoolsController,ai as UIDevtoolsUtils};
